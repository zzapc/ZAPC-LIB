*&---------------------------------------------------------------------*
*& Report  ZCOMPARADOR
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT  zcomparador.

TABLES:  csm_invals, sscrfields.
TYPES: BEGIN OF t_listado,
         clave  TYPE string,
         izquierda TYPE string,
         izquierda_c1 TYPE string,
         izquierda_c1v TYPE p DECIMALS 3,
         derecha TYPE string,
         derecha_c1 TYPE string,
         derecha_c1v TYPE p DECIMALS 3,
       END OF t_listado.

TYPES: BEGIN OF t_datos,
         clave TYPE string,
         valor TYPE string,
         valorv TYPE mengev,
       END OF t_datos.

DATA: i_derecha TYPE SORTED TABLE OF t_datos WITH NON-UNIQUE KEY clave valor WITH HEADER LINE,
      i_izquierda TYPE SORTED TABLE OF t_datos WITH NON-UNIQUE KEY clave valor WITH HEADER LINE,
      o_alv TYPE REF TO zcl_ap_alv,
      l_listado TYPE t_listado,
      i_listado TYPE TABLE OF t_listado,
      l_string TYPE string,
      i_clip TYPE TABLE OF csm_invals-value WITH HEADER LINE .

SELECT-OPTIONS: s_der FOR csm_invals-value,
                s_izq FOR csm_invals-value.

SELECT-OPTIONS: s_der2 FOR csm_invals-value,
                s_izq2 FOR csm_invals-value.

PARAMETERS: p_colt AS CHECKBOX DEFAULT 'X',
            p_valn AS CHECKBOX DEFAULT 'X'.

SELECTION-SCREEN: FUNCTION KEY 1,
                  FUNCTION KEY 2.

INITIALIZATION.
  sscrfields-functxt_01 = 'Importar izquierda'.
  sscrfields-functxt_02 = 'Importar derecha'.
  CREATE OBJECT o_alv.

AT SELECTION-SCREEN.
  DATA l_error TYPE string.

  IF sy-ucomm = 'FC02'.
    cl_gui_frontend_services=>clipboard_import(
  IMPORTING
     data                 = i_clip[]
*       length               = lv_clip_len
   EXCEPTIONS
     cntl_error           = 1
     error_no_gui         = 2
     not_supported_by_gui = 3
     OTHERS               = 4 ).

    LOOP AT i_clip.
      SPLIT i_clip AT cl_bcs_convert=>gc_tab INTO i_derecha-clave i_derecha-valor.

      AT FIRST.
        IF p_colt = 'X'.
          o_alv->set_field_text( campo = 'DERECHA' valor = i_derecha-clave ).
          o_alv->set_field_text( campo = 'DERECHA_C1,DERECHA_C1V' valor = i_derecha-valor ).
          CONTINUE.
        ENDIF.
      ENDAT.


      IF p_valn = 'X'.
        zcl_ap_string=>string2ctd( EXPORTING ctd_texto = i_derecha-valor IMPORTING cantidad = i_derecha-valorv mensaje = l_error ).
        IF l_error IS INITIAL.
          i_derecha-valor = i_derecha-valorv.
        ENDIF.
      ENDIF.
      INSERT i_derecha INTO TABLE i_derecha.
    ENDLOOP.
  ENDIF.

  IF sy-ucomm = 'FC01'.
    cl_gui_frontend_services=>clipboard_import(
  IMPORTING
     data                 = i_clip[]
*       length               = lv_clip_len
   EXCEPTIONS
     cntl_error           = 1
     error_no_gui         = 2
     not_supported_by_gui = 3
     OTHERS               = 4 ).

    LOOP AT i_clip.
      SPLIT i_clip AT cl_bcs_convert=>gc_tab INTO i_izquierda-clave i_izquierda-valor.

      AT FIRST.
        IF p_colt = 'X'.
          o_alv->set_field_text( campo = 'IZQUIERDA' valor = i_izquierda-clave ).
          o_alv->set_field_text( campo = 'IZQUIERDA_C1,IZQUIERDA_C1V' valor = i_izquierda-valor ).
          CONTINUE.
        ENDIF.
      ENDAT.

      IF p_valn = 'X'.
        zcl_ap_string=>string2ctd( EXPORTING ctd_texto = i_izquierda-valor IMPORTING cantidad = i_izquierda-valorv mensaje = l_error  ).
        IF l_error IS INITIAL.
          i_izquierda-valor = i_izquierda-valorv.
        ENDIF.
      ENDIF.
      INSERT i_izquierda INTO TABLE i_izquierda.
    ENDLOOP.
  ENDIF.

START-OF-SELECTION.

  SORT: s_der, s_izq.

  LOOP AT s_der.
    CLEAR i_derecha.
    i_derecha-clave = s_der-low.
    READ TABLE s_der2 INDEX sy-tabix.
    IF sy-subrc = 0.
      i_derecha-valor = s_der2-low.
    ENDIF.
    APPEND i_derecha.
  ENDLOOP.

  LOOP AT s_izq.
    CLEAR i_izquierda.
    i_izquierda-clave = s_izq-low.
    READ TABLE s_izq2 INDEX sy-tabix.
    IF sy-subrc = 0.
      i_izquierda-valor = s_izq2-low.
    ENDIF.
    APPEND i_izquierda.
  ENDLOOP.


  DELETE i_derecha WHERE clave = ''.
  DELETE i_izquierda WHERE clave = ''.

  LOOP AT i_derecha.
    l_string = i_derecha-clave.
    REPLACE ALL OCCURRENCES OF '/' IN l_string WITH ''.
    IF l_string IS INITIAL.
      DELETE i_derecha.
    ENDIF.
  ENDLOOP.

  LOOP AT i_izquierda.
    l_string = i_izquierda-clave.
    REPLACE ALL OCCURRENCES OF '/' IN l_string WITH ''.
    IF l_string IS INITIAL.
      DELETE i_izquierda.
    ENDIF.
  ENDLOOP.

  LOOP AT i_derecha.
    LOOP AT i_izquierda WHERE clave = i_derecha-clave
                         AND valor = i_derecha-valor.
      DELETE i_izquierda.
      DELETE i_derecha.
      EXIT.
    ENDLOOP.
  ENDLOOP.

  LOOP AT i_derecha.
    CLEAR l_listado.
    l_listado-derecha = i_derecha-clave.
    l_listado-derecha_c1 = i_derecha-valor.
    l_listado-derecha_c1v = i_derecha-valorv.
    APPEND l_listado TO i_listado.
  ENDLOOP.

  LOOP AT i_izquierda.
    CLEAR l_listado.
    l_listado-izquierda = i_izquierda-clave.
    l_listado-izquierda_c1 = i_izquierda-valor.
    l_listado-izquierda_c1v = i_izquierda-valorv.
    APPEND l_listado TO i_listado.
  ENDLOOP.

  SORT i_listado.
  o_alv->set_field_noout( 'CLAVE' ).
  IF p_valn IS INITIAL.
    o_alv->set_field_noout( 'DERECHA_C1V,IZQUIERDA_C1V' ).
  ELSE.
    o_alv->set_field_noout( 'DERECHA_C1,IZQUIERDA_C1' ).
  ENDIF.

  o_alv->show( ).