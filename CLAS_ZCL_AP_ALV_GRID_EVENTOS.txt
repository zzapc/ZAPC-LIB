CLASS zcl_ap_alv_grid_eventos DEFINITION
  PUBLIC
  CREATE PUBLIC.

  PUBLIC SECTION.
    DATA v_double_click          TYPE char1.
    DATA v_data_changed          TYPE char1.
    DATA v_user_command          TYPE char1.
    DATA v_after_refresh         TYPE char1.
    DATA v_print_top_of_page     TYPE char1.
    DATA v_toolbar               TYPE char1.
    DATA v_onf4                  TYPE char1.
    DATA v_button_click          TYPE char1.
    DATA v_hotspot_click         TYPE char1.
    DATA v_data_changed_finished TYPE char1.
    DATA v_top_of_page           TYPE char1.
    DATA v_ondrag                TYPE char1.
    DATA v_ondrop                TYPE char1.
    DATA boton_refrescar         TYPE string.
    DATA boton_excel             TYPE string.
    DATA o_alv                   TYPE REF TO zcl_ap_alv_grid.
    DATA o_dev                   TYPE REF TO zcl_ap_dev.
    DATA boton_nuevo             TYPE string.
    DATA boton_borrar            TYPE string.
    DATA tabla                   TYPE string.
    DATA boton_copiar            TYPE string.
    DATA v_after_user_command    TYPE char1.
    DATA v_last_user_command     TYPE sy-ucomm.
    DATA campo_updkz             TYPE string.
    DATA v_delayed_changed_sel   TYPE char1 VALUE 'X' ##NO_TEXT.
    DATA o_grid_local            TYPE REF TO zcl_ap_alv_grid.
    DATA quitar_campos_xlsx      TYPE string.

    METHODS constructor
      IMPORTING boton_refrescar TYPE any                    DEFAULT ''
                boton_excel     TYPE any                    DEFAULT ''
                o_prog          TYPE REF TO zcl_ap_dev      OPTIONAL
                boton_nuevo     TYPE any                    DEFAULT ''
                boton_borrar    TYPE any                    DEFAULT ''
                tabla           TYPE any                    DEFAULT ''
                boton_copiar    TYPE any                    DEFAULT ''
                o_grid_local    TYPE REF TO zcl_ap_alv_grid OPTIONAL
                opciones        TYPE string                 DEFAULT ''.

    METHODS double_click
      FOR EVENT double_click OF cl_gui_alv_grid
      IMPORTING e_row
                e_column.

    METHODS data_changed
      FOR EVENT data_changed OF cl_gui_alv_grid
      IMPORTING er_data_changed.

    METHODS after_refresh
      FOR EVENT after_refresh OF cl_gui_alv_grid.

    METHODS user_command
      FOR EVENT user_command OF cl_gui_alv_grid
      IMPORTING e_ucomm.

    METHODS cambia_valor_campo
      IMPORTING er_data_changed TYPE REF TO cl_alv_changed_data_protocol OPTIONAL
                fila            TYPE i                                   OPTIONAL
                campo           TYPE any
                nuevo_valor     TYPE any.

    METHODS mensaje_log
      IMPORTING er_data_changed TYPE REF TO cl_alv_changed_data_protocol OPTIONAL
                campo           TYPE string                              OPTIONAL
                msgty           TYPE any                                 DEFAULT 'E'
                msgv1           TYPE any                                 OPTIONAL
                msgv2           TYPE any                                 OPTIONAL
                msgv3           TYPE any                                 OPTIONAL
                msgv4           TYPE any                                 OPTIONAL.

    METHODS print_top_of_page
      FOR EVENT print_top_of_page OF cl_gui_alv_grid
      IMPORTING table_index.

    METHODS toolbar
      FOR EVENT toolbar OF cl_gui_alv_grid
      IMPORTING e_object
                e_interactive.

    METHODS onf4
      FOR EVENT onf4 OF cl_gui_alv_grid
      IMPORTING e_fieldname
                e_fieldvalue
                es_row_no
                er_event_data
                et_bad_cells
                e_display.

    METHODS button_click
      FOR EVENT button_click OF cl_gui_alv_grid
      IMPORTING es_col_id
                es_row_no.

    METHODS hotspot_click
      FOR EVENT hotspot_click OF cl_gui_alv_grid
      IMPORTING e_row_id
                e_column_id
                es_row_no.

    METHODS data_changed_finished
      FOR EVENT data_changed_finished OF cl_gui_alv_grid
      IMPORTING e_modified
                et_good_cells.

    METHODS top_of_page
      FOR EVENT top_of_page OF cl_gui_alv_grid
      IMPORTING e_dyndoc_id
                table_index.

    METHODS ondrag
      FOR EVENT ondrag OF cl_gui_alv_grid
      IMPORTING e_row
                e_column
                es_row_no
                e_dragdropobj.

    METHODS ondrop
      FOR EVENT ondrop OF cl_gui_alv_grid
      IMPORTING e_row
                e_column
                es_row_no
                e_dragdropobj.

    METHODS ondropcomplete
      FOR EVENT ondropcomplete OF cl_gui_alv_grid
      IMPORTING e_row
                e_column
                es_row_no
                e_dragdropobj.

    METHODS add_boton
      IMPORTING !function  TYPE any
                !icon      TYPE any OPTIONAL
                !text      TYPE any
                !quickinfo TYPE any OPTIONAL
                e_object   TYPE REF TO cl_alv_event_toolbar_set.

    METHODS set_data_changed
      IMPORTING er_data_changed TYPE REF TO cl_alv_changed_data_protocol
                linea           TYPE lvc_s_modi.

    METHODS after_user_command
      FOR EVENT after_user_command OF cl_gui_alv_grid
      IMPORTING e_ucomm
                e_saved
                e_not_processed.

    METHODS visualizar_objeto
      IMPORTING !hotspot       TYPE zcl_ap_alv=>t_hotspot OPTIONAL
                !list          TYPE any
                !column        TYPE any
                !row           TYPE any                   OPTIONAL
      RETURNING VALUE(message) TYPE bapi_msg.

    METHODS actualizar_fila
      IMPORTING fila_ini        TYPE any
                fila_fin        TYPE any
                er_data_changed TYPE REF TO cl_alv_changed_data_protocol
                fila            TYPE i
                campo_color     TYPE any       DEFAULT ''
                no_tech         TYPE abap_bool DEFAULT 'X'
                comparar_todo   TYPE abap_bool DEFAULT ''.

    METHODS delayed_changed_sel_callback
      FOR EVENT delayed_changed_sel_callback OF cl_gui_alv_grid.

  PROTECTED SECTION.
    DATA i_cambios_celda    TYPE lvc_t_modi.
    DATA campo              TYPE string.
    DATA cambio_celda       TYPE lvc_s_modi.
    DATA tabla_data_changed TYPE string.

    METHODS ini_data_changed
      IMPORTING cambios TYPE lvc_t_modi
                tabla   TYPE string DEFAULT 'O_PROG->I_LISTADO'.

    METHODS set_valor_mod
      CHANGING datos TYPE any.

  PRIVATE SECTION.
    DATA o_data_changed TYPE REF TO cl_alv_changed_data_protocol.
    DATA linea_modi     TYPE lvc_s_modi.
endclass. "ZCL_AP_ALV_GRID_EVENTOS definition
class ZCL_AP_ALV_GRID_EVENTOS implementation.
  METHOD actualizar_fila.
    FIELD-SYMBOLS: <fs_ini> TYPE any,
                   <fs_fin> TYPE any.

    CHECK NOT o_alv IS INITIAL.

    DATA(i_fcat) = o_alv->t_fcat.
    IF NOT campo_color IS INITIAL.
      APPEND VALUE #( fieldname = campo_color ) TO i_fcat.
    ENDIF.
*  DELETE i_fcat WHERE inttype = 'y'. "XSTRING
    IF no_tech = 'X'.
      DELETE i_fcat WHERE tech = 'X'.
    ENDIF.

    LOOP AT i_fcat ASSIGNING FIELD-SYMBOL(<fcat>).
      IF     zcl_ap_lista=>es_elemento( lista = tabla_data_changed elemento = <fcat>-fieldname )
         AND comparar_todo <> 'X'.
        CONTINUE.
      ENDIF.

      ASSIGN COMPONENT <fcat>-fieldname OF STRUCTURE fila_ini TO <fs_ini>.
      IF sy-subrc = 0.
        ASSIGN COMPONENT <fcat>-fieldname OF STRUCTURE fila_fin TO <fs_fin>.
        IF sy-subrc = 0.
          IF <fs_ini> <> <fs_fin>.
            cambia_valor_campo( er_data_changed = er_data_changed
                                fila = fila
                                campo = <fcat>-fieldname
                                nuevo_valor = <fs_fin> ).
          ENDIF.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.
  METHOD add_boton.
    DATA ls_toolbar TYPE stb_button.

    CLEAR ls_toolbar.
    ls_toolbar-function = function.
    ls_toolbar-icon     = icon.
    ls_toolbar-text     = text.
    IF quickinfo IS INITIAL.
      ls_toolbar-quickinfo = text.
    ELSE.
      ls_toolbar-quickinfo = quickinfo.
    ENDIF.
    APPEND ls_toolbar TO e_object->mt_toolbar.
  ENDMETHOD.
  METHOD after_refresh.
    v_after_refresh = 'X'.
  ENDMETHOD.
  METHOD after_user_command.
    v_after_user_command = 'X'.
    v_last_user_command = e_ucomm.
  ENDMETHOD.
  METHOD button_click.
*  read table i_tabla into estructura index e_row.
*  if sy-subrc = 0.
*    case ES_COL_ID-fieldname.
*      when 'XXX'.
*      when others.
*    endcase.
*  endif.

    DATA: l_campo   TYPE string,
          l_message TYPE bapi_msg.

    FIELD-SYMBOLS: <tabla> TYPE table,
                   <list>  TYPE any.

    v_button_click = 'X'.

    IF NOT o_alv IS INITIAL.
      IF o_alv->table_ref IS INITIAL.
        CONCATENATE 'O_DEV->' o_alv->nombre_tabla INTO l_campo.
        ASSIGN (l_campo) TO <tabla>.
      ELSE.
        ASSIGN o_alv->table_ref->* TO <tabla>.
      ENDIF.
    ENDIF.

    IF <tabla> IS ASSIGNED.
      ASSIGN <tabla>[ es_row_no-row_id ] TO <list>.
      IF sy-subrc = 0.
        l_message = visualizar_objeto( list = <list> column = es_col_id-fieldname row = es_row_no-row_id ).
        IF l_message IS INITIAL.
          RETURN.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.
  METHOD cambia_valor_campo.
    DATA: i_campos TYPE TABLE OF lvc_fname,
          l_campo  TYPE lvc_fname.

    SPLIT campo AT ',' INTO TABLE i_campos.

    LOOP AT i_campos INTO l_campo.
      IF er_data_changed IS INITIAL.
        me->o_data_changed->modify_cell(
            i_row_id    = linea_modi-row_id
            i_fieldname = l_campo
            i_value     = nuevo_valor ).
      ELSE.
        er_data_changed->modify_cell(
            i_row_id    = fila
            i_fieldname = l_campo
            i_value     = nuevo_valor ).
      ENDIF.
    ENDLOOP.

*  DEFINE cambiar_valor.
*    cambia_valor_campo( er_data_changed = er_data_changed
*                           fila = ls_good-row_id
*                           campo = &1
*                           nuevo_valor = &2 ).
*  END-OF-DEFINITION.
  ENDMETHOD.
  METHOD constructor.
    CLEAR: v_double_click,
           v_data_changed,
           v_data_changed_finished,
           v_user_command,
           v_after_refresh,
           v_print_top_of_page,
           v_toolbar,
           v_button_click,
           v_hotspot_click.

    me->boton_refrescar = boton_refrescar.
    me->boton_excel     = boton_excel.
    me->boton_nuevo     = boton_nuevo.
    me->boton_copiar    = boton_copiar.
    me->boton_borrar    = boton_borrar.
    o_dev           = o_prog.
    me->tabla        = tabla.
    me->o_grid_local = o_grid_local.

    SPLIT opciones AT ',' INTO TABLE DATA(i_opc).
    LOOP AT i_opc ASSIGNING FIELD-SYMBOL(<opc>).
      SPLIT <opc> AT '=' INTO DATA(l_opcion) DATA(l_valor).
      CASE l_opcion.
        WHEN 'QUITAR_CAMPOS_XLSX'.
          quitar_campos_xlsx = l_valor.
      ENDCASE.
    ENDLOOP.
  ENDMETHOD.
  METHOD data_changed.
*  DATA: ls_good TYPE lvc_s_modi,
*        i_cambios TYPE lvc_t_modi,
*        l_campo(40).
*  FIELD-SYMBOLS <fs> TYPE ANY.
*
*  i_cambios = er_data_changed->mt_good_cells.
*  SORT i_cambios BY row_id.
*
*
*  LOOP AT i_cambios INTO ls_good.
*    AT NEW row_id.
*      CLEAR l_listado.
*      READ TABLE i_listado INTO l_listado INDEX ls_good-row_id.
*    ENDAT.
*
*    CONCATENATE 'L_LISTADO-' ls_good-fieldname INTO l_campo.
*    ASSIGN (l_campo) TO <fs>.
*    IF sy-subrc = 0.
*      <fs> = ls_good-value.
*    ENDIF.
*
*    CASE ls_good-fieldname.
*
*
*        SELECT SINGLE * FROM mkal
*          INTO mkal
*       WHERE matnr = ls_good-value
*         AND werks = zepp022-werks_sust
*         AND verid = zepp021-linea.
*        IF sy-subrc NE 0.
*          mensaje_log(  er_data_changed = er_data_changed
*                       campo = 'MATNR'
*                       msgty = 'E'
*                       msgv1 = 'Error en material' ).
*          cambia_valor_campo( er_data_changed = er_data_changed
*                              fila = ls_good-row_id
*                              campo = 'LIGHTS'
*                              nuevo_valor = '3' ).
*        ENDIF.
*    ENDCASE.
*    AT END OF row_id.
*      MODIFY i_listado FROM l_listado INDEX ls_good-row_id.
*    ENDAT.
*  ENDLOOP.

    v_data_changed = 'X'.
  ENDMETHOD.
  METHOD data_changed_finished.
    v_data_changed_finished = 'X'.
  ENDMETHOD.
  METHOD delayed_changed_sel_callback.
    v_DELAYED_CHANGED_SEL = 'X'.
  ENDMETHOD.
  METHOD double_click.
*  read table i_tabla into estructura index e_row.
*  if sy-subrc = 0.
*    case e_column.
*      when 'XXX'.
*      when others.
*    endcase.
*  endif.

*    v_double_click = 'X'.

    DATA: l_campo   TYPE string,
          l_message TYPE bapi_msg.

    FIELD-SYMBOLS: <tabla> TYPE table,
                   <list>  TYPE any.

    IF NOT o_alv IS INITIAL.
      IF o_alv->table_ref IS INITIAL.
        CONCATENATE 'O_DEV->' o_alv->nombre_tabla INTO l_campo.
        ASSIGN (l_campo) TO <tabla>.
      ELSE.
        ASSIGN o_alv->table_ref->* TO <tabla>.
      ENDIF.
    ENDIF.

    IF <tabla> IS ASSIGNED.
      ASSIGN <tabla>[ e_row-index ] TO <list>.
      IF sy-subrc = 0.
        l_message = visualizar_objeto( list = <list> column = e_column-fieldname row = e_row-index ).
        IF l_message IS INITIAL.
          RETURN.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.
  METHOD hotspot_click.
    DATA: l_campo   TYPE string,
          l_hotspot TYPE zcl_ap_alv=>t_hotspot,
          l_message TYPE bapi_msg.

    FIELD-SYMBOLS: <tabla> TYPE table,
                   <list>  TYPE any,
                   <valor> TYPE any.

    IF NOT o_alv IS INITIAL.
      IF o_alv->table_ref IS INITIAL.
        CONCATENATE 'O_DEV->' o_alv->nombre_tabla INTO l_campo.
        ASSIGN (l_campo) TO <tabla>.
      ELSE.
        ASSIGN o_alv->table_ref->* TO <tabla>.
      ENDIF.
    ENDIF.

    IF <tabla> IS ASSIGNED.
      ASSIGN <tabla>[ es_row_no-row_id ] TO <list>.
      IF sy-subrc = 0.

        IF NOT o_alv IS INITIAL.
          READ TABLE o_alv->i_hotspot INTO l_hotspot WITH KEY campo = e_column_id-fieldname.
        ENDIF.

        l_message = visualizar_objeto( list = <list> column = e_column_id-fieldname hotspot = l_hotspot row = es_row_no-row_id ).
        IF l_message IS INITIAL.
          RETURN.
        ENDIF.

        IF NOT o_alv->o_alv_helper IS INITIAL.
          l_message = o_alv->o_alv_helper->visualizar_objeto( list = <list> column = e_column_id-fieldname hotspot = l_hotspot row = es_row_no-row_id ).
          IF l_message IS INITIAL.
            RETURN.
          ENDIF.
        ENDIF.

        IF NOT l_hotspot IS INITIAL.
          IF l_hotspot-transaccion <> ''.
            zcl_ap_alv=>visualizar_obj( EXPORTING hotspot = l_hotspot list = <list> column = e_column_id-fieldname
                                        IMPORTING mod = DATA(l_mod) salida = DATA(l_salida) ).
            IF l_mod = 'X'.
              ASSIGN COMPONENT e_column_id-fieldname OF STRUCTURE <list> TO <valor>.
              IF sy-subrc = 0.
                IF <valor> <> l_salida.
                  <valor> = l_salida.

                  IF NOT campo_updkz IS INITIAL.
                    ASSIGN COMPONENT campo_updkz OF STRUCTURE <list> TO <valor>.
                    IF sy-subrc = 0.
                      IF <valor> IS INITIAL.
                        <valor> = 'U'.
                      ENDIF.
                    ENDIF.
                    WAIT UP TO '0.1' SECONDS. " Me da la impresión de que a veces no se refrescan los datos correctamente
                  ENDIF.
                  IF NOT o_alv IS INITIAL.
                    o_alv->refrescar_grid( soft_refresh = '' ).
                  ENDIF.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

*    DATA: l_hotspot TYPE zcl_ap_alv=>t_hotspot,
*          l_campo   TYPE string.
*    FIELD-SYMBOLS: <tabla>  TYPE table,
*                   <list>   TYPE any,
*                   <valor>  TYPE any,
*                   <valor2> TYPE any,
*                   <valor3> TYPE any.
*
*    IF NOT o_alv IS INITIAL AND NOT o_dev IS INITIAL.
*      READ TABLE o_alv->i_hotspot INTO l_hotspot WITH KEY campo = e_column_id-fieldname.
*      IF sy-subrc = 0.
*        IF l_hotspot-transaccion NE ''.
*          CONCATENATE 'O_DEV->' o_alv->nombre_tabla INTO l_campo.
*          ASSIGN (l_campo) TO <tabla>.
*          IF sy-subrc = 0.
*            READ TABLE <tabla> ASSIGNING <list> INDEX es_row_no-row_id.
*            IF sy-subrc = 0.
*              zcl_ap_alv=>visualizar_obj( hotspot = l_hotspot list = <list> column = e_column_id-fieldname ).
*            ENDIF.
*          ENDIF.
*        ENDIF.
*      ENDIF.
*    ENDIF.
*  read table i_tabla into estructura index e_row.
*  if sy-subrc = 0.
*    case e_column.
*      when 'XXX'.
*      when others.
*    endcase.
*  endif.

*  v_hotspot_click = 'X'.
  ENDMETHOD.
  METHOD ini_data_changed.
    i_cambios_celda = cambios.
    SORT i_cambios_celda BY row_id.

    tabla_data_changed = tabla.
  ENDMETHOD.
  METHOD mensaje_log.
    DATA l_campo TYPE lvc_fname.

    IF NOT campo IS INITIAL.
      l_campo = campo.
    ELSE.
      l_campo = linea_modi-fieldname.
    ENDIF.

    IF er_data_changed IS INITIAL.
      me->o_data_changed->add_protocol_entry(
          i_msgid     = '00'
          i_msgno     = '398'
          i_msgty     = msgty
          i_msgv1     = msgv1
          i_msgv2     = msgv2
          i_msgv3     = msgv3
          i_msgv4     = msgv4
          i_fieldname = l_campo ).
    ELSE.
      er_data_changed->add_protocol_entry(
          i_msgid     = '00'
          i_msgno     = '398'
          i_msgty     = msgty
          i_msgv1     = msgv1
          i_msgv2     = msgv2
          i_msgv3     = msgv3
          i_msgv4     = msgv4
          i_fieldname = l_campo ).
    ENDIF.
  ENDMETHOD.
  METHOD ondrag.
    v_ondrag = 'X'.
  ENDMETHOD.
  METHOD ondrop.
    v_ondrop = 'X'.
  ENDMETHOD.
  METHOD ondropcomplete.
  ENDMETHOD.
  METHOD onf4.
    v_onf4 = 'X'.

*      data: ls_f4 type ddshretval,
*          lt_f4 type table of ddshretval.
*
**§8 you can define an f4-help for a column without standard f4-help
*    if no_inp = 'X'.
*      message i087(0k) with es_row_no-row_id e_fieldvalue.
*
**§3 set attribute m_event_handled of er_event_data to avoid standard
**   f4-help.
*      er_event_data->m_event_handled = 'X'.
*
**§2 implement (a non-trivial) event handler which allows user input
*    else.
*
**§5 define fields and field-symbols for data-update
*      field-symbols: <itab> type lvc_t_modi.
*      data: ls_modi type lvc_s_modi.
*
** now I call my personal f4-help
*      call method my_f4
*        exporting
*          sender        = sender
*          es_row_no     = es_row_no
*          er_event_data = er_event_data
*          et_bad_cells  = et_bad_cells
*          e_display     = e_display
*          e_fieldname   = e_fieldname
*        importing
*          lt_f4         = lt_f4.
*
**§6 assign the cell table fieldsymbol to the dereferenced data table and
**   fill the table.
*      assign er_event_data->m_data->* to <itab>.
*
*      read table lt_f4 into ls_f4 with key fieldname = 'CONNID'.
*      if not ls_f4 is initial.
*        ls_modi-row_id    = es_row_no-row_id.
*        ls_modi-fieldname = 'CONNID'.
*        ls_modi-value     = ls_f4-fieldval.
*        append ls_modi to <itab>.
*      endif.
*
**§7 in case you set chngeafter (change other values of your table after
**   f4-help) when registering your f4-help, column 7 will change,
**   depending on your choice for column 2. Notice that in this case
**   value change in other columns just happens after f4, not after
**   editing the grid directly. For value change after any editing you
**   should use your event handler for event data_changed (see §9).
*      if chn_aft = 'X'.
*        ls_modi-row_id = es_row_no-row_id.
*        ls_modi-fieldname = 'SEATSMAX'.
*        case ls_f4-fieldval.
*          when '0017'.
*            ls_modi-value = 280.
*          when '0026'.
*            ls_modi-value = 385.
*          when '0064'.
*            ls_modi-value = 385.
*          when '0555'.
*            ls_modi-value = 220.
*          when others.
*            ls_modi-value = 999.
*        endcase.
*        append ls_modi to <itab>.
*      endif.
*
*      er_event_data->m_event_handled = 'X'.
*
*    endif.

*    field-symbols: <itab> type lvc_t_modi.
*    data: ls_modi type lvc_s_modi,
*          i_motivos type zt_parametros,
*          l_motivo type zparametros,
*          o_mc type ref to zcl_ap_matchcode_z,
*          i_lfa1 type table of lfa1,
*          l_index type i.
*
*    assign er_event_data->m_data->* to <itab>.
*    ls_modi-row_id    = es_row_no-row_id.
*    ls_modi-fieldname = e_fieldname.
*    read table i_listado assigning <listado> index es_row_no-row_id.
*    if sy-subrc = 0.
*      case e_fieldname.
*        when 'LIFNR'.
*          i_lfa1 = o_prog->get_proveedores( matnr = <listado>-idnrk ).
*          if i_lfa1 is initial.
**            MESSAGE 'No existen proveedores para el material/proyecto' TYPE 'I'.
*            ls_modi-value = zcl_ap_matchcode_z=>matchcode_std( 'KRED' ).
*            ls_modi-fieldname = e_fieldname.
*            append ls_modi to <itab>.
*          else.
*            create object o_mc
*              exporting
*                tabname = 'LFA1'.
*
*            o_mc->add_field( field = 'LIFNR' selectflag = 'X'  ).
*            o_mc->add_field( field = 'NAME1' ).
*            loop at i_lfa1 into lfa1.
*              o_mc->add_valor( lfa1-lifnr ).
*              lfa1-name1 = zcl_ap_proveedor=>get_nombre( lfa1-lifnr ).
*              o_mc->add_valor( lfa1-name1 ).
*            endloop.
*            l_index = o_mc->matchcode_index( field   =  'LIFNR' ).
*            read table i_lfa1 into lfa1 index l_index.
*            if sy-subrc = 0.
*              ls_modi-value = lfa1-lifnr.
*              ls_modi-fieldname = e_fieldname.
*              append ls_modi to <itab>.
*            endif.
*          endif.
*      endcase.
*    endif.
*
*    er_event_data->m_event_handled = 'X'.
  ENDMETHOD.
  METHOD print_top_of_page.
*    WRITE: / sy-tcode, sy-title, sy-datum, 'Página:', sy-pagno.
*    SELECT SINGLE * FROM zepp003
*      INTO zepp003
*     WHERE linea = p_linea.
*    WRITE: / 'Línea:', p_linea, zepp003-descripcion.
*    IF NOT s_werks[] IS INITIAL.
*      SELECT * FROM t001w
*        INTO t001w
*       WHERE werks IN s_werks.
*        WRITE: / 'Centro:', t001w-werks, t001w-name1.
*      ENDSELECT.
*    ENDIF.
*    SKIP. NEW-LINE.

    v_print_top_of_page = 'X'.
  ENDMETHOD.
  METHOD set_data_changed.
    o_data_changed = er_data_changed.
    linea_modi     = linea.
  ENDMETHOD.
  METHOD set_valor_mod.
    FIELD-SYMBOLS <fs> TYPE any.

    CONCATENATE 'DATOS-' cambio_celda-fieldname INTO campo.
    ASSIGN (campo) TO <fs>.
    IF sy-subrc = 0.
      <fs> = cambio_celda-value.
      __add_lista tabla_data_changed cambio_celda-fieldname.
    ENDIF.
  ENDMETHOD.
  METHOD toolbar.
    DATA l_text TYPE string.

    v_toolbar = 'X'.

    DEFINE add_boton.
      IF &3 <> ''.
        CLEAR v_toolbar.
        IF &3 = 'X' OR &3 = 'Y'.
          l_text = &4.
        ELSE.
          l_text = &3.
        ENDIF.

        add_boton( function = &1 icon = &2 text = l_text quickinfo = l_text e_object = e_object ).
      ENDIF.
    END-OF-DEFINITION.

    add_boton: 'REFRESCAR' '@42@' boton_refrescar 'Refrescar'(ref),
               'EXCEL'     '@J2@' boton_excel     'Excel'(exc),
               'NUEVO'     '@0Y@' boton_nuevo     'Nuevo'(nue),
               'COPIAR'    '@14@' boton_copiar    'Copiar'(cop),
               'BORRAR'    '@11@' boton_borrar    'Borrar'(bor).
  ENDMETHOD.
  METHOD top_of_page.
    v_top_of_page = 'X'.
  ENDMETHOD.
  METHOD user_command.
    " TODO: variable is assigned but only used in commented-out code (ABAP cleaner)
    DATA: l_tabla TYPE string,
          l_xlsx  TYPE xfeld.

    FIELD-SYMBOLS <tabla> TYPE table.

    v_user_command = 'X'.

    IF boton_refrescar = 'X'.
      CLEAR v_user_command.
      IF e_ucomm = 'REFRESCAR'.
        IF NOT o_alv IS INITIAL.
          IF NOT o_dev IS INITIAL.
            o_dev->buscar_datos( ).
          ENDIF.
          o_alv->refrescar_grid( soft_refresh = '' ).
        ENDIF.
      ENDIF.
    ENDIF.

    IF boton_excel = ''.
      RETURN.
    ENDIF.

    CLEAR v_user_command.
    IF e_ucomm <> 'EXCEL'.
      RETURN.
    ENDIF.

    IF o_alv IS INITIAL.
      RETURN.
    ENDIF.

    o_alv->comprobar_cambios( ).

    IF boton_excel = 'Y'.
      SELECT SINGLE clsname FROM seoclass
        INTO l_tabla
       WHERE clsname = 'ZCL_AP_ABAP2XLS'.
      IF sy-subrc = 0.
        ASSIGN o_alv->table_ref->* TO <tabla>.
        IF sy-subrc = 0.
          l_xlsx = 'X'.
        ENDIF.
*            CONCATENATE '(' o_alv->cprog ')' o_alv->nombre_tabla '[]' INTO l_tabla.
*            ASSIGN (l_tabla) TO <tabla>.
*            IF sy-subrc = 0.
*              l_xlsx = 'X'.
*            ELSE.
*              CONCATENATE '(' o_alv->cprog ')O_PROG->' o_alv->nombre_tabla '[]' INTO l_tabla.
*              ASSIGN (l_tabla) TO <tabla>.
*              IF sy-subrc = 0.
*                l_xlsx = 'X'.
*              ENDIF.
*            ENDIF.
      ENDIF.
    ENDIF.

    IF l_xlsx IS INITIAL.
      o_alv->exportar_excel( ).
    ELSE.
*            zcl_ap_abap2xls=>alv_2_xls( alv = o_alv->o_grid tabla = <tabla> abrir = 'X' nombre_fichero = sy-title ).

      IF NOT quitar_campos_xlsx IS INITIAL.
        DATA(i_par) = VALUE abap_parmbind_tab( ( name = 'QUITAR_CAMPOS' kind = cl_abap_objectdescr=>exporting value = REF #( quitar_campos_xlsx ) ) ).
      ENDIF.

      zcl_ap_dev=>exec_method_st( EXPORTING clase = 'ZCL_AP_ABAP2XLS' metodo = 'ALV_2_XLS'
                                  name1 = 'ALV' value1 = o_alv->o_grid
                                  name2 = 'TABLA' value2 = <tabla>
                                  name3 = 'ABRIR' value3 = 'X'
                                  name4 = 'NOMBRE_FICHERO' value4 = sy-title
                                  i_par = i_par
                     IMPORTING message = DATA(msg) ).
      IF NOT msg IS INITIAL.
        MESSAGE msg TYPE 'I'.
      ENDIF.
    ENDIF.
  ENDMETHOD.
  METHOD visualizar_objeto.

    CASE column.
      WHEN 'X'.

      WHEN OTHERS.
        message = '?'.
    ENDCASE.
  ENDMETHOD.
