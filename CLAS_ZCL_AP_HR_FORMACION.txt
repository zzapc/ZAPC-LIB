class ZCL_AP_HR_FORMACION definition
  public
  inheriting from ZCL_OBJETO_PD
  create public .

public section.

  constants C_COD_CALIFICACION type HRP1000-OTYPE value 'BA'. "#EC NOTEXT
  constants C_COD_MODELO_CALIF type HRP1000-OTYPE value 'BS'. "#EC NOTEXT
  constants C_COD_CURSO type HRP1000-OTYPE value 'E'. "#EC NOTEXT
  constants C_COD_TIPO_ACTO type HRP1000-OTYPE value 'D'. "#EC NOTEXT
  constants C_COD_GRUPO_ACTO type HRP1000-OTYPE value 'L'. "#EC NOTEXT
  constants C_COD_CUALIFICACION type HRP1000-OTYPE value 'Q'. "#EC NOTEXT
  constants C_COD_SEDE type HRP1000-OTYPE value 'F'. "#EC NOTEXT

  methods GET_REL_FORMACION
    importing
      !BEGDA type HRP1000-BEGDA default '00000000'
      !ENDDA type HRP1000-ENDDA default '99991231'
      !R_PERNR type TABLE optional
      !ISTAT type HRP1001-ISTAT default '1' .
  class-methods GET_CALIFICACIONES_EMPLEADO
    importing
      !PERNR type PA0024-PERNR
      !BEGDA type PA0024-BEGDA default '01011900'
      !ENDDA type PA0024-ENDDA default '31129999'
    preferred parameter PERNR
    returning
      value(T_CUALIFICACIONES) type HRPD_PROFQ_TAB .
  class-methods GET_CALENDARIO
    importing
      !OBJID type HRP1001-OBJID
      !OTYPE type HRP1001-OTYPE default 'E'
    preferred parameter OBJID
    returning
      value(HORARIO) type PIQHRVSCHED_T .
protected section.
private section.

  data EST_REL_FORMACION type ZEST_REL_FORMACION .
  data TAB_REL_FORMACION type ZTAB_REL_FORMACION .
endclass. "ZCL_AP_HR_FORMACION definition
class ZCL_AP_HR_FORMACION implementation.
method GET_CALENDARIO.

  CALL FUNCTION 'RH_GET_SCHEDULE'
    EXPORTING
      plvar             = c_plvar
      otype             = otype
      objid             = objid
    TABLES
      schedule_out      = horario
    EXCEPTIONS
      no_schedule_found = 1
      calid_error       = 2
      OTHERS            = 3.

endmethod.
method GET_CALIFICACIONES_EMPLEADO.
*  DATA: t_cualif TYPE REF TO zcl_rel_pd,
*        r_pernr  TYPE RANGE OF hrp1001-objid,
*        l_pernr  like LINE OF r_pernr.
*
** Relaciones entre Empleados y Cualificaciones
*  CREATE OBJECT t_cualif.
*
*
*  l_pernr-option = 'EQ'.
*  l_pernr-sign   = 'I'.
*  l_pernr-low    = pernr.
*  APPEND l_pernr TO r_pernr.
*
*  t_cualif->select_rel_pd( tipo_origen  = 'P'
*                       r_objid      = r_pernr
*                       tipo_destino = c_cod_cualificacion
*                       relat        = '032'
*                       begda        = begda
*                       endda        = endda
*                       ).

  DATA: i_sobids     TYPE TABLE OF hrsobid,
        l_sobid      TYPE hrsobid.

  l_sobid-plvar = zcl_objeto_pd=>c_plvar.
  l_sobid-otype = 'P'.
  l_sobid-sobid = pernr.
  APPEND l_sobid TO i_sobids.

  CALL FUNCTION 'RHPP_Q_PROFILE_READ'
       EXPORTING
            begda            = begda
            endda            = endda
*               WITH_STEXT       = 'X'
*               WITH_QK_INFO     = 'X'
            check_note       = 'X'
       TABLES
            OBJECTS          = i_sobids
*               ERR_OBJECTS      =
            profile          = t_cualificaciones
       EXCEPTIONS
            no_authority     = 1
            wrong_otype      = 2
            object_not_found = 3
            undefined        = 4
            OTHERS           = 5.
endmethod.
method GET_REL_FORMACION.
*data: t_ba type ref of zcl_rel_pd.
  data: t_calif type ref to zcl_AP_REl_pd,
        t_mcali type ref to zcl_AP_rel_pd,
        t_cursos type ref to zcl_AP_rel_pd,
        t_tactos type ref to zcl_AP_rel_pd,
        t_gactos type ref to zcl_AP_rel_pd,
        t_aux type ztab_rel_formacion.

  data: r_objid type range of hrp1000-objid,
        l_objid like line of r_objid.

  if r_pernr[] is initial.
    zcl_sgpi=>text('Seleccionando relaciones formación').
  endif.

* Relaciones entre Empleados y Calificaciones
  create object t_calif.
  t_calif->select_rel_pd( tipo_origen  = 'P'
                       r_objid      = r_pernr[]
                       tipo_destino = c_cod_calificacion
                       istat        = istat
                       relat        = '046'
                       begda        = begda
                       endda        = endda
*                       r_sobid      = s_objid[]
                       ).

  refresh tab_rel_formacion.

  refresh r_objid.
  loop at t_calif->t_rel into t_calif->rel.
    clear est_rel_formacion.
    est_rel_formacion-pernr = t_calif->rel-objid.
    est_rel_formacion-calif = t_calif->rel-sobid.
    append est_rel_formacion to tab_rel_formacion.
    delete t_calif->t_rel.

    l_objid-option = 'EQ'.
    l_objid-sign   = 'I'.
    l_objid-low    = t_calif->rel-sobid.
    collect l_objid into r_objid.

  endloop.


  describe table r_objid lines sy-tfill.
  if sy-tfill > 100.
    refresh r_objid.
  endif.

* Relaciones entre calificación y modelo
  create object t_mcali.
  t_mcali->select_rel_pd( tipo_origen  = c_cod_calificacion
                       r_objid      = r_objid
                       tipo_destino = c_cod_modelo_calif
                       istat        = istat
                       rsign        = 'A'
                       relat        = '003'
*                       r_sobid      = s_objid[]
                        ).

  loop at tab_rel_formacion into est_rel_formacion.
    loop at t_mcali->t_rel into t_mcali->rel
           where objid = est_rel_formacion-calif.
      est_rel_formacion-mcali = t_mcali->rel-sobid.
      modify tab_rel_formacion from est_rel_formacion.
      t_mcali->rel-borrar = 'X'.
      modify t_mcali->t_rel from t_mcali->rel.
    endloop.
  endloop.
  if r_pernr[] is initial.
    loop at t_mcali->t_rel into t_mcali->rel
                          where borrar = ''.
      clear est_rel_formacion.
      est_rel_formacion-calif = t_mcali->rel-objid.
      est_rel_formacion-mcali = t_mcali->rel-sobid.
      append est_rel_formacion to tab_rel_formacion.
      delete t_mcali->t_rel.
    endloop.
  endif.

  refresh t_mcali->t_rel.

* Relaciones entre calificación y cursos
  create object t_cursos.
  t_cursos->select_rel_pd( tipo_origen  = c_cod_calificacion
                       r_objid      = r_objid
                       tipo_destino = c_cod_curso
                       istat        = istat
                       rsign        = 'B'
                       relat        = '045'
                       begda        = begda
                       endda        = endda
*                       r_sobid      = s_curso[]
                       ).

  loop at tab_rel_formacion into est_rel_formacion
                           where not calif is initial.
    loop at t_cursos->t_rel into t_cursos->rel
           where objid = est_rel_formacion-calif.
      est_rel_formacion-curso = t_cursos->rel-sobid.
      modify tab_rel_formacion from est_rel_formacion.
      t_cursos->rel-borrar = 'X'.
      modify t_cursos->t_rel from t_cursos->rel.
    endloop.
  endloop.
  if r_pernr[] is initial.
    loop at t_cursos->t_rel into t_cursos->rel where borrar is initial.
      clear est_rel_formacion.
      est_rel_formacion-curso = t_cursos->rel-sobid.
      est_rel_formacion-calif = t_cursos->rel-objid.
      append est_rel_formacion to tab_rel_formacion.
      delete t_cursos->t_rel.
    endloop.
  endif.
  refresh t_cursos->t_rel.

* Relaciones entre Empleados y Cursos
  refresh r_objid.
  loop at tab_rel_formacion into est_rel_formacion
                           where not curso is initial.
    l_objid-option = 'EQ'.
    l_objid-sign   = 'E'.
    l_objid-low    = est_rel_formacion-curso.
    collect l_objid into r_objid.
  endloop.
  t_calif->select_rel_pd( tipo_origen  = 'P'
                       r_objid      = r_pernr[]
                       tipo_destino = c_cod_curso
                       istat        = istat
                       rsign        = 'B'
                       relat        = '025'
                       begda        = begda
                       endda        = endda
*                       r_sobid      = s_objid[]
                       ).

  loop at t_calif->t_rel into t_calif->rel.
    clear est_rel_formacion.
    est_rel_formacion-pernr = t_calif->rel-objid.
    est_rel_formacion-curso = t_calif->rel-sobid.
    append est_rel_formacion to tab_rel_formacion.
    delete t_calif->t_rel.
  endloop.

* Relaciones entr cursos y tipos de actos.
  refresh r_objid.
  loop at tab_rel_formacion into est_rel_formacion
                           where not curso is initial.
    l_objid-option = 'EQ'.
    l_objid-sign   = 'I'.
    l_objid-low    = est_rel_formacion-curso.
    collect l_objid into r_objid.
  endloop.

  describe table r_objid lines sy-tfill.
  if sy-tfill > 100.
    refresh r_objid.
  endif.

  create object t_tactos.
  t_tactos->select_rel_pd( tipo_origen  = c_cod_curso
                       r_objid      = r_objid
                       tipo_destino = c_cod_tipo_acto
                       istat        = istat
                       rsign        = 'A'
                       relat        = '020'
*                       r_sobid      = s_tacto[]
                       ).

  loop at tab_rel_formacion into est_rel_formacion
                           where not curso is initial.
    loop at t_tactos->t_rel into t_tactos->rel
           where objid = est_rel_formacion-curso.
      est_rel_formacion-tacto = t_tactos->rel-sobid.
      modify tab_rel_formacion from est_rel_formacion.
      t_tactos->rel-borrar = 'X'.
      modify t_tactos->t_rel from t_tactos->rel.
    endloop.
  endloop.
  if r_pernr[] is initial.
    loop at t_tactos->t_rel into t_tactos->rel where borrar is initial.
      clear est_rel_formacion.
      est_rel_formacion-tacto = t_tactos->rel-sobid.
      est_rel_formacion-curso = t_tactos->rel-objid.
      append est_rel_formacion to tab_rel_formacion.
      delete t_tactos->t_rel.
    endloop.
  endif.
  refresh t_tactos->t_rel.

* Relaciones entre tipo de actos y grupo de actos
  create object t_gactos.
  refresh r_objid.
  loop at tab_rel_formacion into est_rel_formacion
                           where not tacto is initial.
    l_objid-option = 'EQ'.
    l_objid-sign   = 'I'.
    l_objid-low    = est_rel_formacion-tacto.
    collect l_objid into r_objid.
  endloop.

  describe table r_objid lines sy-tfill.
  if sy-tfill > 100.
    refresh r_objid.
  endif.

  t_gactos->select_rel_pd( tipo_origen  = c_cod_tipo_acto
                       r_objid      = r_objid
                       tipo_destino = c_cod_grupo_acto
                       istat        = istat
                       rsign        = 'A'
                       relat        = '003'
*                       r_sobid      = s_gacto[]
                       ).

  loop at tab_rel_formacion into est_rel_formacion
                           where not tacto is initial.
    loop at t_gactos->t_rel into t_gactos->rel
           where objid = est_rel_formacion-tacto.
      est_rel_formacion-gacto = t_gactos->rel-sobid.
      modify tab_rel_formacion from est_rel_formacion.
      t_gactos->rel-borrar = 'X'.
      modify t_gactos->t_rel from t_gactos->rel.
    endloop.
  endloop.
  if r_pernr[] is initial.
    loop at t_gactos->t_rel into t_gactos->rel where borrar is initial.
      clear est_rel_formacion.
      est_rel_formacion-gacto = t_gactos->rel-sobid.
      est_rel_formacion-tacto = t_gactos->rel-objid.
      append est_rel_formacion to tab_rel_formacion.
      delete t_gactos->t_rel.
    endloop.
  endif.
  refresh t_gactos->t_rel.


endmethod.