FUNCTION z_apc_create_fieldcat.
*"----------------------------------------------------------------------
*"*"Interfase local
*"  IMPORTING
*"     REFERENCE(DESC_CAT) TYPE  C DEFAULT 'M'
*"     REFERENCE(DO_SUM) TYPE  C OPTIONAL
*"  TABLES
*"      IT_FINAL
*"      IT_FIELDCAT TYPE  SLIS_T_FIELDCAT_ALV
*"----------------------------------------------------------------------
*       Global data declarations

  " Delete Data Variables
  refresh_vars.

  " Describe Properties of Internal Table
  "*"*"*"*"*"*"*"*"*"*"*"*"*
  DESCRIBE FIELD it_final INTO td.
  "*"*"*"*"*"*"*"*"*"*"*"*"*

  "Fill New Table for SYS names
  LOOP AT td-names INTO wa_names.
**    if sy-tabix ne l_index.
    IF wa_names-continue EQ '*'.
      wa_names1 = wa_names.

      CLEAR : wa_names, l_index.
      l_index = sy-tabix.
      CLEAR tmp_str.
      DO.

        l_index = l_index + 1.
        READ TABLE td-names INTO wa_names INDEX l_index.
        IF sy-subrc = 0.
          CONCATENATE wa_names1-name  wa_names-name INTO tmp_str.
          wa_names1-name = tmp_str.
          " For Modification
          CLEAR wa_names-name.
          MODIFY td-names FROM wa_names INDEX l_index.
        ENDIF.
        IF wa_names-continue NE '*'.
          EXIT.
        ENDIF.

      ENDDO.
      wa_names-name = tmp_str.
      APPEND wa_names TO it_names.
    ELSE.
      APPEND wa_names TO it_names.
    ENDIF.

  ENDLOOP.

  "Reomve Extra Types
  LOOP AT td-types INTO wa_type.
    IF sy-tabix > 1 AND
      wa_type-type NE 'h' AND
      wa_type-type NE 'u'.
      APPEND wa_type TO table_type.
    ENDIF.
  ENDLOOP.

  "Fill IT_Delem for List of Data Elemen List
  LOOP AT table_type INTO wa_type.
    CLEAR wa_names.
    READ TABLE it_names INTO wa_names INDEX wa_type-idx_help_id.

    IF sy-subrc = 0 AND
       wa_type-idx_help_id NE 0.

      WRITE wa_names-name TO wa_delem-rollname LEFT-JUSTIFIED.
      wa_delem-outputlen = wa_type-output_length.
      wa_delem-decimals = wa_type-decimals.

      APPEND wa_delem TO it_delem.

    ELSEIF wa_type-idx_help_id EQ 0 AND wa_type-context EQ ''.
      IF wa_type-type EQ 'g'.
        wa_names-name = 'STRING'.
      ELSE.
        wa_names-name = wa_type-type.
      ENDIF.

      WRITE wa_names-name TO wa_delem-rollname LEFT-JUSTIFIED.
      wa_delem-outputlen = wa_type-output_length.
      IF wa_delem-outputlen EQ 0.
        wa_delem-outputlen = 200.
      ENDIF.
      wa_delem-decimals = wa_type-decimals.
      APPEND wa_delem TO it_delem.
    ENDIF.
  ENDLOOP.

  " Delete Extra Info from IT-NAMES
  DELETE it_names WHERE name CS '=='.
  DELETE it_names WHERE name EQ ''.

  "New Logic for Temp Code
  DELETE it_names WHERE name CS '%'.
  IF sy-subrc = 0.
    del_index = 0.
  ELSE.
    del_index = 2.
  ENDIF.

  LOOP AT it_names INTO wa_names.
    IF sy-tabix > del_index. " Skip Report Name and Structure Name
      CLEAR wa_delem.
      READ TABLE it_delem INTO wa_delem WITH KEY rollname = wa_names-name.
      IF sy-subrc NE 0.
        WRITE wa_names-name TO wa_field-fieldname LEFT-JUSTIFIED.
        APPEND wa_field TO  it_field.
      ENDIF.
    ENDIF.

  ENDLOOP.

  " Comparing Total Data Element and Field Names
  CLEAR : len, len1.
  DESCRIBE TABLE it_delem LINES len.
  DESCRIBE TABLE it_field LINES len1.
  " If both are same then only Create Fieldcat
  " Match 1 to 1 mapping Field <-> Data Element
  IF len EQ len1.
    CLEAR wa_field.
    LOOP AT it_field INTO wa_field.
      CLEAR wa_delem.
      READ TABLE it_delem INTO wa_delem INDEX sy-tabix.
      IF sy-subrc = 0.
        wa_field-rollname = wa_delem-rollname.
        wa_field-outputlen = wa_delem-outputlen.
        wa_field-decimals = wa_delem-decimals.
        MODIFY it_field FROM wa_field.
      ENDIF.
    ENDLOOP.

    " AFter Filling Final Table IT_FIELD Fill FieldCatlog
    CLEAR wa_fieldcat.
    CLEAR wa_field.
    CHECK it_field[] IS NOT INITIAL.
    LOOP AT it_field INTO wa_field.
      CLEAR : wa_fieldcat, wa_dd04l, wa_dd04t, temp_str1, temp_str2.

      wa_fieldcat-fieldname       = wa_field-fieldname.
      wa_fieldcat-outputlen       = wa_field-outputlen.
      WRITE wa_field-decimals TO wa_fieldcat-decimals_out LEFT-JUSTIFIED.
                                                            " Case 1
      " Data element with Table Ref
      SPLIT wa_field-rollname AT  '-' INTO temp_str1 temp_str2.

      IF temp_str2 IS INITIAL.
        SELECT SINGLE * FROM dd04l INTO wa_dd04l
            WHERE rollname = temp_str1 AND deffdname NE '' .
      ELSE.
        "If Field is Specified with Table Ref
        CLEAR wa_dd03l.
        SELECT SINGLE * FROM dd03l INTO wa_dd03l
            WHERE tabname = temp_str1 AND fieldname EQ temp_str2.
        "Temp_str1 is Table Ref
        "Temp_str2 is Field Name
        IF sy-subrc = 0.
          temp_str2 = wa_dd03l-rollname.
        ENDIF.
        SELECT SINGLE * FROM dd04l INTO wa_dd04l
               WHERE rollname = temp_str2.
      ENDIF.

      IF wa_dd04l IS NOT INITIAL. " Data Element Found in Datadictionary
        IF wa_dd04l-decimals IS INITIAL.
          wa_fieldcat-just         = 'L'.
          wa_fieldcat-do_sum       = ''.
        ELSE.
          wa_fieldcat-just         = 'R'.
          "if No sum inidicator is given
          IF do_sum IS NOT INITIAL.
            wa_fieldcat-do_sum       = 'X'.
          ENDIF.
        ENDIF.

        " Fill Selection Text
        CLEAR wa_dd04t.
        IF temp_str2 IS INITIAL.
          SELECT SINGLE * FROM dd04t INTO wa_dd04t WHERE rollname   =  temp_str1
                                                     AND ddlanguage =  'EN'.
        ELSE.
          SELECT SINGLE * FROM dd04t INTO wa_dd04t WHERE rollname   = temp_str2
                                                     AND ddlanguage = 'EN'.
        ENDIF.

        IF wa_dd04t IS NOT INITIAL.
          CASE desc_cat.
            WHEN 'M'.
              wa_fieldcat-seltext_l    = wa_dd04t-scrtext_m.
              "Fill Other Text to Fieldcat Text
              fill_blank_text.
            WHEN 'L'.
              wa_fieldcat-seltext_l    = wa_dd04t-scrtext_l.
              "Fill Other Text to Fieldcat Text
              fill_blank_text.
            WHEN 'S'.
              wa_fieldcat-seltext_l    = wa_dd04t-scrtext_s.
              "Fill Other Text to  Fieldcat Text
              fill_blank_text.
            WHEN OTHERS.
              wa_fieldcat-seltext_l    = wa_dd04t-scrtext_m.
              "Fill Other Text to  Fieldcat Text
              fill_blank_text.
          ENDCASE.
        ENDIF.
        " End
      ELSE.
        "Custom Fields
        "NO Data Element Found
        TRANSLATE wa_field-fieldname TO LOWER CASE .
        TRANSLATE wa_field-fieldname+0(1) TO UPPER CASE .
        wa_fieldcat-seltext_l    = wa_field-fieldname.
      ENDIF.
      APPEND wa_fieldcat TO it_fieldcat.
    ENDLOOP.
    "Delete Extra Entries                                                            "1st MANDT
    DELETE it_fieldcat WHERE fieldname = 'MANDT'.
  ENDIF.

ENDFUNCTION.