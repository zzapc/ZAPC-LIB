<?xml version="1.0" encoding="utf-8"?>
<PROG NAME="LZAP_ALV_MULTICLI" VARCL="X" SUBC="I" APPL="S" LEVL="750" RMAND="100" RLOAD="1" UCCHECK="X">
 <source>*&amp;---------------------------------------------------------------------*
*&amp; 包含               LZFG_ALV_MULTICLI
*&amp;---------------------------------------------------------------------*


CLASS lcl_abstract_dialog IMPLEMENTATION.


  METHOD clear_message.
    CLEAR gs_message.
  ENDMETHOD.

  METHOD collect_message.
    IF gs_message-msgty IS INITIAL.
      gs_message-msgty = sy-msgty.
      gs_message-msgid = sy-msgid.
      gs_message-msgno = sy-msgno.
      gs_message-msgv1 = sy-msgv1.
      gs_message-msgv2 = sy-msgv2.
      gs_message-msgv3 = sy-msgv3.
      gs_message-msgv4 = sy-msgv4.
    ENDIF.
  ENDMETHOD.

  METHOD show_message.
    IF NOT gs_message-msgty IS INITIAL.
      MESSAGE ID     gs_message-msgid
              TYPE  &apos;S&apos;
              NUMBER gs_message-msgno
              WITH   gs_message-msgv1
                     gs_message-msgv2
                     gs_message-msgv3
                     gs_message-msgv4.
    ELSE.

    ENDIF.
  ENDMETHOD.
ENDCLASS.



CLASS lcl_application IMPLEMENTATION.
  METHOD start_from_transaction.

    DATA lv_application TYPE REF TO lcl_application.


    CREATE OBJECT lv_application.
    CALL METHOD lv_application-&gt;start( ).
  ENDMETHOD.                    &quot;lcl_application


  METHOD constructor.
*   Local data.
    CALL METHOD super-&gt;constructor.



    CASE gv_mode.
      WHEN &apos;H&apos;.
        CALL METHOD cl_bus_abstract_screen=&gt;get_screen
          EXPORTING
            iv_program_name  = gc_program_name
            iv_dynpro_number = gc_dynnr_9000
          IMPORTING
            ev_screen        = go_screen_9000.
*   Register the event handlers.
        SET HANDLER on_process_after_input FOR go_screen_9000.
      WHEN &apos;V&apos;.
        CALL METHOD cl_bus_abstract_screen=&gt;get_screen
          EXPORTING
            iv_program_name  = gc_program_name
            iv_dynpro_number = gc_dynnr_9010
          IMPORTING
            ev_screen        = go_screen_9010.
*   Register the event handlers.
        SET HANDLER on_process_after_input FOR go_screen_9010.

    ENDCASE.



  ENDMETHOD.                    &quot;lcl_application


  METHOD start.

    CASE gv_mode.
      WHEN &apos;H&apos;.
        go_screen_9000-&gt;set_title( gv_title ).
        IF gv_popup = abap_true.
          CALL METHOD go_screen_9000-&gt;show_as_popup(
              iv_xstart = gv_start_row
              iv_ystart = gv_start_column
              iv_width  = gv_end_column
              iv_height = gv_end_row ).
        ELSE.&quot;// 非弹出
          CALL METHOD go_screen_9000-&gt;show( ).
        ENDIF.
      WHEN &apos;V&apos;.
        go_screen_9010-&gt;set_title( gv_title ).
        IF gv_popup = abap_true.
          CALL METHOD go_screen_9010-&gt;show_as_popup(
              iv_xstart = gv_start_row
              iv_ystart = gv_start_column
              iv_width  = gv_end_column
              iv_height = gv_end_row ).
        ELSE.&quot;// 非弹出
          CALL METHOD go_screen_9010-&gt;show( ).
        ENDIF.
    ENDCASE.

  ENDMETHOD.                    &quot;lcl_application


  METHOD end.
  ENDMETHOD.                    &quot;lcl_application



  METHOD dispatch.

    DATA lv_return_code TYPE i.
    DATA lv_dispatched  TYPE bus_locator-boolean.
    DATA lv_seq TYPE i.

    CALL METHOD cl_gui_cfw=&gt;dispatch
      IMPORTING
        return_code = lv_return_code.
    IF lv_return_code NE cl_gui_cfw=&gt;rc_noevent.
      ev_dispatched = abap_true.
      EXIT.
    ENDIF.



    CASE iv_function_code.
      WHEN cl_bus_abstract_main_screen=&gt;gc_function_code_back
        OR cl_bus_abstract_main_screen=&gt;gc_function_code_cancel
        OR cl_bus_abstract_main_screen=&gt;gc_function_code_exit
        OR &apos;BACK&apos; OR &apos;CANC&apos; OR &apos;EXIT&apos; OR &apos;CANCEL&apos;.
        IF go_screen_9000 IS BOUND.
          go_screen_9000-&gt;go_container-&gt;free( ).
          go_screen_9000-&gt;free( ).
        ENDIF.

        IF go_screen_9010 IS BOUND.
          go_screen_9010-&gt;go_splitter-&gt;free( ).
          go_screen_9010-&gt;go_container-&gt;free( ).
          go_screen_9010-&gt;free( ).
        ENDIF.

        cl_bus_abstract_main_screen=&gt;gv_current_main_screen-&gt;leave( ).
      WHEN OTHERS.
        &quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;
        IF iv_function_code(12) = &apos;SCREEN_9000_&apos;.
          go_current_falv-&gt;o_grid-&gt;set_visible( abap_false ).
          lv_seq = iv_function_code+16(2).
          READ TABLE go_alv-&gt;mt_alvs ASSIGNING FIELD-SYMBOL(&lt;fs_alv&gt;) INDEX lv_seq.
          IF sy-subrc = 0.
            go_current_falv = &lt;fs_alv&gt;-falv.
            CHECK go_current_falv IS NOT INITIAL.
            go_current_falv-&gt;o_grid-&gt;set_visible( abap_true ).
            IF &lt;fs_alv&gt;-is_showed = abap_false.
*              go_current_falv-&gt;display( ).
              FIELD-SYMBOLS: &lt;outtab&gt; TYPE STANDARD TABLE.
              ASSIGN &lt;fs_alv&gt;-table-&gt;* TO &lt;outtab&gt;.
              go_current_falv-&gt;show( CHANGING tabla = &lt;outtab&gt; ).
              &lt;fs_alv&gt;-is_showed = abap_true.
            ELSE.
              go_current_falv-&gt;refrescar_grid( ).
            ENDIF.
          ENDIF.
          go_screen_9000-&gt;mr_tabstrip-&gt;dispatch( EXPORTING iv_function_code = iv_function_code
                                                 IMPORTING ev_dispatched    = lv_dispatched ).
          go_screen_9000-&gt;pbo_begin( ).
        ELSE.
          IF NOT go_alv-&gt;o_prog IS INITIAL.
            READ TABLE go_alv-&gt;mt_alvs ASSIGNING &lt;fs_alv&gt; INDEX 1.
            ASSIGN &lt;fs_alv&gt;-table-&gt;* TO &lt;outtab&gt;.
            go_alv-&gt;o_prog-&gt;command_dynpro_m( ucomm = CONV #( iv_function_code ) o_grid = go_current_falv datos = &lt;outtab&gt; ).
          ENDIF.
        ENDIF.
    ENDCASE.

  ENDMETHOD.                    &quot;lcl_application

  METHOD on_process_after_input.

    DATA lv_dispatched TYPE bu_boolean.


    CALL METHOD clear_message.

    CALL METHOD dispatch
      EXPORTING
        iv_function_code = iv_function_code
      IMPORTING
        ev_dispatched    = lv_dispatched.

    IF lv_dispatched IS INITIAL.
    ENDIF.


    CALL METHOD show_message.
  ENDMETHOD.                    &quot;lcl_application

ENDCLASS.                    &quot;lcl_application IMPLEMENTATION



CLASS lcl_screen_9000 IMPLEMENTATION.
  METHOD call_screen.
    CALL SCREEN iv_dynpro_number.
  ENDMETHOD.
  METHOD call_screen_starting_at.
    CALL SCREEN iv_dynpro_number STARTING AT iv_xstart iv_ystart
      ENDING AT iv_xend iv_yend.
  ENDMETHOD.

  METHOD pbo_begin.
    DATA lr_tab TYPE REF TO cl_bus_tabstrip_tab.
    DATA ls_area TYPE bus_screen_area.
    DATA lv_counter TYPE i.
    FIELD-SYMBOLS: &lt;outtab&gt; TYPE STANDARD TABLE.

    FIELD-SYMBOLS:&lt;fs_table&gt; TYPE ANY TABLE.
    IF mr_tabstrip IS NOT BOUND.
      me-&gt;add_tabstrip(
        EXPORTING
          iv_field_name_prefix    = &apos;GS_SCREEN_9000-TABSTRIP&apos;
          iv_function_code_prefix = &apos;SCREEN_9000&apos;
        IMPORTING
          ev_tabstrip             = mr_tabstrip
        CHANGING
          cs_tabstrip_control     = gs_screen_9000_tabstrip
          cs_tabstrip_fields      = gs_screen_9000-tabstrip ).

      ls_area-program_name = gc_program_name.
      ls_area-dynpro_number = gc_dynnr_9001.
      IF go_container IS NOT BOUND.
        CREATE OBJECT go_container
          EXPORTING
            container_name = CONV char100( gc_cont_name_9001 ).
      ENDIF.

      IF NOT  go_alv-&gt;mt_buttons IS INITIAL.
        set_status( iv_status_key     = &apos;ST_DYN&apos;
                    iv_status_program = &apos;SAPLZAP_ALV_MULTI&apos; ).

        LOOP AT go_alv-&gt;mt_buttons ASSIGNING FIELD-SYMBOL(&lt;but&gt;).
          PERFORM add_button USING &lt;but&gt;-obj_code &lt;but&gt;-text &lt;but&gt;-icon_id &lt;but&gt;-quickinfo.
        ENDLOOP.
      ENDIF.

      LOOP AT go_alv-&gt;mt_alvs ASSIGNING FIELD-SYMBOL(&lt;fs_alv&gt;).
        lv_counter = lv_counter +  1.
        &lt;fs_alv&gt;-index = lv_counter.
        mr_tabstrip-&gt;add_tab( IMPORTING ev_tab = lr_tab ).
        lr_tab-&gt;set_area( ls_area ).

        lr_tab-&gt;set_caption( iv_caption = |{ COND string( WHEN &lt;fs_alv&gt;-title IS NOT INITIAL
                                                          THEN &lt;fs_alv&gt;-title
                                                          ELSE |Tab { lv_counter }|  ) }| ).

        ASSIGN &lt;fs_alv&gt;-table-&gt;* TO &lt;fs_table&gt;.
        &lt;fs_alv&gt;-falv = NEW zcl_ap_alv_grid( o_container = go_container nombre_tabla = &apos;&apos; o_event = &lt;fs_alv&gt;-o_event ).
        LOOP AT &lt;fs_alv&gt;-it_hide INTO DATA(ls_hide).
          &lt;fs_alv&gt;-falv-&gt;set_field_quitar( campo = ls_hide-fieldname ).
        ENDLOOP.
        LOOP AT &lt;fs_alv&gt;-it_text INTO DATA(ls_text).
          &lt;fs_alv&gt;-falv-&gt;set_field_text( campo = ls_hide-fieldname valor = ls_text-text ).
        ENDLOOP.
        IF NOT go_alv-&gt;o_prog IS INITIAL.
          ASSIGN &lt;fs_alv&gt;-table-&gt;* TO &lt;outtab&gt;.
          go_alv-&gt;o_prog-&gt;status_dynpro_m( title = CONV #( &lt;fs_alv&gt;-title ) o_grid = &lt;fs_alv&gt;-falv datos = &lt;outtab&gt; ).
        ENDIF.
        go_alv-&gt;on_before_show_alv( &lt;fs_alv&gt; ).
        IF lv_counter = 1.
          go_current_falv = &lt;fs_alv&gt;-falv.
          &lt;fs_alv&gt;-is_showed = abap_true.

          ASSIGN &lt;fs_alv&gt;-table-&gt;* TO &lt;outtab&gt;.
          &lt;fs_alv&gt;-falv-&gt;show( CHANGING tabla = &lt;outtab&gt; ).
          mr_tabstrip-&gt;set_active_tab( lr_tab ).
        ENDIF.
      ENDLOOP.

    ENDIF. &quot;
    super-&gt;pbo_begin( ).
  ENDMETHOD.

  METHOD remove_tabstrip_tabs.
    IF me-&gt;mr_tabstrip IS BOUND.
      me-&gt;mr_tabstrip-&gt;remove_all_tabs( ).
      TRY.
          me-&gt;go_container-&gt;free( ).
          FREE me-&gt;go_container.
        CATCH cx_root INTO DATA(lo_error).
      ENDTRY.
    ENDIF.
  ENDMETHOD.

ENDCLASS.


CLASS lcl_screen_9010 IMPLEMENTATION.

  METHOD call_screen.
    CALL SCREEN iv_dynpro_number.
  ENDMETHOD.
  METHOD call_screen_starting_at.
    CALL SCREEN iv_dynpro_number STARTING AT iv_xstart iv_ystart
      ENDING AT iv_xend iv_yend.
  ENDMETHOD.

  METHOD pbo_begin.
    DATA lv_counter TYPE i.
    DATA: lv_height     TYPE i,
          lv_height_sum TYPE i.
    FIELD-SYMBOLS: &lt;outtab&gt; TYPE STANDARD TABLE.
    FIELD-SYMBOLS:&lt;fs_table&gt; TYPE ANY TABLE.
    IF go_container IS NOT BOUND.
      CREATE OBJECT go_container
        EXPORTING
          container_name = CONV char100( gc_cont_name_9010 ).
    ENDIF.

    IF go_splitter IS NOT BOUND.
      CREATE OBJECT go_splitter
        EXPORTING
          parent  = go_container
          rows    = lines( go_alv-&gt;mt_alvs )
          columns = 1.
      lv_height = 100 / lines( go_alv-&gt;mt_alvs ).
    ENDIF.

    IF NOT  go_alv-&gt;mt_buttons IS INITIAL.
      set_status( iv_status_key     = &apos;ST_DYN&apos;
                  iv_status_program = &apos;SAPLZAP_ALV_MULTI&apos; ).

      LOOP AT go_alv-&gt;mt_buttons ASSIGNING FIELD-SYMBOL(&lt;but&gt;).
        PERFORM add_button USING &lt;but&gt;-obj_code &lt;but&gt;-text &lt;but&gt;-icon_id &lt;but&gt;-quickinfo.
      ENDLOOP.
    ENDIF.


    LOOP AT go_alv-&gt;mt_alvs ASSIGNING FIELD-SYMBOL(&lt;fs_alv&gt;).
      AT LAST.
        lv_height = 100 - lv_height_sum.
      ENDAT.
      lv_counter = lv_counter + 1.
      &lt;fs_alv&gt;-index = lv_counter.
      lv_height_sum = lv_height + lv_height_sum.
      go_splitter-&gt;set_row_height( id = lv_counter height = lv_height ).

      ASSIGN &lt;fs_alv&gt;-table-&gt;* TO &lt;fs_table&gt;.
      &lt;fs_alv&gt;-falv = NEW zcl_ap_alv_grid( o_container = go_splitter-&gt;get_container( row = lv_counter column = 1 ) nombre_tabla = &apos;&apos; o_event = &lt;fs_alv&gt;-o_event  ).
      IF NOT go_alv-&gt;o_prog IS INITIAL.
        ASSIGN &lt;fs_alv&gt;-table-&gt;* TO &lt;outtab&gt;.
        go_alv-&gt;o_prog-&gt;status_dynpro_m( title = CONV #( &lt;fs_alv&gt;-title ) o_grid = &lt;fs_alv&gt;-falv datos = &lt;outtab&gt; ).
      ENDIF.
      LOOP AT &lt;fs_alv&gt;-it_hide INTO DATA(ls_hide).
        &lt;fs_alv&gt;-falv-&gt;set_field_quitar( campo = ls_hide-fieldname ).
      ENDLOOP.
      LOOP AT &lt;fs_alv&gt;-it_text INTO DATA(ls_text).
        &lt;fs_alv&gt;-falv-&gt;set_field_text( campo = ls_hide-fieldname valor = ls_text-text ).
      ENDLOOP.
      go_alv-&gt;on_before_show_alv( &lt;fs_alv&gt; ).

      ASSIGN &lt;fs_alv&gt;-table-&gt;* TO &lt;outtab&gt;.
      &lt;fs_alv&gt;-falv-&gt;show( CHANGING tabla = &lt;outtab&gt; ).
    ENDLOOP.

    super-&gt;pbo_begin( ).
  ENDMETHOD.
ENDCLASS.

FORM bus_screen_create USING iv_program_name TYPE bus_screen-program_name
                             iv_dynpro_number TYPE bus_screen-dynpro_number
                       CHANGING ev_screen TYPE any.         &quot;#EC CALLED
  CASE iv_dynpro_number.
    WHEN gc_dynnr_9000.
      CREATE OBJECT ev_screen TYPE lcl_screen_9000
        EXPORTING
          iv_program_name  = iv_program_name
          iv_dynpro_number = iv_dynpro_number.
    WHEN gc_dynnr_9010.
      CREATE OBJECT ev_screen TYPE lcl_screen_9010
        EXPORTING
          iv_program_name  = iv_program_name
          iv_dynpro_number = iv_dynpro_number.
  ENDCASE.
ENDFORM.</source>
</PROG>
