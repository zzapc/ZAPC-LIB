<?xml version="1.0" encoding="utf-8"?>
<PROG NAME="ZTRANSPORTAR_ORDENES" VARCL="X" SUBC="1" RMAND="100" RLOAD="S" FIXPT="X" UCCHECK="X">
 <textPool>
  <language SPRAS="S">
   <textElement ID="R" ENTRY="Transportar ordenes" LENGTH="19 "/>
   <textElement ID="S" KEY="PA_DIR_L" ENTRY="        Directorio PC Local" LENGTH="27 "/>
   <textElement ID="S" KEY="PA_DOWN" ENTRY="        Descargar" LENGTH="17 "/>
   <textElement ID="S" KEY="PA_ORDEN" ENTRY="        NÂº de orden" LENGTH="19 "/>
   <textElement ID="S" KEY="PA_UP" ENTRY="        Subir" LENGTH="13 "/>
  </language>
 </textPool>
 <source>*&amp;---------------------------------------------------------------------*
*&amp; Report  ZTRANSPORTAR_ORDENES
*&amp;
*&amp;---------------------------------------------------------------------*
*&amp;
*&amp;
*&amp;---------------------------------------------------------------------*


REPORT  ZTRANSPORTAR_ORDENES                    .
* Selection screen *

* Orden
PARAMETERS pa_orden(20).

* Directorio local
PARAMETERS pa_dir_l LIKE draw-filep  OBLIGATORY DEFAULT &apos;c:\temp\&apos;.

SELECTION-SCREEN SKIP.

PARAMETERS pa_down RADIOBUTTON GROUP rb1 DEFAULT &apos;X&apos;.
PARAMETERS pa_up   RADIOBUTTON GROUP rb1.

* Global data *
TYPE-POOLS sabc.

DATA pos  TYPE i.
DATA temp TYPE c.

data p_trkorr LIKE e070-trkorr.
DATA p_lpath        LIKE draw-filep.
DATA path        LIKE draw-filep.
DATA path_cofile LIKE draw-filep.
DATA path_data   LIKE draw-filep.
DATA path_bin    LIKE draw-filep.

DATA fk LIKE draw-filep.
DATA fr LIKE draw-filep.
DATA fd LIKE draw-filep.

DATA separator TYPE c.

* Complete local path *
AT SELECTION-SCREEN.
  p_lpath = pa_dir_l.
  pos  = strlen( p_lpath ) - 1.
  temp =  p_lpath+pos(1).
  CHECK NOT temp = &apos;\&apos;.
  CONCATENATE p_lpath &apos;\&apos; INTO p_lpath.

START-OF-SELECTION.

* Determine transport base directory *
  CALL &apos;C_SAPGPARAM&apos; ID &apos;NAME&apos;  FIELD &apos;DIR_TRANS&apos;
                     ID &apos;VALUE&apos; FIELD  path .

* Determine file/path separator *
  IF sy-opsys = &apos;Windows NT&apos;.
    separator = &apos;\&apos;.
  ELSE.
    separator = &apos;/&apos;.
  ENDIF.

* Determine transport directories *
  CONCATENATE path separator &apos;cofiles&apos; separator INTO path_cofile.
  CONCATENATE path separator &apos;data&apos;    separator INTO path_data.
  CONCATENATE path separator &apos;data&apos;    separator INTO path_bin.
  WRITE  / &apos;Paths:&apos;.
  WRITE: /  path_cofile,path_data,path_bin.
  SKIP.

* Build filenames *
  p_trkorr = pa_orden.
  CONCATENATE p_trkorr+3(7) p_trkorr+0(3) INTO fk SEPARATED BY &apos;.&apos;.
  CONCATENATE &apos;R&apos; p_trkorr+4(6) &apos;.&apos; p_trkorr+0(3) INTO fr.
  CONCATENATE &apos;D&apos; p_trkorr+4(6) &apos;.&apos; p_trkorr+0(3) INTO fd.

* Up - or download transport request *
  IF pa_down = &apos;X&apos;.
    PERFORM download USING path_cofile p_lpath fk.
    PERFORM download USING path_data   p_lpath fr.
    PERFORM download USING path_data   p_lpath fd.
  ELSE.
    PERFORM upload USING p_lpath path_cofile fk.
    PERFORM upload USING p_lpath path_data   fr.
    PERFORM upload USING p_lpath path_data   fd.
  ENDIF.

**----------------------------------------------------------------------
*
*
* Download files *
FORM download USING value(srcpath) LIKE draw-filep
                    value(dstpath) LIKE draw-filep
                    value(file)    LIKE draw-filep.
  DATA BEGIN OF buffer OCCURS 0.
  DATA   data(1024) TYPE x.
  DATA END OF buffer.

  DATA filename TYPE rlgrap-filename.
  DATA reclen   TYPE i.
  DATA filelen  TYPE i.

* Read input file *
  CONCATENATE srcpath file INTO filename.
  OPEN DATASET filename FOR INPUT IN BINARY MODE.
  CHECK sy-subrc = 0.
  WHILE sy-subrc = 0.
    READ DATASET filename INTO buffer LENGTH reclen.
    filelen = filelen + reclen.
    APPEND buffer.
  ENDWHILE.
  CLOSE DATASET filename.

* Download file *
  CONCATENATE dstpath file INTO filename.
  CALL FUNCTION &apos;WS_DOWNLOAD&apos;
       EXPORTING
            bin_filesize = filelen
            filename     = filename
            filetype     = &apos;BIN&apos;
       TABLES
            data_tab     = buffer
       EXCEPTIONS
            OTHERS       = 1.
  CHECK sy-subrc = 0.
  WRITE: / &apos;Download: &apos;,(150) file.
ENDFORM.

* Upload file *
FORM upload USING value(srcpath) LIKE draw-filep
                  value(dstpath) LIKE draw-filep
                  value(file)    LIKE draw-filep.
  DATA BEGIN OF buffer OCCURS 0.
  DATA   data(1024) TYPE x.
  DATA END OF buffer.

  DATA filename TYPE rlgrap-filename.
  DATA reclen   TYPE i.
  DATA filelen  TYPE i.
  DATA result   TYPE c.

* Check if file exists *
  CONCATENATE srcpath file INTO filename.
  CALL FUNCTION &apos;WS_QUERY&apos;
       EXPORTING
            filename = filename
            query    = &apos;FE&apos;
       IMPORTING
            return   = result
       EXCEPTIONS
            OTHERS   = 1.
  CHECK sy-subrc = 0 AND result = &apos;1&apos;.

* Upload file *
  CALL FUNCTION &apos;WS_UPLOAD&apos;
       EXPORTING
            filename   = filename
            filetype   = &apos;BIN&apos;
       IMPORTING
            filelength = filelen
       TABLES
            data_tab   = buffer
       EXCEPTIONS
            OTHERS     = 1.

* Write file to server *
  CONCATENATE dstpath file INTO filename.
  OPEN DATASET filename FOR OUTPUT IN BINARY MODE.
  CHECK sy-subrc = 0.
  LOOP AT buffer.
    DESCRIBE FIELD buffer-data LENGTH reclen IN BYTE MODE.
    IF filelen &gt; reclen.
      filelen = filelen - reclen.
    ELSE.
      reclen = filelen.
    ENDIF.
    TRANSFER buffer TO filename LENGTH reclen.
  ENDLOOP.
  CLOSE DATASET filename.
  WRITE: / &apos;Upload: &apos;,file(150).
ENDFORM.</source>
</PROG>
