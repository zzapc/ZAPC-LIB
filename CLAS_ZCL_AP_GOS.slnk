<?xml version="1.0" encoding="utf-8"?>
<CLAS CLSNAME="ZCL_AP_GOS" VERSION="1" LANGU="S" DESCRIPT="Tratamiento adjuntos GOS" CATEGORY="00" EXPOSURE="2" STATE="1" RELEASE="0" CLSCCINCL="X" FIXPT="X" UNICODE="X" CLSBCCAT="00" DURATION_TYPE="0 " RISK_LEVEL="0 ">
 <types CLSNAME="ZCL_AP_GOS" CMPNAME="T_ADJ" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="1 " TYPTYPE="4" SRCROW1="7 " SRCCOLUMN1="6 " SRCROW2="10 " SRCCOLUMN2="17 " TYPESRC_LENG="98 " TYPESRC="BEGIN OF t_adj,
        fichero TYPE string,
        xstring TYPE xstring,
      END OF t_adj
"/>
 <types CLSNAME="ZCL_AP_GOS" CMPNAME="TT_ADJ" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="2 " TYPTYPE="4" SRCROW1="11 " SRCCOLUMN1="10 " SRCROW2="11 " SRCCOLUMN2="35 " TYPESRC_LENG="28 " TYPESRC="tt_adj TYPE TABLE OF t_adj
"/>
 <localImplementation>*&quot;* local class implementation for public class
*&quot;* use this source file for the implementation part of
*&quot;* local helper classes</localImplementation>
 <localTypes>*&quot;* use this source file for any type declarations (class
*&quot;* definitions, interfaces or data types) you need for method
*&quot;* implementation or private method&apos;s signature</localTypes>
 <localMacros>*&quot;* use this source file for any macro definitions you need
*&quot;* in the implementation part of the class</localMacros>
 <textPool>
  <language SPRAS="S">
   <textElement ID="I" KEY="AGB" ENTRY="llamando a función ARCHIVOBJECT_GET_BYTES" LENGTH="82 "/>
   <textElement ID="I" KEY="EAF" ENTRY="Error abriendo fichero" LENGTH="44 "/>
   <textElement ID="I" KEY="ECF" ENTRY="Error convirtiendo fecha" LENGTH="48 "/>
   <textElement ID="I" KEY="ERA" ENTRY="Error recuperando adjuntos" LENGTH="52 "/>
   <textElement ID="I" KEY="ERR" ENTRY="Error" LENGTH="15 "/>
   <textElement ID="I" KEY="FRA" ENTRY="The file you requested file is attached." LENGTH="80 "/>
   <textElement ID="I" KEY="LFU" ENTRY="llamando a función SCMS_BINARY_TO_XSTRING" LENGTH="82 "/>
   <textElement ID="I" KEY="MNO" ENTRY="modificando nota" LENGTH="26 "/>
   <textElement ID="I" KEY="RFA" ENTRY="Requested File is Attached" LENGTH="52 "/>
  </language>
 </textPool>
 <typeUsage CLSNAME="ZCL_AP_GOS" TYPEGROUP="ABAP" VERSION="1" TPUTYPE="0" IMPLICIT="X"/>
 <forwardDeclaration>ABAP</forwardDeclaration>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_NOTA" VERSION="1" LANGU="S" DESCRIPT="Actualizar nota" EXPOSURE="2" STATE="1" EDITORDER="31 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_NOTA" SCONAME="CLAVE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_NOTA" SCONAME="CONTENIDO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_NOTA" SCONAME="CONTENIDO_XSTRING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="XSTRING" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_NOTA" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Local Persistent Object Reference - BOR Compatible" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_NOTA" SCONAME="DESCRIPCION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_NOTA" SCONAME="MESSAGE" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD actualizar_nota.
    DATA(l_sood) = get_nota( clave       = clave
                             tipo        = tipo
                             descripcion = descripcion ).

    IF l_sood IS INITIAL.
      DATA(i_return) = crear_nota( clave             = clave
                                   tipo              = tipo
                                   descripcion       = descripcion
                                   contenido         = contenido
                                   contenido_xstring = contenido_xstring ).
      ASSIGN i_return[ type = &apos;E&apos; ] TO FIELD-SYMBOL(&lt;return&gt;).
      IF sy-subrc = 0.
        message = &lt;return&gt;-message.
      ENDIF.
    ELSE.
      IF contenido IS INITIAL.
        borrar_nota( EXPORTING clave       = clave
                               tipo        = tipo
                               descripcion = descripcion
                     IMPORTING i_return    = i_return ).
        ASSIGN i_return[ type = &apos;E&apos; ] TO &lt;return&gt;.
        IF sy-subrc = 0.
          message = &lt;return&gt;-message.
        ENDIF.
      ELSE.
        message = modificar_nota( sood      = l_sood
                                  contenido = contenido ).
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_URL" VERSION="1" LANGU="S" DESCRIPT="Actualizar URL" EXPOSURE="2" STATE="1" EDITORDER="30 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_URL" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_URL" SCONAME="CLAVE" VERSION="1" LANGU="S" DESCRIPT="Identif.instancia compat.en BOR. Refer.objeto persistente" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_URL" SCONAME="URL_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_URL" SCONAME="URL_OLD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_URL" SCONAME="OK" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="0" TYPTYPE="1" TYPE="ABAP_BOOL"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ACTUALIZAR_URL" SCONAME="MESSAGE" VERSION="1" LANGU="S" DESCRIPT="Texto de mensaje" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD actualizar_url.
    DATA: ls_object   TYPE gos_s_obj,
          ls_atta_key TYPE gos_s_attkey.

    CLEAR: ok,
           message.

    IF url_new IS INITIAL.
      message = &apos;No informado URL destino&apos;(nud).
      RETURN.
    ENDIF.

    ls_object-typeid = tipo.
    ls_object-instid = clave.
    ls_object-catid  = &apos;BO&apos;.

    TRY.
        DATA(lo_ins) = cl_gos_api=&gt;create_instance( ls_object ).
      CATCH cx_gos_api INTO DATA(cx_gos_api).
        message = cx_gos_api-&gt;get_text( ).
    ENDTRY.

    SELECT instid_b FROM srgbtbrel
      INTO TABLE @DATA(i_srgbtbrel)
      WHERE reltype  = &apos;URL&apos;
        AND instid_a = @clave
        AND typeid_a = @tipo
        AND typeid_b = &apos;MESSAGE&apos;.

    LOOP AT i_srgbtbrel ASSIGNING FIELD-SYMBOL(&lt;srgbtbrel&gt;).
      ls_atta_key-atta_id  = &lt;srgbtbrel&gt;-instid_b.
      ls_atta_key-atta_cat = &apos;MSG&apos;.
      TRY.
          DATA(ls_att_cont) = lo_ins-&gt;get_al_item( ls_atta_key ).
        CATCH cx_root INTO DATA(o_root).

      ENDTRY.
      IF ls_att_cont-content &lt;&gt; url_old.
        CONTINUE.
      ENDIF.

      ls_att_cont-content = url_new.

      TRY.
          CLEAR sy-msgno.
          lo_ins-&gt;update_al_item( is_attcont = ls_att_cont ).

          ls_att_cont = lo_ins-&gt;get_al_item( ls_atta_key ).
          IF ls_att_cont-content = url_new.
            ok = &apos;X&apos;.
          ELSE.
            message = &apos;No se actualizado la URL&apos;(nud).
          ENDIF.
        CATCH cx_root INTO o_root.
          MESSAGE ID sy-msgid TYPE &apos;S&apos; NUMBER sy-msgno WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO DATA(l_msg).
          message = o_root-&gt;get_longtext( ).
          IF message IS INITIAL.
            message = o_root-&gt;get_text( ).
          ENDIF.

          CONCATENATE message l_msg INTO message.

      ENDTRY.
    ENDLOOP.
    IF sy-subrc &lt;&gt; 0.
      message = &apos;No hay ningún enlace GOS a esa clave&apos;(neg).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_SOLITAB" VERSION="1" LANGU="S" DESCRIPT="attach files when using ITS Applications" EXPOSURE="2" STATE="1" EDITORDER="14 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_SOLITAB" SCONAME="IV_NAME" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_SOLITAB" SCONAME="IV_CONTENT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_SOLITAB" SCONAME="IV_CONTENT_SOLITAB" VERSION="1" LANGU="S" DESCRIPT="Objcont and Objhead as Table Type" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SOLI_TAB" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_SOLITAB" SCONAME="IS_LPORB" VERSION="1" LANGU="S" DESCRIPT="Local Persistent Object Reference - BOR Compatible" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SIBFLPORB"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_SOLITAB" SCONAME="IV_OBJTP" VERSION="1" LANGU="S" DESCRIPT="Code for document class" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_TP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_SOLITAB" SCONAME="IV_FILELENGTH" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="I"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_SOLITAB" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <source>METHOD attach_file_solitab.
    DATA ls_header     TYPE solisti1.
    DATA lt_obj_header TYPE STANDARD TABLE OF solisti1.
    DATA l_obj_rolea   TYPE borident.
    DATA l_obj_roleb   TYPE borident.
    DATA: lt_ls_doc_change   TYPE STANDARD TABLE OF sodocchgi1,
          l_folder_id        TYPE sofdk,
          size               TYPE i,
          objname            TYPE string,
          filename           TYPE string,
          file_ext           TYPE string,
          ls_doc_change      LIKE LINE OF lt_ls_doc_change,
          l_retype           TYPE breltyp-reltype,
          l_obj_type         TYPE so_obj_tp,
          l_object_hd_change TYPE sood1,
          lt_data            TYPE soli_tab,
          offset             TYPE i,
          offset_old         TYPE i,
          temp_len           TYPE i,
          ls_data            TYPE soli,
          l_document_title   TYPE so_text255,
          lt_urltab          TYPE STANDARD TABLE OF sood-objdes,
          l_tab_size         TYPE int4,
          ls_object_id       TYPE soodk,
          ls_message         TYPE bapiret2,
          l_object_id_fol    TYPE so_obj_id,
          l_object_id        TYPE so_obj_id.

    CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
      EXPORTING region    = &apos;B&apos;
      IMPORTING folder_id = l_folder_id.
    IF iv_objtp = &apos;EXT&apos;.
      size = iv_filelength.

      objname  = zcl_ap_ficheros=&gt;get_nombre_fichero( filename ).
      file_ext = zcl_ap_ficheros=&gt;get_extension( filename ).

      ls_doc_change-obj_name   = objname.
      ls_doc_change-obj_descr  = objname.
      ls_doc_change-obj_langu  = sy-langu.
      ls_doc_change-sensitivty = &apos;F&apos;.
      ls_doc_change-doc_size   = size.
      l_retype = &apos;ATTA&apos;.
      l_obj_type = &apos;EXT&apos;.
      l_object_hd_change-objnam   = ls_doc_change-obj_name.
      l_object_hd_change-objdes   = ls_doc_change-obj_descr.
      l_object_hd_change-objsns   = ls_doc_change-sensitivty.
      l_object_hd_change-objla    = ls_doc_change-obj_langu.
      l_object_hd_change-objlen   = ls_doc_change-doc_size.
      l_object_hd_change-file_ext = file_ext.
      CONCATENATE &apos;&amp;SO_FILENAME=&apos; filename INTO ls_header.
      APPEND ls_header TO lt_obj_header.
      CLEAR ls_header.
      ls_header = &apos;&amp;SO_FORMAT=BIN&apos;.
      APPEND ls_header TO lt_obj_header.
      lt_data[] = iv_content_solitab[].
    ELSE.
      size = strlen( iv_content ).
      objname = iv_name.
      ls_doc_change-obj_descr  = objname.
      ls_doc_change-sensitivty = &apos;O&apos;.
      ls_doc_change-obj_langu  = sy-langu.
      offset = 0.
      IF iv_objtp = &apos;RAW&apos;.
        l_retype = &apos;NOTE&apos;.
        l_obj_type = &apos;RAW&apos;.
        l_object_hd_change-file_ext = &apos;TXT&apos;.
        WHILE offset &lt;= size.
          offset_old = offset.
          offset = offset + 255 ##NUMBER_OK.
          IF offset &gt; size.
            temp_len = strlen( iv_content+offset_old ).
            CLEAR ls_data-line.
            ls_data-line = iv_content+offset_old(temp_len).
          ELSE.
            ls_data-line = iv_content+offset_old(255).
          ENDIF.
          APPEND ls_data TO lt_data.
        ENDWHILE.
        IF objname IS INITIAL.
          READ TABLE lt_data INDEX 1 INTO l_document_title.
          WHILE l_document_title+49 &lt;&gt; &apos; &apos;.
            SHIFT l_document_title RIGHT.
          ENDWHILE.
          SHIFT l_document_title LEFT DELETING LEADING &apos; &apos;.
          ls_doc_change-obj_descr = l_document_title.
        ENDIF.
      ELSE.
*     it&apos;s url (not note)
        l_retype = &apos;URL&apos;.
        l_obj_type = &apos;URL&apos;.
        IF objname IS INITIAL.
          SPLIT iv_content AT &apos;/&apos; INTO TABLE lt_urltab.
          l_tab_size = lines( lt_urltab ).
          READ TABLE lt_urltab INDEX l_tab_size INTO ls_doc_change-obj_descr.
        ENDIF.
        WHILE offset &lt;= size.
          offset_old = offset.
          offset = offset + 250 ##NUMBER_OK.
          IF offset &gt; size.
            temp_len = strlen( iv_content+offset_old ).
            CLEAR ls_data-line.
            ls_data-line = iv_content+offset_old(temp_len).
          ELSE.
            ls_data-line = iv_content+offset_old(250).
          ENDIF.
          CONCATENATE &apos;&amp;KEY&amp;&apos; ls_data-line INTO ls_data-line.
          APPEND ls_data TO lt_data.
        ENDWHILE.
      ENDIF.
      ls_doc_change-doc_size = size.
      l_object_hd_change-objdes = ls_doc_change-obj_descr.
      l_object_hd_change-objsns = ls_doc_change-sensitivty.
      l_object_hd_change-objla  = ls_doc_change-obj_langu.
      l_object_hd_change-objlen = ls_doc_change-doc_size.
    ENDIF.
* save object
    CALL FUNCTION &apos;SO_OBJECT_INSERT&apos;
      EXPORTING  folder_id                  = l_folder_id
                 object_hd_change           = l_object_hd_change
                 object_type                = l_obj_type
      IMPORTING  object_id                  = ls_object_id
      TABLES     objcont                    = lt_data
                 objhead                    = lt_obj_header
      EXCEPTIONS component_not_available    = 01 ##NUMBER_OK
                 folder_not_exist           = 06 ##NUMBER_OK
                 folder_no_authorization    = 05 ##NUMBER_OK
                 object_type_not_exist      = 17 ##NUMBER_OK
                 operation_no_authorization = 21 ##NUMBER_OK
                 parameter_error            = 23 ##NUMBER_OK
                 OTHERS                     = 1000 ##NUMBER_OK.
    IF sy-subrc &lt;&gt; 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
      ls_message-type       = sy-msgty.
      ls_message-id         = sy-msgid.
      ls_message-number     = sy-msgno.
      ls_message-message_v1 = sy-msgv1.
      ls_message-message_v2 = sy-msgv2.
      ls_message-message_v3 = sy-msgv3.
      ls_message-message_v4 = sy-msgv4.
      APPEND ls_message TO i_return.
      RETURN.
    ENDIF.
* create relation
    l_obj_rolea-objkey  = is_lporb-instid.
    l_obj_rolea-objtype = is_lporb-typeid.
    l_obj_rolea-logsys  = is_lporb-catid.
    l_object_id_fol = l_folder_id.
    l_object_id = ls_object_id.
    CONCATENATE l_object_id_fol l_object_id INTO l_obj_roleb-objkey RESPECTING BLANKS.
    l_obj_roleb-objtype = &apos;MESSAGE&apos;.
    CLEAR l_obj_roleb-logsys.
    CALL FUNCTION &apos;BINARY_RELATION_CREATE&apos;
      EXPORTING  obj_rolea    = l_obj_rolea
                 obj_roleb    = l_obj_roleb
                 relationtype = l_retype
      EXCEPTIONS OTHERS       = 1.
    IF sy-subrc = 0.
      COMMIT WORK AND WAIT.
    ELSE.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
      ls_message-type       = sy-msgty.
      ls_message-id         = sy-msgid.
      ls_message-number     = sy-msgno.
      ls_message-message_v1 = sy-msgv1.
      ls_message-message_v2 = sy-msgv2.
      ls_message-message_v3 = sy-msgv3.
      ls_message-message_v4 = sy-msgv4.
      APPEND ls_message TO i_return.
      RETURN.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_XSTRING" VERSION="1" LANGU="S" DESCRIPT="attach files when using ABAP WebDynpro Applications" EXPOSURE="2" STATE="1" EDITORDER="13 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_XSTRING" SCONAME="IV_NAME" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_XSTRING" SCONAME="IV_CONTENT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_XSTRING" SCONAME="IV_CONTENT_HEX" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="XSTRING" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_XSTRING" SCONAME="IS_LPORB" VERSION="1" LANGU="S" DESCRIPT="Local Persistent Object Reference - BOR Compatible" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SIBFLPORB"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_XSTRING" SCONAME="IV_OBJTP" VERSION="1" LANGU="S" DESCRIPT="Code for document class" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_TP" PARVALUE="&apos;EXT&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_XSTRING" SCONAME="DESCRIPCION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTACH_FILE_XSTRING" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <source>METHOD attach_file_xstring.
    DATA ls_header     TYPE solisti1.
    DATA lt_obj_header TYPE STANDARD TABLE OF solisti1.
    DATA l_obj_rolea   TYPE borident.
    DATA l_obj_roleb   TYPE borident.
    DATA: lt_ls_doc_change   TYPE STANDARD TABLE OF sodocchgi1,
          l_folder_id        TYPE sofdk,
          size               TYPE i,
          filename           TYPE string,
          objname            TYPE string,
          file_ext           TYPE string,
          ls_doc_change      LIKE LINE OF lt_ls_doc_change,
          offset             TYPE i,
          offset_old         TYPE i,
          temp_len           TYPE i,
          ls_xdata           TYPE solix,
          hex_null           TYPE x LENGTH 1 VALUE &apos;20&apos;,
          lt_xdata           TYPE solix_tab,
          l_retype           TYPE breltyp-reltype,
          l_obj_type         TYPE so_obj_tp,
          l_object_hd_change TYPE sood1,
          lt_data            TYPE soli_tab,
          ls_data            TYPE soli,
          l_document_title   TYPE so_text255,
          lt_urltab          TYPE STANDARD TABLE OF sood-objdes,
          l_tab_size         TYPE int4,
          ls_object_id       TYPE soodk,
          ls_message         TYPE bapiret2,
          l_object_id_fol    TYPE so_obj_id,
          l_object_id        TYPE so_obj_id.

    CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
      EXPORTING region    = &apos;B&apos;
      IMPORTING folder_id = l_folder_id.
    IF iv_objtp = &apos;EXT&apos; OR iv_objtp = &apos;BIN&apos;.
      size     = xstrlen( iv_content_hex ).
      filename = zcl_ap_ficheros=&gt;get_nombre_fichero( iv_name ).

      objname  = zcl_ap_ficheros=&gt;get_nombre_fichero( filename ).
      file_ext = zcl_ap_ficheros=&gt;get_extension( iv_name ).

      ls_doc_change-obj_name = objname.
      IF descripcion IS INITIAL.
        ls_doc_change-obj_descr = objname.
      ELSE.
        ls_doc_change-obj_descr = descripcion.
      ENDIF.
      ls_doc_change-obj_langu  = sy-langu.
      ls_doc_change-sensitivty = &apos;F&apos;.
      ls_doc_change-doc_size   = size.
      offset                   = 0.
      WHILE offset &lt;= size.
        offset_old = offset.
        offset     = offset + 255 ##NUMBER_OK.
        IF offset &gt; size.
          temp_len = xstrlen( iv_content_hex+offset_old ).
          CLEAR ls_xdata-line WITH hex_null IN BYTE MODE.
          ls_xdata-line = iv_content_hex+offset_old(temp_len).
        ELSE.
          ls_xdata-line = iv_content_hex+offset_old(255).
        ENDIF.
        APPEND ls_xdata TO lt_xdata.
      ENDWHILE.
      l_retype                    = &apos;ATTA&apos;.
      l_obj_type                  = iv_objtp.
      l_object_hd_change-objnam   = ls_doc_change-obj_name.
      l_object_hd_change-objdes   = ls_doc_change-obj_descr.
      l_object_hd_change-objsns   = ls_doc_change-sensitivty.
      l_object_hd_change-objla    = ls_doc_change-obj_langu.
      l_object_hd_change-objlen   = ls_doc_change-doc_size.
      l_object_hd_change-file_ext = file_ext.
      l_object_hd_change-file_ext = to_lower( l_object_hd_change-file_ext ). &quot; APC?
*    l_object_hd_change-EXTCT    = &apos;K&apos;. &quot;APC?
      CONCATENATE &apos;&amp;SO_FILENAME=&apos; filename INTO ls_header.
      APPEND ls_header TO lt_obj_header.
      CLEAR ls_header.
      ls_header = &apos;&amp;SO_FORMAT=BIN&apos;.
      APPEND ls_header TO lt_obj_header.
*   change hex data to text data
      CALL FUNCTION &apos;SO_SOLIXTAB_TO_SOLITAB&apos;
        EXPORTING ip_solixtab = lt_xdata
        IMPORTING ep_solitab  = lt_data.
    ELSE.
      size    = strlen( iv_content ).
      objname = iv_name.
      IF descripcion IS INITIAL.
        ls_doc_change-obj_descr = objname.
      ELSE.
        ls_doc_change-obj_descr = descripcion.
      ENDIF.
      ls_doc_change-sensitivty = &apos;O&apos;.
      ls_doc_change-obj_langu  = sy-langu.
      offset                   = 0.
      IF iv_objtp = &apos;RAW&apos;.
        l_retype                    = &apos;NOTE&apos;.
        l_obj_type                  = &apos;RAW&apos;.
        l_object_hd_change-file_ext = &apos;TXT&apos;.
        WHILE offset &lt;= size.
          offset_old = offset.
          offset     = offset + 255 ##NUMBER_OK.
          IF offset &gt; size.
            temp_len = strlen( iv_content+offset_old ).
            CLEAR ls_data-line.
            ls_data-line = iv_content+offset_old(temp_len).
          ELSE.
            ls_data-line = iv_content+offset_old(255).
          ENDIF.
          APPEND ls_data TO lt_data.
        ENDWHILE.
        IF objname IS INITIAL.
          READ TABLE lt_data INDEX 1 INTO l_document_title.
          WHILE l_document_title+49 &lt;&gt; &apos; &apos;.
            SHIFT l_document_title RIGHT.
          ENDWHILE.
          SHIFT l_document_title LEFT DELETING LEADING &apos; &apos;.
          ls_doc_change-obj_descr = l_document_title.
        ENDIF.
      ELSE.
*     it&apos;s url (not note)
        l_retype   = &apos;URL&apos;.
        l_obj_type = &apos;URL&apos;.
        IF objname IS INITIAL.
          SPLIT iv_content AT &apos;/&apos; INTO TABLE lt_urltab.
          l_tab_size = lines( lt_urltab ).
          READ TABLE lt_urltab INDEX l_tab_size INTO ls_doc_change-obj_descr.
        ENDIF.
        WHILE offset &lt;= size.
          offset_old = offset.
          offset     = offset + 250 ##NUMBER_OK.
          IF offset &gt; size.
            temp_len = strlen( iv_content+offset_old ).
            CLEAR ls_data-line.
            ls_data-line = iv_content+offset_old(temp_len).
          ELSE.
            ls_data-line = iv_content+offset_old(250).
          ENDIF.
          CONCATENATE &apos;&amp;KEY&amp;&apos; ls_data-line INTO ls_data-line.
          APPEND ls_data TO lt_data.
        ENDWHILE.
      ENDIF.
      ls_doc_change-doc_size    = size.
      l_object_hd_change-objdes = ls_doc_change-obj_descr.
      l_object_hd_change-objsns = ls_doc_change-sensitivty.
      l_object_hd_change-objla  = ls_doc_change-obj_langu.
      l_object_hd_change-objlen = ls_doc_change-doc_size.
    ENDIF.
* save object
    CALL FUNCTION &apos;SO_OBJECT_INSERT&apos;
      EXPORTING  folder_id                  = l_folder_id
                 object_hd_change           = l_object_hd_change
                 object_type                = l_obj_type
      IMPORTING  object_id                  = ls_object_id
      TABLES     objcont                    = lt_data
                 objhead                    = lt_obj_header
      EXCEPTIONS component_not_available    = 01 ##NUMBER_OK
                 folder_not_exist           = 06 ##NUMBER_OK
                 folder_no_authorization    = 05 ##NUMBER_OK
                 object_type_not_exist      = 17 ##NUMBER_OK
                 operation_no_authorization = 21 ##NUMBER_OK
                 parameter_error            = 23 ##NUMBER_OK
                 OTHERS                     = 1000 ##NUMBER_OK.
    IF sy-subrc &lt;&gt; 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
      ls_message-type       = sy-msgty.
      ls_message-id         = sy-msgid.
      ls_message-number     = sy-msgno.
      ls_message-message_v1 = sy-msgv1.
      ls_message-message_v2 = sy-msgv2.
      ls_message-message_v3 = sy-msgv3.
      ls_message-message_v4 = sy-msgv4.
      APPEND ls_message TO i_return.
      RETURN.
    ENDIF.
* create relation
    l_obj_rolea-objkey  = is_lporb-instid.
    l_obj_rolea-objtype = is_lporb-typeid.
    l_obj_rolea-logsys  = is_lporb-catid.
    l_object_id_fol     = l_folder_id.
    l_object_id         = ls_object_id.
    CONCATENATE l_object_id_fol l_object_id INTO l_obj_roleb-objkey RESPECTING BLANKS.
    l_obj_roleb-objtype = &apos;MESSAGE&apos;.
    CLEAR l_obj_roleb-logsys.
    CALL FUNCTION &apos;BINARY_RELATION_CREATE&apos;
      EXPORTING  obj_rolea    = l_obj_rolea
                 obj_roleb    = l_obj_roleb
                 relationtype = l_retype
      EXCEPTIONS OTHERS       = 1.
    IF sy-subrc = 0.
      COMMIT WORK AND WAIT.
    ELSE.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
      ls_message-type       = sy-msgty.
      ls_message-id         = sy-msgid.
      ls_message-number     = sy-msgno.
      ls_message-message_v1 = sy-msgv1.
      ls_message-message_v2 = sy-msgv2.
      ls_message-message_v3 = sy-msgv3.
      ls_message-message_v4 = sy-msgv4.
      APPEND ls_message TO i_return.
      RETURN.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="ATTA_GOS_ST" VERSION="1" LANGU="S" DESCRIPT="Devuelve lista de URLs de GOS" EXPOSURE="2" STATE="1" EDITORDER="5 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTA_GOS_ST" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-TYPEID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTA_GOS_ST" SCONAME="CLAVE" VERSION="1" LANGU="S" DESCRIPT="Clave objeto" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-INSTID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="ATTA_GOS_ST" SCONAME="TABLA" VERSION="1" LANGU="S" DESCRIPT="URL GOS" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ZTAB_URL_GOS"/>
  <source>METHOD atta_gos_st.
    DATA: i_urls      TYPE TABLE OF srgbtbrel,
          l_srgbtbrel TYPE srgbtbrel,
          l_soodk     TYPE soodk,
          l_folder_id TYPE soodk,
          i_objcont   TYPE TABLE OF soli,
          l_sood2     TYPE sood2,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_objcont   TYPE soli,
          l_url       TYPE zest_url_gos.

    SELECT instid_b utctime FROM srgbtbrel
      INTO CORRESPONDING FIELDS OF TABLE i_urls
      WHERE reltype  = &apos;ATTA&apos;
        AND instid_a = clave
        AND typeid_a = tipo
        AND catid_a  = &apos;BO&apos;.

    LOOP AT i_urls INTO l_srgbtbrel.
      l_soodk = l_srgbtbrel-instid_b+17.
      l_folder_id = l_srgbtbrel-instid_b(17).
      REFRESH i_objcont.
      CALL FUNCTION &apos;SO_OBJECT_READ&apos;
        EXPORTING
*                   FILTER                     =
                   folder_id                  = l_folder_id
*                   FORWARDER                  =
                   object_id                  = l_soodk
*                   OWNER                      =
*                   F_MAILER                   = &apos; &apos;
        IMPORTING
*                   OBJECT_FL_DISPLAY          =
                   object_hd_display          = l_sood2
*                   OBJECT_RC_DISPLAY          =
        TABLES     objcont                    = i_objcont
*                   OBJHEAD                    =
*                   OBJPARA                    =
*                   OBJPARB                    =
        EXCEPTIONS active_user_not_exist      = 1
                   communication_failure      = 2
                   component_not_available    = 3
                   folder_not_exist           = 4
                   folder_no_authorization    = 5
                   object_not_exist           = 6
                   object_no_authorization    = 7
                   operation_no_authorization = 8
                   owner_not_exist            = 9
                   parameter_error            = 10 ##NUMBER_OK
                   substitute_not_active      = 11 ##NUMBER_OK
                   substitute_not_defined     = 12 ##NUMBER_OK
                   system_failure             = 13 ##NUMBER_OK
                   x_error                    = 14 ##NUMBER_OK
                   OTHERS                     = 15 ##NUMBER_OK.
      IF sy-subrc &lt;&gt; 0.
*       message
      ENDIF.

      LOOP AT i_objcont INTO l_objcont.
        l_url-titulo = l_sood2-objdes.
        CALL FUNCTION &apos;WRF_PBAS_TIMESTAMP_TO_DATE&apos;
          EXPORTING  i_timestamp       = l_srgbtbrel-utctime
                     i_tzone           = sy-zonlo
          IMPORTING  e_datlo           = l_url-fecha_creacion
                     e_timlo           = l_url-hora_creacion
          EXCEPTIONS invalid_date      = 1
                     invalid_time      = 2
                     invalid_date_time = 3
                     OTHERS            = 4.
        IF sy-subrc &lt;&gt; 0.
          MESSAGE &apos;Error convirtiendo fecha&apos;(ecf) TYPE &apos;E&apos;.
        ENDIF.

        l_url-url = l_srgbtbrel-instid_b.
        APPEND l_url TO tabla.
      ENDLOOP.

    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_NOTA" VERSION="1" LANGU="S" DESCRIPT="Borra nota" EXPOSURE="2" STATE="1" EDITORDER="23 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_NOTA" SCONAME="CLAVE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_NOTA" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Local Persistent Object Reference - BOR Compatible" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_NOTA" SCONAME="DESCRIPCION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_NOTA" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <source>METHOD borrar_nota.
    DATA: i_urls    TYPE TABLE OF sood,
          sood      TYPE sood,
          sibflporb TYPE sibflporb.

    CLEAR i_return.

    zcl_ap_gos=&gt;get_file_list( EXPORTING typeid        = tipo
                                         instid        = clave
                               CHANGING  i_attachments = i_urls ).

    READ TABLE i_urls INTO sood WITH KEY objdes   = descripcion
                                         objtp    = &apos;RAW&apos;
                                         file_ext = &apos;TXT&apos;.

    IF sood IS INITIAL.
      RETURN.
    ENDIF.

    sibflporb-typeid = tipo.
    sibflporb-instid = clave.

    delete_file( EXPORTING doctp    = sood-objtp
                           docyr    = sood-objyr
                           docno    = sood-objno
                           is_lporb = sibflporb
                 IMPORTING i_return = i_return ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_URL_GOS_ST" VERSION="1" LANGU="S" DESCRIPT="Borrar URL" EXPOSURE="2" STATE="1" EDITORDER="6 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_URL_GOS_ST" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_URL_GOS_ST" SCONAME="CLAVE" VERSION="1" LANGU="S" DESCRIPT="Clave objeto" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_URL_GOS_ST" SCONAME="URL" VERSION="1" LANGU="S" DESCRIPT="URL" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_URL_GOS_ST" SCONAME="TITULO" VERSION="1" LANGU="S" DESCRIPT="Titulo" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="BORRAR_URL_GOS_ST" SCONAME="ERROR" VERSION="1" LANGU="S" DESCRIPT="Se ha producido un error" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="EKKO-LOEKZ"/>
  <source>METHOD borrar_url_gos_st.
    DATA: ls_object   TYPE borident,
          ls_fol_id   TYPE soodk,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          ls_obj_data TYPE sood1,
          ls_obj_id   TYPE soodk,
          ls_folmem_k TYPE sofmk,
          lv_ep_note  TYPE borident-objkey,
          ls_note     TYPE borident.

    DATA: i_urls      TYPE TABLE OF srgbtbrel,
          l_srgbtbrel TYPE srgbtbrel,
          l_soodk     TYPE soodk,
          i_objcont   TYPE TABLE OF soli,
          l_folder_id TYPE soodk,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_sood2     TYPE sood2,
          l_objcont   TYPE soli.

    error = &apos;X&apos;.

    ls_object-objkey  = clave.
    ls_object-objtype = tipo.

    CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
      EXPORTING  region    = &apos;B&apos;
      IMPORTING  folder_id = ls_fol_id
      EXCEPTIONS OTHERS    = 1.
    IF sy-subrc &lt;&gt; 0.
*       message
    ENDIF.
    ls_obj_data-objsns = &apos;O&apos;.
    ls_obj_data-objla  = sy-langu.
    ls_obj_data-objdes = titulo.

    SELECT instid_b FROM srgbtbrel
      INTO CORRESPONDING FIELDS OF TABLE i_urls
      WHERE reltype  = &apos;URL&apos;
        AND instid_a = clave
        AND typeid_a = tipo
        AND catid_a  = &apos;BO&apos;.

    LOOP AT i_urls INTO l_srgbtbrel.
      IF l_srgbtbrel-instid_b(17) &lt;&gt; ls_fol_id.
        CONTINUE.
      ENDIF.

      l_soodk = l_srgbtbrel-instid_b+17.
      REFRESH i_objcont.
      l_folder_id = l_srgbtbrel-instid_b(17).

      CALL FUNCTION &apos;SO_OBJECT_READ&apos;
        EXPORTING
*                   FILTER                     =
                   folder_id                  = l_folder_id
*                   FORWARDER                  =
                   object_id                  = l_soodk
*                   OWNER                      =
*                   F_MAILER                   = &apos; &apos;
        IMPORTING
*                   OBJECT_FL_DISPLAY          =
                   object_hd_display          = l_sood2
*                   OBJECT_RC_DISPLAY          =
        TABLES     objcont                    = i_objcont
*                   OBJHEAD                    =
*                   OBJPARA                    =
*                   OBJPARB                    =
        EXCEPTIONS active_user_not_exist      = 1
                   communication_failure      = 2
                   component_not_available    = 3
                   folder_not_exist           = 4
                   folder_no_authorization    = 5
                   object_not_exist           = 6
                   object_no_authorization    = 7
                   operation_no_authorization = 8
                   owner_not_exist            = 9
                   parameter_error            = 10 ##NUMBER_OK
                   substitute_not_active      = 11 ##NUMBER_OK
                   substitute_not_defined     = 12 ##NUMBER_OK
                   system_failure             = 13 ##NUMBER_OK
                   x_error                    = 14 ##NUMBER_OK
                   OTHERS                     = 15 ##NUMBER_OK.
      IF sy-subrc &lt;&gt; 0.
*       message
      ENDIF.

      LOOP AT i_objcont INTO l_objcont.
        IF l_objcont+5 = url.
          ls_obj_id = l_soodk.
        ENDIF.
      ENDLOOP.
    ENDLOOP.

    IF NOT ls_obj_id IS INITIAL.
      CALL FUNCTION &apos;SO_OBJECT_DELETE&apos;
        EXPORTING  folder_id                  = ls_fol_id
*                   FORWARDER                  = &apos; &apos;
*                   F_UNREAD_DELETE            = &apos; &apos;
                   object_id                  = ls_obj_id
*                   OWNER                      = &apos; &apos;
*                   PUT_IN_WASTEBASKET         = &apos;X&apos;
        EXCEPTIONS communication_failure      = 1
                   folder_not_empty           = 2
                   folder_not_exist           = 3
                   folder_no_authorization    = 4
                   forwarder_not_exist        = 5
                   object_not_exist           = 6
                   object_no_authorization    = 7
                   operation_no_authorization = 8
                   owner_not_exist            = 9
                   substitute_not_active      = 10 ##NUMBER_OK
                   substitute_not_defined     = 11 ##NUMBER_OK
                   system_failure             = 12 ##NUMBER_OK
                   x_error                    = 13 ##NUMBER_OK
                   OTHERS                     = 14 ##NUMBER_OK.

      IF sy-subrc = 0 AND ls_object-objkey IS NOT INITIAL.
        ls_folmem_k-foltp = ls_fol_id-objtp.
        ls_folmem_k-folyr = ls_fol_id-objyr.
        ls_folmem_k-folno = ls_fol_id-objno.
        ls_folmem_k-doctp = ls_obj_id-objtp.
        ls_folmem_k-docyr = ls_obj_id-objyr.
        ls_folmem_k-docno = ls_obj_id-objno.
        lv_ep_note = ls_folmem_k.
        ls_note-objtype = &apos;MESSAGE&apos;.
        ls_note-objkey  = lv_ep_note.

        CALL FUNCTION &apos;BINARY_RELATION_DELETE_COMMIT&apos;
          EXPORTING  obj_rolea          = ls_object
                     obj_roleb          = ls_note
                     relationtype       = &apos;URL&apos;
          EXCEPTIONS entry_not_existing = 1
                     internal_error     = 2
                     no_relation        = 3
                     no_role            = 4
                     OTHERS             = 5.

        IF sy-subrc = 0.
          CLEAR error.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="CREAR_NOTA" VERSION="1" LANGU="S" DESCRIPT="Crear nota" EXPOSURE="2" STATE="1" EDITORDER="20 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="CREAR_NOTA" SCONAME="CLAVE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="CREAR_NOTA" SCONAME="CONTENIDO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="CREAR_NOTA" SCONAME="CONTENIDO_XSTRING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="XSTRING" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="CREAR_NOTA" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Local Persistent Object Reference - BOR Compatible" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="CREAR_NOTA" SCONAME="DESCRIPCION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="CREAR_NOTA" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <source>METHOD crear_nota.
    DATA sibflporb TYPE sibflporb.

    sibflporb-typeid = tipo.
    sibflporb-instid = clave.

    i_return = attach_file_xstring( iv_content     = contenido
                                    iv_content_hex = contenido_xstring
                                    iv_name        = clave
                                    descripcion    = descripcion
                                    iv_objtp       = &apos;RAW&apos;
                                    is_lporb       = sibflporb ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="DELETE_FILE" VERSION="1" LANGU="S" DESCRIPT="email attachments" EXPOSURE="2" STATE="1" EDITORDER="16 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="DELETE_FILE" SCONAME="FOLDER_REGION" VERSION="1" LANGU="S" DESCRIPT="Folder: Area (private, shared folders)" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_FOL_RG" PARVALUE="&apos;B&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="DELETE_FILE" SCONAME="DOCTP" VERSION="1" LANGU="S" DESCRIPT="Code for document class" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_TP"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="DELETE_FILE" SCONAME="DOCYR" VERSION="1" LANGU="S" DESCRIPT="Object: Year from ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_YR"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="DELETE_FILE" SCONAME="DOCNO" VERSION="1" LANGU="S" DESCRIPT="Object: Number from ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_NO"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="DELETE_FILE" SCONAME="IS_LPORB" VERSION="1" LANGU="S" DESCRIPT="HTML content type" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SIBFLPORB" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="DELETE_FILE" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <source>METHOD delete_file.
    DATA: ls_fol_id        TYPE soodk,
          l_folder_id      TYPE soodk,
          l_object_id      TYPE soodk,
          document_content TYPE STANDARD TABLE OF soli,
          document_id      TYPE sofmk,
          l_document_id    TYPE swo_typeid,
          lo_docsrv        TYPE REF TO cl_gos_document_service,
          lv_message       TYPE bapiret2,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          ex               TYPE REF TO cx_root.

    CLEAR i_return.

    TRY.
        CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
          EXPORTING  region    = folder_region
          IMPORTING  folder_id = ls_fol_id
          EXCEPTIONS OTHERS    = 1.
        IF sy-subrc = 0.
          l_folder_id-objtp = ls_fol_id-objtp.
          l_folder_id-objyr = ls_fol_id-objyr.
          l_folder_id-objno = ls_fol_id-objno.
          l_object_id-objtp = doctp.
          l_object_id-objyr = docyr.
          l_object_id-objno = docno.
          CALL FUNCTION &apos;SO_OBJECT_READ&apos;
            EXPORTING  folder_id                  = l_folder_id
                       object_id                  = l_object_id
            TABLES     objcont                    = document_content
            EXCEPTIONS active_user_not_exist      = 1
                       communication_failure      = 2
                       component_not_available    = 3
                       folder_not_exist           = 4
                       folder_no_authorization    = 5
                       object_not_exist           = 6
                       object_no_authorization    = 7
                       operation_no_authorization = 8
                       owner_not_exist            = 9
                       parameter_error            = 10 ##NUMBER_OK
                       substitute_not_active      = 11 ##NUMBER_OK
                       substitute_not_defined     = 12 ##NUMBER_OK
                       system_failure             = 13 ##NUMBER_OK
                       x_error                    = 14 ##NUMBER_OK
                       OTHERS                     = 15 ##NUMBER_OK.
          IF sy-subrc = 0.
            document_id-foltp = l_folder_id-objtp.
            document_id-folyr = l_folder_id-objyr.
            document_id-folno = l_folder_id-objno.
            document_id-doctp = l_object_id-objtp.
            document_id-docyr = l_object_id-objyr.
            document_id-docno = l_object_id-objno.
            l_document_id     = document_id.
            lo_docsrv = NEW #( ).
            CASE doctp.
              WHEN &apos;EXT&apos;.
                lo_docsrv-&gt;delete_attachment( is_lporb      = is_lporb
                                              ip_attachment = l_document_id ).
              WHEN &apos;RAW&apos;.
                lo_docsrv-&gt;delete_note( is_lporb = is_lporb
                                        ip_note  = l_document_id ).
              WHEN &apos;URL&apos;.
                lo_docsrv-&gt;delete_url( is_lporb = is_lporb
                                       ip_url   = l_document_id ).
            ENDCASE.
            IF sy-subrc = 0.
              COMMIT WORK AND WAIT.
            ELSE.
              lv_message-id         = sy-msgid.
              lv_message-number     = sy-msgno.
              lv_message-message_v1 = sy-msgv1.
              lv_message-message_v2 = sy-msgv2.
              lv_message-message_v3 = sy-msgv3.
              lv_message-message_v4 = sy-msgv4.
              APPEND lv_message TO i_return.
              RETURN.
            ENDIF.
          ENDIF.
        ENDIF.
      CATCH cx_root INTO ex.
        lv_message-id         = sy-msgid.
        lv_message-number     = sy-msgno.
        lv_message-message_v1 = sy-msgv1.
        lv_message-message_v2 = sy-msgv2.
        lv_message-message_v3 = sy-msgv3.
        lv_message-message_v4 = sy-msgv4.
        APPEND lv_message TO i_return.
    ENDTRY.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="DOWNLOAD_FILE_TO_GUI" VERSION="1" LANGU="S" DESCRIPT="Descarga fichero a PC" EXPOSURE="2" STATE="1" EDITORDER="10 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="DOWNLOAD_FILE_TO_GUI" SCONAME="RUTA" VERSION="1" LANGU="S" DESCRIPT="Character 100" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="DOWNLOAD_FILE_TO_GUI" SCONAME="ATTACHMENT" VERSION="1" LANGU="S" DESCRIPT="SAPoffice: Object definition" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SOOD"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="DOWNLOAD_FILE_TO_GUI" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <source>METHOD download_file_to_gui.
    DATA: ltp_sortfield   TYPE char30,
          lta_objcont     TYPE soli_tab,
          ltp_pathfile    TYPE c LENGTH 1000,
          ltp_binfilesize TYPE so_doc_len,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          ltp_filename    TYPE string,
          ls_message      TYPE bapiret2,
          ex              TYPE REF TO cx_root,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          text            TYPE string.

    CLEAR i_return.

    TRY.
        CONCATENATE attachment-objtp attachment-objyr attachment-objno INTO ltp_sortfield.
        IMPORT objcont_tab TO lta_objcont FROM DATABASE soc3(dt) ID ltp_sortfield.
        IF sy-subrc = 0.
          IF NOT attachment-acnam IS INITIAL.
            CONCATENATE ruta &apos;\&apos; attachment-objdes &apos;.&apos; attachment-acnam INTO ltp_pathfile.
          ELSE.
            CONCATENATE ruta &apos;\&apos; attachment-objdes &apos;.&apos; attachment-file_ext INTO ltp_pathfile.
          ENDIF.
          REPLACE &apos;\\&apos; WITH &apos;\&apos; INTO ltp_pathfile+2.
          ltp_pathfile = translate( val  = ltp_pathfile
                                    from = `/`
                                    to   = ` ` ).
          ltp_binfilesize = attachment-objlen.
          CALL FUNCTION &apos;SO_OBJECT_DOWNLOAD&apos;
            EXPORTING  bin_filesize     = ltp_binfilesize
                       filetype         = &apos;BIN&apos;
                       path_and_file    = ltp_pathfile
                       extct            = attachment-extct
                       no_dialog        = &apos;X&apos;
            IMPORTING  act_filename     = ltp_filename
            TABLES     objcont          = lta_objcont
            EXCEPTIONS file_write_error = 1
                       invalid_type     = 2
                       x_error          = 3
                       kpro_error       = 4
                       OTHERS           = 5.
          IF sy-subrc &lt;&gt; 0.
            MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
            ls_message-type       = sy-msgty.
            ls_message-id         = sy-msgid.
            ls_message-number     = sy-msgno.
            ls_message-message_v1 = sy-msgv1.
            ls_message-message_v2 = sy-msgv2.
            ls_message-message_v3 = sy-msgv3.
            ls_message-message_v4 = sy-msgv4.
            APPEND ls_message TO i_return.
            RETURN.
          ENDIF.
        ELSE.
          MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                  WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
          ls_message-type       = sy-msgty.
          ls_message-id         = sy-msgid.
          ls_message-number     = sy-msgno.
          ls_message-message_v1 = sy-msgv1.
          ls_message-message_v2 = sy-msgv2.
          ls_message-message_v3 = sy-msgv3.
          ls_message-message_v4 = sy-msgv4.
          APPEND ls_message TO i_return.
          RETURN.
        ENDIF.
      CATCH cx_root INTO ex.
        text = ex-&gt;get_text( ).
        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
        ls_message-type       = sy-msgty.
        ls_message-id         = sy-msgid.
        ls_message-number     = sy-msgno.
        ls_message-message_v1 = sy-msgv1.
        ls_message-message_v2 = sy-msgv2.
        ls_message-message_v3 = sy-msgv3.
        ls_message-message_v4 = sy-msgv4.
        APPEND ls_message TO i_return.
        RETURN.
    ENDTRY.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="EMAIL_ATTACHED_FILE" VERSION="1" LANGU="S" DESCRIPT="email attachments" EXPOSURE="2" STATE="1" EDITORDER="15 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EMAIL_ATTACHED_FILE" SCONAME="FOLDER_REGION" VERSION="1" LANGU="S" DESCRIPT="Folder: Area (private, shared folders)" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_FOL_RG" PARVALUE="&apos;B&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EMAIL_ATTACHED_FILE" SCONAME="DOCTP" VERSION="1" LANGU="S" DESCRIPT="Code for document class" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_TP"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EMAIL_ATTACHED_FILE" SCONAME="DOCYR" VERSION="1" LANGU="S" DESCRIPT="Object: Year from ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_YR"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EMAIL_ATTACHED_FILE" SCONAME="DOCNO" VERSION="1" LANGU="S" DESCRIPT="Object: Number from ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_NO"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EMAIL_ATTACHED_FILE" SCONAME="T_RECEIVERS" VERSION="1" LANGU="S" DESCRIPT="Table of Strings" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TABLE_OF_STRINGS"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EMAIL_ATTACHED_FILE" SCONAME="SEND_NOW" VERSION="1" LANGU="S" DESCRIPT="HTML content type" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EMAIL_ATTACHED_FILE" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <source>METHOD email_attached_file.
    DATA: lwa_object_header    TYPE STANDARD TABLE OF solisti1,
          ls_fol_id            TYPE soodk,
          l_folder_id          TYPE soodk,
          l_object_id          TYPE soodk,
          document_content     TYPE STANDARD TABLE OF soli,
          document_id          TYPE sofmk,
          l_document_id        TYPE so_entryid,
          lwa_document_data    TYPE sofolenti1,
          lwa_object_content_1 TYPE STANDARD TABLE OF solisti1,
          lwa_contents_hex     TYPE STANDARD TABLE OF solix,
          send_request         TYPE REF TO cl_bcs,
          document             TYPE REF TO cl_document_bcs,
          recipient            TYPE REF TO if_recipient_bcs,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          sent_to_all          TYPE os_boolean,
          fil_nm_txt           TYPE so_obj_des,
          wa_t_receivers       LIKE LINE OF t_receivers,
          mailto               TYPE ad_smtpadr,
          wa_object_header     LIKE LINE OF lwa_object_header,
          moff                 TYPE i,
          fil_nm               TYPE c LENGTH 50,
          lt_url_tab           TYPE TABLE OF so_url,
          ld_url_tab_size      TYPE sytabix,
          file_ext             TYPE c LENGTH 3,
          ttext                TYPE bcsy_text,
          bcs_exception        TYPE REF TO cx_bcs,
          ls_message           TYPE bapiret2,
          ex                   TYPE REF TO cx_root,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          text                 TYPE string.

    CLEAR i_return.

    TRY.
        CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
          EXPORTING  region    = folder_region
          IMPORTING  folder_id = ls_fol_id
          EXCEPTIONS OTHERS    = 1.
        IF sy-subrc = 0.
          l_folder_id-objtp = ls_fol_id-objtp.
          l_folder_id-objyr = ls_fol_id-objyr.
          l_folder_id-objno = ls_fol_id-objno.
          l_object_id-objtp = doctp.
          l_object_id-objyr = docyr.
          l_object_id-objno = docno.
          CALL FUNCTION &apos;SO_OBJECT_READ&apos;
            EXPORTING  folder_id                  = l_folder_id
                       object_id                  = l_object_id
            TABLES     objcont                    = document_content
            EXCEPTIONS active_user_not_exist      = 1
                       communication_failure      = 2
                       component_not_available    = 3
                       folder_not_exist           = 4
                       folder_no_authorization    = 5
                       object_not_exist           = 6
                       object_no_authorization    = 7
                       operation_no_authorization = 8
                       owner_not_exist            = 9
                       parameter_error            = 10 ##NUMBER_OK
                       substitute_not_active      = 11 ##NUMBER_OK
                       substitute_not_defined     = 12 ##NUMBER_OK
                       system_failure             = 13 ##NUMBER_OK
                       x_error                    = 14 ##NUMBER_OK
                       OTHERS                     = 15 ##NUMBER_OK.
          IF sy-subrc = 0.
            document_id-foltp = l_folder_id-objtp.
            document_id-folyr = l_folder_id-objyr.
            document_id-folno = l_folder_id-objno.
            document_id-doctp = l_object_id-objtp.
            document_id-docyr = l_object_id-objyr.
            document_id-docno = l_object_id-objno.
            l_document_id     = document_id.
            CALL FUNCTION &apos;SO_DOCUMENT_READ_API1&apos;
              EXPORTING  document_id                = l_document_id
              IMPORTING  document_data              = lwa_document_data
              TABLES     object_header              = lwa_object_header
                         object_content             = lwa_object_content_1
                         contents_hex               = lwa_contents_hex
              EXCEPTIONS document_id_not_exist      = 1
                         operation_no_authorization = 2
                         x_error                    = 3
                         OTHERS                     = 4.
            IF sy-subrc = 0.
              CLEAR: send_request,
                     document,
                     recipient,
                     sent_to_all,
                     fil_nm_txt.
              TRY.
                  READ TABLE t_receivers INTO wa_t_receivers INDEX 1.
                  mailto       = wa_t_receivers. &quot;-receiver.
                  send_request = cl_bcs=&gt;create_persistent( ).
                  READ TABLE lwa_object_header INTO wa_object_header INDEX 1.
                  IF sy-subrc = 0.
                    FIND &apos;=&apos; IN wa_object_header-line MATCH OFFSET moff.
                    moff = moff + 1.
                    fil_nm = wa_object_header-line+moff.
                    SPLIT fil_nm AT &apos;.&apos; INTO TABLE lt_url_tab.
                    ld_url_tab_size = lines( lt_url_tab ).
                    IF ld_url_tab_size &gt; 1.
                      READ TABLE lt_url_tab INDEX ld_url_tab_size INTO file_ext.
                    ELSE.
                      CLEAR file_ext.
                    ENDIF.
                  ENDIF.
                  fil_nm_txt = fil_nm.
                  IF fil_nm_txt IS INITIAL.
                    fil_nm_txt = &apos;Requested File is Attached&apos;(rfa).
                  ENDIF.
                  APPEND &apos;The file you requested file is attached.&apos;(fra) TO ttext.
                  document = cl_document_bcs=&gt;create_document( i_type    = &apos;RAW&apos;
                                                               i_text    = ttext
                                                               i_subject = fil_nm_txt ).
                  document-&gt;add_attachment( i_attachment_type    = file_ext
                                            i_attachment_subject = fil_nm
                                            i_att_content_hex    = lwa_contents_hex
                                            i_attachment_header  = lwa_object_header
                                            i_attachment_size    = lwa_document_data-doc_size ).
                  send_request-&gt;set_document( document ).
                  recipient = cl_cam_address_bcs=&gt;create_internet_address( mailto ).
                  send_request-&gt;add_recipient( recipient ).
                  sent_to_all = send_request-&gt;send( i_with_error_screen = &apos;X&apos; ).
                CATCH cx_bcs INTO bcs_exception.
                  MESSAGE i865(so) WITH bcs_exception-&gt;error_type.
              ENDTRY.
              IF sy-subrc = 0.
                IF send_now = &apos;X&apos;.
                  SUBMIT rsconn01 WITH mode = &apos;INT&apos; AND RETURN.  &quot;&quot;#EC CI_SUBMIT
                ENDIF.
              ELSE.
                MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                        WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
                ls_message-type       = sy-msgty.
                ls_message-id         = sy-msgid.
                ls_message-number     = sy-msgno.
                ls_message-message_v1 = sy-msgv1.
                ls_message-message_v2 = sy-msgv2.
                ls_message-message_v3 = sy-msgv3.
                ls_message-message_v4 = sy-msgv4.
                APPEND ls_message TO i_return.
                RETURN.
              ENDIF.
              COMMIT WORK.
            ELSE.
              MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                      WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
              ls_message-type       = sy-msgty.
              ls_message-id         = sy-msgid.
              ls_message-number     = sy-msgno.
              ls_message-message_v1 = sy-msgv1.
              ls_message-message_v2 = sy-msgv2.
              ls_message-message_v3 = sy-msgv3.
              ls_message-message_v4 = sy-msgv4.
              APPEND ls_message TO i_return.
              RETURN.
            ENDIF.
          ELSE.
            MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
            ls_message-type       = sy-msgty.
            ls_message-id         = sy-msgid.
            ls_message-number     = sy-msgno.
            ls_message-message_v1 = sy-msgv1.
            ls_message-message_v2 = sy-msgv2.
            ls_message-message_v3 = sy-msgv3.
            ls_message-message_v4 = sy-msgv4.
            APPEND ls_message TO i_return.
            RETURN.
          ENDIF.
        ELSE.
          MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                  WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
          ls_message-type       = sy-msgty.
          ls_message-id         = sy-msgid.
          ls_message-number     = sy-msgno.
          ls_message-message_v1 = sy-msgv1.
          ls_message-message_v2 = sy-msgv2.
          ls_message-message_v3 = sy-msgv3.
          ls_message-message_v4 = sy-msgv4.
          APPEND ls_message TO i_return.
          RETURN.
        ENDIF.
      CATCH cx_root INTO ex.
        text = ex-&gt;get_text( ).
        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
        ls_message-type       = sy-msgty.
        ls_message-id         = sy-msgid.
        ls_message-number     = sy-msgno.
        ls_message-message_v1 = sy-msgv1.
        ls_message-message_v2 = sy-msgv2.
        ls_message-message_v3 = sy-msgv3.
        ls_message-message_v4 = sy-msgv4.
        APPEND ls_message TO i_return.
        RETURN.
    ENDTRY.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="EXISTE_URL" VERSION="1" LANGU="S" DESCRIPT="¿Existe URL?" EXPOSURE="2" STATE="1" EDITORDER="28 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EXISTE_URL" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-TYPEID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EXISTE_URL" SCONAME="CLAVE" VERSION="1" LANGU="S" DESCRIPT="Clave objeto" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-INSTID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EXISTE_URL" SCONAME="URL" VERSION="1" LANGU="S" DESCRIPT="Documentos URL GOS" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="0" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="EXISTE_URL" SCONAME="EXISTE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ABAP_BOOL"/>
  <source>METHOD existe_url.
    DATA i_urls TYPE ztab_url_gos.

    i_urls = urls_gos_st( tipo  = tipo
                          clave = clave ).

    IF line_exists( i_urls[ url = url ] ).
      existe = &apos;X&apos;.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES" VERSION="1" LANGU="S" DESCRIPT="Recupera ficheros en Archivelink" EXPOSURE="2" STATE="1" EDITORDER="17 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES" SCONAME="SAP_OBJECT" VERSION="1" LANGU="S" DESCRIPT="SAP ArchiveLink: Tipo de objeto del business object" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES" SCONAME="OBJECT_ID" VERSION="1" LANGU="S" DESCRIPT="SAp ArchiveLink: ID de objeto (identificador de objeto)" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES" SCONAME="AR_OBJECT" VERSION="1" LANGU="S" DESCRIPT="Clase documentos" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TOA01-AR_OBJECT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES" SCONAME="RESERVE" VERSION="1" LANGU="S" DESCRIPT="SAP ArchiveLink: Reserva para aplicaciones futuras" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TOA01-RESERVE" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES" SCONAME="COPIAR_A_TEMP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES" SCONAME="I_FICHEROS" VERSION="1" LANGU="S" DESCRIPT="CTS: File Attributes" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ZAL_FILES_T"/>
  <source>METHOD get_archivelink_files.
    DATA: l_dir_temp   TYPE string,
          i_ficheros_m TYPE zal_files_m_t,
          l_fichero    TYPE zal_files,
          l_file       TYPE string,
          l_dtpath     TYPE sapb-sappfad.

    FIELD-SYMBOLS &lt;fichero_m&gt; TYPE zal_files_m.

    IF copiar_a_temp = &apos;X&apos;.
      l_dir_temp = zcl_ap_documentos=&gt;get_directorio_temporal( ).
    ENDIF.

    i_ficheros_m = get_archivelink_files_m( sap_object = sap_object
                                            object_id  = object_id
                                            ar_object  = ar_object
                                            reserve    = reserve ).

    LOOP AT i_ficheros_m ASSIGNING &lt;fichero_m&gt;.
      CLEAR l_fichero.
      MOVE-CORRESPONDING &lt;fichero_m&gt; TO l_fichero.

      IF copiar_a_temp = &apos;X&apos;.
        l_file = zcl_ap_ficheros=&gt;concat_ruta( directorio = l_dir_temp
                                               fichero    = l_fichero-fichero ).
        l_dtpath = l_file.
        l_fichero-fichero = l_file.
        CALL FUNCTION &apos;ARCHIVOBJECT_GET_DT_VIA_TABLE&apos;
          EXPORTING  archiv_id         = &lt;fichero_m&gt;-archiv_id
                     archiv_doc_id     = &lt;fichero_m&gt;-arc_doc_id
                     dtpath            = l_dtpath
                     convert           = &apos; &apos;
          EXCEPTIONS error_application = 1.
        IF sy-subrc &lt;&gt; 0.
* message
        ENDIF.
      ENDIF.

      APPEND l_fichero TO i_ficheros.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES_M" VERSION="1" LANGU="S" DESCRIPT="Recupera ficheros en Archivelink memoria" EXPOSURE="2" STATE="1" EDITORDER="18 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES_M" SCONAME="SAP_OBJECT" VERSION="1" LANGU="S" DESCRIPT="SAP ArchiveLink: Tipo de objeto del business object" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES_M" SCONAME="OBJECT_ID" VERSION="1" LANGU="S" DESCRIPT="SAp ArchiveLink: ID de objeto (identificador de objeto)" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES_M" SCONAME="AR_OBJECT" VERSION="1" LANGU="S" DESCRIPT="Clase documentos" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TOA01-AR_OBJECT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES_M" SCONAME="RESERVE" VERSION="1" LANGU="S" DESCRIPT="SAP ArchiveLink: Reserva para aplicaciones futuras" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TOA01-RESERVE" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES_M" SCONAME="GET_CONTENIDO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES_M" SCONAME="DESCRIPCION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_FILES_M" SCONAME="I_FICHEROS" VERSION="1" LANGU="S" DESCRIPT="CTS: File Attributes" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ZAL_FILES_M_T"/>
  <source>METHOD get_archivelink_files_m.
    DATA: l_ar_object    TYPE toaom-ar_object,
          l_object_id    TYPE sapb-sapobjid,
          l_sap_object   TYPE toaom-sap_object,
          connect_info   TYPE STANDARD TABLE OF toav0,
          l_fichero      TYPE zal_files_m,
          l_nombre_tabla TYPE c LENGTH 40.

    FIELD-SYMBOLS &lt;info&gt; TYPE toav0.

    IF ar_object &lt;&gt; &apos;*&apos;.
      l_ar_object = ar_object.
    ENDIF.

    l_object_id = object_id.
    l_sap_object = sap_object.
    CALL FUNCTION &apos;ARCHIV_CONNECTINFO_GET_META&apos;
      EXPORTING
*                 ARCHIV_ID             = &apos; &apos;
                 ar_object             = l_ar_object
*                 DOC_TYPE              = &apos; &apos;
                 object_id             = l_object_id
                 sap_object            = l_sap_object
*                 LIMITED               = LIMITED
*     IMPORTING
*                 NUMBER                = NUMBER
*                 REDUCEDBYLIMIT        = REDUCEDBYLIMIT
*                 REDUCEDBYAUTHORITY    = REDUCEDBYAUTHORITY
*                 COUNT                 = COUNT
      TABLES     connect_info          = connect_info
      EXCEPTIONS error_connectiontable = 1.
    IF sy-subrc &lt;&gt; 0.
*    MESSAGE &apos;Error recuperando adjuntos&apos;(era) TYPE &apos;E&apos;.
    ENDIF.

    LOOP AT connect_info ASSIGNING &lt;info&gt;.
      IF NOT reserve IS INITIAL.
        IF reserve &lt;&gt; &lt;info&gt;-reserve.
          CONTINUE.
        ENDIF.
      ENDIF.

      CLEAR l_fichero.
      l_nombre_tabla = &apos;TOAAT&apos;.
      SELECT SINGLE filename descr
        FROM (l_nombre_tabla)
        INTO ( l_fichero-fichero, l_fichero-descripcion )
        WHERE arc_doc_id = &lt;info&gt;-arc_doc_id.
      IF sy-subrc &lt;&gt; 0.
        CONCATENATE &lt;info&gt;-arc_doc_id &apos;.&apos; &lt;info&gt;-reserve INTO l_fichero-fichero.
      ENDIF.

      IF NOT descripcion IS INITIAL AND l_fichero-descripcion &lt;&gt; descripcion.
        CONTINUE.
      ENDIF.

      l_fichero-extension  = zcl_ap_ficheros=&gt;get_extension( l_fichero-fichero ).

      l_fichero-archiv_id  = &lt;info&gt;-archiv_id.
      l_fichero-arc_doc_id = &lt;info&gt;-arc_doc_id.
      l_fichero-date       = &lt;info&gt;-ar_date.
      IF get_contenido = &apos;X&apos;.
        get_archivelink_xstring( EXPORTING archiv_id  = l_fichero-archiv_id
                                           arc_doc_id = l_fichero-arc_doc_id
                                 IMPORTING contenido  = l_fichero-contenido
                                           longitud   = l_fichero-longitud ).
      ENDIF.

      APPEND l_fichero TO i_ficheros.
    ENDLOOP.

*  DATA: l_fichero          TYPE zal_files_m,
*        i_toa01            TYPE TABLE OF toa01,
*        l_toa01            TYPE toa01,
*        r_ar_object        TYPE rstt_t_range_string,
*        r_reserve          TYPE rstt_t_range_string,
*        l_nombre_tabla(40).
*
*  r_ar_object = zcl_ap_rango=&gt;set_eq_str( ar_object ).
*  r_reserve = zcl_ap_rango=&gt;set_eq_str( reserve ).
*
*  SELECT * FROM toa01
*    INTO TABLE i_toa01
*   WHERE sap_object = sap_object
*     AND object_id  = object_id
*     AND ar_object IN r_ar_object
*     AND reserve   IN r_reserve.
*
*  LOOP AT i_toa01 INTO l_toa01.
*    CLEAR l_fichero.
*    l_nombre_tabla = &apos;TOAAT&apos;.
*    SELECT SINGLE filename descr FROM (l_nombre_tabla)
*       INTO (l_fichero-fichero, l_fichero-descripcion)
*      WHERE arc_doc_id = l_toa01-arc_doc_id.
*    IF sy-subrc NE 0.
*      CONCATENATE l_toa01-arc_doc_id &apos;.&apos; l_toa01-reserve INTO l_fichero-fichero.
*    ENDIF.
*
*    l_fichero-extension = zcl_ap_ficheros=&gt;get_extension( l_fichero-fichero ).
*
*    l_fichero-archiv_id = l_toa01-archiv_id.
*    l_fichero-arc_doc_id = l_toa01-arc_doc_id.
*    l_fichero-date = l_toa01-ar_date.
*    IF get_contenido = &apos;X&apos;.
*      get_archivelink_xstring( EXPORTING archiv_id  = l_fichero-archiv_id
*                                         arc_doc_id = l_fichero-arc_doc_id
*                               IMPORTING contenido  = l_fichero-contenido
*                                         longitud   = l_fichero-longitud ).
*    ENDIF.
*
*    APPEND l_fichero TO i_ficheros.
*  ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_XSTRING" VERSION="1" LANGU="S" DESCRIPT="Recupera contenido en memoria de un archivo" EXPOSURE="2" STATE="1" EDITORDER="19 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_XSTRING" SCONAME="ARCHIV_ID" VERSION="1" LANGU="S" DESCRIPT="Identificación Repository contenidos" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SAEARCHIVI"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_XSTRING" SCONAME="ARC_DOC_ID" VERSION="1" LANGU="S" DESCRIPT="SAP ArchiveLink: ID del documento de archivo" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SAEARDOID"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_XSTRING" SCONAME="VISUALIZAR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_XSTRING" SCONAME="CONTENIDO" VERSION="1" LANGU="S" DESCRIPT="XSTRING" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="ZXSTRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_XSTRING" SCONAME="LONGITUD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="I"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_ARCHIVELINK_XSTRING" SCONAME="MESSAGE" VERSION="1" LANGU="S" DESCRIPT="Texto de mensaje" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD get_archivelink_xstring.
    DATA: length          TYPE sapb-length,
          offset          TYPE sapb-offset,
          binlength       TYPE sapb-length,
          binarchivobject TYPE TABLE OF tbl1024,
          l_aux           TYPE c LENGTH 2.

    CLEAR: message,
           contenido,
           longitud.

    CALL FUNCTION &apos;ARCHIVOBJECT_GET_BYTES&apos;
      EXPORTING  archiv_id                = archiv_id
                 archiv_doc_id            = arc_doc_id
                 document_type            = &apos; &apos;
                 length                   = 0
                 offset                   = 0
                 mode                     = &apos; &apos;
                 signature                = &apos;X&apos;
                 shift_flag               = &apos; &apos;
                 compid                   = &apos; &apos;
      IMPORTING  length                   = length
                 offset                   = offset
                 binlength                = binlength
      TABLES     binarchivobject          = binarchivobject
      EXCEPTIONS error_archiv             = 1
                 error_communicationtable = 2
                 error_kernel             = 3
                 OTHERS                   = 4.
    IF sy-subrc &lt;&gt; 0.
      l_aux = sy-subrc.
      CONCATENATE &apos;Error&apos;(err) l_aux &apos;llamando a función ARCHIVOBJECT_GET_BYTES&apos;(agb) INTO message SEPARATED BY space.
      RETURN.
    ENDIF.

    longitud = binlength.
    CALL FUNCTION &apos;SCMS_BINARY_TO_XSTRING&apos;
      EXPORTING  input_length = longitud
      IMPORTING  buffer       = contenido
      TABLES     binary_tab   = binarchivobject
      EXCEPTIONS failed       = 1.
    IF sy-subrc &lt;&gt; 0.
      l_aux = sy-subrc.
      CONCATENATE &apos;Error&apos;(err) l_aux &apos;llamando a función SCMS_BINARY_TO_XSTRING&apos;(lfu) INTO message SEPARATED BY space.
      RETURN.
    ENDIF.

    IF visualizar = &apos;X&apos;.
      IF NOT contenido IS INITIAL.
        SELECT SINGLE filename FROM toaat
          INTO @DATA(l_filename)
          WHERE arc_doc_id = @arc_doc_id.
        IF sy-subrc = 0.
          message = zcl_ap_ficheros=&gt;visualizar( xstring = contenido
                                                 fichero = l_filename ).
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" VERSION="1" LANGU="S" DESCRIPT="Recupera lista ficheros" EXPOSURE="2" STATE="1" EDITORDER="9 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" SCONAME="INSTID" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" SCONAME="TYPEID" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SIBFTYPEID"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" SCONAME="CATID" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SIBFCATID" PARVALUE="&apos;BO&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" SCONAME="GET_ADJ_MAIL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" SCONAME="INSTID_B" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" SCONAME="I_ATTACHMENTS" VERSION="1" LANGU="S" DESCRIPT="Tipo table of SOOD" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="2" PARPASSTYP="1" TYPTYPE="1" TYPE="ZT_SOOD" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="2" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRETTAB" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" SCONAME="I_ADJUNTOS_MAIL" VERSION="1" LANGU="S" DESCRIPT="Tabla transferencia contenidos correo entr." CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="2" PARPASSTYP="1" TYPTYPE="1" TYPE="RMPS_T_POST_CONTENT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_LIST" SCONAME="I_ADJ" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="2" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_ADJ" PAROPTIONL="X"/>
  <source>METHOD get_file_list.
* http://scn.sap.com/docs/DOC-41922

    TYPES: BEGIN OF ts_key,
             foltp     TYPE so_fol_tp,
             folyr     TYPE so_fol_yr,
             folno     TYPE so_fol_no,
             objtp     TYPE so_obj_tp,
             objyr     TYPE so_obj_yr,
             objno     TYPE so_obj_no,
             forwarder TYPE so_usr_nam,
           END OF ts_key,
           BEGIN OF ts_attachment,
             foltp    TYPE so_fol_tp,
             folyr    TYPE so_fol_yr,
             folno    TYPE so_fol_no,
             objtp    TYPE so_obj_tp,
             objyr    TYPE so_obj_yr,
             objno    TYPE so_obj_no,
             brelguid TYPE oblguid32,
             roletype TYPE oblroltype,
           END OF ts_attachment,
           tt_attachment TYPE TABLE OF ts_attachment.

    DATA objhead_tab TYPE TABLE OF soli.
    DATA: r_instid_b      TYPE RANGE OF srgbtbrel-instid_b,
          ta_srgbtbrel    TYPE STANDARD TABLE OF srgbtbrel,
          wa_srgbtbrel    TYPE srgbtbrel,
          lt_attachment   TYPE tt_attachment,
          lta_attachments TYPE tt_attachment,
          gs_lpor         TYPE sibflporb,
          ls_option       TYPE obl_s_relt,
          lt_options      TYPE obl_t_relt,
          lt_links        TYPE obl_t_link,
          ls_link         TYPE obl_s_link,
          ls_key          TYPE ts_key,
          ls_attachment   TYPE ts_attachment,
          lta_sood        TYPE STANDARD TABLE OF sood,
          ls_message      TYPE bapiret2.
    DATA sood_key        TYPE soodk.
    DATA objcont_tab     TYPE TABLE OF soli.
    DATA objpara_tab     TYPE TABLE OF selc.
    DATA objparb_tab     TYPE TABLE OF soop1.
    DATA hex_mode        TYPE sonv-flag.
    DATA rcode           TYPE i.
    DATA l_param_search  TYPE soli-line.
    DATA wa_objhead_tab  LIKE LINE OF objhead_tab.
    DATA moff            TYPE i.
    DATA l_param_head    TYPE soli-line.
    DATA value           TYPE soli-line.
    DATA lt_url_tab      TYPE TABLE OF so_url.
    DATA ld_url_tab_size TYPE sytabix.

    FIELD-SYMBOLS &lt;fs&gt; TYPE LINE OF zt_sood.

    DATA: o_mail        TYPE REF TO zcl_ap_envio_mail,
          l_url         LIKE LINE OF i_attachments,
          o_fichero     TYPE string,
          o_mimetype    TYPE w3conttype,
          o_content     TYPE string,
          o_content_hex TYPE xstring,
          l_longitud    TYPE i,
          l_ext         TYPE string,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_aux         TYPE string.

    IF NOT typeid IS INITIAL AND NOT instid IS INITIAL.
      IF NOT instid_b IS INITIAL.
        APPEND VALUE #( option = &apos;EQ&apos;
                        sign   = &apos;I&apos;
                        low    = instid_b ) TO r_instid_b.
      ENDIF.

      SELECT catid_a typeid_a instid_a
        FROM srgbtbrel
        INTO CORRESPONDING FIELDS OF TABLE ta_srgbtbrel
        WHERE instid_a  = instid
          AND typeid_a  = typeid
          AND catid_a   = catid
          AND instid_b IN r_instid_b.
      IF sy-subrc = 0.
        SORT ta_srgbtbrel BY instid_a
                             typeid_a
                             catid_a.
        DELETE ADJACENT DUPLICATES FROM ta_srgbtbrel COMPARING instid_a typeid_a catid_a.
        LOOP AT ta_srgbtbrel INTO wa_srgbtbrel.
          CLEAR: lt_attachment[],
                 lta_attachments[].
          gs_lpor-instid = wa_srgbtbrel-instid_a.
          gs_lpor-typeid = wa_srgbtbrel-typeid_a.
          gs_lpor-catid  = wa_srgbtbrel-catid_a.
          ls_option-sign   = &apos;I&apos;.
          ls_option-option = &apos;EQ&apos;.
          ls_option-low    = &apos;ATTA&apos;.
          APPEND ls_option TO lt_options.
          ls_option-low = &apos;NOTE&apos;.
          APPEND ls_option TO lt_options.
          ls_option-low = &apos;PNOT&apos;.
          APPEND ls_option TO lt_options.
          ls_option-low = &apos;URL&apos;.
          APPEND ls_option TO lt_options.
          TRY.
              cl_binary_relation=&gt;read_links_of_binrels( EXPORTING is_object           = gs_lpor
                                                                   it_relation_options = lt_options
                                                                   ip_role             = &apos;GOSAPPLOBJ&apos;
                                                         IMPORTING et_links            = lt_links ).
              LOOP AT lt_links INTO ls_link WHERE instid_b IN r_instid_b.
                CASE ls_link-typeid_b.
                  WHEN &apos;MESSAGE&apos;.
                    IF ls_link-roletype_b = &apos;PERSNOTE&apos;.
                      ls_key = ls_link-instid_b+12.
                    ELSE.
                      ls_key = ls_link-instid_b.
                    ENDIF.
                    MOVE-CORRESPONDING ls_key TO ls_attachment.
                    ls_attachment-roletype = ls_link-roletype_b.
                    IF ls_link-brelguid IS INITIAL.
                      ls_attachment-brelguid = ls_link-relguidold.
                    ELSE.
                      ls_attachment-brelguid = ls_link-brelguid.
                    ENDIF.
                    APPEND ls_attachment TO lt_attachment.
                  WHEN OTHERS.
                    CONTINUE.
                ENDCASE.
              ENDLOOP.
            CATCH cx_obl_parameter_error.
            CATCH cx_obl_internal_error.
            CATCH cx_obl_model_error.
            CATCH cx_root.
          ENDTRY.
        ENDLOOP.
        lta_attachments[] = lt_attachment[].
        IF lta_attachments[] IS INITIAL.
          RETURN.
        ENDIF.
        SELECT * FROM sood
          INTO TABLE lta_sood
          FOR ALL ENTRIES IN lta_attachments
          WHERE objtp = lta_attachments-objtp
            AND objyr = lta_attachments-objyr
            AND objno = lta_attachments-objno.
        IF sy-subrc = 0.
          i_attachments[] = lta_sood.
        ENDIF.
        LOOP AT i_attachments ASSIGNING &lt;fs&gt;.
          IF &lt;fs&gt;-objtp IS INITIAL OR &lt;fs&gt;-objyr IS INITIAL OR &lt;fs&gt;-objno IS INITIAL.
            CONTINUE.
          ENDIF.

          CONCATENATE &lt;fs&gt;-objtp &lt;fs&gt;-objyr &lt;fs&gt;-objno INTO sood_key.
          PERFORM socx_select IN PROGRAM sapfsso0
                  TABLES objhead_tab
                         objcont_tab
                         objpara_tab
                         objparb_tab
                  USING  sood_key
                         hex_mode
                         rcode.
          IF rcode &lt;&gt; 0.
            CONTINUE.
          ENDIF.

          l_param_search = &apos;&amp;SO_FILENAME&apos;.
          l_param_search = to_upper( l_param_search ).
          LOOP AT objhead_tab INTO wa_objhead_tab.
            CLEAR moff.
            FIND &apos;=&apos; IN wa_objhead_tab-line MATCH OFFSET moff.
            IF sy-subrc &lt;&gt; 0.
              CONTINUE.
            ENDIF.
            l_param_head = wa_objhead_tab-line(moff).
            l_param_head = to_upper( l_param_head ).
            IF l_param_head = l_param_search.
              moff = moff + 1.
              value = wa_objhead_tab-line+moff.
              IF NOT ( value IS INITIAL ).
                SPLIT value AT &apos;.&apos; INTO TABLE lt_url_tab.
                ld_url_tab_size = lines( lt_url_tab ).
                IF ld_url_tab_size &gt; 1.
                  READ TABLE lt_url_tab INDEX ld_url_tab_size INTO &lt;fs&gt;-acnam.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDLOOP.
        ENDLOOP.
      ELSE.
        MESSAGE ID sy-msgid TYPE &apos;I&apos; NUMBER sy-msgno
                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
        ls_message-type       = sy-msgty.
        ls_message-id         = sy-msgid.
        ls_message-number     = sy-msgno.
        ls_message-message_v1 = sy-msgv1.
        ls_message-message_v2 = sy-msgv2.
        ls_message-message_v3 = sy-msgv3.
        ls_message-message_v4 = sy-msgv4.
        APPEND ls_message TO i_return.
        RETURN.
      ENDIF.
    ELSE.
      MESSAGE ID sy-msgid TYPE &apos;I&apos; NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO ls_message-message.
      ls_message-type       = sy-msgty.
      ls_message-id         = sy-msgid.
      ls_message-number     = sy-msgno.
      ls_message-message_v1 = sy-msgv1.
      ls_message-message_v2 = sy-msgv2.
      ls_message-message_v3 = sy-msgv3.
      ls_message-message_v4 = sy-msgv4.
      APPEND ls_message TO i_return.
      RETURN.
    ENDIF.

    IF get_adj_mail = &apos;X&apos;.
      o_mail = NEW #( ).
      LOOP AT i_attachments INTO l_url WHERE objtp = &apos;EXT&apos;.
        zcl_ap_gos=&gt;get_file_xstring( EXPORTING doctp         = l_url-objtp
                                                docyr         = l_url-objyr
                                                docno         = l_url-objno
                                      IMPORTING o_fichero     = o_fichero
                                                o_mimetype    = o_mimetype
                                                o_content     = o_content
                                                o_content_hex = o_content_hex
                                                longitud      = l_longitud ).
        IF o_fichero IS INITIAL AND NOT l_url-objdes IS INITIAL.
          o_fichero = l_url-objdes.
          IF NOT l_url-file_ext IS INITIAL.
            o_fichero = |{ o_fichero }.{ l_url-file_ext }|.
          ENDIF.
        ENDIF.
        IF NOT o_fichero IS INITIAL.
          l_ext = zcl_ap_ficheros=&gt;get_extension( o_fichero ).
          IF l_ext IS INITIAL.
            IF o_mimetype CS &apos;/&apos;.
              SPLIT o_mimetype AT &apos;/&apos; INTO l_aux l_ext.
            ELSE.
              l_ext = o_mimetype.
            ENDIF.
            IF NOT l_ext IS INITIAL.
              CONCATENATE o_fichero l_ext INTO o_fichero SEPARATED BY space.
            ENDIF.
          ENDIF.
          l_ext = to_upper( l_ext ).
          o_mail-&gt;add_adjunto( titulo   = o_fichero
                               xstring  = o_content_hex
                               longitud = l_longitud
                               tipo     = &apos;&apos; ).
        ENDIF.

        APPEND VALUE #( fichero = o_fichero
                        xstring = o_content_hex ) TO i_adj.
      ENDLOOP.
      i_adjuntos_mail = o_mail-&gt;i_adjuntos.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" VERSION="1" LANGU="S" DESCRIPT="download attached files when using ITS Applications" EXPOSURE="2" STATE="1" EDITORDER="12 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" SCONAME="FOLDER_REGION" VERSION="1" LANGU="S" DESCRIPT="Folder: Area (private, shared folders)" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_FOL_RG" PARVALUE="&apos;B&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" SCONAME="DOCTP" VERSION="1" LANGU="S" DESCRIPT="Code for document class" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_TP"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" SCONAME="DOCYR" VERSION="1" LANGU="S" DESCRIPT="Object: Year from ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_YR"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" SCONAME="DOCNO" VERSION="1" LANGU="S" DESCRIPT="Object: Number from ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_NO"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" SCONAME="O_FICHERO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" SCONAME="O_MIMETYPE" VERSION="1" LANGU="S" DESCRIPT="HTML content type" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="W3CONTTYPE"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" SCONAME="O_CONTENT_SOLITAB" VERSION="1" LANGU="S" DESCRIPT="Objcont and Objhead as Table Type" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="SOLI_TAB"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" SCONAME="O_FILELENGTH" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="I"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_SOLITAB" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <source>METHOD get_file_solitab.
    DATA: ls_fol_id        TYPE soodk,
          l_folder_id      TYPE soodk,
          l_object_id      TYPE soodk,
          document_content TYPE STANDARD TABLE OF soli,
          document_id      TYPE sofmk,
          l_document_id    TYPE sofolenti1-doc_id,
          l_document_data  TYPE sofolenti1,
          lt_header        TYPE soli_tab,
          lt_data          TYPE STANDARD TABLE OF solisti1,
          lt_xdata         TYPE solix_tab,
          l_subrc          TYPE int4,
          lv_message       TYPE bapiret2,
          lo_header        TYPE REF TO cl_bcs_objhead,
          lv_filename      TYPE string,
          file             TYPE string,
          dot_offset       TYPE i,
          extension        TYPE mimetypes-extension,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          ex               TYPE REF TO cx_root.

    CLEAR: i_return,
           o_content_solitab,
           o_mimetype,
           o_filelength,
           o_fichero.

    TRY.
        CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
          EXPORTING  region    = folder_region
          IMPORTING  folder_id = ls_fol_id
          EXCEPTIONS OTHERS    = 1.
        IF sy-subrc = 0.
          l_folder_id-objtp = ls_fol_id-objtp.
          l_folder_id-objyr = ls_fol_id-objyr.
          l_folder_id-objno = ls_fol_id-objno.
          l_object_id-objtp = doctp.
          l_object_id-objyr = docyr.
          l_object_id-objno = docno.
          CALL FUNCTION &apos;SO_OBJECT_READ&apos;
            EXPORTING  folder_id                  = l_folder_id
                       object_id                  = l_object_id
            TABLES     objcont                    = document_content
            EXCEPTIONS active_user_not_exist      = 1
                       communication_failure      = 2
                       component_not_available    = 3
                       folder_not_exist           = 4
                       folder_no_authorization    = 5
                       object_not_exist           = 6
                       object_no_authorization    = 7
                       operation_no_authorization = 8
                       owner_not_exist            = 9
                       parameter_error            = 10 ##NUMBER_OK
                       substitute_not_active      = 11 ##NUMBER_OK
                       substitute_not_defined     = 12 ##NUMBER_OK
                       system_failure             = 13 ##NUMBER_OK
                       x_error                    = 14 ##NUMBER_OK
                       OTHERS                     = 15 ##NUMBER_OK.
          IF sy-subrc = 0.
            document_id-foltp = l_folder_id-objtp.
            document_id-folyr = l_folder_id-objyr.
            document_id-folno = l_folder_id-objno.
            document_id-doctp = l_object_id-objtp.
            document_id-docyr = l_object_id-objyr.
            document_id-docno = l_object_id-objno.
            l_document_id = document_id.
            CALL FUNCTION &apos;SO_DOCUMENT_READ_API1&apos;
              EXPORTING  document_id                = l_document_id
              IMPORTING  document_data              = l_document_data
              TABLES     object_header              = lt_header
                         object_content             = lt_data
                         contents_hex               = lt_xdata
              EXCEPTIONS document_id_not_exist      = 1
                         operation_no_authorization = 2
                         x_error                    = 3
                         OTHERS                     = 4.
            IF sy-subrc &lt;&gt; 0.
*       message
            ENDIF.

            o_filelength = l_document_data-doc_size.
            IF sy-subrc &lt;&gt; 0.
              l_subrc = sy-subrc.
              lv_message-type = &apos;E&apos;.
              IF sy-msgid IS NOT INITIAL AND sy-msgno IS NOT INITIAL.
                lv_message-id         = sy-msgid.
                lv_message-number     = sy-msgno.
                lv_message-message_v1 = sy-msgv1.
                lv_message-message_v2 = sy-msgv2.
                lv_message-message_v3 = sy-msgv3.
                lv_message-message_v4 = sy-msgv4.
              ELSEIF l_subrc = 2.
                lv_message-id         = &apos;SO&apos;.
                lv_message-number     = &apos;055&apos;.
                lv_message-message_v1 = l_document_id.
              ELSE.
                lv_message-id         = &apos;SO&apos;.
                lv_message-number     = &apos;006&apos;.
                lv_message-message_v1 = l_document_id.
              ENDIF.
              APPEND lv_message TO i_return.
              RETURN.
            ENDIF.
            lo_header = cl_bcs_objhead=&gt;create( lt_header ).
            lv_filename = lo_header-&gt;get_filename( ).
            o_fichero = lv_filename.
            file = o_fichero.
            FIND FIRST OCCURRENCE OF REGEX &apos;\.[^\.]+$&apos; IN file MATCH OFFSET dot_offset.
            dot_offset = dot_offset + 1.
            extension = file+dot_offset.
            CALL FUNCTION &apos;SDOK_MIMETYPE_GET&apos;
              EXPORTING extension = extension
              IMPORTING mimetype  = o_mimetype.
            IF lt_data IS NOT INITIAL.
              o_content_solitab[] = lt_data[].
            ENDIF.
          ENDIF.
        ENDIF.
      CATCH cx_root INTO ex.
        lv_message-id         = sy-msgid.
        lv_message-number     = sy-msgno.
        lv_message-message_v1 = sy-msgv1.
        lv_message-message_v2 = sy-msgv2.
        lv_message-message_v3 = sy-msgv3.
        lv_message-message_v4 = sy-msgv4.
        APPEND lv_message TO i_return.
    ENDTRY.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" VERSION="1" LANGU="S" DESCRIPT="download attached files when using ABAP WebDynpro Applicatio" EXPOSURE="2" STATE="1" EDITORDER="11 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="FOLDER_REGION" VERSION="1" LANGU="S" DESCRIPT="Folder: Area (private, shared folders)" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_FOL_RG" PARVALUE="&apos;B&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="DOCTP" VERSION="1" LANGU="S" DESCRIPT="Code for document class" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_TP"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="DOCYR" VERSION="1" LANGU="S" DESCRIPT="Object: Year from ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_YR"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="DOCNO" VERSION="1" LANGU="S" DESCRIPT="Object: Number from ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_NO"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="O_FICHERO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="O_MIMETYPE" VERSION="1" LANGU="S" DESCRIPT="HTML content type" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="W3CONTTYPE"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="O_CONTENT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="O_CONTENT_HEX" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="XSTRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_FILE_XSTRING" SCONAME="LONGITUD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="I"/>
  <source>METHOD get_file_xstring.
    DATA: ls_fol_id        TYPE soodk,
          l_folder_id      TYPE soodk,
          l_object_id      TYPE soodk,
          document_content TYPE STANDARD TABLE OF soli,
          document_id      TYPE sofmk,
          l_document_id    TYPE sofolenti1-doc_id,
          l_document_data  TYPE sofolenti1,
          lt_header        TYPE soli_tab,
          lt_data          TYPE STANDARD TABLE OF solisti1,
          lt_xdata         TYPE solix_tab,
          l_subrc          TYPE int4,
          lv_message       TYPE bapiret2,
          lo_header        TYPE REF TO cl_bcs_objhead,
          lv_filename      TYPE string,
          file             TYPE string,
          dot_offset       TYPE i,
          extension        TYPE mimetypes-extension,
          ls_xdata         TYPE solix,
          l_xdata          TYPE xstring,
          ls_data          TYPE solisti1,
          l_data           TYPE string,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          ex               TYPE REF TO cx_root.
    DATA l_counter TYPE i.
    DATA conv_out  TYPE REF TO cl_abap_conv_out_ce.

    CLEAR: o_content_hex,
           i_return,
           o_fichero,
           o_mimetype,
           longitud,
           o_content.

    TRY.
        CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
          EXPORTING  region    = folder_region
          IMPORTING  folder_id = ls_fol_id
          EXCEPTIONS OTHERS    = 1.
        IF sy-subrc = 0.
          l_folder_id-objtp = ls_fol_id-objtp.
          l_folder_id-objyr = ls_fol_id-objyr.
          l_folder_id-objno = ls_fol_id-objno.
          l_object_id-objtp = doctp.
          l_object_id-objyr = docyr.
          l_object_id-objno = docno.
          CALL FUNCTION &apos;SO_OBJECT_READ&apos;
            EXPORTING  folder_id                  = l_folder_id
                       object_id                  = l_object_id
            TABLES     objcont                    = document_content
            EXCEPTIONS active_user_not_exist      = 1
                       communication_failure      = 2
                       component_not_available    = 3
                       folder_not_exist           = 4
                       folder_no_authorization    = 5
                       object_not_exist           = 6
                       object_no_authorization    = 7
                       operation_no_authorization = 8
                       owner_not_exist            = 9
                       parameter_error            = 10 ##NUMBER_OK
                       substitute_not_active      = 11 ##NUMBER_OK
                       substitute_not_defined     = 12 ##NUMBER_OK
                       system_failure             = 13 ##NUMBER_OK
                       x_error                    = 14 ##NUMBER_OK
                       OTHERS                     = 15 ##NUMBER_OK.
          IF sy-subrc = 0.
            document_id-foltp = l_folder_id-objtp.
            document_id-folyr = l_folder_id-objyr.
            document_id-folno = l_folder_id-objno.
            document_id-doctp = l_object_id-objtp.
            document_id-docyr = l_object_id-objyr.
            document_id-docno = l_object_id-objno.
            l_document_id = document_id.
            CALL FUNCTION &apos;SO_DOCUMENT_READ_API1&apos;
              EXPORTING  document_id                = l_document_id
              IMPORTING  document_data              = l_document_data
              TABLES     object_header              = lt_header
                         object_content             = lt_data
                         contents_hex               = lt_xdata
              EXCEPTIONS document_id_not_exist      = 1
                         operation_no_authorization = 2
                         x_error                    = 3
                         OTHERS                     = 4.
            IF sy-subrc &lt;&gt; 0.
              l_subrc = sy-subrc.
              lv_message-type = &apos;E&apos;.
              IF sy-msgid IS NOT INITIAL AND sy-msgno IS NOT INITIAL.
                lv_message-id         = sy-msgid.
                lv_message-number     = sy-msgno.
                lv_message-message_v1 = sy-msgv1.
                lv_message-message_v2 = sy-msgv2.
                lv_message-message_v3 = sy-msgv3.
                lv_message-message_v4 = sy-msgv4.
              ELSEIF l_subrc = 2.
                lv_message-id         = &apos;SO&apos;.
                lv_message-number     = &apos;055&apos;.
                lv_message-message_v1 = l_document_id.
              ELSE.
                lv_message-id         = &apos;SO&apos;.
                lv_message-number     = &apos;006&apos;.
                lv_message-message_v1 = l_document_id.
              ENDIF.
              APPEND lv_message TO i_return.
              RETURN.
            ENDIF.
            longitud = l_document_data-doc_size.
            lo_header = cl_bcs_objhead=&gt;create( lt_header ).
            lv_filename = lo_header-&gt;get_filename( ).
            o_fichero = lv_filename.
            file = o_fichero.
            FIND FIRST OCCURRENCE OF REGEX &apos;\.[^\.]+$&apos; IN file MATCH OFFSET dot_offset.
            dot_offset = dot_offset + 1.
            IF NOT file IS INITIAL.
              extension = file+dot_offset.
            ELSE.
              extension = l_document_data-obj_type.
            ENDIF.

            IF NOT extension IS INITIAL.
              CALL FUNCTION &apos;SDOK_MIMETYPE_GET&apos;
                EXPORTING extension = extension
                IMPORTING mimetype  = o_mimetype.
            ENDIF.
            IF lt_xdata IS NOT INITIAL.
              l_counter = l_document_data-doc_size.
              LOOP AT lt_xdata INTO ls_xdata.
                IF l_counter &gt; 255 ##NUMBER_OK.
                  CONCATENATE l_xdata ls_xdata-line INTO l_xdata IN BYTE MODE.
                ELSE.
                  CONCATENATE l_xdata ls_xdata-line+0(l_counter) INTO l_xdata IN BYTE MODE.
                ENDIF.
                l_counter = l_counter - 255 ##NUMBER_OK.
              ENDLOOP.
              o_content_hex = l_xdata.
            ELSE.
              LOOP AT lt_data INTO ls_data.
                IF doctp = &apos;URL&apos; AND strlen( ls_data-line ) &gt;= 5.
                  CONCATENATE l_data ls_data-line+5 INTO l_data.
                ENDIF.
                IF doctp = &apos;RAW&apos;.
                  CONCATENATE l_data ls_data-line INTO l_data.
                ENDIF.
              ENDLOOP.
              IF doctp = &apos;RAW&apos; OR doctp = &apos;URL&apos;.
                o_content = l_data.
                RETURN.
              ENDIF.
              conv_out = cl_abap_conv_out_ce=&gt;create( encoding = &apos;UTF-8&apos; ).
              conv_out-&gt;convert( EXPORTING data   = l_data
                                 IMPORTING buffer = o_content_hex ).
            ENDIF.
          ENDIF.
        ENDIF.
      CATCH cx_root INTO ex.
        lv_message-id         = sy-msgid.
        lv_message-number     = sy-msgno.
        lv_message-message_v1 = sy-msgv1.
        lv_message-message_v2 = sy-msgv2.
        lv_message-message_v3 = sy-msgv3.
        lv_message-message_v4 = sy-msgv4.
        APPEND lv_message TO i_return.
    ENDTRY.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NOTA" VERSION="1" LANGU="S" DESCRIPT="Recupera nota" EXPOSURE="2" STATE="1" EDITORDER="27 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NOTA" SCONAME="CLAVE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NOTA" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Local Persistent Object Reference - BOR Compatible" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NOTA" SCONAME="DESCRIPCION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NOTA" SCONAME="SOOD" VERSION="1" LANGU="S" DESCRIPT="SAPoffice: Definición de objetos" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="SOOD"/>
  <source>METHOD get_nota.
    DATA i_urls TYPE TABLE OF sood.

    zcl_ap_gos=&gt;get_file_list( EXPORTING typeid        = tipo
                                         instid        = clave
                               CHANGING  i_attachments = i_urls ).

    IF descripcion IS INITIAL.
      READ TABLE i_urls INTO sood INDEX 1.              &quot;#EC CI_NOORDER
    ELSE.
      READ TABLE i_urls INTO sood WITH KEY objdes   = descripcion
                                           objtp    = &apos;RAW&apos;
                                           file_ext = &apos;TXT&apos;.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NUM_GOS" VERSION="1" LANGU="S" DESCRIPT="Devuelve nº de URLs" EXPOSURE="2" STATE="1" EDITORDER="25 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NUM_GOS" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NUM_GOS" SCONAME="CLAVE" VERSION="1" LANGU="S" DESCRIPT="Clave objeto" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NUM_GOS" SCONAME="ATTA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NUM_GOS" SCONAME="URL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NUM_GOS" SCONAME="NOTAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NUM_GOS" SCONAME="AR_OBJECT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_NUM_GOS" SCONAME="TOTAL" VERSION="1" LANGU="S" DESCRIPT="URL GOS" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="INT4"/>
  <source>METHOD get_num_gos.
    DATA l_cont TYPE i.

    IF url = &apos;X&apos;.
      SELECT COUNT( * ) FROM srgbtbrel
        INTO l_cont
        WHERE reltype  = &apos;URL&apos;
          AND instid_a = clave
          AND typeid_a = tipo
          AND catid_a  = &apos;BO&apos;.
      total = total + l_cont.
    ENDIF.

    IF atta = &apos;X&apos;.
      IF ar_object IS INITIAL.
        SELECT COUNT( * ) FROM srgbtbrel
          INTO l_cont
          WHERE reltype  = &apos;ATTA&apos;
            AND instid_a = clave
            AND typeid_a = tipo
            AND catid_a  = &apos;BO&apos;.
      ELSEIF ar_object = &apos;*&apos;.
        SELECT COUNT( * ) FROM toa01
          INTO l_cont
          WHERE sap_object = tipo
            AND object_id  = clave.
      ELSE.
        SELECT COUNT( * ) FROM toa01
          INTO l_cont
          WHERE sap_object = tipo
            AND object_id  = clave
            AND ar_object  = ar_object.
      ENDIF.
      total = total + l_cont.
    ENDIF.

    IF notas = &apos;X&apos;.
      SELECT COUNT( * ) FROM srgbtbrel
        INTO l_cont
        WHERE reltype  = &apos;NOTE&apos;
          AND instid_a = clave
          AND typeid_a = tipo
          AND catid_a  = &apos;BO&apos;.
      total = total + l_cont.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_POPUP_GOS" VERSION="1" LANGU="S" DESCRIPT="Muestra popup GOS" EXPOSURE="2" STATE="1" EDITORDER="24 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_POPUP_GOS" SCONAME="OBJETO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objeto" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SWO_OBJTYP"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_POPUP_GOS" SCONAME="CLAVE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_POPUP_GOS" SCONAME="SERVICIO_CREAR" VERSION="1" LANGU="S" DESCRIPT="Nombre técnico del servicio de objeto genérico" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SGS_SRVNAM" PARVALUE="&apos;URL_CREA&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_POPUP_GOS" SCONAME="AR_OBJECT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <source>METHOD get_popup_gos.
    DATA: l_obj     TYPE borident,
          l_num_gos TYPE i,
          l_service TYPE sgs_srvnam,
          l_manager TYPE REF TO cl_gos_manager.

* Set object Key
    l_obj-objtype = objeto.
    l_obj-objkey  = clave.

    l_num_gos = zcl_ap_gos=&gt;get_num_gos( tipo      = l_obj-objtype
                                         clave     = l_obj-objkey
                                         ar_object = ar_object ).

    IF l_num_gos &gt; 0.
      l_service = &apos;VIEW_ATTA&apos;.
    ELSE.
*    l_service = &apos;ARL_LINK&apos;.
      IF servicio_crear IS INITIAL.
        RETURN.
      ENDIF.
      l_service = servicio_crear.
    ENDIF.

* GOS toolbar
    CREATE OBJECT l_manager
      EXPORTING
        is_object    = l_obj
        ip_no_commit = &apos;&apos;
      EXCEPTIONS
        OTHERS       = 1.
    IF sy-subrc NE 0.
      MESSAGE &apos;Error creando toolbar&apos; TYPE &apos;S&apos;.
      RETURN.
    ENDIF.

    l_manager-&gt;start_service_direct( EXPORTING  ip_service         = l_service    &quot; Generic Service to Be Executed
                                                is_object          = l_obj
                                                ip_check_available = &apos;&apos;
                                     EXCEPTIONS no_object          = 1
                                                object_invalid     = 2
                                                execution_failed   = 3
                                                OTHERS             = 4 ).

    IF sy-subrc &lt;&gt; 0.
      IF NOT sy-msgty IS INITIAL.
        MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="GET_URL_POR_TITULO_ST" VERSION="1" LANGU="S" DESCRIPT="Devuelve URL filtrando por título" EXPOSURE="2" STATE="1" EDITORDER="4 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-TYPEID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="CLAVE" VERSION="1" LANGU="S" DESCRIPT="Clave objeto" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-INSTID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="TITULO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="URL" VERSION="1" LANGU="S" DESCRIPT="Documentos URL GOS" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="STRING"/>
  <source>METHOD get_url_por_titulo_st.
    DATA: i_urls   TYPE ztab_url_gos,
          l_titulo TYPE so_obj_des,
          l_url    TYPE zest_url_gos.

    i_urls = urls_gos_st( tipo  = tipo
                          clave = clave ).

    CLEAR url.
    l_titulo = titulo.
    LOOP AT i_urls INTO l_url WHERE     titulo  = l_titulo
                                    AND url    &lt;&gt; &apos;&apos;.
      url = l_url-url.
      EXIT.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" VERSION="1" LANGU="S" DESCRIPT="Insertar Attachment" EXPOSURE="2" STATE="1" EDITORDER="8 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-TYPEID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="CLAVE" VERSION="1" LANGU="S" DESCRIPT="Clave objeto" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="CONTENT" VERSION="1" LANGU="S" DESCRIPT="Content" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SOLI_TAB" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="TITULO" VERSION="1" LANGU="S" DESCRIPT="Titulo" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="FICHERO" VERSION="1" LANGU="S" DESCRIPT="Tabla de conversión: Nombres fichero internos --&gt; externos" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="CONVERT" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="I_OTFDATA" VERSION="1" LANGU="S" DESCRIPT="Smart Forms: Tabla OTF" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TSFOTF" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="XSTRING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="XSTRING" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="RELTYPE" VERSION="1" LANGU="S" DESCRIPT="Relationship type" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BRELTYP-RELTYPE" PARVALUE="&apos;ATTA&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="STRING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="AR_OBJECT" VERSION="1" LANGU="S" DESCRIPT="Clase documentos" CMPTYPE="1" MTDTYPE="0" EDITORDER="11 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TOA01-AR_OBJECT" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="ARCHIV_ID" VERSION="1" LANGU="S" DESCRIPT="Identificación Repository contenidos" CMPTYPE="1" MTDTYPE="0" EDITORDER="12 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TOA01-ARCHIV_ID" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="EXTENSION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="13 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="ARC_DOC_ID" VERSION="1" LANGU="S" DESCRIPT="SAP ArchiveLink: ID del documento de archivo" CMPTYPE="1" MTDTYPE="0" EDITORDER="14 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="TOAV0-ARC_DOC_ID"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_ATA_GOS_ST" SCONAME="ERROR" VERSION="1" LANGU="S" DESCRIPT="Se ha producido un error" CMPTYPE="1" MTDTYPE="0" EDITORDER="15 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="EKKO-LOEKZ"/>
  <source>METHOD insertar_ata_gos_st.
    DATA: ls_object   TYPE borident,
          ls_fol_id   TYPE soodk,
          ls_obj_data TYPE sood1,
          l_fichero   TYPE filename,
          lv_offset   TYPE i,
          ls_obj_id   TYPE soodk,
          ls_folmem_k TYPE sofmk,
          lv_ep_note  TYPE borident-objkey,
          ls_note     TYPE borident.
    DATA: it_content TYPE STANDARD TABLE OF soli,
          it_objhead TYPE STANDARD TABLE OF soli.
    DATA: l_arcid      TYPE toaom-archiv_id,
          i_data       TYPE TABLE OF tbl1024,
          l_arcdocid   TYPE toav0-arc_doc_id,
          l_descr      TYPE c LENGTH 60,
          l_filename   TYPE char255,
          l_object_id  TYPE sapb-sapobjid,
          l_sap_object TYPE toaom-sap_object.
    DATA : content_txt    TYPE soli_tab,
           l_xstring      TYPE xstring,
           l_itcoo        TYPE itcoo,
           ac             LIKE LINE OF content_txt,
           l_len          TYPE so_obj_len,
           l_longitud_pdf TYPE i,
           l_transfer_bin TYPE sx_boolean,
           l_extension    TYPE toadv-doc_type,
           content_bin    TYPE solix_tab,
           objhead        TYPE soli_tab,
           l_size         TYPE i,
           l_offset       TYPE i,
           l_offset_old   TYPE i,
           l_temp_len     TYPE i,
           l_content_bin  TYPE solix,
           hex_null       TYPE x LENGTH 1 VALUE &apos;20&apos;,
           l_content_txt  TYPE soli,
           l_obj_type     TYPE soodk-objtp.

    CLEAR arc_doc_id.
    error = &apos;X&apos;.

    ls_object-objkey  = clave.
    ls_object-objtype = tipo.

    l_xstring = xstring.

    IF content IS INITIAL AND i_otfdata IS INITIAL AND xstring IS INITIAL AND string IS INITIAL AND NOT fichero IS INITIAL.
      zcl_ap_ficheros=&gt;leer_xstring( EXPORTING fichero = fichero
                                     IMPORTING xstring = l_xstring ).
    ENDIF.

    IF NOT content IS INITIAL.
      it_content = content.
    ELSEIF NOT i_otfdata IS INITIAL.
      LOOP AT i_otfdata INTO l_itcoo.
        CONCATENATE l_itcoo-tdprintcom l_itcoo-tdprintpar INTO ac.
        APPEND ac TO content_txt.
      ENDLOOP.
      l_len = l_longitud_pdf.
      l_transfer_bin = &apos;&apos;.
      l_extension = &apos;PDF&apos;.

      CALL FUNCTION &apos;SX_OBJECT_CONVERT_OTF_PDF&apos;
        EXPORTING  format_src      = &apos;OTF&apos;
                   format_dst      = &apos;PDF&apos;
                   devtype         = &apos;ASCIIPRI&apos;
        CHANGING   transfer_bin    = l_transfer_bin
                   len             = l_len
                   content_txt     = content_txt
                   content_bin     = content_bin
                   objhead         = objhead
        EXCEPTIONS err_conv_failed = 1
                   OTHERS          = 2.
      IF sy-subrc &lt;&gt; 0.
*       message
      ENDIF.

      l_size = l_len.
      CALL FUNCTION &apos;SCMS_BINARY_TO_XSTRING&apos;
        EXPORTING  input_length = l_size
        IMPORTING  buffer       = l_xstring
        TABLES     binary_tab   = content_bin
        EXCEPTIONS failed       = 1
                   OTHERS       = 2.
      IF sy-subrc &lt;&gt; 0.
*       message
      ENDIF.

      CALL FUNCTION &apos;SO_SOLIXTAB_TO_SOLITAB&apos;
        EXPORTING ip_solixtab = content_bin
        IMPORTING ep_solitab  = it_content.

    ELSEIF NOT l_xstring IS INITIAL.
      l_size = xstrlen( l_xstring ).
      l_offset = 0.
      WHILE l_offset &lt;= l_size.
        l_offset_old = l_offset.
        l_offset     = l_offset + 255 ##NUMBER_OK.
        IF l_offset &gt; l_size.
          l_temp_len = xstrlen( l_xstring+l_offset_old ).
          CLEAR l_content_bin-line WITH hex_null IN BYTE MODE.
          l_content_bin-line = l_xstring+l_offset_old(l_temp_len).
        ELSE.
          l_content_bin-line = l_xstring+l_offset_old(255).
        ENDIF.
        APPEND l_content_bin TO content_bin.
      ENDWHILE.

      CALL FUNCTION &apos;SO_SOLIXTAB_TO_SOLITAB&apos;
        EXPORTING ip_solixtab = content_bin
        IMPORTING ep_solitab  = it_content.

    ELSEIF NOT string IS INITIAL.
      l_size = strlen( string ).
      l_offset = 0.
      WHILE l_offset &lt;= l_size.
        l_offset_old = l_offset.
        l_offset     = l_offset + 255 ##NUMBER_OK.
        IF l_offset &gt; l_size.
          l_temp_len = strlen( string+l_offset_old ).
          CLEAR l_content_txt-line.
          l_content_txt-line = string+l_offset_old(l_temp_len).
        ELSE.
          l_content_txt-line = string+l_offset_old(255).
        ENDIF.
        APPEND l_content_txt TO it_content.
      ENDWHILE.
    ENDIF.

    IF NOT convert IS INITIAL.
      CALL FUNCTION &apos;SO_CONVERT_CONTENTS_BIN&apos;
        EXPORTING it_contents_bin = it_content
        IMPORTING et_contents_bin = it_content.
    ENDIF.

    CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
      EXPORTING  region    = &apos;B&apos;
      IMPORTING  folder_id = ls_fol_id
      EXCEPTIONS OTHERS    = 1.
    IF sy-subrc &lt;&gt; 0.
*       message
    ENDIF.

    ls_obj_data-objsns = &apos;O&apos;.
    ls_obj_data-objla  = sy-langu.
    ls_obj_data-objdes = titulo.

    l_fichero = fichero.

    IF reltype = &apos;NOTE&apos;.
      ls_obj_data-file_ext = &apos;TXT&apos;.
      l_obj_type = &apos;RAW&apos;.
    ELSE.
      l_obj_type = &apos;EXT&apos;.
      lv_offset = strlen( l_fichero ) - 3.
      IF lv_offset &gt; 0.
        ls_obj_data-file_ext = l_fichero+lv_offset(3).
      ENDIF.
    ENDIF.
    ls_obj_data-objlen = lines( it_content ) * 255 ##NUMBER_OK.

    IF NOT extension IS INITIAL.
      ls_obj_data-file_ext = extension.
    ENDIF.

    IF archiv_id IS INITIAL OR ar_object IS INITIAL.
      CALL FUNCTION &apos;SO_OBJECT_INSERT&apos;
        EXPORTING  folder_id             = ls_fol_id
                   object_type           = l_obj_type
                   object_hd_change      = ls_obj_data
        IMPORTING  object_id             = ls_obj_id
        TABLES     objhead               = it_objhead
                   objcont               = it_content
        EXCEPTIONS active_user_not_exist = 35 ##NUMBER_OK
                   folder_not_exist      = 6 ##NUMBER_OK
                   object_type_not_exist = 17 ##NUMBER_OK
                   owner_not_exist       = 22 ##NUMBER_OK
                   parameter_error       = 23 ##NUMBER_OK
                   OTHERS                = 1000 ##NUMBER_OK.

      IF sy-subrc = 0 AND ls_object-objkey IS NOT INITIAL.
        ls_folmem_k-foltp = ls_fol_id-objtp.
        ls_folmem_k-folyr = ls_fol_id-objyr.
        ls_folmem_k-folno = ls_fol_id-objno.
        ls_folmem_k-doctp = ls_obj_id-objtp.
        ls_folmem_k-docyr = ls_obj_id-objyr.
        ls_folmem_k-docno = ls_obj_id-objno.
        lv_ep_note = ls_folmem_k.
        ls_note-objtype = &apos;MESSAGE&apos;.
        ls_note-objkey  = lv_ep_note.
        CALL FUNCTION &apos;BINARY_RELATION_CREATE_COMMIT&apos;
          EXPORTING  obj_rolea    = ls_object
                     obj_roleb    = ls_note
                     relationtype = reltype
          EXCEPTIONS OTHERS       = 1.
        IF sy-subrc = 0.
          CLEAR error.
        ENDIF.
      ENDIF.
    ELSE.
      SELECT archiv_id FROM toaom
        INTO l_arcid
        UP TO 1 ROWS
        WHERE sap_object = tipo
          AND ar_object  = ar_object
        ORDER BY PRIMARY KEY.
      ENDSELECT.

      CALL FUNCTION &apos;SCMS_XSTRING_TO_BINARY&apos;
        EXPORTING buffer        = l_xstring
        IMPORTING output_length = l_size
        TABLES    binary_tab    = i_data.

      IF extension IS INITIAL.
        l_extension = zcl_ap_ficheros=&gt;get_extension( l_fichero ).
      ELSE.
        l_extension = extension.
      ENDIF.

      CALL FUNCTION &apos;SCMS_AO_TABLE_CREATE&apos;
        EXPORTING  arc_id       = l_arcid
                   doc_type     = l_extension
                   length       = l_size
        IMPORTING  doc_id       = l_arcdocid
        TABLES     data         = i_data
        EXCEPTIONS error_http   = 1
                   error_archiv = 2
                   error_kernel = 3
                   error_config = 4
                   OTHERS       = 5.
* realizamos la conexion de la imagen archivada
      IF sy-subrc = 0.
        l_descr = titulo.
        IF fichero IS INITIAL.
          CONCATENATE l_descr &apos;.&apos; l_extension INTO l_filename.
        ELSE.
          l_filename = fichero.
        ENDIF.
        l_object_id = clave.
        l_sap_object = tipo.
        CALL FUNCTION &apos;ARCHIV_CONNECTION_INSERT&apos;
          EXPORTING  archiv_id             = l_arcid
                     arc_doc_id            = l_arcdocid
                     ar_date               = sy-datum
                     ar_object             = ar_object
                     object_id             = l_object_id
                     sap_object            = l_sap_object
                     filename              = l_filename
                     doc_type              = l_extension
                     descr                 = l_descr
                     creator               = sy-uname
          EXCEPTIONS error_connectiontable = 1
                     OTHERS                = 2.
        IF sy-subrc = 0.
          CLEAR error.
          arc_doc_id = l_arcdocid.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_URL_GOS_ST" VERSION="1" LANGU="S" DESCRIPT="Insertar URL" EXPOSURE="2" STATE="1" EDITORDER="2 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-TYPEID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="CLAVE" VERSION="1" LANGU="S" DESCRIPT="Clave objeto" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-INSTID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="URL" VERSION="1" LANGU="S" DESCRIPT="URL" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="TITULO" VERSION="1" LANGU="S" DESCRIPT="Titulo" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="ERROR" VERSION="1" LANGU="S" DESCRIPT="Se ha producido un error" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="EKKO-LOEKZ"/>
  <source>METHOD insertar_url_gos_st.
    DATA: ls_object   TYPE borident,
          ls_fol_id   TYPE soodk,
          ls_obj_data TYPE sood1,
          ls_obj_id   TYPE soodk,
          ls_folmem_k TYPE sofmk,
          lv_ep_note  TYPE borident-objkey,
          ls_note     TYPE borident.

    DATA: it_content TYPE STANDARD TABLE OF soli,
          wa_content TYPE soli,
          it_objhead TYPE STANDARD TABLE OF soli.

    error = &apos;X&apos;.

    ls_object-objkey  = clave.
    ls_object-objtype = tipo.

    CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
      EXPORTING  region    = &apos;B&apos;
      IMPORTING  folder_id = ls_fol_id
      EXCEPTIONS OTHERS    = 1.
    IF sy-subrc &lt;&gt; 0.
*       message
    ENDIF.

    ls_obj_data-objsns = &apos;O&apos;.
    ls_obj_data-objla  = sy-langu.
    ls_obj_data-objdes = titulo.

    REFRESH it_content.
    CONCATENATE &apos;&amp;KEY&amp;&apos; url INTO wa_content.
    APPEND wa_content TO it_content.

    CALL FUNCTION &apos;SO_OBJECT_INSERT&apos;
      EXPORTING  folder_id             = ls_fol_id
                 object_type           = &apos;URL&apos;
                 object_hd_change      = ls_obj_data
      IMPORTING  object_id             = ls_obj_id
      TABLES     objhead               = it_objhead
                 objcont               = it_content
      EXCEPTIONS active_user_not_exist = 35 ##NUMBER_OK
                 folder_not_exist      = 6 ##NUMBER_OK
                 object_type_not_exist = 17 ##NUMBER_OK
                 owner_not_exist       = 22 ##NUMBER_OK
                 parameter_error       = 23 ##NUMBER_OK
                 OTHERS                = 1000 ##NUMBER_OK.

    IF sy-subrc = 0 AND ls_object-objkey IS NOT INITIAL.
      ls_folmem_k-foltp = ls_fol_id-objtp.
      ls_folmem_k-folyr = ls_fol_id-objyr.
      ls_folmem_k-folno = ls_fol_id-objno.
      ls_folmem_k-doctp = ls_obj_id-objtp.
      ls_folmem_k-docyr = ls_obj_id-objyr.
      ls_folmem_k-docno = ls_obj_id-objno.
      lv_ep_note = ls_folmem_k.
      ls_note-objtype = &apos;MESSAGE&apos;.
      ls_note-objkey  = lv_ep_note.
      CALL FUNCTION &apos;BINARY_RELATION_CREATE_COMMIT&apos;
        EXPORTING  obj_rolea    = ls_object
                   obj_roleb    = ls_note
                   relationtype = &apos;URL&apos;
        EXCEPTIONS OTHERS       = 1.
      IF sy-subrc = 0.
        CLEAR error.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="INSERTA_BOTON_GOS" VERSION="1" LANGU="S" DESCRIPT="Inserta Boton GOS" EXPOSURE="2" STATE="1" EDITORDER="7 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <source>METHOD inserta_boton_gos.
*  if not p_matnr is initial.
*    data: lo_manager  type ref to cl_gos_manager,
*          la_obj      type borident.
**
**
** Set object Key
*    la_obj-objtype = &apos;ZCURSO_TMP&apos;.
*    la_obj-objkey  =  p_matnr.
**
** GOS toolbar
*    create object lo_manager
*      exporting
*        is_object    = la_obj
*        ip_no_commit = space
*      exceptions
*        others       = 1.
*  else.
*    if not lo_manager is initial.
*      lo_manager-&gt;unpublish( ).
*      clear lo_manager.
*    endif.
*  endif.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="LEER_NOTA" VERSION="1" LANGU="S" DESCRIPT="Lee nota" EXPOSURE="2" STATE="1" EDITORDER="21 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="LEER_NOTA" SCONAME="CLAVE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="LEER_NOTA" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Local Persistent Object Reference - BOR Compatible" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="LEER_NOTA" SCONAME="DESCRIPCION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="LEER_NOTA" SCONAME="CONTENIDO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="LEER_NOTA" SCONAME="CONTENIDO_XSTRING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="XSTRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="LEER_NOTA" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Table with BAPI Return Information" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRETTAB"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="LEER_NOTA" SCONAME="DESCRIPCION_SALIDA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <source>METHOD leer_nota.
    DATA sood TYPE sood.

    CLEAR: contenido_xstring,
           i_return,
           descripcion_salida,
           contenido.

    sood = get_nota( tipo        = tipo
                     clave       = clave
                     descripcion = descripcion ).

    IF sood IS INITIAL.
      RETURN.
    ENDIF.

    get_file_xstring( EXPORTING doctp         = sood-objtp
                                docyr         = sood-objyr
                                docno         = sood-objno
                      IMPORTING o_content     = contenido
                                o_content_hex = contenido_xstring
                                i_return      = i_return ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="MODIFICAR_NOTA" VERSION="1" LANGU="S" DESCRIPT="Modificar nota" EXPOSURE="2" STATE="1" EDITORDER="22 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="MODIFICAR_NOTA" SCONAME="SOOD" VERSION="1" LANGU="S" DESCRIPT="SAPoffice: Definición de objetos" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SOOD"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="MODIFICAR_NOTA" SCONAME="CONTENIDO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="MODIFICAR_NOTA" SCONAME="MESSAGE" VERSION="1" LANGU="S" DESCRIPT="Texto de mensaje" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD modificar_nota.
    DATA: folder_id        TYPE soodk,
          object_id        TYPE soodk,
          object_hd_change TYPE sood1,
          size             TYPE i,
          offset           TYPE i,
          offset_old       TYPE i,
          temp_len         TYPE i,
          ls_data          TYPE soli,
          objcont          TYPE TABLE OF soli,
          objhead          TYPE TABLE OF soli.

    CALL FUNCTION &apos;SO_FOLDER_ROOT_ID_GET&apos;
      EXPORTING region    = &apos;B&apos;
      IMPORTING folder_id = folder_id.

    MOVE-CORRESPONDING sood TO object_id.
    MOVE-CORRESPONDING sood TO object_hd_change.
    size   = strlen( contenido ).
    offset = 0.
    WHILE offset &lt;= size.
      offset_old = offset.
      offset     = offset + 255 ##NUMBER_OK.
      IF offset &gt; size.
        temp_len = strlen( contenido+offset_old ).
        CLEAR ls_data-line.
        ls_data-line = contenido+offset_old(temp_len).
      ELSE.
        ls_data-line = contenido+offset_old(255).
      ENDIF.
      APPEND ls_data TO objcont.
    ENDWHILE.

    CALL FUNCTION &apos;SO_OBJECT_UPDATE&apos;
      EXPORTING  folder_id                  = folder_id
*                 FORWARDER                  = &apos; &apos;
*                 OBJECT_FL_CHANGE           = &apos; &apos;
                 object_hd_change           = object_hd_change
                 object_id                  = object_id
*                 OBJECT_REAPPEAR            = &apos; &apos;
*                 OWNER                      = &apos; &apos;
*   IMPORTING
*                 OBJECT_FL_DISPLAY          = OBJECT_FL_DISPLAY
*                 OBJECT_HD_DISPLAY          = OBJECT_HD_DISPLAY
      TABLES     objcont                    = objcont
                 objhead                    = objhead
*                 OBJPARA                    = OBJPARA
*                 OBJPARB                    = OBJPARB
      EXCEPTIONS active_user_not_exist      = 1
                 communication_failure      = 2
                 component_not_available    = 3
                 folder_not_exist           = 4
                 folder_no_authorization    = 5
                 forwarder_not_exist        = 6
                 object_not_exist           = 7
                 object_no_authorization    = 8
                 operation_no_authorization = 9
                 owner_not_exist            = 10 ##NUMBER_OK
                 parameter_error            = 11 ##NUMBER_OK
                 substitute_not_active      = 12 ##NUMBER_OK
                 substitute_not_defined     = 13 ##NUMBER_OK
                 system_failure             = 14 ##NUMBER_OK
                 x_error                    = 15 ##NUMBER_OK.

    IF sy-subrc &lt;&gt; 0.
      __concat3 message &apos;Error&apos;(err) sy-subrc &apos;modificando nota&apos;(mno).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="URLS_GOS_ST" VERSION="1" LANGU="S" DESCRIPT="Devuelve lista de URLs de GOS" EXPOSURE="2" STATE="1" EDITORDER="1 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="URLS_GOS_ST" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SRGBTBREL-TYPEID_A"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="URLS_GOS_ST" SCONAME="CLAVE" VERSION="1" LANGU="S" DESCRIPT="Clave objeto" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="URLS_GOS_ST" SCONAME="ATTA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="URLS_GOS_ST" SCONAME="URL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="URLS_GOS_ST" SCONAME="NOTAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="URLS_GOS_ST" SCONAME="TABLA" VERSION="1" LANGU="S" DESCRIPT="URL GOS" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ZTAB_URL_GOS"/>
  <source>METHOD urls_gos_st.
    DATA: i_urls      TYPE TABLE OF srgbtbrel,
          l_srgbtbrel TYPE srgbtbrel,
          l_soodk     TYPE soodk,
          i_objcont   TYPE TABLE OF soli,
          l_folder_id TYPE soodk,
          l_sood2     TYPE sood2,
          l_url       TYPE zest_url_gos,
          l_objcont   TYPE soli,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_aux       TYPE string.

    IF url = &apos;X&apos;.
      SELECT instid_b reltype utctime
        FROM srgbtbrel
        INTO CORRESPONDING FIELDS OF TABLE i_urls
        WHERE reltype  = &apos;URL&apos;
          AND instid_a = clave
          AND typeid_a = tipo
          AND catid_a  = &apos;BO&apos;.
    ENDIF.

    IF atta = &apos;X&apos;.
      SELECT instid_b reltype utctime
        FROM srgbtbrel
        APPENDING CORRESPONDING FIELDS OF TABLE i_urls
        WHERE reltype  = &apos;ATTA&apos;
          AND instid_a = clave
          AND typeid_a = tipo
          AND catid_a  = &apos;BO&apos;.
    ENDIF.

    IF notas = &apos;X&apos;.
      SELECT instid_b reltype utctime
        FROM srgbtbrel
        APPENDING CORRESPONDING FIELDS OF TABLE i_urls
        WHERE reltype  = &apos;NOTE&apos;
          AND instid_a = clave
          AND typeid_a = tipo
          AND catid_a  = &apos;BO&apos;.
    ENDIF.

    LOOP AT i_urls INTO l_srgbtbrel.
      l_soodk = l_srgbtbrel-instid_b+17.
      REFRESH i_objcont.
      l_folder_id = l_srgbtbrel-instid_b(17).
      CALL FUNCTION &apos;SO_OBJECT_READ&apos;
        EXPORTING
*                   FILTER                     =
                   folder_id                  = l_folder_id
*                   FORWARDER                  =
                   object_id                  = l_soodk
*                   OWNER                      =
*                   F_MAILER                   = &apos; &apos;
        IMPORTING
*                   OBJECT_FL_DISPLAY          =
                   object_hd_display          = l_sood2
*                   OBJECT_RC_DISPLAY          =
        TABLES     objcont                    = i_objcont
*                   OBJHEAD                    =
*                   OBJPARA                    =
*                   OBJPARB                    =
        EXCEPTIONS active_user_not_exist      = 1
                   communication_failure      = 2
                   component_not_available    = 3
                   folder_not_exist           = 4
                   folder_no_authorization    = 5
                   object_not_exist           = 6
                   object_no_authorization    = 7
                   operation_no_authorization = 8
                   owner_not_exist            = 9
                   parameter_error            = 10 ##NUMBER_OK
                   substitute_not_active      = 11 ##NUMBER_OK
                   substitute_not_defined     = 12 ##NUMBER_OK
                   system_failure             = 13 ##NUMBER_OK
                   x_error                    = 14 ##NUMBER_OK
                   OTHERS                     = 15 ##NUMBER_OK.
      IF sy-subrc &lt;&gt; 0.
*       message
      ENDIF.
      l_url-titulo   = l_sood2-objdes.
      l_url-file_ext = l_sood2-file_ext.
      CALL FUNCTION &apos;WRF_PBAS_TIMESTAMP_TO_DATE&apos;
        EXPORTING  i_timestamp       = l_srgbtbrel-utctime
                   i_tzone           = sy-zonlo
        IMPORTING  e_datlo           = l_url-fecha_creacion
                   e_timlo           = l_url-hora_creacion
        EXCEPTIONS invalid_date      = 1
                   invalid_time      = 2
                   invalid_date_time = 3
                   OTHERS            = 4.
      IF sy-subrc &lt;&gt; 0.
*       message
      ENDIF.

      LOOP AT i_objcont INTO l_objcont.
        IF l_srgbtbrel-reltype = &apos;NOTE&apos;.
          IF l_url-url IS INITIAL.
            l_url-url = l_objcont.
          ELSE.
            CONCATENATE l_url-url l_objcont INTO l_url-url SEPARATED BY space.
          ENDIF.
        ELSE.
          SPLIT l_objcont AT &apos;&amp;KEY&amp;&apos; INTO l_aux l_url-url.
        ENDIF.
      ENDLOOP.
      APPEND l_url TO tabla.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="VIEW_GOS" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="26 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VIEW_GOS" SCONAME="TIPO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VIEW_GOS" SCONAME="CLAVE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VIEW_GOS" SCONAME="ATTA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VIEW_GOS" SCONAME="URL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VIEW_GOS" SCONAME="NOTAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VIEW_GOS" SCONAME="AR_OBJECT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VIEW_GOS" SCONAME="POPUP_SI_NO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VIEW_GOS" SCONAME="SERVICIO_CREAR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SGS_SRVNAM" PARVALUE="&apos;&apos;"/>
  <source>METHOD view_gos.
    DATA: l_num_gos        TYPE i,
          l_servicio_crear TYPE sgs_srvnam,
          i_attachments    TYPE zt_sood,
          l_sood           TYPE sood,
          l_sood4          TYPE sood4,
          documents        TYPE TABLE OF sood4.

    l_num_gos = get_num_gos( tipo      = tipo
                             clave     = clave
                             atta      = atta
                             url       = url
                             notas     = notas
                             ar_object = ar_object ).

    IF ( l_num_gos = 0 AND popup_si_no = &apos;X&apos; ) OR l_num_gos &gt; 1.
      IF servicio_crear IS INITIAL.
        IF atta = &apos;X&apos;.
          IF ar_object IS INITIAL.
            l_servicio_crear = &apos;PCATTA_CREA&apos;.
          ELSE.
            l_servicio_crear = &apos;ARL_LINK&apos;.
          ENDIF.
        ELSEIF url = &apos;X&apos;.
          l_servicio_crear = &apos;URL_CREA&apos;.
        ENDIF.
      ELSE.
        l_servicio_crear = servicio_crear.
      ENDIF.

      get_popup_gos( objeto         = tipo
                     clave          = clave
                     ar_object      = ar_object
                     servicio_crear = l_servicio_crear ).
    ELSE.
      IF ar_object IS INITIAL.
        get_file_list( EXPORTING instid        = clave
                                 typeid        = tipo
                       CHANGING  i_attachments = i_attachments ).
        READ TABLE i_attachments INTO l_sood INDEX 1.       &quot;#EC CI_NOORDER
        IF sy-subrc = 0.
          MOVE-CORRESPONDING l_sood TO l_sood4.
          APPEND l_sood4 TO documents.
          CALL FUNCTION &apos;SO_DOCUMENTS_MANAGER&apos;
            EXPORTING activity  = &apos;DISP&apos;
            TABLES    documents = documents.
        ENDIF.
      ELSE.
        DATA(i_ficheros) = get_archivelink_files_m( sap_object    = tipo
                                                    object_id     = clave
                                                    ar_object     = ar_object    &quot; Clase documentos
*                                                    reserve       = reserve    &quot; SAP ArchiveLink: Reserva para aplicaciones futuras
                                                    get_contenido = &apos;&apos; ).
        ASSIGN i_ficheros[ 1 ] TO FIELD-SYMBOL(&lt;fichero&gt;).
        IF sy-subrc = 0.
          CALL FUNCTION &apos;ARCHIVOBJECT_DISPLAY&apos;
            EXPORTING  archiv_doc_id            = &lt;fichero&gt;-arc_doc_id
                       archiv_id                = &lt;fichero&gt;-archiv_id
                       ar_object                = ar_object
            EXCEPTIONS error_archiv             = 1
                       error_communicationtable = 2
                       error_kernel             = 3
                       OTHERS                   = 4.
          IF sy-subrc &lt;&gt; 0.
*         MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
*                    WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR" VERSION="1" LANGU="S" DESCRIPT="Visualizar" EXPOSURE="2" STATE="1" EDITORDER="29 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR" SCONAME="OBJTP" VERSION="1" LANGU="S" DESCRIPT="Sigla p.tipo de documento" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_TP"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR" SCONAME="OBJYR" VERSION="1" LANGU="S" DESCRIPT="Objeto: Año de ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_YR"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR" SCONAME="OBJNO" VERSION="1" LANGU="S" DESCRIPT="Objeto: Número de ID" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SO_OBJ_NO"/>
  <source>METHOD visualizar.
    DATA: o_fichero     TYPE string,
          o_mimetype    TYPE w3conttype,
          o_content     TYPE string,
          o_content_hex TYPE xstring,
          i_return      TYPE bapirettab,
          l_longitud    TYPE i,
          l_file        TYPE string.

    get_file_xstring( EXPORTING doctp         = objtp
                                docyr         = objyr
                                docno         = objno
                      IMPORTING o_fichero     = o_fichero
                                o_mimetype    = o_mimetype
                                o_content     = o_content
                                o_content_hex = o_content_hex
                                i_return      = i_return
                                longitud      = l_longitud ).
    IF NOT l_longitud IS INITIAL.
      l_file = o_fichero.
      l_file = zcl_ap_ficheros=&gt;get_directorio_temporal( fichero = l_file ).
      zcl_ap_ficheros=&gt;grabar_xstring( EXPORTING xstring       = o_content_hex
                                                 fichero       = l_file
                                                 mostrar_error = &apos;&apos;
                                       IMPORTING mensaje       = DATA(l_msg) ).
      IF l_msg IS INITIAL.
        visualizar_fichero_st( l_file ).
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" VERSION="1" LANGU="S" DESCRIPT="Visualizar adjunto" EXPOSURE="2" STATE="1" EDITORDER="3 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="FICHERO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="IMPRIMIR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="ARCHIV_ID" VERSION="1" LANGU="S" DESCRIPT="Identificación Repository contenidos" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TOA01-ARCHIV_ID" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="EXTENSION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="NAVEGADOR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="DOKAR" VERSION="1" LANGU="S" DESCRIPT="Clase de documento" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="DRAW-DOKAR" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="DOKNR" VERSION="1" LANGU="S" DESCRIPT="Número de documento" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="DRAW-DOKNR" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="DOKTL" VERSION="1" LANGU="S" DESCRIPT="Documentación - Líneas de texto" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="DRAW-DOKTL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="DOKVR" VERSION="1" LANGU="S" DESCRIPT="Versión documento" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="DRAW-DOKVR" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="URL2LOCAL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_GOS" CMPNAME="VISUALIZAR_FICHERO_ST" SCONAME="NOMBRE_FICHERO_TEMP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="11 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <source>METHOD visualizar_fichero_st.
    DATA: l_fichero       TYPE dsvasdocid,
          l_extension     TYPE dsvasdocid,
          l_archiv_doc_id TYPE sapb-sapadokid,
          l_archiv_id     TYPE toaar-archiv_id,
          l_dappl         TYPE draw-dappl,
          l_file          TYPE c LENGTH 255,
          l_program       TYPE c LENGTH 255,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_ext           TYPE c LENGTH 50,
          l_aux           TYPE c LENGTH 255,
          l_opc_imprimir  TYPE c LENGTH 10.
    DATA l_url                 TYPE string.
    DATA l_nombre_fichero_temp TYPE string.
    DATA i_doc                 TYPE TABLE OF sood4.
    DATA application           TYPE string.
    DATA parameter             TYPE string.

    l_fichero = fichero.

    l_extension = l_fichero(8).
    l_extension = to_lower( l_extension ).
    IF l_extension CS &apos;https://&apos; OR l_extension CS &apos;http://&apos;.
      DATA(l_es_url) = &apos;X&apos;.
      IF url2local = &apos;X&apos;.
        l_url = fichero.
        IF l_fichero CS &apos;sharepoint&apos; AND NOT l_fichero CS &apos;?download=1&apos;.
          CONCATENATE l_fichero &apos;?download=1&apos; INTO l_url.
        ENDIF.
        zcl_ap_ws=&gt;get_fichero_local( EXPORTING url     = l_url
                                      IMPORTING xstring = DATA(l_xstring) ).
        IF NOT l_xstring IS INITIAL.
          DATA(l_string) = zcl_ap_string=&gt;xstring2string( l_xstring ).
          IF l_string CS &apos;%PDF&apos; AND nombre_fichero_temp IS INITIAL.
            l_nombre_fichero_temp = &apos;pdf.pdf&apos;.
          ELSE.
            l_nombre_fichero_temp = nombre_fichero_temp.
          ENDIF.

          DATA(l_msg) = zcl_ap_ficheros=&gt;visualizar( xstring = l_xstring
                                                     fichero = l_nombre_fichero_temp ).
          IF l_msg IS INITIAL.
            RETURN.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

    IF NOT archiv_id IS INITIAL.
      IF NOT fichero IS INITIAL.
        l_archiv_doc_id = fichero.
        l_archiv_id = archiv_id.
        CALL FUNCTION &apos;ARCHIVOBJECT_DISPLAY&apos;
          EXPORTING  archiv_doc_id            = l_archiv_doc_id
*                     ARCHIV_DOC_INDEX         = &apos; &apos;
                     archiv_id                = l_archiv_id
*                     OBJECTTYPE               = &apos; &apos;
*                     OBJECT_ID                = &apos; &apos;
*                     AR_OBJECT                = &apos; &apos;
*                     LANGUAGE                 = &apos; &apos;
*                     SIGN                     = &apos; &apos;
*                     WINDOW_ID                = &apos; &apos;
*                     WINDOW_TITLE             = &apos; &apos;
*                     DOC_TYPE                 = &apos; &apos;
*                     POSITIONINALFFILE        = &apos; &apos;
*                     NOGET                    = &apos; &apos;
*                     PATHOFFILE               = &apos; &apos;
*                     EOF                      = &apos; &apos;
*                     DALENGTH                 = &apos; &apos;
*                     PFSTATUS                 = &apos; &apos;
*                     REPORT                   = &apos; &apos;
*                     MULTIPLE                 = &apos; &apos;
* IMPORTING
*                     RETURNCODE               =
* TABLES
*                     DISPDOCS                 =
          EXCEPTIONS error_archiv             = 1
                     error_communicationtable = 2
                     error_kernel             = 3
                     OTHERS                   = 4.
        IF sy-subrc &lt;&gt; 0.
          MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
                  WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
        ENDIF.
      ENDIF.
    ELSEIF NOT doknr IS INITIAL.
      zcl_ap_gd=&gt;get_anexos_contenido( EXPORTING dokar               = dokar
                                                 doknr               = doknr
                                                 doktl               = doktl
                                                 dokvr               = dokvr
                                                 kpro_use            = &apos;X&apos;
                                       &quot; TODO: variable is assigned but never used (ABAP cleaner)
                                       IMPORTING i_documents         = DATA(i_documents)
                                                 i_contenido_xstring = DATA(i_contenido) ).
      LOOP AT i_contenido ASSIGNING FIELD-SYMBOL(&lt;contenido&gt;) WHERE filename CS fichero.
        zcl_ap_ficheros=&gt;visualizar( fichero = fichero
                                     xstring = &lt;contenido&gt;-xstring ).
      ENDLOOP.
    ELSEIF fichero(3) = &apos;FOL&apos; AND fichero+17(3) = &apos;EXT&apos;.
      APPEND fichero TO i_doc.
      CALL FUNCTION &apos;SO_DOCUMENTS_MANAGER&apos;
        EXPORTING activity  = &apos;DISP&apos;
*                  OFFICE_USER =
        TABLES    documents = i_doc.
    ELSE.
      IF l_es_url = &apos;X&apos; OR sy-sysid = &apos;NSP&apos; OR navegador = &apos;X&apos;.
        CALL FUNCTION &apos;PRGN_GENER_EXECUTE_URL&apos;
          EXPORTING node_data = l_fichero.
      ELSE.
        IF extension IS INITIAL.
          l_extension = zcl_ap_ficheros=&gt;get_extension( l_fichero ).
        ELSE.
          l_extension = extension.
        ENDIF.
        l_dappl = l_extension.
        l_dappl = to_upper( l_dappl ).                    &quot;#EC *
        l_file = fichero.
        IF navegador = &apos;E&apos; OR l_dappl = &apos;XLS&apos; OR l_dappl = &apos;DOC&apos;.
          sy-subrc = 4.
        ELSE.
          CALL FUNCTION &apos;CV120_START_APPLICATION&apos;
            EXPORTING  pf_dappl       = l_dappl
                       pf_file        = l_file
            EXCEPTIONS error          = 1
                       file_not_found = 2
                       OTHERS         = 3.
        ENDIF.
        IF sy-subrc &lt;&gt; 0.
          l_file = fichero.
          IF NOT extension IS INITIAL.
            CONCATENATE fichero &apos;.&apos; extension INTO l_file.
          ENDIF.
          CALL FUNCTION &apos;CV120_GET_APPL_FROM_REGISTRY&apos;
            EXPORTING  pf_apptp         = &apos;1&apos;
                       pf_file          = l_file
            IMPORTING  pfx_program      = l_program
            EXCEPTIONS no_valid_program = 1
                       OTHERS           = 2.
          IF sy-subrc &lt;&gt; 0.
            l_file = fichero.
            CONCATENATE &apos;.&apos; l_dappl INTO l_ext.
            REPLACE l_ext WITH &apos;.HTM&apos; INTO l_file.
            CALL FUNCTION &apos;CV120_GET_APPL_FROM_REGISTRY&apos;
              EXPORTING  pf_apptp         = &apos;1&apos;
                         pf_file          = l_file
              IMPORTING  pfx_program      = l_program
              EXCEPTIONS no_valid_program = 1
                         OTHERS           = 2.
            IF sy-subrc &lt;&gt; 0.
*       message
            ENDIF.
          ENDIF.
          IF NOT l_fichero IS INITIAL.
            IF l_program IS INITIAL.
              CALL FUNCTION &apos;PRGN_GENER_EXECUTE_URL&apos;
                EXPORTING node_data = l_fichero.
            ELSE.
              SPLIT l_program+1 AT &apos;&quot;&apos; INTO l_program l_aux.
              IF l_program(1) = &apos;:&apos;.
                CONCATENATE &apos;c&apos; l_program INTO l_program.
              ENDIF.
              REPLACE &apos;%f&apos; WITH &apos;&apos; INTO l_program.
              CLEAR l_aux.
              IF imprimir = &apos;X&apos;.
                l_extension = to_upper( l_extension ).
                CASE l_extension.
                  WHEN &apos;PDF&apos;.
                    l_opc_imprimir = &apos;/t&apos;.
                  WHEN &apos;DOC&apos; OR &apos;DOCX&apos;.
                    l_opc_imprimir = &apos;/i&apos;.
                  WHEN &apos;XLS&apos; OR &apos;XLSX&apos;.
                    l_opc_imprimir = &apos;/i&apos;.

                ENDCASE.
              ENDIF.
              CONCATENATE &apos;&quot;&apos; fichero &apos;&quot;&apos; INTO l_aux.

              IF NOT l_opc_imprimir IS INITIAL.
                CONCATENATE l_opc_imprimir l_aux INTO l_aux SEPARATED BY space.
              ENDIF.

              application = l_program.
              parameter = l_aux.
              cl_gui_frontend_services=&gt;execute( EXPORTING
*                                                            document               = document
                                                            application            = application
                                                            parameter              = parameter
*                                                            default_directory      = default_directory
*                                                            maximized              = maximized
*                                                            minimized              = minimized
*                                                            synchronous            = synchronous
*                                                            operation              = &apos;OPEN&apos;
                                                 EXCEPTIONS cntl_error             = 1
                                                            error_no_gui           = 2
                                                            bad_parameter          = 3
                                                            file_not_found         = 4
                                                            path_not_found         = 5
                                                            file_extension_unknown = 6
                                                            error_execute_failed   = 7
                                                            synchronous_failed     = 8
                                                            not_supported_by_gui   = 9 ).
              IF sy-subrc &lt;&gt; 0.
                MESSAGE &apos;Error abriendo fichero&apos;(eaf) TYPE &apos;E&apos;.
              ENDIF.

*            CALL FUNCTION &apos;WS_EXECUTE&apos;
*              EXPORTING
*                commandline        = l_aux
*                program            = l_program
*              EXCEPTIONS
*                frontend_error     = 1
*                no_batch           = 2
*                prog_not_found     = 3
*                illegal_option     = 4
*                gui_refuse_execute = 5
*                OTHERS             = 6.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
</CLAS>
