
*------TABLAS INTERNAS-------------------------------------------------*
TABLES: tadir, zestadisticas.

DATA: BEGIN OF i_datos OCCURS 1000,
       account    LIKE stad_output-account,
       date       LIKE stad_output-date,
  starttime  LIKE stad_output-starttime,
       endti      LIKE stad_output-endti,
       tcode      LIKE stad_output-tcode,
       terminalid LIKE stad_output-terminalid,
       report     LIKE stad_output-report,
       btcjobname    LIKE stad_output-btcjobname,
       jobstep    LIKE stad_output-btcstepnr,
       tabload    LIKE stad_output-tabload,
       dynpronr   LIKE stad_output-dynpronr,
  respti LIKE stad_output-respti,
dbcalls LIKE stad_output-dbcalls,
     END OF i_datos.

DATA: BEGIN OF i_aux OCCURS 1000,
       account    LIKE stad_output-account,
       tcode      LIKE stad_output-tcode,
       report     LIKE stad_output-report,
       date       LIKE stad_output-date,
       endti      LIKE stad_output-endti,
       terminalid LIKE stad_output-terminalid,
       btcjobname    LIKE stad_output-btcjobname,
  starttime  LIKE stad_output-starttime,
  respti LIKE stad_output-respti,
dbcalls LIKE stad_output-dbcalls,
     END OF i_aux.
*------VARIABLES-------------------------------------------------------*

*** INICIO MODIFICACIONES
PARAMETERS:      p_act AS CHECKBOX DEFAULT ' ',
                p_list AS CHECKBOX DEFAULT 'X'.
*** FIN MODIFICACIONES

*** INICIO MODIFICACIONES
********************************** ALV *********************************
TYPE-POOLS: slis.

DATA: alv_fieldtab TYPE slis_t_fieldcat_alv,
     alv_heading  TYPE slis_t_listheader,
     alv_layout   TYPE slis_layout_alv,
     alv_events   TYPE slis_t_event,
     alv_sort     TYPE slis_t_sortinfo_alv,
     alv_filter   TYPE slis_t_filter_alv,
     alv_repname  LIKE sy-repid,
     alv_f2code   LIKE sy-ucomm VALUE  '&ETA',
     alv_g_save(1) TYPE c,
     alv_g_exit(1) TYPE c.
DATA: alv_fieldcat TYPE slis_fieldcat_alv.
*** FIN MODIFICACIONES













FORM zwrite_mainlist USING rmode.

* local help data
  DATA: zeilen        TYPE i      VALUE 0,
        kbyte         TYPE p,
        output_flag.

* progress indicator
*
  output_flag = 'X'.
  CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
    EXPORTING
      percentage = 0
      text       = 'Preparing output'
    EXCEPTIONS
      OTHERS     = 1.
*
* clear workareas
  CLEAR: wa_stats_c_lv0, wa_stats_c_lv1, wa_main, wa_all_stats.

* set status, titlebar and start date
  IF simple_mode = abap_true.
    REFRESH buttons.
    buttons-exclude = 'OPAL'.
    APPEND buttons.
    buttons-exclude = 'CLAL'.
    APPEND buttons.
    buttons-exclude = 'FILC'.
    APPEND buttons.
    buttons-exclude = 'CLII'.
    APPEND buttons.
    IF loghandle IS INITIAL.
      buttons-exclude = 'ALOG'.
      APPEND buttons.
    ENDIF.
    SET PF-STATUS 'MAIN_SMALL' EXCLUDING buttons.
    SET TITLEBAR '012'.
  ELSE.
    CASE rmode.
      WHEN 'c' OR 'C'.
        IF overall_opened_level = 1.
          SET PF-STATUS 'MAIN' EXCLUDING 'OPAL'.
        ELSE.
          SET PF-STATUS 'MAIN' EXCLUDING 'CLAL'.
        ENDIF.
        SET TITLEBAR '010'.
      WHEN 'b' OR 'B'.
        REFRESH buttons.
        buttons-exclude = 'OPAL'.
        APPEND buttons.
        buttons-exclude = 'CLAL'.
        APPEND buttons.
        buttons-exclude = 'FILC'.
        APPEND buttons.
        SET PF-STATUS 'MAIN' EXCLUDING buttons.
        SET TITLEBAR '012'.
      WHEN OTHERS.
        REFRESH buttons.
        buttons-exclude = 'OPAL'.
        APPEND buttons.
        buttons-exclude = 'CLAL'.
        APPEND buttons.
        buttons-exclude = 'FILC'.
        APPEND buttons.
        buttons-exclude = 'CLII'.
        APPEND buttons.
        SET PF-STATUS 'MAIN' EXCLUDING buttons.
        SET TITLEBAR '012'.
    ENDCASE.
  ENDIF.
  save_date = selection-sdat.

* check wether table ausgabe is filled (Outputfields)
  DESCRIBE TABLE ausgabe LINES zeilen.
  IF zeilen < 1.
    PERFORM fill_ausgabe.
  ENDIF.

* get and set line-size
  PERFORM get_breite USING rmode.
  NEW-PAGE LINE-SIZE breite.

* check wether records have been read
  READ TABLE all_stats TRANSPORTING NO FIELDS INDEX 1.
  IF sy-subrc <> 0.
    FORMAT COLOR 1 INVERSE.
    WRITE: /   sy-vline,
            30 '* No records received for current selection. *',
            AT breite sy-vline.
  ENDIF.

* write records ------------------------------------------------------ *
  CASE rmode.
*
    WHEN 'c' OR 'C'.
* display mode aggregation by trans-ID ---------------------------------
* level 0 ----------------------------
      DESCRIBE TABLE stats_c_lv0 LINES zeilen.
* check if stats_c_lv0 already has been filled
      IF zeilen = 0.
        PERFORM fill_c_level_0.
      ENDIF.
      " 11/99 copy-free loop:
      LOOP AT stats_c_lv0 INTO wa_stats_c_lv0.
* Sätze ohne Trans-ID ausfiltern
        CHECK wa_stats_c_lv0-main-transid <> space.
* check user is in selection
        CHECK wa_stats_c_lv0-main-account CP selection-sbenu.
* are further selection criteria set?
        IF selection-sresptime > 0 OR
           selection-scputime  > 0 OR
           selection-sdbtime   > 0 OR
           selection-sbytes    > 0 OR
           selection-schg      > 0.
          kbyte =   wa_stats_c_lv0-main-bytes / 1024.
          CHECK wa_stats_c_lv0-main-respti     >= selection-sresptime
          AND
                wa_stats_c_lv0-main-cputi      >= selection-scputime
                AND
                wa_stats_c_lv0-main-dbcallti   >= selection-sdbtime
                AND
                kbyte                          >= selection-sbytes
                AND
                  wa_stats_c_lv0-main-phychngcnt >= selection-schg.
        ENDIF.
* if a filter (mode c, level 0) is set, check selection
*@AD new(7.0)
*        lv0_filter-tcode = selection-stcod.
*        lv0_filter-program = selection-sprogram.
*
        IF lv0_filter-tcode <> '*'.
          CHECK ( wa_stats_c_lv0-main-tcode CP lv0_filter-tcode OR
                  wa_stats_c_lv0-action     CP lv0_filter-tcode ).
        ENDIF.
        IF lv0_filter-program <> '*'.
          CHECK ( wa_stats_c_lv0-main-report CP lv0_filter-program OR
                  wa_stats_c_lv0-action      CP lv0_filter-program ).
        ENDIF.
        IF lv0_filter-transid <> '*'.
          CHECK wa_stats_c_lv0-main-transid CP lv0_filter-transid.
        ENDIF.
* initialize some stuff
        save_clv0_tabix = sy-tabix.
        level = 0. opened_level = -1.
* get client info top level
        IF client_info_only = 'X'.
          CHECK wa_stats_c_lv0-subclir IS NOT INITIAL.
*AD          READ TABLE wa_stats_c_lv0-subclir INDEX 1 INTO wa_info.
          MOVE-CORRESPONDING wa_stats_c_lv0-subclir TO wa_info.
          PERFORM push_client_info." using wa_info.
        ENDIF.
* check if level 0 is opened
        IF wa_stats_c_lv0-opened <> space AND wa_stats_c_lv0-steps > 1.
          ADD 1 TO opened_level.
          PERFORM zwrite_main_record USING level opened_level.
* level 1 ----------------------------
          READ TABLE stats_c_lv1 INTO wa_stats_c_lv1 WITH KEY
                          main-transid = wa_stats_c_lv0-main-transid.
          IF sy-subrc <> 0.
            PERFORM fill_c_level_1 USING wa_stats_c_lv0-main-transid.
          ENDIF.
          " 11/99 copy-free loop:
          LOOP AT stats_c_lv1 INTO wa_stats_c_lv1
                     WHERE main-transid = wa_stats_c_lv0-main-transid.
            save_clv1_tabix = sy-tabix.
            level = 1. opened_level = 0.
* check if level 1 is opened and more than 1 step
            IF wa_stats_c_lv1-opened <> space
                               AND wa_stats_c_lv1-steps > 1.
              ADD 1 TO opened_level.
              PERFORM zwrite_main_record USING level opened_level.
* level 2 ----------------------------
              level = 2.
              LOOP AT navigate
                          WHERE transid = wa_stats_c_lv0-main-transid.
                CLEAR: wa_all_stats, wa_main.
                READ TABLE all_stats INTO wa_all_stats
                                            INDEX navigate-record_idx.
*                READ TABLE wa_all_stats-main INTO wa_main
*                                            INDEX navigate-main_idx.
                MOVE-CORRESPONDING wa_all_stats-main TO wa_main.
                CHECK wa_main-tasktype = wa_stats_c_lv1-main-tasktype.
                CHECK wa_main-instance = wa_stats_c_lv1-main-instance.
                CHECK wa_main-okey     = wa_stats_c_lv1-main-okey.
                PERFORM zwrite_main_record USING level opened_level.
              ENDLOOP.                 "navigate
* if level 1 is closed or only one step don't display level 2
            ELSE.
              PERFORM zwrite_main_record USING level opened_level.
            ENDIF.
*            clear wa_stats_c_lv1.     "copy-free loop instead
          ENDLOOP.                     "stats_c_lv1
* if level 0 is closed or only one step display only this level
        ELSE.
          PERFORM zwrite_main_record USING level opened_level.
        ENDIF.
*        clear wa_stats_c_lv0.         "copy-free loop instead
      ENDLOOP.                         "stats_c_lv0
    WHEN 'b' OR 'B'.
* display mode all records grouped by trans-ID -------------------------
      level = 2. opened_level = -1.
      DESCRIBE TABLE stats_b_lv1 LINES zeilen.
* check if stats_c_lv0 already has been filled
      IF zeilen = 0.
        PERFORM fill_b_level_1.
      ENDIF.
      LOOP AT stats_b_lv1.
* Sätze ohne Trans-ID ausfiltern
        CHECK stats_b_lv1-transid <> space.
* are further selection criteria set?
        IF selection-sresptime > 0 OR
           selection-scputime  > 0 OR
           selection-sdbtime   > 0 OR
           selection-sbytes    > 0 OR
           selection-schg      > 0.
          CHECK stats_b_lv1-maxrspti >= selection-sresptime AND
                stats_b_lv1-maxcputi >= selection-scputime  AND
                stats_b_lv1-maxdbti  >= selection-sdbtime   AND
                stats_b_lv1-maxkbyte >= selection-sbytes    AND
                stats_b_lv1-maxchg   >= selection-schg.
        ENDIF.
* set color and 'block flag' trans-ID
        IF sy-tabix = 1.
          save_transid = stats_b_lv1-transid.
          PERFORM flip_flop CHANGING colflag.
        ENDIF.
* check client info for client_info_only mode
        IF client_info_only = 'X'.
          PERFORM check_client_info USING output_flag wa_info.
        ENDIF.
* get records
        IF output_flag = 'X'.
          LOOP AT navigate WHERE transid = stats_b_lv1-transid.
            CLEAR: wa_all_stats, wa_main.
            READ TABLE all_stats INTO wa_all_stats
                                              INDEX navigate-record_idx.
*            READ TABLE wa_all_stats-main INTO wa_main
*                                              INDEX navigate-main_idx.
            MOVE-CORRESPONDING wa_all_stats-main TO wa_main.
* check selection criteria
            CHECK  wa_main-account CP selection-sbenu
               AND wa_main-tcode   CP selection-stcod
               AND wa_main-report  CP selection-sprogram
               AND ( wa_main-tasktype = rtasktype OR rtasktype = '00' ).
* output
            IF client_info_only = 'X' AND output_flag = 'X'.
              CLEAR output_flag.
              PERFORM push_client_info." using wa_info.
            ENDIF.
            PERFORM zwrite_main_record USING level opened_level.
          ENDLOOP.                       "navigate
        ENDIF.
      ENDLOOP.                         "stats_b_lv1
    WHEN OTHERS.
* display mode all records sorted by start time ------------------------
      SORT navigate BY startdate starttime wpid.
      level = 2. opened_level = -1.
      LOOP AT navigate.
        READ TABLE occurng_trids WITH KEY transid = navigate-transid.
        CHECK sy-subrc = 0.
        READ TABLE all_stats INTO wa_all_stats
                                            INDEX navigate-record_idx.
*        READ TABLE wa_all_stats-main INTO wa_main
*                                            INDEX navigate-main_idx.
        MOVE-CORRESPONDING wa_all_stats-main TO wa_main.
        CHECK  wa_main-account  CP selection-sbenu
           AND wa_main-tcode    CP selection-stcod
           AND wa_main-report   CP selection-sprogram
           AND wa_main-dynpronr CP selection-sscreen
           AND ( wa_main-tasktype = rtasktype OR rtasktype = '00' ).
* are further selection criteria set?
        IF selection-sresptime > 0 OR
           selection-scputime  > 0 OR
           selection-sdbtime   > 0 OR
           selection-sbytes    > 0 OR
           selection-schg      > 0.
          kbyte =   wa_main-bytes / 1024.
          CHECK wa_main-respti     >= selection-sresptime AND
                wa_main-cputi      >= selection-scputime  AND
                wa_main-dbcallti   >= selection-sdbtime   AND
                kbyte              >= selection-sbytes    AND
                wa_main-phychngcnt >= selection-schg.
        ENDIF.
        PERFORM zwrite_main_record USING level opened_level.
      ENDLOOP.                         "navigate
      SORT navigate BY transid startdate starttime.
  ENDCASE.

**** APC!!!
  EXIT.

  ULINE.

* get first and last row
  IF overall_opened_level > 0 AND ( rmode = 'C' OR rmode = 'c' ) .
    first_row = tcdef + 1.
* = Anzahl Headerzeilen + 1 jtc tcdef ist 10
  ELSE.
    first_row = tcdef.
  ENDIF.
  tcdef = 10."reinitialize tcdef change jtc
  last_row = sy-linno - 2.             " -2 wg. uline
* there is allways the client info in the first line.
  IF client_info_only = 'X'.
    first_row = first_row + 1.
  ENDIF.

ENDFORM.                               " WRITE_MAINLIST

*&---------------------------------------------------------------------*
*&      Form  ZWRITE_MAIN_RECORD
*&---------------------------------------------------------------------*
*       Write one record in main list.
*----------------------------------------------------------------------*
*      -->P_LEVEL  display level (0..2)                                *
*      -->P_OPENED_LEVEL  opened display level (-1..1)                 *
*----------------------------------------------------------------------*
FORM zwrite_main_record USING p_level p_opened_level.

* Borramos datos de usuarios especiales
  CHECK NOT ( wa_main-account = 'DDIC'
           OR wa_main-account = 'SAPSYS'
           OR wa_main-account = 'CUA_ERD'
           OR wa_main-account = 'ADMIN'
           OR wa_main-account = 'WF-BATCH'
           OR wa_main-account = 'ADS_AGENT'
           OR wa_main-account = 'SM_SMD'
           OR wa_main-account = 'UNKNOWN'
           OR wa_main-account CS '<RPC(PLUGIN TIMEOUT' ).

** Borramos datos de programas especiales.
*  CHECK NOT ( wa_main-report = 'RSABAPPROGRAM'
*                  OR wa_main-report = 'SAPMSYST'
*                  OR wa_main-report = 'RSBTCRTE'
*                  OR wa_main-report = 'RSEDNAMT'
*                  OR wa_main-report = 'RSCONN01'
*                  OR wa_main-report = 'SAPRSEUT'
*                  OR wa_main-report = 'SAPRSLOG'
*                  OR wa_main-report = 'SAPMSJOB'
*                  OR wa_main-report = 'RSDBAJOB'
*                  OR wa_main-report = 'RSM13000'
*                  OR wa_main-report = 'RSVRSRS3'
*                  OR wa_main-report(4) = 'RSWW'
*                  OR wa_main-report(1) = '/'
*                  OR wa_main-report = 'RFC'
*                  OR wa_main-btcjobname(4) = 'SAP_'
*                  OR wa_main-btcjobname(13) = 'AUTO_SESSION_'
*                  OR wa_main-tcode = 'SMEN'
*                  OR wa_main-btcjobname = 'SWFSLSDLEX'
*                  OR wa_main-btcjobname = 'CODE_INSPECTOR_DELETION'
*                  ).

  CHECK NOT ( wa_main-report = 'SAPMSSYC'
           OR wa_main-report = 'RSTPDAMAIN'
           OR wa_main-report = 'SAPMSYST'
           OR wa_main-report = 'SAPMSEU0'
           OR wa_main-report = '<AD_DISPLACE>'
           OR wa_main-report = 'RFC'
           OR wa_main-report = '<AD_DEL_USER>'
           OR wa_main-report = 'RSM13000' ).
  MOVE-CORRESPONDING wa_main TO i_aux.
*
*  IF i_aux-btcjobname IS INITIAL AND
*     i_aux-tcode(1) NE 'Z' AND
*     i_aux-tcode NE 'SE38' AND
*     i_aux-tcode(7) NE 'SESSION'.
*    CLEAR i_aux-report.
*  ENDIF.


  APPEND i_aux.
ENDFORM.                               " zWRITE_MAIN_RECORD
*&---------------------------------------------------------------------*
*&      Form  agrupar_informacion
*&---------------------------------------------------------------------*
FORM agrupar_informacion .

* Eliminamos ejecuciones muy pr#ximas
  SORT i_aux.
  DATA: l_time LIKE stad_output-endti,
        l_secs TYPE i,
        l_new,
        l_aux LIKE i_aux,
        l_respti LIKE stad_output-respti,
        l_dbcalls LIKE stad_output-dbcalls,
        l_start TYPE sy-uzeit,
        l_fin.

  SORT i_aux.
  LOOP AT i_aux.
    l_aux = i_aux.
    CLEAR: l_fin.
    AT END OF date.
      l_fin = 'X'.
    ENDAT.

    AT NEW date.
      l_new  = 'X'.
    ENDAT.
    IF l_new = 'X'.
      CLEAR: l_new.
      l_time = l_aux-endti.
      l_start = i_aux-starttime.
      l_dbcalls = i_aux-dbcalls.
      l_respti = i_aux-respti.
      l_time = l_aux-endti.
    ENDIF.

    l_secs = i_aux-endti - l_time.
    ADD i_aux-dbcalls TO l_dbcalls.
    ADD i_aux-respti TO l_respti.
    IF l_secs > 90 OR l_fin = 'X'.
      MOVE-CORRESPONDING i_aux TO i_datos.
      i_datos-starttime = l_start.
      i_datos-dbcalls = l_dbcalls.
      i_datos-respti = l_respti.
      APPEND i_datos.
      l_new = 'X'.
    ENDIF.

  ENDLOOP.
  SORT i_datos.

*  LOOP AT i_datos.
*    IF NOT i_datos-report IS INITIAL.
** Comprobamos que existan los registros
*      SELECT SINGLE * FROM  tadir
*             WHERE  pgmid     = 'R3TR'
*             AND    object    = 'PROG'
*             AND    obj_name  = i_datos-report.
*      IF sy-subrc NE 0.
*        DELETE i_datos.
*      ENDIF.
*    ELSEIF i_datos-tcode IS INITIAL.
*      DELETE i_datos.
*    ENDIF.
*  ENDLOOP.

  IF p_act = 'X'.
    LOOP AT i_datos.
      CLEAR zestadisticas.
      MOVE-CORRESPONDING i_datos TO zestadisticas.
      zestadisticas-fecha = i_datos-date.
      zestadisticas-jobname = i_datos-btcjobname.
      MODIFY zestadisticas.
    ENDLOOP.

*    submit zstats_upd
*      and return
*     with s_fechas = rday
*     with p_actu  = 'X'.
  ENDIF.

  IF p_list = 'X'.
    PERFORM alv_write_output TABLES i_datos USING 'I_DATOS'.
  ENDIF.

  LEAVE PROGRAM.

ENDFORM.                    " agrupar_informacion

*&---------------------------------------------------------------------*
*&      Form  BUILD_EVENTTAB
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_EVENTS[]  text                                             *
*----------------------------------------------------------------------*
FORM alv_build_eventtab USING p_events TYPE slis_t_event.
  DATA: ls_event TYPE slis_alv_event.
  CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
    EXPORTING
      i_list_type = 0
    IMPORTING
      et_events   = p_events.
  READ TABLE p_events WITH KEY name = slis_ev_top_of_page
                           INTO ls_event.
  IF sy-subrc = 0.
    MOVE slis_ev_top_of_page TO ls_event-form.
    MODIFY p_events FROM ls_event INDEX sy-tabix.
  ENDIF.

*
  READ TABLE p_events WITH KEY name = slis_ev_pf_status_set
                           INTO ls_event.
  IF sy-subrc = 0.
    MOVE slis_ev_pf_status_set TO ls_event-form.
    MODIFY p_events FROM ls_event INDEX sy-tabix.
  ENDIF.

  READ TABLE p_events WITH KEY name = slis_ev_user_command
                           INTO ls_event.
  IF sy-subrc = 0.
    MOVE slis_ev_user_command TO ls_event-form.
    MODIFY p_events FROM ls_event INDEX sy-tabix.
  ENDIF.

ENDFORM.                               " BUILD_EVENTTAB

*&---------------------------------------------------------------------*
*&      Form  WRITE_OUTPUT
*&---------------------------------------------------------------------*
FORM alv_write_output TABLES pi_tabla
                     USING pe_tabla.

  alv_repname = sy-repid.
  CALL FUNCTION 'REUSE_ALV_FIELDCATALOG_MERGE'
    EXPORTING
      i_program_name     = alv_repname
      i_internal_tabname = pe_tabla
      i_inclname         = alv_repname
    CHANGING
      ct_fieldcat        = alv_fieldtab.
  IF sy-subrc <> 0.
    WRITE: 'SY-SUBRC: ', sy-subrc, 'REUSE_ALV_FIELDCATALOG_MERGE'.
  ENDIF.
  CALL FUNCTION 'REUSE_ALV_LIST_DISPLAY'
    EXPORTING
      i_callback_program = alv_repname
      i_structure_name   = pe_tabla
      is_layout          = alv_layout
      it_fieldcat        = alv_fieldtab
      i_default          = 'A'
      i_save             = alv_g_save
      it_events          = alv_events[]
      it_sort            = alv_sort
      it_filter          = alv_filter
    TABLES
      t_outtab           = pi_tabla.
  IF sy-subrc <> 0.
    WRITE: 'SY-SUBRC: ', sy-subrc, 'REUSE_ALV_LIST_DISPLAY'.
  ENDIF.
ENDFORM.                               " WRITE_OUTPUT
