<?xml version="1.0" encoding="utf-8"?>
<PROG NAME="LZAP_POPUPO01" VARCL="X" SUBC="I" APPL="S" RMAND="600" RLOAD="S" UCCHECK="X">
 <textPool>
  <language SPRAS="S">
   <textElement ID="R" LENGTH="0 "/>
  </language>
 </textPool>
 <source>*----------------------------------------------------------------------*
***INCLUDE LZAP_POPUPO01 .
*----------------------------------------------------------------------*
*&amp;---------------------------------------------------------------------*
*&amp;      Module  STATUS_0100  OUTPUT
*&amp;---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0100 OUTPUT.

  DATA: i_bot TYPE TABLE OF string WITH HEADER LINE,
        i_opc TYPE TABLE OF string WITH HEADER LINE,
        l_o   TYPE string,
        l_v   TYPE string,
        BEGIN OF i_bot_par OCCURS 0,
          b TYPE sy-ucomm,
          t TYPE smp_dyntxt-text,
          i TYPE smp_dyntxt-icon_id,
          q TYPE smp_dyntxt-quickinfo,
        END OF i_bot_par,
        BEGIN OF i_opciones OCCURS 0,
          opcion TYPE string,
          valor  TYPE string,
        END OF i_opciones,
        l_ancho_optimizado        TYPE abap_bool,
        l_botones_estandard       TYPE abap_bool,
        l_check_editable          TYPE abap_bool,
        l_campos_checkbox         TYPE string,
        l_campos_input_no_cero    TYPE abap_bool,
        l_ocultar_columnas_vacias TYPE abap_bool,
        l_campo_color             TYPE lvc_fname,
        l_handle                  TYPE slis_handl,
        l_campos_no_cero          TYPE string.

  SET PF-STATUS &apos;ST_POPUP_DYN&apos; OF PROGRAM &apos;ZAP_STATUS&apos;.

  SET TITLEBAR &apos;001&apos; WITH v_titulo.

  PERFORM campo_usuario USING 1 CHANGING svald1.
  zcl_ap_dynpro=&gt;screen_visible( campo = &apos;SVALD1-KEYTEXT&apos; variable = v_campo_usuario1 input = &apos;0&apos; ).
  zcl_ap_dynpro=&gt;screen_visible( campo = &apos;SVALD1-VALUE&apos; variable = v_campo_usuario1 input = &apos;1&apos; ).

  PERFORM campo_usuario USING 2 CHANGING svald2.
  zcl_ap_dynpro=&gt;screen_visible( campo = &apos;SVALD2-KEYTEXT&apos; variable = v_campo_usuario2 input = &apos;0&apos; ).
  zcl_ap_dynpro=&gt;screen_visible( campo = &apos;SVALD2-VALUE&apos; variable = v_campo_usuario2 input = &apos;1&apos; ).

  PERFORM campo_usuario USING 3 CHANGING svald3.
  zcl_ap_dynpro=&gt;screen_visible( campo = &apos;SVALD3-KEYTEXT&apos; variable = v_campo_usuario3 input = &apos;0&apos; ).
  zcl_ap_dynpro=&gt;screen_visible( campo = &apos;SVALD3-VALUE&apos; variable = v_campo_usuario3 input = &apos;1&apos; ).

  IF v_inicio IS INITIAL.
    l_ancho_optimizado = &apos;X&apos;.
    if v_opciones cs &apos;&amp;&amp;&apos;.
      SPLIT v_opciones AT &apos;&amp;&amp;&apos; INTO TABLE i_opc.
    else.
      SPLIT v_opciones AT &apos;,&apos; INTO TABLE i_opc.
    endif.
    LOOP AT i_opc.
      SPLIT i_opc AT &apos;=&apos; INTO i_opciones-opcion i_opciones-valor.
      APPEND i_opciones.

      CASE i_opciones-opcion.
        WHEN &apos;ANCHO_OPTIMIZADO&apos;.
          l_ancho_optimizado = i_opciones-valor.
        WHEN &apos;BOTONES_ESTANDARD&apos;.
          l_botones_estandard = i_opciones-valor.
        WHEN &apos;CHECK_EDITABLE&apos;.
          l_check_editable = i_opciones-valor.
        WHEN &apos;CHECKBOX&apos;.
          __add_lista l_campos_checkbox i_opciones-valor.
        WHEN &apos;CAMPOS_INPUT_NO_CERO&apos;.
          l_campos_input_no_cero = &apos;X&apos;.
        WHEN &apos;OCULTAR_COLUMNAS_VACIAS&apos;.
          l_ocultar_columnas_vacias = &apos;X&apos;.
        WHEN &apos;CAMPO_COLOR&apos;.
          l_campo_color = i_opciones-valor.
        WHEN &apos;HANDLE&apos;.
          l_handle = i_opciones-valor.
        WHEN &apos;CAMPOS_NO_CERO&apos;.
          l_campos_no_cero = i_opciones-valor.
        WHEN &apos;FICHERO_EXCEL&apos;.
          v_fichero_excel = i_opciones-valor.
      ENDCASE.
    ENDLOOP.
    REFRESH i_opc.

    IF l_check_editable = &apos;X&apos;.
      v_controlar_cambios = &apos;X&apos;.
    ENDIF.

    v_inicio = &apos;X&apos;.
    LOOP AT SCREEN.
      IF screen-name = &apos;V_TEXTO&apos; OR screen-name = &apos;V_TEXTO2&apos;.
        screen-length = v_max_ancho_txt.
        MODIFY SCREEN.
      ENDIF.
    ENDLOOP.
    zcl_ap_dynpro=&gt;screen_visible( campo = &apos;V_TEXTO&apos; variable = v_texto input = &apos;0&apos; ).
    zcl_ap_dynpro=&gt;screen_visible( campo = &apos;V_TEXTO2&apos; variable = v_texto2 input = &apos;0&apos; ).


    DATA l_aux3(3).
    l_aux3 = v_texto2.
    IF l_aux3 = &apos;!#!&apos;.
      v_texto2 = v_texto2+3.
      LOOP AT SCREEN.
        IF screen-name = &apos;V_TEXTO2&apos;.
          screen-intensified = 1.
        ENDIF.
      ENDLOOP.
    ENDIF.

    IF v_botones(1) = &apos;$&apos;.
      REFRESH i_bot_par.
* Ejemplo &apos;$B=F01&amp;&amp;T=Aceptar&amp;&amp;I=@0V@||B=F02&amp;&amp;T=Borrar&amp;&amp;I=@11@&apos;
      SPLIT v_botones+1 AT &apos;||&apos; INTO TABLE i_bot.
      LOOP AT i_bot.
        SPLIT i_bot AT &apos;&amp;&amp;&apos; INTO TABLE i_opc.
        CLEAR: i_bot_par.
        LOOP AT i_opc.
          SPLIT i_opc AT &apos;=&apos; INTO l_o l_v.
          IF NOT l_o IS INITIAL.
            TRANSLATE l_o TO UPPER CASE.
            CASE l_o(1).
              WHEN &apos;B&apos;. i_bot_par-b = l_v.
              WHEN &apos;T&apos;. i_bot_par-t = l_v.
              WHEN &apos;I&apos;. i_bot_par-i = l_v.
              WHEN &apos;Q&apos;. i_bot_par-q = l_v.
              WHEN &apos;S&apos;. IF l_v = &apos;X&apos;. __add_lista v_validar_seleccion i_bot_par-b. ENDIF.
            ENDCASE.
          ENDIF.
        ENDLOOP.
        APPEND i_bot_par.
      ENDLOOP.
    ENDIF.
  ENDIF.

  IF v_grid IS INITIAL.
    IF o_alv_popup IS INITIAL.
      CREATE OBJECT o_alv_popup
        EXPORTING
          tabla = &apos;&apos;.

      IF v_botones(1) = &apos;$&apos;.
        LOOP AT i_bot_par.
          o_alv_popup-&gt;add_button( button = i_bot_par-b text = i_bot_par-t icon = i_bot_par-i qinfo = i_bot_par-q ).
        ENDLOOP.
      ELSE.
        IF v_botones CS &apos;OK&apos;.
          o_alv_popup-&gt;add_button( button = &apos;F01&apos; text = &apos;Aceptar&apos; icon = &apos;@0V@&apos; qinfo = &apos;Aceptar&apos; ).
        ENDIF.
        IF v_botones CS &apos;PRINT&apos;.
          o_alv_popup-&gt;add_button( button = &apos;F02&apos; text = &apos;Imprimir&apos; icon = &apos;@0X@&apos; qinfo = &apos;Imprimir&apos; ).
        ENDIF.
        IF v_botones CS &apos;CANCEL&apos;.
          o_alv_popup-&gt;add_button( button = &apos;F03&apos; text = &apos;Cancelar&apos; icon = &apos;@0W@&apos; qinfo = &apos;Cancelar&apos; ).
        ENDIF.
      ENDIF.


      DATA(l_no_layout) = SWITCH xfeld( l_handle WHEN &apos;&apos; THEN &apos;X&apos; ELSE &apos;&apos; ).
      IF v_check = &apos;X&apos;.
        IF l_handle IS INITIAL.
          l_handle = sy-cprog.
        ENDIF.

        o_alv_popup-&gt;constructor_tabla( EXPORTING campo_check        = &apos;CHECK&apos;
                                                  sel                = &apos;M&apos;
                                                  no_layout          = l_no_layout
                                                  cprog              = &apos;SAPZAP_POPUP&apos;
*            status           = &apos;ST_DYN&apos;
*            status_prog      = &apos;ZAP_STATUS&apos;
                                                  container_name     = &apos;CALV&apos;
                                                  color              = l_campo_color
                                                  botones_standard   = l_botones_estandard
                                                  restriccion_layout = if_salv_c_layout=&gt;restrict_user_dependant
                                                  handle             = l_handle
                                        CHANGING  t_tabla            = &lt;tabla&gt; ).

        o_alv_popup-&gt;set_field_noout( &apos;CHECK&apos; ).
        o_alv_popup-&gt;set_seleccion( CHANGING t_tabla = &lt;tabla&gt; ).
      ELSE.
        o_alv_popup-&gt;constructor_tabla( EXPORTING no_layout          = l_no_layout
                                                  cprog              = &apos;SAPZAP_POPUP&apos;
*            status           = &apos;ST_DYN&apos;
*            status_prog      = &apos;ZAP_STATUS&apos;
                                                  container_name     = &apos;CALV&apos;
                                                  color              = l_campo_color
                                                  botones_standard   = l_botones_estandard
                                                  restriccion_layout = if_salv_c_layout=&gt;restrict_user_dependant
                                                  handle             = l_handle
                                        CHANGING  t_tabla            = &lt;tabla&gt; ).
      ENDIF.
      IF NOT v_campos_noout IS INITIAL.
        o_alv_popup-&gt;set_field_noout( v_campos_noout ).
      ENDIF.

      IF NOT v_campos_sum IS INITIAL.
        o_alv_popup-&gt;set_agregacion( v_campos_sum ).
      ENDIF.

      SPLIT v_campos_texto AT &apos;&amp;&amp;&apos; INTO TABLE i_opc.
      LOOP AT i_opc.
        SPLIT i_opc AT &apos;=&apos; INTO l_o l_v.
        IF NOT l_v IS INITIAL.
          o_alv_popup-&gt;set_field_text( campo = l_o valor = l_v ).
        ENDIF.
      ENDLOOP.

      IF NOT v_campos_hotspot IS INITIAL.
        IF v_campos_hotspot CS &apos;(&apos;.
          DATA(i_hotspots) = zcl_ap_lista=&gt;get_valores_lista( v_campos_hotspot ).
          LOOP AT i_hotspots ASSIGNING FIELD-SYMBOL(&lt;hotspot&gt;).
            o_alv_popup-&gt;set_field_hotspot( campo = &lt;hotspot&gt;-valor valor = &lt;hotspot&gt;-subvalor ).
          ENDLOOP.
        ELSE.
          o_alv_popup-&gt;set_field_hotspot( campo = v_campos_hotspot auto = &apos;X&apos; ).
        ENDIF.
      ENDIF.

      IF NOT v_alv_helper IS INITIAL.
        o_alv_popup-&gt;o_alv_helper = v_alv_helper.
      ENDIF.

      IF NOT v_campos_orden IS INITIAL.
        o_alv_popup-&gt;set_orden( v_campos_orden ).
      ENDIF.

      IF NOT l_campos_no_cero IS INITIAL.
        o_alv_popup-&gt;set_field( campo = l_campos_no_cero op = &apos;NO_CERO&apos; ).
      ENDIF.

      IF l_ocultar_columnas_vacias = &apos;X&apos;.
        o_alv_popup-&gt;ocultar_columnas_vacias( t_tabla = &lt;tabla&gt; ).
      ENDIF.

      o_alv_popup-&gt;show( ).

    ELSE.
      o_alv_popup-&gt;refresh( ).
    ENDIF.
  ELSE.
    IF o_grid_popup IS INITIAL.
      CREATE OBJECT o_event_popup.

      CREATE OBJECT o_grid_popup
        EXPORTING
          estructura     = &apos;&apos;
          o_event        = o_event_popup
          obj_contenedor = &apos;CALV&apos;
          nombre_layout  = &apos;Z_POPUP_ALV_AP&apos;.

      IF v_botones(1) = &apos;$&apos;.
        LOOP AT i_bot_par.
          o_grid_popup-&gt;add_button( button = i_bot_par-b text = i_bot_par-t icon = i_bot_par-i qinfo = i_bot_par-q ).
        ENDLOOP.
      ELSE.
        IF v_botones CS &apos;OK&apos;.
          o_grid_popup-&gt;add_button( button = &apos;F01&apos; text = &apos;Aceptar&apos; icon = &apos;@0V@&apos; qinfo = &apos;Aceptar&apos; ).
        ENDIF.
        IF v_botones CS &apos;PRINT&apos;.
          o_grid_popup-&gt;add_button( button = &apos;F02&apos; text = &apos;Imprimir&apos; icon = &apos;@0X@&apos; qinfo = &apos;Imprimir&apos; ).
        ENDIF.
        IF v_botones CS &apos;CANCEL&apos;.
          o_grid_popup-&gt;add_button( button = &apos;F03&apos; text = &apos;Cancelar&apos; icon = &apos;@0W@&apos; qinfo = &apos;Cancelar&apos; ).
        ENDIF.
      ENDIF.

      o_grid_popup-&gt;set_campos_tabint( &lt;tabla&gt; ).

      DATA(l_input) = &apos;&apos;.
      IF l_check_editable = &apos;X&apos;.
        CLEAR v_check.
        l_input = &apos;X&apos;.
        o_grid_popup-&gt;set_field_input( &apos;CHECK&apos; ).
        o_grid_popup-&gt;set_field( campo = &apos;CHECK&apos; op = &apos;CHECKBOX&apos; ).
      ENDIF.

      IF NOT l_campos_checkbox IS INITIAL.
        o_grid_popup-&gt;set_field( campo = l_campos_checkbox op = &apos;CHECKBOX&apos; ).
      ENDIF.

      IF NOT v_campos_noout IS INITIAL.
        o_grid_popup-&gt;set_field_noout( v_campos_noout ).
      ENDIF.

      IF NOT v_campos_sum IS INITIAL.
        o_grid_popup-&gt;set_field( campo = v_campos_sum op = &apos;SUM&apos; ).
      ENDIF.

      IF NOT v_campos_hotspot IS INITIAL.
        o_grid_popup-&gt;set_field_hotspot( campo = v_campos_hotspot auto = &apos;X&apos; ).
      ENDIF.

      SPLIT v_campos_texto AT &apos;&amp;&amp;&apos; INTO TABLE i_opc.
      LOOP AT i_opc.
        SPLIT i_opc AT &apos;=&apos; INTO l_o l_v.
        IF NOT l_v IS INITIAL.
          o_grid_popup-&gt;set_field_text( campo = l_o valor = l_v ).
        ENDIF.
      ENDLOOP.

      IF NOT v_campos_input IS INITIAL.
        l_input = &apos;X&apos;.
        o_grid_popup-&gt;set_field_input( v_campos_input ).
        IF l_campos_input_no_cero = &apos;X&apos;.
          o_grid_popup-&gt;set_field( campo = v_campos_input op = &apos;NO_CERO&apos; ).
        ENDIF.
      ENDIF.

      IF NOT v_alv_helper IS INITIAL.
        o_grid_popup-&gt;o_alv_helper = v_alv_helper.
      ENDIF.

      IF NOT v_campos_orden IS INITIAL.
        o_grid_popup-&gt;set_orden( v_campos_orden ).
      ENDIF.

      IF v_check IS INITIAL.
        DATA l_sel_mode .
        l_sel_mode = &apos;N&apos;.
      ELSE.
        l_sel_mode = &apos;D&apos;.
      ENDIF.
      IF l_botones_estandard IS INITIAL.
        o_grid_popup-&gt;set_layout( no_toolbar = &apos;X&apos; sel_mode = l_sel_mode ancho_optimizado = l_ancho_optimizado input = l_input ).
      ELSE.
        o_grid_popup-&gt;set_layout( no_toolbar = &apos;&apos; sel_mode = l_sel_mode ancho_optimizado = l_ancho_optimizado input = l_input ).
        o_grid_popup-&gt;quitar_botones_insercion( ).
      ENDIF.

      o_grid_popup-&gt;show( CHANGING tabla = &lt;tabla&gt; ).

      o_grid_popup-&gt;actualiza_campos_grid( campos_no_opt = v_campos_input ).

    ELSE.
      o_grid_popup-&gt;refrescar_grid( ).
    ENDIF.
  ENDIF.


ENDMODULE.                 &quot; STATUS_0100  OUTPUT
*&amp;---------------------------------------------------------------------*
*&amp;      Module  STATUS_0200  OUTPUT
*&amp;---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE status_0200 OUTPUT.

  SET PF-STATUS &apos;ST_POPUP_DYN&apos; OF PROGRAM &apos;ZAP_STATUS&apos;.

  SET TITLEBAR &apos;001&apos; WITH v_titulo.

  zcl_ap_dynpro=&gt;screen_input( campo = &apos;TVARVC-LOW&apos; variable = v_edit ).
  PERFORM remove_button IN PROGRAM zap_status USING &apos;F02&apos;.
  PERFORM add_button IN PROGRAM zap_status USING &apos;F03&apos; &apos;Cancelar&apos; icon_cancel &apos;Cancelar&apos;.
  IF v_edit = &apos;X&apos;.
    PERFORM add_button IN PROGRAM zap_status USING &apos;F01&apos; &apos;Aceptar&apos; icon_okay &apos;Aceptar cambios&apos;.
  ELSE.
    PERFORM remove_button IN PROGRAM zap_status USING &apos;F01&apos;.
    IF v_editable = &apos;X&apos;.
      PERFORM add_button IN PROGRAM zap_status USING &apos;F02&apos; &apos;Modificar&apos; icon_change &apos;Modificar valor&apos;.
    ENDIF.
  ENDIF.

ENDMODULE.</source>
</PROG>
