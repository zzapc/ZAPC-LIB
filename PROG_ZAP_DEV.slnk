<?xml version="1.0" encoding="utf-8"?>
<PROG NAME="ZAP_DEV" VARCL="X" SUBC="1" RMAND="100" RLOAD="S" FIXPT="X" UCCHECK="X">
 <textPool>
  <language SPRAS="E">
   <textElement ID="R" ENTRY="Desarrollos" LENGTH="70 "/>
   <textElement ID="S" KEY="P_VARI" ENTRY="D       ." LENGTH="14 "/>
   <textElement ID="S" KEY="S_VBELN" ENTRY="D       ." LENGTH="9 "/>
  </language>
  <language SPRAS="S">
   <textElement ID="R" ENTRY="Desarrollos" LENGTH="31 "/>
   <textElement ID="S" KEY="P_VARI" ENTRY="D       ." LENGTH="14 "/>
   <textElement ID="S" KEY="S_VBELN" ENTRY="D       ." LENGTH="9 "/>
  </language>
 </textPool>
 <programDocumentation OBJECT="ZAP_DEV">
  <language SPRAS="S">
   <textLine TDFORMAT="U1" TDLINE="&amp;PURPOSE&amp;"/>
   <textLine TDFORMAT="AS" TDLINE="Plantilla para generar ALV GRIDs"/>
   <textLine TDFORMAT="U1" TDLINE="&amp;INTEGRATION&amp;"/>
   <textLine TDFORMAT="AS"/>
   <textLine TDFORMAT="U1" TDLINE="&amp;PREREQUISITES&amp;"/>
   <textLine TDFORMAT="AS"/>
   <textLine TDFORMAT="U1" TDLINE="&amp;FEATURES&amp;"/>
   <textLine TDFORMAT="AS"/>
   <textLine TDFORMAT="U2" TDLINE="&amp;SELECTION&amp;"/>
   <textLine TDFORMAT="AS"/>
   <textLine TDFORMAT="U2" TDLINE="&amp;STANDARD_VARIANTS&amp;"/>
   <textLine TDFORMAT="AS"/>
   <textLine TDFORMAT="U2" TDLINE="&amp;OUTPUT&amp;"/>
   <textLine TDFORMAT="U2"/>
   <textLine TDFORMAT="U1" TDLINE="&amp;ACTIVITIES&amp;"/>
   <textLine TDFORMAT="AS"/>
   <textLine TDFORMAT="U1" TDLINE="&amp;EXAMPLE&amp;"/>
   <textLine TDFORMAT="AS"/>
   <textLine TDFORMAT="AS"/>
  </language>
 </programDocumentation>
 <dynpros>
  <dynpro PROG="ZAP_DEV" DNUM="0100" FNUM="0100" BZMX="41 " BZBR="208 " MILI="192 " MICO="37 " MALI="0 " MACO="0 " NOLI="57 " NOCO="255 " VALP="0 " CUAN="G" SPRA="S" DTEXT="Grid">
   <dynprofield FNAM="ZAP_DEV_EST-OBJETO" DIDX="0006" FLG1="30" FLG2="00" FLG3="00" FMB1="30" FMB2="00" LENG="06" LINE="01" COLN="02" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" ITYP="0" AGLT="00" ADEZ="00" STXT="Objeto" RES1="                                       00                                                                                                                                                                                                               X"/>
   <dynprofield FNAM="ZAP_DEV_EST-OBJETO" DIDX="0028" FLG1="A1" FLG2="00" FLG3="80" FMB1="00" FMB2="00" LENG="28" LINE="01" COLN="09" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" ITYP="C" AGLT="50" ADEZ="00" STXT="________________________________________" RES1="                                       00"/>
   <dynprofield FNAM="ZAP_DEV_EST-TIPO" DIDX="0022" FLG1="B0" FLG2="00" FLG3="81" FMB1="00" FMB2="18" LENG="20" LINE="01" COLN="33" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" ITYP="C" AGLT="04" ADEZ="00" STXT="________________________________" RES1="XDL                                    00"/>
   <dynprofield FNAM="BUSQUEDA" DIDX="001D" FLG1="80" FLG2="00" FLG3="88" FMB1="00" FMB2="00" LENG="1D" LINE="01" COLN="57" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" AGLT="00" ADEZ="00" STXT="_____________________________"/>
   <dynprofield FNAM="V1" DIDX="0004" FLG1="00" FLG2="00" FLG3="08" FMB1="30" FMB2="00" LENG="04" LINE="02" COLN="02" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" AGLT="00" ADEZ="00" STXT="Var1"/>
   <dynprofield FNAM="LIST1" DIDX="0018" FLG1="80" FLG2="00" FLG3="88" FMB1="00" FMB2="00" LENG="18" LINE="02" COLN="08" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" AGLT="00" ADEZ="00" STXT="________________________" RES1=" DL                                                                                                                                                                     FILTRO"/>
   <dynprofield FNAM="VAR2" DIDX="0004" FLG1="00" FLG2="00" FLG3="08" FMB1="30" FMB2="00" LENG="04" LINE="02" COLN="23" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" AGLT="00" ADEZ="00" STXT="Var2"/>
   <dynprofield FNAM="LIST2" DIDX="0018" FLG1="80" FLG2="00" FLG3="88" FMB1="00" FMB2="00" LENG="18" LINE="02" COLN="29" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" AGLT="00" ADEZ="00" STXT="________________________" RES1=" DL                                                                                                                                                                     FILTRO"/>
   <dynprofield FNAM="OT" DIDX="0002" FLG1="00" FLG2="00" FLG3="08" FMB1="30" FMB2="00" LENG="02" LINE="02" COLN="44" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" AGLT="00" ADEZ="00" STXT="OT"/>
   <dynprofield FNAM="LIST3" DIDX="000F" FLG1="80" FLG2="00" FLG3="88" FMB1="00" FMB2="00" LENG="0F" LINE="02" COLN="4A" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" AGLT="00" ADEZ="00" STXT="_______________" RES1=" DL                                                                                                                                                                     FILTRO"/>
   <dynprofield FNAM="TCODE" DIDX="0018" FLG1="00" FLG2="30" FLG3="00" FILL="U" FMB1="00" FMB2="00" LENG="5F" LINE="02" COLN="73" LANF="65" LBLK="00" LREP="00" AUTH="101" AGLT="0F" ADEZ="3B"/>
   <dynprofield FNAM="GRID" DIDX="0017" FLG1="00" FLG2="30" FLG3="00" FILL="U" FMB1="00" FMB2="00" LENG="70" LINE="03" COLN="02" LANF="66" LBLK="00" LREP="00" AUTH="102" AGLT="0F" ADEZ="3B"/>
   <dynprofield FNAM="TEXTO" DIDX="0010" FLG1="00" FLG2="00" FLG3="00" FILL="U" FMB1="00" FMB2="00" LENG="70" LINE="1A" COLN="02" LANF="67" LBLK="00" LREP="00" AUTH="103" AGLT="00" ADEZ="00"/>
   <dynprofield FNAM="PC" DIDX="0010" FLG1="00" FLG2="30" FLG3="00" FILL="U" FMB1="00" FMB2="00" LENG="5F" LINE="1A" COLN="73" LANF="68" LBLK="00" LREP="00" AUTH="104" AGLT="0F" ADEZ="3B"/>
   <dynprofield DIDX="0014" FLG1="80" FLG2="10" FLG3="08" FMB1="00" FMB2="00" LENG="14" LINE="FF" COLN="01" LTYP="O" LANF="00" LBLK="00" LREP="00" TYPE="CHAR" AGLT="00" ADEZ="00" STXT="____________________"/>
   <dynproflowsource>PROCESS BEFORE OUTPUT.
 MODULE STATUS_0100.
*
PROCESS AFTER INPUT.
 MODULE USER_COMMAND_0100 AT EXIT-COMMAND.

 chain.
   field: ZAP_DEV_EST-OBJETO,
          ZAP_DEV_EST-tipo.
      module validar_tipo.
 endchain.

 MODULE USER_COMMAND_0100.</dynproflowsource>
  </dynpro>
 </dynpros>
 <pfstatus>
  <pfstatus_tit CODE="100" TEXT="&amp;"/>
 </pfstatus>
 <source>***********************************************************************
* TIPO : LISTADO
* TITULO : Lista ultimos desarrollos
* DESCRIPCION : Lista ultimos desarrollos
*
* AUTOR: Andrés Picazo                                FECHA: 18/04/2017
*
***********************************************************************
REPORT zap_dev.


*------TABLAS/ESTRUCTURAS----------------------------------------------*
TABLES: zap_dev_est, *zap_dev_est, e071, zap_dev_hist.

*------TABLAS INTERNAS-------------------------------------------------*
DATA: zap_dev       TYPE zap_dev,
      g_zap_dev_est TYPE zap_dev_est.

*------VARIABLES-------------------------------------------------------*
DATA: list1     TYPE string,
      list2     TYPE string,
      list3     TYPE string,
      busqueda  TYPE string,
      *busqueda TYPE string.

*----------------------------------------------------------------------*
* CLASS lcl_alv DEFINITION
*----------------------------------------------------------------------*

CLASS lcl_event_grid DEFINITION INHERITING FROM zcl_ap_alv_grid_eventos FINAL.
  PUBLIC SECTION.
    METHODS: double_click          REDEFINITION,
             data_changed          REDEFINITION,
             data_changed_finished REDEFINITION,
             toolbar               REDEFINITION,
             user_command          REDEFINITION.
ENDCLASS.


*----------------------------------------------------------------------*
*       CLASS zcl_report DEFINITION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS zcl_report DEFINITION INHERITING FROM zcl_ap_dev FINAL.
  PUBLIC SECTION.
    TYPES: BEGIN OF  t_listado,
             check   TYPE xfeld,
             lights  TYPE zico_estado_mensaje,
             objeto  TYPE zap_dev_est-objeto,
             tipo    TYPE zap_dev_est-tipo,
             valor1  TYPE zap_dev-valor1,
             valor2  TYPE zap_dev-valor2,
             valor3  TYPE zap_dev-valor3,
             texto   TYPE zap_dev-texto,
             erdat   TYPE zap_dev-erdat,
             erzet   TYPE zap_dev-erzet,
             text    TYPE trdirt-text,
             trkorr  TYPE e071-trkorr,
             string  TYPE zap_dev-string,
             message TYPE bapi_msg,
             style   TYPE lvc_t_styl,
             color   TYPE lvc_t_scol,
             tabix   TYPE sy-tabix,
           END OF t_listado,
           tt_listado TYPE STANDARD TABLE OF t_listado.

    DATA: i_listado     TYPE tt_listado,
          i_tcode       TYPE tt_listado,
          i_pc          TYPE tt_listado,
*          o_timer       TYPE REF TO zcl_ap_utils,
          o_alv         TYPE REF TO zcl_ap_alv_grid,
          o_alv_t       TYPE REF TO zcl_ap_alv_grid,
          o_alv_p       TYPE REF TO zcl_ap_alv_grid,
          o_event       TYPE REF TO lcl_event_grid,
          o_event_t     TYPE REF TO lcl_event_grid,
          o_event_p     TYPE REF TO lcl_event_grid,
          o_texto       TYPE REF TO zcl_ap_control_texto,
          i_e070        TYPE TABLE OF e070,
          r_trkorr      TYPE RANGE OF e070-trkorr,
          zedit         TYPE repname,
          zap_dev_info  TYPE repname,
          i_filtro_1    TYPE tpda_vrm_values,
          i_filtro_2    TYPE tpda_vrm_values,
          i_filtro_3    TYPE tpda_vrm_values,
          l_filtro      TYPE tpda_vrm_value,
          texto_control TYPE string,
          v_grid_ok     TYPE c LENGTH 1.

    METHODS: buscar_datos REDEFINITION,

      validaciones IMPORTING !mod    TYPE abap_bool DEFAULT &apos;&apos;
                   CHANGING  listado TYPE t_listado,

      status_dynpro_0100,
      command_dynpro_0100,
      editar IMPORTING !list TYPE t_listado OPTIONAL.

  PRIVATE SECTION.
    METHODS: backup,
             restore,
             get_obj_ots,

      get_list
        IMPORTING objeto      TYPE zap_dev-objeto
                  tipo        TYPE zap_dev-tipo
        RETURNING VALUE(list) TYPE t_listado,

      grabar.

ENDCLASS.

DATA: o_prog TYPE REF TO zcl_report,
      l_list TYPE o_prog-&gt;t_listado.

PARAMETERS p_max TYPE i DEFAULT 200 NO-DISPLAY.

************************************************************************
*
* LOGICA DEL PROGRAMA
*
************************************************************************
CLASS lcl_event_grid IMPLEMENTATION.
  METHOD double_click.
    DATA l_listado TYPE o_prog-&gt;t_listado.

    FIELD-SYMBOLS &lt;listado&gt; TYPE o_prog-&gt;t_listado.

    CASE tabla.
      WHEN &apos;TCODE&apos;.
        ASSIGN o_prog-&gt;i_tcode[ e_row-index ] TO &lt;listado&gt;.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING &lt;listado&gt; TO zap_dev_est.
          CASE e_column.
            WHEN &apos;VALOR1&apos; OR &apos;VALOR2&apos; OR &apos;VALOR3&apos; OR &apos;TIPO&apos;.
              o_prog-&gt;ucomm = &apos;EDITAR&apos;.
              o_prog-&gt;editar( list = &lt;listado&gt; ).
            WHEN &apos;TEXT&apos;.
              SELECT SINGLE pgmna FROM tstc
                INTO zap_dev_est-objeto
               WHERE tcode = zap_dev_est-objeto.
              IF sy-subrc = 0.
                IF NOT zap_dev_est-objeto IS INITIAL.
                  *zap_dev_est = zap_dev_est.
                  zap_dev_est-objeto = *zap_dev_est-objeto.
                  zap_dev_est-tipo   = &apos;RE&apos;.
                  *zap_dev_est = zap_dev_est.
                  g_zap_dev_est = *zap_dev_est.
                  READ TABLE o_prog-&gt;i_listado INTO l_listado WITH KEY objeto = zap_dev_est-objeto.
                  IF sy-subrc &lt;&gt; 0.
                    SELECT * FROM zap_dev               &quot;#EC CI_NOFIRST
                      INTO CORRESPONDING FIELDS OF l_listado
                      UP TO 1 ROWS
                    WHERE objeto = zap_dev_est-objeto AND tipo = zap_dev_est-tipo
                     ORDER BY PRIMARY KEY.
                    ENDSELECT.
                    IF sy-subrc &lt;&gt; 0.
                      MOVE-CORRESPONDING zap_dev_est TO l_listado.
                      APPEND l_listado TO o_prog-&gt;i_listado.
                    ENDIF.
                  ENDIF.
                  o_prog-&gt;ucomm = &apos;EDITAR&apos;.
                  o_prog-&gt;editar( list = l_listado ).
                ENDIF.
              ENDIF.

            WHEN OTHERS.
              o_prog-&gt;ucomm = &apos;EJEC&apos;.
              o_prog-&gt;editar( list = &lt;listado&gt; ).
          ENDCASE.
          o_prog-&gt;o_alv_t-&gt;refrescar_grid( ).
        ENDIF.
      WHEN &apos;PC&apos;.
        ASSIGN o_prog-&gt;i_pc[ e_row-index ] TO &lt;listado&gt;.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING &lt;listado&gt; TO zap_dev_est.
*          CASE e_column.
*            WHEN &apos;VALOR1&apos; OR &apos;VALOR2&apos; OR &apos;VALOR3&apos; OR &apos;TIPO&apos;.
*              o_prog-&gt;ucomm = &apos;EDITAR&apos;.
*              o_prog-&gt;editar( list = &lt;listado&gt; ).
*            WHEN OTHERS.
          o_prog-&gt;ucomm = &apos;LINK&apos;.
          o_prog-&gt;editar( list = &lt;listado&gt; ).
*          ENDCASE.
          o_prog-&gt;o_alv_p-&gt;refrescar_grid( ).
        ENDIF.
      WHEN OTHERS.
        ASSIGN o_prog-&gt;i_listado[ e_row-index ] TO &lt;listado&gt;.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING &lt;listado&gt; TO zap_dev_est.
          CASE e_column.
            WHEN &apos;VALOR1&apos;.
              IF &lt;listado&gt;-objeto(1) = &apos;Z&apos;.
                o_prog-&gt;ucomm = &apos;EDITAR&apos;.
              ELSE.
                o_prog-&gt;ucomm = &apos;VIS&apos;.
              ENDIF.
              o_prog-&gt;editar( list = &lt;listado&gt; ).
            WHEN &apos;LIGHTS&apos;.
              o_prog-&gt;ucomm = &apos;EJEC&apos;.
              o_prog-&gt;editar( list = &lt;listado&gt; ).
            WHEN &apos;TRKORR&apos;.
              IF NOT &lt;listado&gt;-trkorr IS INITIAL.
                SUBMIT zlist_orden_transporte            &quot;#EC CI_SUBMIT
                  AND RETURN
                       WITH s_korr = &lt;listado&gt;-trkorr
                       WITH p_transp = &apos;&apos;
                       WITH p_pend = &apos;X&apos;
                       WITH p_detal = &apos;X&apos;.
              ELSE.
                SUBMIT zlist_orden_transporte            &quot;#EC CI_SUBMIT
                  AND RETURN
                       WITH s_name = &lt;listado&gt;-texto
                       WITH p_transp = &apos;&apos;
                       WITH p_detal = &apos;X&apos;.
              ENDIF.
            WHEN OTHERS.
              IF sy-sysid = zcl_c=&gt;entorno_desarrollo AND &lt;listado&gt;-objeto(1) = &apos;Z&apos;.
                o_prog-&gt;ucomm = &apos;EDITAR&apos;.
              ELSE.
                o_prog-&gt;ucomm = &apos;VIS&apos;.
              ENDIF.
              o_prog-&gt;editar( list = &lt;listado&gt; ).
          ENDCASE.
          o_prog-&gt;o_alv-&gt;refrescar_grid( ).
        ENDIF.
    ENDCASE.
  ENDMETHOD.

  METHOD toolbar.
    super-&gt;toolbar( e_object = e_object e_interactive = e_interactive ).
    IF tabla = &apos;&apos;.
      add_boton( function = &apos;EDT_TEXT&apos; icon = icon_text_act text = &apos;Editar texto&apos; quickinfo = &apos;Editar text&apos; e_object = e_object ).
    ENDIF.
  ENDMETHOD.

  METHOD user_command.
    FIELD-SYMBOLS &lt;listado&gt; TYPE o_prog-&gt;t_listado.

    CASE e_ucomm.
      WHEN &apos;EDT_TEXT&apos;.
        IF o_prog-&gt;o_texto-&gt;es_editable( ) = &apos;&apos;.
          o_prog-&gt;o_texto-&gt;set_editable( &apos;X&apos; ).
        ELSE.
          o_prog-&gt;o_texto-&gt;set_editable( &apos;&apos; ).
        ENDIF.

      WHEN &apos;BORRAR&apos;.
        CASE tabla.
          WHEN &apos;TCODE&apos;.
            o_prog-&gt;o_alv_t-&gt;set_marca_filas_sel( EXPORTING validar_seleccion = &apos;X&apos; CHANGING t_tabla = o_prog-&gt;i_tcode ).
            LOOP AT o_prog-&gt;i_tcode ASSIGNING &lt;listado&gt; WHERE check = &apos;X&apos;.
              DELETE FROM zap_dev WHERE cliente = zcl_c=&gt;cliente_tasks AND sysid = sy-sysid AND ernam = sy-uname AND objeto = &lt;listado&gt;-objeto AND tipo = &lt;listado&gt;-tipo.
              DELETE o_prog-&gt;i_tcode.
            ENDLOOP.
            o_prog-&gt;o_alv_t-&gt;set_marca_filas_sel( CHANGING t_tabla = o_prog-&gt;i_tcode ).
            o_prog-&gt;o_alv_t-&gt;refrescar_grid( ).
          WHEN &apos;PC&apos;.
            o_prog-&gt;o_alv_p-&gt;set_marca_filas_sel( EXPORTING validar_seleccion = &apos;X&apos; CHANGING t_tabla = o_prog-&gt;i_pc ).
            LOOP AT o_prog-&gt;i_pc ASSIGNING &lt;listado&gt; WHERE check = &apos;X&apos;.
              DELETE FROM zap_dev WHERE cliente = zcl_c=&gt;cliente_tasks AND sysid = sy-sysid AND ernam = sy-uname AND objeto = &lt;listado&gt;-objeto AND tipo = &lt;listado&gt;-tipo.

              DELETE o_prog-&gt;i_pc.
            ENDLOOP.
            o_prog-&gt;o_alv_p-&gt;set_marca_filas_sel( CHANGING t_tabla = o_prog-&gt;i_pc ).
            o_prog-&gt;o_alv_p-&gt;refrescar_grid( ).
          WHEN OTHERS.
            o_prog-&gt;o_alv-&gt;set_marca_filas_sel( EXPORTING validar_seleccion = &apos;X&apos; CHANGING t_tabla = o_prog-&gt;i_listado ).
            LOOP AT o_prog-&gt;i_listado ASSIGNING &lt;listado&gt; WHERE check = &apos;X&apos;.
              DELETE FROM zap_dev WHERE cliente = zcl_c=&gt;cliente_tasks AND sysid = sy-sysid AND ernam = sy-uname AND objeto = &lt;listado&gt;-objeto AND tipo = &lt;listado&gt;-tipo.

              DELETE o_prog-&gt;i_listado.
            ENDLOOP.
            o_prog-&gt;o_alv-&gt;set_marca_filas_sel( CHANGING t_tabla = o_prog-&gt;i_listado ).
            o_prog-&gt;o_alv-&gt;refrescar_grid( ).
        ENDCASE.

      WHEN OTHERS.
        super-&gt;user_command( e_ucomm = e_ucomm ).
    ENDCASE.
  ENDMETHOD.

  METHOD data_changed.
    DATA l_listado TYPE o_prog-&gt;t_listado.

    ini_data_changed( cambios = er_data_changed-&gt;mt_good_cells ).

    LOOP AT i_cambios_celda INTO cambio_celda.
      AT NEW row_id.
        CLEAR l_listado.
        CASE tabla.
          WHEN &apos;TCODE&apos;.
            READ TABLE o_prog-&gt;i_tcode INTO l_listado INDEX cambio_celda-row_id. &quot;#EC CI_SUBRC
          WHEN &apos;PC&apos;.
            READ TABLE o_prog-&gt;i_pc INTO l_listado INDEX cambio_celda-row_id. &quot;#EC CI_SUBRC
          WHEN OTHERS.
            READ TABLE o_prog-&gt;i_listado INTO l_listado INDEX cambio_celda-row_id. &quot;#EC CI_SUBRC
        ENDCASE.
      ENDAT.

      set_valor_mod( CHANGING datos = l_listado ).

      AT END OF row_id.
        o_prog-&gt;validaciones( EXPORTING mod = &apos;X&apos; CHANGING listado = l_listado ).
        MODIFY o_prog-&gt;i_listado FROM l_listado INDEX cambio_celda-row_id.

        CASE tabla.
          WHEN &apos;TCODE&apos;.
            MODIFY o_prog-&gt;i_tcode FROM l_listado INDEX cambio_celda-row_id.
          WHEN &apos;PC&apos;.
            MODIFY o_prog-&gt;i_pc FROM l_listado INDEX cambio_celda-row_id.
          WHEN OTHERS.
            MODIFY o_prog-&gt;i_listado FROM l_listado INDEX cambio_celda-row_id.
        ENDCASE.

        CLEAR zap_dev.
        MOVE-CORRESPONDING l_listado TO zap_dev.
        zap_dev-cliente = zcl_c=&gt;cliente_tasks.
*        o_prog-&gt;o_texto-&gt;get_editor( IMPORTING string = zap_dev-string ).
        zap_dev-sysid   = sy-sysid.
        zap_dev-ernam   = sy-uname.
        zap_dev-erdat   = sy-datum.
        zap_dev-erzet   = sy-uzeit.
        MODIFY zap_dev FROM zap_dev.
      ENDAT.
    ENDLOOP.
  ENDMETHOD.

  METHOD data_changed_finished.
    IF NOT tabla_data_changed IS INITIAL.
      o_alv-&gt;refrescar_grid( ).
      CLEAR tabla_data_changed.
    ENDIF.
  ENDMETHOD.
ENDCLASS.


*----------------------------------------------------------------------*
*       CLASS zcl_report IMPLEMENTATION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS zcl_report IMPLEMENTATION.
  METHOD buscar_datos.
    FIELD-SYMBOLS: &lt;e070&gt;    TYPE e070,
                   &lt;listado&gt; TYPE t_listado.

    DATA: r_busqueda  TYPE RANGE OF string,
          lr_busqueda LIKE LINE OF r_busqueda,
          l_listado   TYPE t_listado,
          lr_trkorr   LIKE LINE OF r_trkorr.

    zedit = &apos;ZEDIT&apos;.
    zap_dev_info = &apos;ZBCUT011&apos;.

*    CLEAR: g_zap_dev_est, zap_dev, zap_dev_est.

    IF o_cache-&gt;i_cache_mem IS INITIAL AND sy-sysid &lt;&gt; zcl_c=&gt;entorno_produccion.
      o_cache-&gt;get_shma( ).
      DELETE o_cache-&gt;i_cache_mem WHERE tabla = &apos;E071&apos;.
    ENDIF.

    CASE zcl_c=&gt;cliente_tasks.
      WHEN &apos;VOS&apos;.
        zedit = &apos;ZBCVX019&apos;.
        zap_dev_info = &apos;ZAP_DEV_INFO&apos;.
*      WHEN &apos;FGV&apos;.
*        zedit = &apos;ZBCU0003&apos;.
    ENDCASE.

    SELECT SINGLE obj_name FROM tadir
      INTO zedit
     WHERE pgmid    = &apos;R3TR&apos;
       AND object   = &apos;PROG&apos;
       AND obj_name = zedit.
    IF sy-subrc &lt;&gt; 0.
      CLEAR zedit.
    ENDIF.

    IF i_e070 IS INITIAL.
      SELECT DISTINCT trkorr FROM tlock                 &quot;#EC CI_NOFIELD
        INTO CORRESPONDING FIELDS OF TABLE i_e070  ##TOO_MANY_ITAB_FIELDS
       WHERE author = sy-uname.
      LOOP AT i_e070 ASSIGNING &lt;e070&gt;.
        __rangoc_eq r_trkorr &lt;e070&gt;-trkorr.
      ENDLOOP.
    ENDIF.

    CLEAR lr_busqueda.
    lr_busqueda-option = &apos;CP&apos;.
    lr_busqueda-sign   = &apos;I&apos;.
    CONCATENATE &apos;*&apos; busqueda &apos;*&apos; INTO lr_busqueda-low.
    APPEND lr_busqueda TO r_busqueda.
    lr_busqueda-low = to_lower( lr_busqueda-low ).
    APPEND lr_busqueda TO r_busqueda.
    lr_busqueda-low = to_upper( lr_busqueda-low ).
    APPEND lr_busqueda TO r_busqueda.

    sgpi_texto( &apos;Seleccionando datos&apos; ).
    CLEAR: i_listado, i_tcode, i_pc.
    SELECT * FROM zap_dev
      INTO CORRESPONDING FIELDS OF TABLE i_listado ##TOO_MANY_ITAB_FIELDS
      UP TO p_max ROWS
     WHERE cliente = zcl_c=&gt;cliente_tasks
       AND sysid   = sy-sysid
       AND ernam   = sy-uname
       AND (    objeto IN r_busqueda
             OR valor1 IN r_busqueda
             OR valor2 IN r_busqueda
             OR valor3 IN r_busqueda
             OR texto  IN r_busqueda
             OR titulo IN r_busqueda )
       ORDER BY erdat DESCENDING erzet DESCENDING.

    ASSIGN i_listado[ 1 ] TO &lt;listado&gt;.
    IF sy-subrc = 0.
      l_listado = &lt;listado&gt;.
    ENDIF.

    o_prog-&gt;o_sgpi-&gt;get_filas_tabla( i_listado[] ).
    LOOP AT i_listado ASSIGNING &lt;listado&gt;.
      &lt;listado&gt;-tabix = sy-tabix.
      sgpi_texto( texto1 = &apos;Procesando datos&apos; cant_porc = 100 ).

      validaciones( CHANGING listado = &lt;listado&gt; ).

      IF &lt;listado&gt;-tipo = &apos;TR&apos;.
        APPEND &lt;listado&gt; TO i_tcode.
        DELETE i_listado.
      ELSEIF &lt;listado&gt;-tipo = &apos;PC&apos; OR &lt;listado&gt;-tipo = &apos;UR&apos; OR &lt;listado&gt;-tipo = &apos;NO&apos; OR &lt;listado&gt;-tipo = &apos;RT&apos;.
        APPEND &lt;listado&gt; TO i_pc.
        DELETE i_listado.
      ENDIF.
    ENDLOOP.

    IF NOT l_listado IS INITIAL.
      IF v_grid_ok IS INITIAL.
        MOVE-CORRESPONDING l_listado TO zap_dev_est.

        o_texto-&gt;set_editor( string = l_listado-string display_mode = &apos;X&apos; ).
        ucomm = &apos;INICIO&apos;.
        editar( list = l_listado ).
      ENDIF.
    ELSE.
      zap_dev_est-tipo = &apos;RE&apos;.
    ENDIF.

    IF inicio = &apos;X&apos;.
      o_alv-&gt;set_seleccion( CHANGING t_tabla = i_listado ).
      o_alv-&gt;refrescar_grid( new_code = &apos;ENTER&apos; ).
    ENDIF.

    IF NOT o_alv_t IS INITIAL.
      o_alv_t-&gt;refrescar_grid( ).
    ENDIF.

    IF NOT o_alv_p IS INITIAL.
      o_alv_p-&gt;refrescar_grid( ).
    ENDIF.
  ENDMETHOD.                                               &quot; seleccionar_datos

  METHOD command_dynpro_0100.
    DATA: l_hay_sel TYPE c LENGTH 1,
          l_list    TYPE t_listado,
          l_ok      TYPE c LENGTH 1.

    FIELD-SYMBOLS &lt;listado&gt; TYPE t_listado.

    CLEAR l_hay_sel.
    IF NOT ( sy-ucomm = &apos;BACK&apos; OR sy-ucomm = &apos;GRABAR&apos; ).
      o_alv-&gt;set_marca_filas_sel( CHANGING t_tabla = i_listado hay_sel = l_hay_sel ).
      IF l_hay_sel = &apos;X&apos;.
        ASSIGN i_listado[ check = &apos;X&apos; ] TO &lt;listado&gt;.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING &lt;listado&gt; TO zap_dev_est.
          *zap_dev_est = zap_dev_est.
        ENDIF.
      ENDIF.
    ENDIF.

*    IF NOT *zap_dev_est IS INITIAL.
*      zap_dev_est = *zap_dev_est.
*      CLEAR *zap_dev_est.
*    ENDIF.

    CLEAR texto_control.
    o_texto-&gt;get_editor( IMPORTING string = texto_control ).
    string = texto_control.

    IF sy-ucomm = &apos;BACK&apos; OR sy-ucomm = &apos;GRABAR&apos;.
      LOOP AT i_listado ASSIGNING &lt;listado&gt; WHERE erdat = sy-datum.
        CLEAR zap_dev_hist.
        MOVE-CORRESPONDING &lt;listado&gt; TO zap_dev_hist.
        zap_dev_hist-cliente = zcl_c=&gt;cliente_tasks.
        zap_dev_hist-sysid   = sy-sysid.
        zap_dev_hist-ernam   = sy-uname.
        MODIFY zap_dev_hist FROM zap_dev_hist.
      ENDLOOP.
      LOOP AT i_tcode ASSIGNING &lt;listado&gt; WHERE erdat = sy-datum.
        CLEAR zap_dev_hist.
        MOVE-CORRESPONDING &lt;listado&gt; TO zap_dev_hist.
        zap_dev_hist-cliente = zcl_c=&gt;cliente_tasks.
        zap_dev_hist-sysid   = sy-sysid.
        zap_dev_hist-ernam   = sy-uname.
        MODIFY zap_dev_hist FROM zap_dev_hist.
      ENDLOOP.
      LOOP AT i_pc ASSIGNING &lt;listado&gt; WHERE erdat = sy-datum.
        CLEAR zap_dev_hist.
        MOVE-CORRESPONDING &lt;listado&gt; TO zap_dev_hist.
        zap_dev_hist-cliente = zcl_c=&gt;cliente_tasks.
        zap_dev_hist-sysid   = sy-sysid.
        zap_dev_hist-ernam   = sy-uname.
        MODIFY zap_dev_hist FROM zap_dev_hist.
      ENDLOOP.
    ENDIF.

    IF sy-ucomm = &apos;BACK&apos;.
      IF NOT o_cache-&gt;i_cache_mem IS INITIAL.
        o_cache-&gt;set_shma( ).
      ENDIF.
    ENDIF.

    command_dynpro( EXPORTING o_alv         = o_alv
                              seleccion     = &apos;&apos;
                    CHANGING  i_listado     = i_listado
                              i_listado_ini = i_listado
                              hay_sel       = l_hay_sel ).

    CASE ucomm.
      WHEN &apos;ENTER&apos;.
        IF busqueda &lt;&gt; *busqueda.
          buscar_datos( ).
        ELSEIF NOT *zap_dev_est-objeto IS INITIAL AND zap_dev_est-objeto &lt;&gt; *zap_dev_est-objeto.
          l_list = get_list( objeto = zap_dev_est-objeto tipo = zap_dev_est-tipo ).
          MOVE-CORRESPONDING l_list TO zap_dev_est.
          o_texto-&gt;set_editor( string = l_list-string display_mode = &apos;X&apos; ).
          g_zap_dev_est = zap_dev_est.
        ENDIF.
      WHEN &apos;GRABAR&apos;.
        grabar( ).
        LEAVE TO SCREEN 0100.

      WHEN &apos;EJEC&apos; OR &apos;EDITAR&apos; OR &apos;VIS&apos;.
        editar( ).
      WHEN &apos;NUEVO&apos;.
        CLEAR: zap_dev, zap_dev_est, g_zap_dev_est.
      WHEN &apos;REFRESH&apos;.
        buscar_datos( ).
      WHEN &apos;LIST&apos;.
        SUBMIT zap_dev_list VIA SELECTION-SCREEN AND RETURN. &quot;#EC CI_SUBMIT
      WHEN &apos;DEV&apos;.
        o_alv-&gt;set_marca_filas_sel( CHANGING t_tabla = i_listado ).
        __def_rangoc progname.
        LOOP AT i_listado ASSIGNING &lt;listado&gt; WHERE check = &apos;X&apos;.
          __rangoc_eq r_progname &lt;listado&gt;-texto.
        ENDLOOP.
        IF sy-subrc = 0.
          SUBMIT (zap_dev_info) WITH s_report IN r_progname AND RETURN. &quot;#EC CI_SUBMIT
        ELSE.
          SUBMIT (zap_dev_info) VIA SELECTION-SCREEN AND RETURN. &quot;#EC CI_SUBMIT
        ENDIF.
      WHEN &apos;OT&apos;.
        SUBMIT zap_ots AND RETURN.                       &quot;#EC CI_SUBMIT
      WHEN &apos;SQL&apos;.
        SUBMIT zsql_apc AND RETURN.                      &quot;#EC CI_SUBMIT

      WHEN &apos;M01&apos;.
        CALL TRANSACTION &apos;ZAPCL&apos;.                        &quot;#EC CI_CALLTA
      WHEN &apos;M02&apos;.
        IF NOT zedit IS INITIAL.
          IF l_hay_sel = &apos;X&apos;.
            LOOP AT i_listado ASSIGNING &lt;listado&gt; WHERE check = &apos;X&apos;.
              SUBMIT (zedit) AND RETURN WITH programm = &lt;listado&gt;-texto. &quot;#EC CI_SUBMIT
            ENDLOOP.
          ELSEIF NOT zap_dev_est-objeto IS INITIAL.
            SUBMIT (zedit) AND RETURN WITH programm = zap_dev_est-objeto. &quot;#EC CI_SUBMIT
          ENDIF.
        ENDIF.
      WHEN &apos;M03&apos;.
        SUBMIT zap_dev                                   &quot;#EC CI_SUBMIT
               WITH p_max = 99999.
      WHEN &apos;FILTRO&apos;.
        CLEAR o_alv-&gt;i_filter.
        IF NOT list1 IS INITIAL.
          o_alv-&gt;add_filtro( campo = &apos;VALOR1&apos; valor = list1 ).
        ENDIF.
        IF NOT list2 IS INITIAL.
          o_alv-&gt;add_filtro( campo = &apos;VALOR2&apos; valor = list2 ).
        ENDIF.
        IF NOT list3 IS INITIAL.
          IF list3 = &apos;TODAS&apos;.
            o_alv-&gt;add_filtro( campo = &apos;TRKORR&apos; valor = &apos;&apos; sign = &apos;E&apos; ).
          ELSE.
            o_alv-&gt;add_filtro( campo = &apos;TRKORR&apos; valor = list3 ).
          ENDIF.
        ENDIF.
        o_alv-&gt;o_grid-&gt;set_filter_criteria( o_alv-&gt;i_filter ).
*        o_alv-&gt;refrescar_grid( ).
      WHEN &apos;M04&apos;.
        LOOP AT i_listado ASSIGNING &lt;listado&gt; WHERE trkorr &lt;&gt; &apos;&apos;.
          e071-trkorr = &lt;listado&gt;-trkorr.
          EXIT.
        ENDLOOP.
        zcl_ap_popup=&gt;popup_usuario( EXPORTING campo1 = &apos;E071-TRKORR&apos;
                                               titulo = &apos;Indique OT&apos;
                                     IMPORTING return = l_ok
                                     CHANGING  valor1 = e071-trkorr ).
        IF l_ok &lt;&gt; &apos;A&apos; AND NOT e071-trkorr IS INITIAL.
          MESSAGE &apos;TODO!&apos; TYPE &apos;I&apos;.
        ENDIF.
      WHEN &apos;M05&apos;.
        SET PARAMETER ID &apos;DTB&apos; FIELD zap_dev_est-objeto.
        SET PARAMETER ID &apos;ZSE16N&apos; FIELD &apos;X&apos; ##EXISTS.
        CALL TRANSACTION &apos;SE16N&apos;.                        &quot;#EC CI_CALLTA
        SET PARAMETER ID &apos;ZSE16N&apos; FIELD &apos;&apos; ##EXISTS.
      WHEN &apos;M06&apos;.
        backup( ).
      WHEN &apos;M07&apos;.
        restore( ).
      WHEN &apos;M08&apos;.
        get_obj_ots( ).
    ENDCASE.
  ENDMETHOD.

  METHOD status_dynpro_0100.
    FIELD-SYMBOLS &lt;listado&gt; TYPE t_listado.

    CLEAR ucomm.

    IF NOT g_zap_dev_est IS INITIAL.
      zap_dev_est = g_zap_dev_est.
    ENDIF.

    o_alv-&gt;registrar_mod( ).
    o_alv-&gt;set_campos_tabint( i_listado[] ).
    o_alv-&gt;set_field_text( campo = &apos;TEXTO&apos; valor = &apos;Desarrollo&apos; ).
    o_alv-&gt;set_field_text( campo = &apos;VALOR1&apos; valor = &apos;Var 1&apos; ).
    o_alv-&gt;set_field_text( campo = &apos;VALOR2&apos; valor = &apos;Var 2&apos; ).
    o_alv-&gt;set_field_text( campo = &apos;VALOR3&apos; valor = &apos;Var 3&apos; ).
    o_alv-&gt;quitar_botones( insercion = &apos;X&apos; operaciones = &apos;X&apos; resto = &apos;X&apos; ).

    IF inicio IS INITIAL.
      LOOP AT i_listado ASSIGNING &lt;listado&gt; WHERE NOT valor1 IS INITIAL.
        l_filtro-key  = &lt;listado&gt;-valor1.
        l_filtro-text = &lt;listado&gt;-valor1.
        COLLECT l_filtro INTO i_filtro_1.
      ENDLOOP.
      SORT i_filtro_1.
      zcl_ap_popup=&gt;list_dynpro( campo   = &apos;LIST1&apos;
                                 valores = i_filtro_1[] ).

      LOOP AT i_listado ASSIGNING &lt;listado&gt; WHERE NOT valor2 IS INITIAL.
        l_filtro-key  = &lt;listado&gt;-valor2.
        l_filtro-text = &lt;listado&gt;-valor2.
        COLLECT l_filtro INTO i_filtro_2.
      ENDLOOP.
      SORT i_filtro_2.
      zcl_ap_popup=&gt;list_dynpro( campo   = &apos;LIST2&apos;
                                 valores = i_filtro_2[] ).

      l_filtro-key  = &apos;TODAS&apos;.
      l_filtro-text = &apos;TODAS&apos;.
      COLLECT l_filtro INTO i_filtro_3.
      LOOP AT i_listado ASSIGNING &lt;listado&gt; WHERE NOT trkorr IS INITIAL.
        l_filtro-key  = &lt;listado&gt;-trkorr.
        l_filtro-text = &lt;listado&gt;-trkorr.
        COLLECT l_filtro INTO i_filtro_3.
      ENDLOOP.
      SORT i_filtro_3.
      zcl_ap_popup=&gt;list_dynpro( campo   = &apos;LIST3&apos;
                                 valores = i_filtro_3[] ).
    ENDIF.

    status_dynpro( EXPORTING o_alv = o_alv style = &apos;STYLE&apos; color = &apos;COLOR&apos; cprog = &apos;ZAP_STATUS&apos; status = &apos;ST_DYN&apos; alv_standard = &apos;&apos; CHANGING i_listado = i_listado ).
    o_alv-&gt;set_field_quitar( &apos;CHECK,TABIX,MESSAGE&apos; ).
    o_alv-&gt;set_field_input( &apos;VALOR1,VALOR2,VALOR3,TEXTO&apos; ).
    o_alv-&gt;show( CHANGING tabla = i_listado ).
    v_grid_ok = &apos;X&apos;.

    IF o_alv_t IS INITIAL.
      o_prog-&gt;o_event_t = NEW #(
          boton_refrescar = &apos;X&apos;
          boton_excel     = &apos;X&apos;
          boton_borrar    = &apos;X&apos;
          o_prog          = o_prog
          tabla           = &apos;TCODE&apos; ).

      o_prog-&gt;o_alv_t   = NEW #(
                  estructura     = &apos;&apos;
                  o_event        = o_prog-&gt;o_event_t
                  obj_contenedor = &apos;TCODE&apos; ).

      o_alv_t-&gt;registrar_mod( ).
      o_alv_t-&gt;set_campos_tabint( i_tcode[] ).
      o_alv_t-&gt;set_field_text( campo = &apos;TEXTO&apos; valor = &apos;Transacción&apos; ).
      o_alv_t-&gt;quitar_botones( insercion = &apos;X&apos; operaciones = &apos;X&apos; resto = &apos;X&apos; ).
      o_alv_t-&gt;set_field_quitar( &apos;CHECK,TABIX,TRKORR,LIGHTS,TIPO&apos; ).
      o_alv_t-&gt;set_field_input( &apos;VALOR1,VALOR2,VALOR3,TEXTO&apos; ).
      o_alv_t-&gt;show( CHANGING tabla = i_tcode ).

      o_prog-&gt;o_event_p = NEW #(
          boton_refrescar = &apos;X&apos;
          boton_excel     = &apos;X&apos;
          boton_borrar    = &apos;X&apos;
          o_prog          = o_prog
          tabla           = &apos;PC&apos; ).

      o_prog-&gt;o_alv_p   = NEW #(
                  estructura     = &apos;&apos;
                  o_event        = o_prog-&gt;o_event_p
                  obj_contenedor = &apos;PC&apos; ).
      o_alv_p-&gt;registrar_mod( ).
      o_alv_p-&gt;set_campos_tabint( i_pc[] ).
      o_alv_p-&gt;set_field_text( campo = &apos;TEXTO&apos; valor = &apos;Ruta&apos; ).
      o_alv_p-&gt;quitar_botones( insercion = &apos;X&apos; operaciones = &apos;X&apos; resto = &apos;X&apos; ).
      o_alv_p-&gt;set_field_quitar( &apos;CHECK,TABIX,TRKORR,LIGHTS&apos; ).
      o_alv_p-&gt;set_field_input( &apos;VALOR1,VALOR2,VALOR3,TEXTO&apos; ).
      o_alv_p-&gt;show( CHANGING tabla = i_pc ).
    ENDIF.

*    IF o_timer IS INITIAL.
*      CREATE OBJECT o_timer.
*      o_timer-&gt;set_timer( segundos = 1200 ).
*    ELSE.
*      o_timer-&gt;set_timer( segundos = 1200 cancel_previo = &apos;X&apos; ).
*    ENDIF.
    *busqueda = busqueda.
  ENDMETHOD.

  METHOD validaciones.
    DATA: r_obj_name TYPE RANGE OF e071-obj_name,
          l_icono    TYPE icon_d.

    CLEAR: listado-message, listado-style, listado-color.

    IF listado-tipo &lt;&gt; &apos;PC&apos; AND listado-tipo &lt;&gt; &apos;TR&apos; AND listado-tipo &lt;&gt; &apos;UR&apos; AND listado-tipo &lt;&gt; &apos;NO&apos; AND listado-tipo &lt;&gt; &apos;RT&apos;.
      o_cache-&gt;get_cache_mem( EXPORTING tabla      = &apos;E071&apos;
                                        clave      = listado-objeto
                                        clave2     = sy-uname
                              IMPORTING valor      = listado-trkorr
                                        encontrado = o_cache-&gt;enc ).
      IF o_cache-&gt;enc IS INITIAL.
        IF listado-tipo = &apos;CL&apos;.
          APPEND VALUE #( option = &apos;CP&apos; sign = &apos;I&apos; low = |{ listado-objeto }*| ) TO r_obj_name.
        ELSE.
          APPEND VALUE #( option = &apos;EQ&apos; sign = &apos;I&apos; low = listado-objeto ) TO r_obj_name.
        ENDIF.
        SELECT trkorr FROM e071
          INTO listado-trkorr
          UP TO 1 ROWS
         WHERE trkorr   IN r_trkorr
           AND obj_name IN r_obj_name
         ORDER BY PRIMARY KEY.
        ENDSELECT.
        o_cache-&gt;set_cache_mem( tabla = &apos;E071&apos; clave = listado-objeto clave2 = sy-uname valor = listado-trkorr ).
      ENDIF.

      IF NOT listado-trkorr IS INITIAL.
        SELECT SINGLE strkorr FROM  e070
          INTO listado-trkorr
         WHERE trkorr = listado-trkorr.

        l_icono = zcl_ap_alv=&gt;c_ico_verde.
      ELSE.
        l_icono = zcl_ap_alv=&gt;c_ico_ambar.
      ENDIF.
    ENDIF.

    aux1 = listado-tipo.
    IF NOT ( listado-objeto(1) = &apos;+&apos; AND listado-tipo = &apos;UR&apos; ). &quot; URL
      PERFORM get_text USING o_cache CHANGING listado-tipo listado-objeto listado-text.

      IF mod = &apos;X&apos; AND listado-text IS INITIAL.
        listado-tipo = &apos;RE&apos;.
        PERFORM get_text USING o_cache CHANGING listado-tipo listado-objeto listado-text.
        IF listado-text IS INITIAL.
          listado-tipo = &apos;TR&apos;.
          PERFORM get_text USING o_cache CHANGING listado-tipo listado-objeto listado-text.
          IF listado-text IS INITIAL.
            listado-tipo = &apos;FU&apos;.
            PERFORM get_text USING o_cache CHANGING listado-tipo listado-objeto listado-text.
            IF listado-text IS INITIAL.
              listado-tipo = &apos;TA&apos;.
              PERFORM get_text USING o_cache CHANGING listado-tipo listado-objeto listado-text.
              IF listado-text IS INITIAL.
                listado-tipo = &apos;CL&apos;.
                PERFORM get_text USING o_cache CHANGING listado-tipo listado-objeto listado-text.
                IF listado-text IS INITIAL.
                  listado-tipo = aux1.
                ENDIF.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
      IF listado-text IS INITIAL.
        l_icono = icon_red_light.
      ENDIF.
    ENDIF.

    set_status_list( EXPORTING message = listado-message icono = l_icono CHANGING list = listado ).
  ENDMETHOD.

  METHOD editar.
    DATA: l_list      TYPE t_listado,
          l_refrescar TYPE c LENGTH 1,
          l_list_act  TYPE t_listado,
          l_display   TYPE c LENGTH 1,
          l_listado   TYPE t_listado,
          l_program   TYPE c LENGTH 255,
          l_include   TYPE tfdir-include,
          l_string    TYPE string.

    DATA: source               TYPE TABLE OF text255,
          syntax_check_message TYPE c LENGTH 128,
          line_no              TYPE i,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          lv_word              TYPE text255,
          name_report          TYPE text255 VALUE &apos;YAP_DEV_TEMP&apos;,
          ls_trdir             TYPE trdir.

    FIELD-SYMBOLS &lt;list&gt; TYPE t_listado.

    IF zap_dev_est-objeto = &apos;&apos;.
      RETURN.
    ENDIF.

    IF ucomm = &apos;EJEC&apos; AND zap_dev_est-tipo = &apos;RT&apos; AND o_prog-&gt;o_texto-&gt;es_editable( ) = &apos;X&apos;.
      grabar( ).
    ELSEIF ucomm = &apos;EDITAR&apos; AND zap_dev_est-tipo = &apos;RT&apos;.
      IF o_prog-&gt;o_texto-&gt;es_editable( ) = &apos;&apos;.
        o_prog-&gt;o_texto-&gt;set_editable( &apos;X&apos; ).
      ELSE.
        o_prog-&gt;o_texto-&gt;set_editable( &apos;&apos; ).
      ENDIF.
      cl_gui_cfw=&gt;set_new_ok_code( &apos;ENTER&apos; ).
      RETURN.
    ENDIF.

    IF NOT ( zap_dev_est-tipo = &apos;PC&apos; OR zap_dev_est-tipo = &apos;UR&apos; OR zap_dev_est-tipo = &apos;NO&apos; ).
      zap_dev_est-objeto = to_upper( zap_dev_est-objeto ).
    ENDIF.

    l_list = get_list( objeto = zap_dev-objeto tipo = zap_dev-tipo ).

    IF ucomm = &apos;LINK&apos; OR zap_dev_est IS INITIAL.
      o_texto-&gt;set_editor( string = list-string display_mode = &apos;X&apos; ).
    ELSE.
      IF g_zap_dev_est-objeto &lt;&gt; zap_dev_est-objeto OR g_zap_dev_est-tipo &lt;&gt; zap_dev_est-tipo.
        IF NOT o_texto IS INITIAL.
          IF NOT g_zap_dev_est IS INITIAL.
            l_refrescar = &apos;X&apos;.
            CLEAR zap_dev.
            MOVE-CORRESPONDING g_zap_dev_est TO zap_dev.
            IF o_prog-&gt;o_texto-&gt;es_editable( ) = &apos;X&apos;.
              o_texto-&gt;get_editor( IMPORTING string = zap_dev-string ).
            ELSE.
              l_list_act = get_list( objeto = zap_dev-objeto tipo = zap_dev-tipo ).
              IF NOT l_list_act IS INITIAL.
                zap_dev-string = l_list_act-string.
              ENDIF.
            ENDIF.
            zap_dev-cliente = zcl_c=&gt;cliente_tasks.
            zap_dev-sysid   = sy-sysid.
            zap_dev-ernam   = sy-uname.
            zap_dev-erdat   = sy-datum.
            zap_dev-erzet   = sy-uzeit - 1.
            MODIFY zap_dev FROM zap_dev.
            IF NOT l_list IS INITIAL.
              ASSIGN l_list TO &lt;list&gt;.
              IF &lt;list&gt; IS ASSIGNED.
                &lt;list&gt;-string = zap_dev-string.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
        IF NOT list IS INITIAL.
          o_texto-&gt;set_editor( string = list-string display_mode = &apos;X&apos; ).
        ELSE.
          IF NOT ( zap_dev_est-tipo = &apos;PC&apos; OR zap_dev_est-tipo = &apos;UR&apos; OR zap_dev_est-tipo = &apos;NO&apos; ).
            o_texto-&gt;set_editor( string = &apos;&apos; display_mode = &apos;X&apos; ).
          ENDIF.
        ENDIF.
      ELSE.
        IF NOT o_texto IS INITIAL.
          IF o_texto-&gt;mostrado IS INITIAL.
            o_texto-&gt;set_editor( string = zap_dev-string display_mode = &apos;X&apos; ).
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

    IF o_texto-&gt;mostrado IS INITIAL.
      o_texto-&gt;set_editor( string = list-string display_mode = &apos;X&apos; ).
    ENDIF.

    g_zap_dev_est = zap_dev_est.

    *zap_dev_est = zap_dev_est.

    IF ucomm = &apos;INICIO&apos;.
      IF l_refrescar = &apos;X&apos;.
        o_alv-&gt;refrescar_grid( ).
        o_alv_p-&gt;refrescar_grid( ).
        o_alv_t-&gt;refrescar_grid( ).
        cl_gui_cfw=&gt;set_new_ok_code( &apos;ENTER&apos; ).
      ENDIF.
      RETURN.
    ELSE.
      cl_gui_cfw=&gt;set_new_ok_code( &apos;ENTER&apos; ).
    ENDIF.

    IF ucomm = &apos;VIS&apos;.
      l_display = &apos;X&apos;.
    ENDIF.

    CLEAR zap_dev.
    MOVE-CORRESPONDING zap_dev_est TO zap_dev.
    IF o_prog-&gt;o_texto-&gt;es_editable( ) = &apos;X&apos;.
      o_texto-&gt;get_editor( IMPORTING string = zap_dev-string ).
    ELSE.
      l_list_act = get_list( objeto = zap_dev-objeto tipo = zap_dev-tipo ).
      IF NOT l_list_act IS INITIAL.
        zap_dev-string = l_list_act-string.
      ENDIF.
    ENDIF.

    l_listado-string = zap_dev-string.
    zap_dev-cliente = zcl_c=&gt;cliente_tasks.
    zap_dev-sysid   = sy-sysid.
    zap_dev-ernam   = sy-uname.
    zap_dev-erdat   = sy-datum.
    zap_dev-erzet   = sy-uzeit.
    zap_dev-titulo  = l_list_act-text.
    zap_dev-titulo  = to_upper( zap_dev-titulo ).
    MODIFY zap_dev FROM zap_dev.

    IF ucomm &lt;&gt; &apos;LINK&apos;.
      CASE zap_dev_est-tipo.
        WHEN &apos;RE&apos;.
          SELECT SINGLE name FROM trdir
            INTO zap_dev_est-objeto
           WHERE name = zap_dev_est-objeto.
          IF sy-subrc &lt;&gt; 0.
            MESSAGE i398(00) WITH &apos;No existe report&apos; zap_dev_est-objeto &apos;&apos; &apos;&apos;.
          ELSE.
            SET PARAMETER ID &apos;RID&apos; FIELD zap_dev_est-objeto.
            IF ucomm = &apos;EJEC&apos; OR ucomm = &apos;LINK&apos;.
              SELECT SINGLE name FROM trdir
                INTO zap_dev_est-objeto
               WHERE name = zap_dev_est-objeto
                 AND subc = &apos;1&apos;.
              IF sy-subrc = 0.
                SUBMIT (zap_dev_est-objeto)              &quot;#EC CI_SUBMIT
                       VIA SELECTION-SCREEN
                       AND RETURN.
              ELSE.
                MESSAGE |No es posible ejecutar { zap_dev_est-objeto }| TYPE &apos;S&apos;.
                RETURN.
              ENDIF.
            ELSE.
              IF sy-sysid = zcl_c=&gt;entorno_desarrollo OR l_display = &apos;X&apos; OR zedit IS INITIAL.
                CALL FUNCTION &apos;EDITOR_PROGRAM&apos; ##FM_SUBRC_OK
                  EXPORTING
                    appid       = &apos;PG&apos;
                    display     = l_display
                    program     = zap_dev_est-objeto
                  EXCEPTIONS
                    application = 1.
              ELSE.
                SUBMIT (zedit) AND RETURN WITH programm = zap_dev_est-objeto. &quot;#EC CI_SUBMIT
              ENDIF.
            ENDIF.
          ENDIF.
        WHEN &apos;AF&apos;.
          SET PARAMETER ID &apos;FPWBFORM&apos; FIELD zap_dev_est-objeto.
          CALL TRANSACTION &apos;SFP&apos;.                        &quot;#EC CI_CALLTA

        WHEN &apos;CL&apos;.
          SET PARAMETER ID &apos;CLASS&apos; FIELD zap_dev_est-objeto.
          COMMIT WORK.
          CONCATENATE &apos;SEOCLASS-CLSNAME=&apos; zap_dev_est-objeto INTO string.
          CALL FUNCTION &apos;Z_NUEVO_MODO&apos;
            EXPORTING
              tcode        = &apos;SE24&apos;
              parametros   = string
              max_sesiones = 4.
        WHEN &apos;TA&apos;.
          SET PARAMETER ID &apos;DTB&apos; FIELD zap_dev_est-objeto.
          COMMIT WORK.
          CONCATENATE &apos;RSRD1-TBMA_VAL=&apos; zap_dev_est-objeto INTO string.
          CALL FUNCTION &apos;Z_NUEVO_MODO&apos;
            EXPORTING
              tcode        = &apos;SE11&apos;
              parametros   = string
              max_sesiones = 4.
        WHEN &apos;FU&apos;.
          IF ucomm = &apos;EJEC&apos; OR ucomm = &apos;LINK&apos;.
            SET PARAMETER ID &apos;LIB&apos; FIELD zap_dev_est-objeto.
            CALL TRANSACTION &apos;SE37&apos;.                     &quot;#EC CI_CALLTA
          ELSE.
            SELECT SINGLE pname include FROM tfdir
             INTO (l_program, l_include)
              WHERE funcname = zap_dev_est-objeto.
            IF sy-subrc = 0.
              CONCATENATE l_program+3 &apos;U&apos; l_include INTO l_program.
            ENDIF.
            IF sy-sysid = zcl_c=&gt;entorno_desarrollo OR l_display = &apos;X&apos;.
              CALL FUNCTION &apos;EDITOR_PROGRAM&apos; ##FM_SUBRC_OK
                EXPORTING
                  appid       = &apos;FB&apos;
                  display     = l_display
                  program     = l_program
                EXCEPTIONS
                  application = 1.

            ELSE.
              SUBMIT (zedit) AND RETURN WITH programm = l_program. &quot;#EC CI_SUBMIT
            ENDIF.
          ENDIF.
        WHEN &apos;TR&apos;.
          SELECT SINGLE tcode FROM  tstc
            INTO zap_dev_est-objeto
                 WHERE tcode = zap_dev_est-objeto.
          IF sy-subrc = 0.
*          CALL TRANSACTION zap_dev_est-objeto.
            CALL FUNCTION &apos;Z_NUEVO_MODO&apos;
              EXPORTING
                tcode        = zap_dev_est-objeto
                max_sesiones = 4.

          ELSE.
            MESSAGE i398(00) WITH &apos;No existe transacción&apos; zap_dev_est-objeto &apos;&apos; &apos;&apos;.
          ENDIF.
        WHEN &apos;PC&apos;.
          CALL FUNCTION &apos;WS_EXECUTE&apos; ##FM_OLDED
            EXPORTING
              program            = zap_dev_est-objeto
            EXCEPTIONS
              frontend_error     = 1
              no_batch           = 2
              prog_not_found     = 3
              illegal_option     = 4
              gui_refuse_execute = 5
              OTHERS             = 6.
          IF sy-subrc &lt;&gt; 0.
            MESSAGE &apos;Error lanzando programa&apos; TYPE &apos;E&apos;.
          ENDIF.
        WHEN &apos;UR&apos;.
          aux1 = l_listado-string.
          aux1 = to_upper( aux1 ).
          IF aux1(4) = &apos;HTTP&apos; OR ( zap_dev_est-objeto(1) = &apos;+&apos; AND NOT l_listado-string IS INITIAL ).
            SPLIT l_listado-string AT cl_abap_char_utilities=&gt;cr_lf INTO string aux2.
            zcl_ap_gos=&gt;visualizar_fichero_st( string ).
          ELSE.
            zcl_ap_gos=&gt;visualizar_fichero_st( zap_dev_est-objeto ).
          ENDIF.

        WHEN &apos;RT&apos;.
          IF ucomm = &apos;EJEC&apos;.
            IF NOT zap_dev-string IS INITIAL.
              l_string = zap_dev-string.
              IF NOT l_string CS &apos;report&apos; AND NOT l_string CS &apos;REPORT&apos;.
                CONCATENATE &apos;REPORT Z.&apos; l_string INTO l_string SEPARATED BY cl_abap_char_utilities=&gt;cr_lf.
              ENDIF.
              zcl_ap_string=&gt;string2tabla( EXPORTING string = l_string longitud = 255 CHANGING tabla = source ).
              SYNTAX-CHECK FOR source
                           MESSAGE syntax_check_message
                           LINE line_no
                           WORD lv_word
                           PROGRAM name_report.
              IF sy-subrc &lt;&gt; 0.
                MESSAGE i398(00) WITH &apos;Error de sintaxis, mensaje&apos; syntax_check_message &apos;en linea&apos; line_no.
              ELSE.
                CLEAR ls_trdir.
                ls_trdir-name    = name_report.
                ls_trdir-clas    = &apos;TEMP&apos;.
                ls_trdir-dbna    = &apos; &apos;.
                ls_trdir-fixpt   = &apos;X&apos;.
                ls_trdir-rstat   = &apos;P&apos;.
                ls_trdir-subc    = &apos;1&apos;.
                ls_trdir-rmand   = sy-mandt.

                ls_trdir-sqlx    = &apos;R&apos;.
                ls_trdir-uccheck = &apos;X&apos;.
                MODIFY trdir FROM ls_trdir.
                INSERT REPORT ls_trdir-name FROM source.
                GENERATE REPORT ls_trdir-name.         &quot;#EC CI_GENERATE
                SUBMIT (name_report) AND RETURN VIA SELECTION-SCREEN. &quot;#EC CI_SUBMIT
                DELETE REPORT ls_trdir-name.
              ENDIF.
            ENDIF.
          ENDIF.
      ENDCASE.
    ENDIF.

    cl_gui_cfw=&gt;flush( ).
*    IF zap_dev_est-tipo NE &apos;RT&apos;.
*      buscar_datos( ).
*    IF v_grid_ok = &apos;X&apos;.
*      o_alv-&gt;refrescar_grid( new_code = &apos;ENTER&apos; ).
*    ENDIF.
    buscar_datos( ).
    IF v_grid_ok = &apos;X&apos;.
      LEAVE TO SCREEN 0100.
    ENDIF.
*    ENDIF.
  ENDMETHOD.

  METHOD backup.
    DATA: izip       TYPE REF TO cl_abap_zip,
          l_xstring  TYPE xstring,
          l_filename TYPE string,
          l_xml      TYPE xstring.

    izip = NEW #( ).

    DEFINE add_zip.
      DATA i_&amp;1 TYPE TABLE OF &amp;1.

      SELECT * FROM &amp;1                                  &quot;#EC CI_NOWHERE
      INTO TABLE i_&amp;1.

      CALL TRANSFORMATION id
           SOURCE i_&amp;1 = i_&amp;1
           RESULT XML l_xml.

      izip-&gt;add( name    = &apos;&amp;1.XML&apos; content = l_xml ).
    END-OF-DEFINITION.

    add_zip: zap_dev,
             zap_dev_hist.

    l_xstring = izip-&gt;save( ).

    CONCATENATE &apos;ZAP_DEV&apos; zcl_c=&gt;cliente_tasks sy-datum &apos;.ZIP&apos; INTO l_filename SEPARATED BY &apos;_&apos;.

    zcl_ap_ficheros=&gt;grabar_xstring( fichero = l_filename xstring = l_xstring dialogo = &apos;X&apos; ).
  ENDMETHOD.

  METHOD restore.
    DATA: izip           TYPE REF TO cl_abap_zip,
          l_filename     TYPE string,
          l_xstring      TYPE xstring,
          l_xml          TYPE xstring,
          i_zap_dev      TYPE TABLE OF zap_dev,
          i_zap_dev_hist TYPE TABLE OF zap_dev_hist.

    izip = NEW #( ).
    l_filename = zcl_ap_ficheros=&gt;popup_select_fichero( file_filter = &apos;ZAP_DEV*&apos; default_extension = &apos;ZIP&apos; ).
    IF l_filename IS INITIAL.
      RETURN.
    ENDIF.
    zcl_ap_ficheros=&gt;leer_xstring( EXPORTING fichero = l_filename IMPORTING xstring = l_xstring ).
    IF l_xstring IS INITIAL.
      RETURN.
    ENDIF.
    izip-&gt;load( l_xstring ).

    izip-&gt;get( EXPORTING name    = &apos;ZAP_DEV.XML&apos;
               IMPORTING content = l_xml ).

    IF NOT l_xml IS INITIAL.
      CALL TRANSFORMATION id
           SOURCE XML l_xml
           RESULT i_zap_dev = i_zap_dev.

      IF zcl_c=&gt;cliente_tasks = &apos;MIN&apos;.
        MODIFY zap_dev FROM TABLE i_zap_dev.
      ELSE.
        LOOP AT i_zap_dev ASSIGNING FIELD-SYMBOL(&lt;zap_dev&gt;) WHERE    cliente    = zcl_c=&gt;cliente_tasks
                                                                  OR tipo       = &apos;RT&apos;
                                                                  OR objeto(1) &lt;&gt; &apos;Z&apos;.
          &lt;zap_dev&gt;-cliente = zcl_c=&gt;cliente_tasks.
          &lt;zap_dev&gt;-sysid   = sy-sysid.
          &lt;zap_dev&gt;-ernam   = sy-uname.
          SELECT SINGLE * FROM zap_dev
            INTO @DATA(l_zap_dev)
           WHERE cliente = @&lt;zap_dev&gt;-cliente
             AND sysid   = @sy-sysid
             AND ernam   = @&lt;zap_dev&gt;-ernam
             AND objeto  = @&lt;zap_dev&gt;-objeto
             AND tipo    = @&lt;zap_dev&gt;-tipo.
          IF sy-subrc = 0.
            IF l_zap_dev-valor1 IS INITIAL.
              l_zap_dev-valor1 = &lt;zap_dev&gt;-valor1.
            ENDIF.
            IF l_zap_dev-valor2 IS INITIAL.
              l_zap_dev-valor2 = &lt;zap_dev&gt;-valor2.
            ENDIF.
            IF l_zap_dev-valor3 IS INITIAL.
              l_zap_dev-valor3 = &lt;zap_dev&gt;-valor3.
            ENDIF.
            IF l_zap_dev-texto IS INITIAL.
              l_zap_dev-texto = &lt;zap_dev&gt;-texto.
            ENDIF.
            IF l_zap_dev-string IS INITIAL.
              l_zap_dev-string = &lt;zap_dev&gt;-string.
            ENDIF.
            MODIFY zap_dev FROM l_zap_dev.
          ELSE.
            INSERT zap_dev FROM &lt;zap_dev&gt;.
          ENDIF.
        ENDLOOP.
      ENDIF.
    ENDIF.

    CLEAR l_xml.
    izip-&gt;get( EXPORTING name    = &apos;ZAP_DEV_HIST.XML&apos;
               IMPORTING content = l_xml ).
    IF NOT l_xml IS INITIAL.
      CALL TRANSFORMATION id
           SOURCE XML l_xml
           RESULT i_zap_dev_hist = i_zap_dev_hist.
    ENDIF.

    IF zcl_c=&gt;cliente_tasks &lt;&gt; &apos;MIN&apos;.
      DELETE i_zap_dev_hist WHERE cliente &lt;&gt; zcl_c=&gt;cliente_tasks.
    ENDIF.
    MODIFY zap_dev_hist FROM TABLE i_zap_dev_hist.
  ENDMETHOD.

  METHOD get_obj_ots.
    DATA: l_fecha TYPE dats,
          l_ucomm TYPE sy-ucomm.

    l_fecha = sy-datum - 30.
    SELECT &apos; &apos; AS check, object, obj_name, as4date, as4text FROM e070 JOIN e07t ON e070~trkorr = e07t~trkorr &quot;#EC CI_USAGE_OK[2270335]
                       JOIN e071 ON e070~trkorr = e071~trkorr
      INTO TABLE @DATA(i_e071)
     WHERE     trfunction IN ( &apos;R&apos;, &apos;S&apos; )
       AND     trstatus    = &apos;D&apos;
       AND     as4user     = @sy-uname
       AND     as4date     &gt; @l_fecha
       AND NOT as4text    IN ( &apos;basura&apos;, &apos;borrar&apos; )
       AND     object     IN ( &apos;FORM&apos;, &apos;CLAS&apos;, &apos;REPS&apos;, &apos;PROG&apos;, &apos;METH&apos;, &apos;TABD&apos;, &apos;TABL&apos;, &apos;FUNC&apos; )
     GROUP BY object, obj_name, as4date, as4text.

    LOOP AT i_e071 ASSIGNING FIELD-SYMBOL(&lt;e071&gt;).
      IF &lt;e071&gt;-object = &apos;METH&apos;.
        &lt;e071&gt;-object   = &apos;CLAS&apos;.
        &lt;e071&gt;-obj_name = &lt;e071&gt;-obj_name(30).
      ENDIF.

      IF line_exists( i_listado[ objeto = &lt;e071&gt;-obj_name ] ).
        DELETE i_e071.
      ENDIF.
    ENDLOOP.

    SORT i_e071 BY obj_name ASCENDING as4date DESCENDING.
    DELETE ADJACENT DUPLICATES FROM i_e071 COMPARING obj_name.

    CALL FUNCTION &apos;Z_POPUP_ALV_AP&apos;
      EXPORTING
        titulo  = &apos;Seleccione objetos a incorporar&apos;
        check   = &apos;X&apos;
      IMPORTING
        ucomm   = l_ucomm
      TABLES
        t_datos = i_e071.

    IF l_ucomm = &apos;F01&apos;.
      LOOP AT i_e071 ASSIGNING &lt;e071&gt; WHERE check = &apos;X&apos;.
        DATA(l_tipo) = SWITCH zap_dev-tipo( &lt;e071&gt;-object
                                            WHEN &apos;CLAS&apos;           THEN &apos;CL&apos;
                                            WHEN &apos;REPS&apos; OR &apos;PROG&apos; THEN &apos;RE&apos;
                                            WHEN &apos;FORM&apos;           THEN &apos;FO&apos;
                                            WHEN &apos;FUNC&apos;           THEN &apos;FU&apos; &quot;#EC CI_USAGE_OK[2270335]
                                            WHEN &apos;TABD&apos; OR &apos;TABL&apos; THEN &apos;TA&apos;
                                            WHEN &apos;TCOD&apos;           THEN &apos;TR&apos; ).

        DATA(l_list) = get_list( objeto = CONV #( &lt;e071&gt;-obj_name ) tipo = l_tipo ).
        IF l_list-lights(3) &lt;&gt; icon_red_light(3).
          MOVE-CORRESPONDING l_list TO zap_dev_est.
        ENDIF.
        grabar( ).
      ENDLOOP.
      IF sy-subrc = 0.
        o_alv-&gt;refrescar_grid( ).
        o_alv_t-&gt;refrescar_grid( ).
      ENDIF.
    ENDIF.
  ENDMETHOD.

  METHOD get_list.
    CLEAR list.
    IF objeto = &apos;&apos;.
      RETURN.
    ENDIF.

    READ TABLE i_listado INTO list WITH KEY objeto = objeto tipo = tipo.
    IF sy-subrc = 0.
      RETURN.
    ENDIF.

    READ TABLE i_tcode INTO list WITH KEY objeto = objeto tipo = tipo.
    IF sy-subrc = 0.
      RETURN.
    ENDIF.

    READ TABLE i_pc INTO list WITH KEY objeto = objeto tipo = tipo.
    IF sy-subrc = 0.
      RETURN.
    ENDIF.

    SELECT * FROM zap_dev                               &quot;#EC CI_NOFIRST
      INTO CORRESPONDING FIELDS OF list
      UP TO 1 ROWS
     WHERE objeto = objeto AND tipo = tipo
     ORDER BY PRIMARY KEY.
    ENDSELECT.
    IF sy-subrc &lt;&gt; 0.
      list-objeto = objeto.
      list-tipo   = tipo.
    ENDIF.

    validaciones( CHANGING listado = list ).

    IF list-tipo = &apos;TR&apos;.
      INSERT list INTO i_tcode INDEX 1.
    ELSEIF list-tipo = &apos;PC&apos; OR list-tipo = &apos;UR&apos; OR list-tipo = &apos;NO&apos; OR list-tipo = &apos;RT&apos;.
      INSERT list INTO i_pc INDEX 1.
    ELSE.
      INSERT list INTO i_listado INDEX 1.
    ENDIF.
  ENDMETHOD.

  METHOD grabar.
    DATA l_list TYPE t_listado.

    FIELD-SYMBOLS &lt;listado&gt; TYPE t_listado.

    CLEAR zap_dev.
    MOVE-CORRESPONDING zap_dev_est TO zap_dev.
    IF o_prog-&gt;o_texto-&gt;es_editable( ) = &apos;X&apos;.
      o_texto-&gt;get_editor( IMPORTING string = zap_dev-string ).
    ELSE.
      l_list = get_list( objeto = zap_dev-objeto tipo = zap_dev-tipo ).
      IF NOT l_list IS INITIAL.
        zap_dev-string = l_list-string.
      ENDIF.
    ENDIF.
    zap_dev-cliente = zcl_c=&gt;cliente_tasks.
    zap_dev-sysid   = sy-sysid.
    zap_dev-ernam   = sy-uname.
    zap_dev-erdat   = sy-datum.
    zap_dev-erzet   = sy-uzeit.
    MODIFY zap_dev FROM zap_dev.
    LOOP AT i_listado ASSIGNING &lt;listado&gt; WHERE objeto = zap_dev-objeto AND tipo = zap_dev-tipo.
      MOVE-CORRESPONDING zap_dev TO &lt;listado&gt;.
    ENDLOOP.
    IF sy-subrc = 0.
      o_alv-&gt;refrescar_grid( ).
    ELSE.
      LOOP AT i_tcode ASSIGNING &lt;listado&gt; WHERE objeto = zap_dev-objeto AND tipo = zap_dev-tipo.
        MOVE-CORRESPONDING zap_dev TO &lt;listado&gt;.
      ENDLOOP.
      IF sy-subrc = 0.
        o_alv_t-&gt;refrescar_grid( ).
      ELSE.
        LOOP AT i_pc ASSIGNING &lt;listado&gt; WHERE objeto = zap_dev-objeto AND tipo = zap_dev-tipo.
          MOVE-CORRESPONDING zap_dev TO &lt;listado&gt;.
        ENDLOOP.
        IF sy-subrc = 0.
          o_alv_p-&gt;refrescar_grid( ).
        ELSE.
          buscar_datos( ).
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.
ENDCLASS.
*----------------------------------------------------------------------*
* INITIALIZATION
*----------------------------------------------------------------------*
INITIALIZATION.
  o_prog = NEW #(
      status              = &apos;&apos;
      guardar_logz        = &apos;X&apos;
      status_prog         = &apos;ZAP_STATUS&apos;
      get_nombre_pc       = &apos;X&apos;
      get_doc_from_report = &apos;&apos; ).

  IF sy-batch IS INITIAL.
    o_prog-&gt;o_event = NEW #(
        boton_refrescar = &apos;X&apos;
        boton_excel     = &apos;X&apos;
        boton_borrar    = &apos;X&apos;
        o_prog          = o_prog ).

    o_prog-&gt;o_alv   = NEW #(
                estructura = &apos;&apos;
                o_event    = o_prog-&gt;o_event ).

    IF o_prog-&gt;o_texto IS INITIAL.
      o_prog-&gt;o_texto = NEW #(
          controlname = &apos;TEXTO&apos; ).
    ENDIF.

    o_prog-&gt;o_alv-&gt;add_button( button = &apos;F01&apos; text = &apos;Ejecutar&apos; icon = icon_execute_object qinfo = &apos;Ejecutar&apos; ucomm = &apos;EJEC&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;F02&apos; text = &apos;Editar&apos; icon = icon_change qinfo = &apos;Editar&apos; ucomm = &apos;EDITAR&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;F03&apos; text = &apos;Visualizar&apos; icon = icon_display qinfo = &apos;Visualizar&apos; ucomm = &apos;VIS&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;F04&apos; text = &apos;Nuevo&apos; icon = icon_create qinfo = &apos;Nuevo&apos; ucomm = &apos;NUEVO&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;F05&apos; text = &apos;Refrescar&apos; icon = icon_refresh qinfo = &apos;Refrescar&apos; ucomm = &apos;REFRESH&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;F06&apos; text = &apos;Listado&apos; icon = icon_icon_list qinfo = &apos;Listado&apos; ucomm = &apos;LIST&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;F07&apos; text = &apos;Desarrollos&apos; icon = icon_calculation qinfo = &apos;Gestión desarrollos&apos; ucomm = &apos;DEV&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;F08&apos; text = &apos;OTs&apos; icon = icon_transport qinfo = &apos;Ordenes de transporte&apos; ucomm = &apos;OT&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;F09&apos; text = &apos;SQL&apos; icon = icon_question qinfo = &apos;SQL&apos; ucomm = &apos;SQL&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;M01&apos; text = &apos;Descarga librería&apos; qinfo = &apos;Descarga librería&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;M02&apos; text = &apos;ZEDIT&apos; qinfo = &apos;ZEDIT&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;M03&apos; text = &apos;No limitar&apos; qinfo = &apos;Mostrar todos los programas&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;M04&apos; text = &apos;Añadir OT&apos; qinfo = &apos;Añadir objetos de OT&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;M05&apos; text = &apos;SE16N editable&apos; qinfo = &apos;Ejecutar SE16N editable&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;M06&apos; text = &apos;Backup datos&apos; qinfo = &apos;Backup datos&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;M07&apos; text = &apos;Restaurar datos&apos; qinfo = &apos;Restaurar datos&apos; ).
    o_prog-&gt;o_alv-&gt;add_button( button = &apos;M08&apos; text = &apos;Recuperar objetos en OT&apos; ).
  ENDIF.

  DATA l_nombre_pc TYPE text255.
  l_nombre_pc(4) = o_prog-&gt;nombre_pc.
  IF zcl_c=&gt;usuario_ap = sy-uname AND o_prog-&gt;nombre_pc(2) &lt;&gt; &apos;NW&apos; AND l_nombre_pc(4) &lt;&gt; &apos;TSEC&apos;.
    IF NOT zcl_c=&gt;nombre_pc CS o_prog-&gt;nombre_pc.
      LEAVE TO TRANSACTION &apos;SMEN&apos;.
    ENDIF.
  ENDIF.

************************************************************************
* AT SELECTION-SCREEN.
************************************************************************
AT SELECTION-SCREEN.
  o_prog-&gt;at_selection( ).

AT SELECTION-SCREEN ON EXIT-COMMAND.
  o_prog-&gt;at_selection( ).

AT SELECTION-SCREEN OUTPUT.
*----------------------------------------------------------------------
* START-OF-SELECTION.
*----------------------------------------------------------------------*
START-OF-SELECTION.
  o_prog-&gt;buscar_datos( ).

  IF sy-batch IS INITIAL.
    CALL SCREEN 0100.
  ENDIF.

*&amp;---------------------------------------------------------------------*
*&amp;      Module  STATUS_0100  OUTPUT
*&amp;---------------------------------------------------------------------*

MODULE status_0100 OUTPUT.

  o_prog-&gt;status_dynpro_0100( ).

ENDMODULE.
*&amp;---------------------------------------------------------------------*
*&amp;      Module  USER_COMMAND_0100  INPUT
*&amp;---------------------------------------------------------------------*
MODULE user_command_0100 INPUT.

  o_prog-&gt;command_dynpro_0100( ).

ENDMODULE.
*&amp;---------------------------------------------------------------------*
*&amp;      Module  VALIDAR_TIPO  INPUT
*&amp;---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE validar_tipo INPUT.


  IF sy-ucomm &lt;&gt; &apos;GRABAR&apos;. &quot; Si pulsan en grabar modificamos lo que había
    IF zap_dev_est-objeto &lt;&gt; *zap_dev_est-objeto OR zap_dev_est-tipo &lt;&gt; *zap_dev_est-tipo.
      *zap_dev_est = zap_dev_est.
      CLEAR zap_dev_est.
      zap_dev_est-objeto = *zap_dev_est-objeto.
      zap_dev_est-tipo   = *zap_dev_est-tipo.
      CLEAR l_list.
      READ TABLE o_prog-&gt;i_listado INTO l_list WITH KEY objeto = zap_dev_est-objeto
                                                tipo   = zap_dev_est-tipo.
      IF sy-subrc &lt;&gt; 0.
        zap_dev_est-objeto = to_upper( zap_dev_est-objeto ).
        zap_dev_est-tipo   = to_upper( zap_dev_est-tipo ).
        SELECT SINGLE * FROM zap_dev
          INTO CORRESPONDING FIELDS OF l_list
          WHERE cliente = zcl_c=&gt;cliente_tasks AND sysid = sy-sysid AND ernam = sy-uname AND objeto = zap_dev_est-objeto AND tipo = zap_dev_est-tipo.
      ENDIF.
      IF l_list IS INITIAL.
        CLEAR: zap_dev_est-valor1, zap_dev_est-valor2, zap_dev_est-valor3, zap_dev_est-texto, zap_dev_est-trkorr.
        IF NOT o_prog-&gt;o_texto IS INITIAL.
          o_prog-&gt;o_texto-&gt;set_editor( string = &apos;&apos; display_mode = &apos;X&apos; ).
        ENDIF.
        l_list-tipo   = zap_dev_est-tipo.
        l_list-objeto = zap_dev_est-objeto.
        IF l_list-tipo IS INITIAL.
          l_list-tipo = &apos;RE&apos;.
        ENDIF.
*    ELSE.
*      IF NOT o_prog-&gt;o_texto IS INITIAL.
*        o_prog-&gt;o_texto-&gt;set_editor( string = l_list-string display_mode = &apos;X&apos;).
*      ENDIF.
      ENDIF.
      o_prog-&gt;validaciones( EXPORTING mod = &apos;X&apos; CHANGING listado = l_list ).
      zap_dev_est-tipo = l_list-tipo.
      *zap_dev_est = zap_dev_est.
      CLEAR g_zap_dev_est.
    ENDIF.
  ENDIF.

ENDMODULE.

*&amp;---------------------------------------------------------------------*
*&amp; Form GET_TEXT
*&amp;---------------------------------------------------------------------*
FORM get_text
  USING    o_cache   TYPE REF TO zcl_ap_cache
  CHANGING ps_tipo   TYPE any
           ps_objeto TYPE any
           ps_text   TYPE any.

  CLEAR ps_text.
  o_cache-&gt;get_cache_mem( EXPORTING tabla      = &apos;DEV_TEXT&apos;
                                    clave      = ps_tipo
                                    clave2     = ps_objeto
                          IMPORTING valor      = ps_text
                                    encontrado = o_cache-&gt;enc ).
  IF o_cache-&gt;enc IS NOT INITIAL.
    RETURN.
  ENDIF.

  CASE ps_tipo.
    WHEN &apos;RE&apos;.
      SELECT SINGLE text FROM trdirt
        INTO ps_text
       WHERE sprsl = sy-langu
         AND name  = ps_objeto.
      IF sy-subrc &lt;&gt; 0.
        SELECT name FROM trdir
          INTO ps_objeto
          UP TO 1 ROWS
         WHERE name = ps_objeto
          ORDER BY PRIMARY KEY.
        ENDSELECT.
        IF sy-subrc = 0.
          ps_text = &apos;.&apos;.
        ENDIF.
      ENDIF.
    WHEN &apos;TR&apos;.
      SELECT SINGLE ttext FROM tstct
    INTO ps_text
   WHERE sprsl = sy-langu
     AND tcode = ps_objeto.
      IF sy-subrc &lt;&gt; 0.
        SELECT ttext FROM tstct                         &quot;#EC CI_GENBUFF
      INTO ps_text
          UP TO 1 ROWS
     WHERE tcode = ps_objeto
         ORDER BY PRIMARY KEY.
        ENDSELECT.
      ENDIF.
    WHEN &apos;TA&apos;.
      SELECT ddtext FROM  dd02t
        INTO ps_text
        UP TO 1 ROWS
       WHERE tabname    = ps_objeto
         AND ddlanguage = sy-langu
       ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc &lt;&gt; 0.
        SELECT ddtext FROM  dd02t
          INTO ps_text
          UP TO 1 ROWS
               WHERE tabname = ps_objeto
          ORDER BY PRIMARY KEY.
        ENDSELECT.
      ENDIF.
    WHEN &apos;FU&apos;.
      SELECT stext FROM v_fdirt
        INTO ps_text
        UP TO 1 ROWS
       WHERE funcname = ps_objeto
         AND spras    = sy-langu
      ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc &lt;&gt; 0.
        SELECT stext FROM v_fdirt
          INTO ps_text
         UP TO 1 ROWS
         WHERE funcname = ps_objeto
          ORDER BY PRIMARY KEY.
        ENDSELECT.
      ENDIF.
    WHEN &apos;CL&apos;.
      SELECT descript FROM vseoclass
        INTO ps_text
        UP TO 1 ROWS
       WHERE clsname = ps_objeto
         AND langu   = sy-langu
       ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc &lt;&gt; 0.
        SELECT descript FROM vseoclass
          INTO ps_text
          UP TO 1 ROWS
         WHERE clsname = ps_objeto
          ORDER BY PRIMARY KEY.
        ENDSELECT.
      ENDIF.
    WHEN &apos;AF&apos;.
      SELECT  text FROM  fpcontextt
        INTO ps_text
        UP TO 1 ROWS
             WHERE name     = ps_objeto
               AND language = sy-langu
        ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc &lt;&gt; 0.
        SELECT text FROM  fpcontextt
          UP TO 1 ROWS
          INTO ps_text
               WHERE name = ps_objeto
          ORDER BY PRIMARY KEY.
        ENDSELECT.
      ENDIF.
  ENDCASE.

  o_cache-&gt;set_cache_mem( tabla = &apos;DEV_TEXT&apos; clave = ps_tipo clave2 = ps_objeto valor = ps_text ).
ENDFORM.</source>
</PROG>
