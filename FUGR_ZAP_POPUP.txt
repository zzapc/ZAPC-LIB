FUNCTION z_popup_alv_ap.
*"----------------------------------------------------------------------
*"*"Interfase local
*"  IMPORTING
*"     REFERENCE(TITULO) OPTIONAL
*"     REFERENCE(TEXTO) OPTIONAL
*"     REFERENCE(TEXTO2) OPTIONAL
*"     REFERENCE(CHECK) DEFAULT ''
*"     REFERENCE(ANCHO) TYPE  I DEFAULT 120
*"     REFERENCE(ALTO) TYPE  I DEFAULT 0
*"     REFERENCE(CAMPOS_NOOUT) DEFAULT ''
*"     REFERENCE(BOTONES) DEFAULT 'OK_CANCEL'
*"     REFERENCE(CAMPOS_TEXTO) DEFAULT ''
*"     REFERENCE(COMANDO_ENTER) DEFAULT ''
*"     REFERENCE(CAMPOS_INPUT) DEFAULT ''
*"     REFERENCE(GRID) DEFAULT ''
*"     REFERENCE(OPCIONES) DEFAULT ''
*"     REFERENCE(CAMPOS_ORDEN) DEFAULT ''
*"     REFERENCE(CAMPOS_SUM) DEFAULT ''
*"     REFERENCE(CAMPOS_HOTSPOT) TYPE  ANY DEFAULT ''
*"     REFERENCE(O_ALV_HELPER) TYPE REF TO  ZCL_AP_ALV OPTIONAL
*"     REFERENCE(CAMPO_USUARIO1) DEFAULT ''
*"     REFERENCE(CAMPO_USUARIO2) OPTIONAL
*"     REFERENCE(CAMPO_USUARIO3) OPTIONAL
*"  EXPORTING
*"     REFERENCE(COMANDO) TYPE  TEXT40
*"     REFERENCE(UCOMM) TYPE  SY-UCOMM
*"     REFERENCE(OK) TYPE  XFELD
*"     REFERENCE(FILA) TYPE  INT4
*"  TABLES
*"      T_DATOS
*"  CHANGING
*"     REFERENCE(VALOR_CAMPO_USUARIO1) OPTIONAL
*"     REFERENCE(VALOR_CAMPO_USUARIO2) OPTIONAL
*"     REFERENCE(VALOR_CAMPO_USUARIO3) OPTIONAL
*"----------------------------------------------------------------------
  DATA: l_alto  TYPE i,
        l_ancho TYPE i.

  CLEAR: v_inicio, ok, fila, comando, ucomm, v_ok, v_row, v_validar_seleccion, v_grid, v_controlar_cambios.

  v_texto = texto.
  v_titulo = titulo.
  IF titulo IS INITIAL.
    v_titulo = texto.
  ENDIF.
  v_texto2 = texto2.
  v_check = check.
*  v_opcion_borrar = opcion_borrar.
*  v_solo_aceptar = solo_aceptar.
*  v_seleccionar_fila = seleccionar_fila.
*  v_boton_imprimir = boton_imprimir.


  IF NOT ancho IS INITIAL.
    v_max_ancho = ancho.
  ENDIF.
  l_ancho = strlen( v_titulo ).
  IF l_ancho > v_max_ancho.
    v_max_ancho = l_ancho.
  ENDIF.
  l_ancho = strlen( v_texto ).
  IF l_ancho > v_max_ancho.
    v_max_ancho = l_ancho.
  ENDIF.
  ADD 3 TO v_max_ancho.

  IF v_max_ancho > 120.
    v_max_ancho = 120.
  ENDIF.

  DESCRIBE TABLE t_datos LINES l_alto.
  IF l_alto = 0.
    l_alto = 5.
  ELSEIF l_alto < 20.
    ADD 8 TO l_alto.
  ENDIF.
  IF NOT texto2 IS INITIAL.
    ADD 1 TO l_alto.
  ENDIF.
  IF l_alto > 27.
    l_alto = 27.
  ENDIF.

  IF NOT campos_sum IS INITIAL.
    IF campos_orden CS '*'.
      ADD 4 TO l_alto.
    ELSE.
      ADD 1 TO l_alto.
    ENDIF.
  ENDIF.

  IF NOT campo_usuario1 IS INITIAL.
    ADD 1 TO l_alto.
  ENDIF.
  IF NOT campo_usuario2 IS INITIAL.
    ADD 1 TO l_alto.
  ENDIF.
  IF NOT campo_usuario3 IS INITIAL.
    ADD 1 TO l_alto.
  ENDIF.

  v_campos_noout = campos_noout.
  v_campos_texto = campos_texto.
  v_comando_enter = comando_enter.
  v_campos_input = campos_input.
  v_campos_sum = campos_sum.
  v_campos_orden = campos_orden.
  v_campos_hotspot = campos_hotspot.
  v_opciones = opciones.
  v_alv_helper = o_alv_helper.
  v_campo_usuario1 = campo_usuario1.
  v_campo_usuario2 = campo_usuario2.
  v_campo_usuario3 = campo_usuario3.

  CLEAR svald1.
  IF NOT v_campo_usuario1 IS INITIAL AND NOT valor_campo_usuario1 IS INITIAL.
    svald1-value = valor_campo_usuario1.
  ENDIF.

  CLEAR svald2.
  IF NOT v_campo_usuario2 IS INITIAL AND NOT valor_campo_usuario2 IS INITIAL.
    svald2-value = valor_campo_usuario2.
  ENDIF.

  CLEAR svald3.
  IF NOT v_campo_usuario3 IS INITIAL AND NOT valor_campo_usuario3 IS INITIAL.
    svald3-value = valor_campo_usuario3.
  ENDIF.

  ASSIGN ('T_DATOS[]') TO <tabla>.

  v_grid = grid.
  IF NOT v_campos_input IS INITIAL.
    v_grid = 'X'.
  ENDIF.

  IF v_grid IS INITIAL.
    IF NOT o_alv_popup IS INITIAL.
      o_alv_popup->free( ).
      CLEAR o_alv_popup.
    ENDIF.
  ELSE.
    IF NOT o_grid_popup IS INITIAL.
      o_grid_popup->free( ).
      CLEAR o_grid_popup.
    ENDIF.
  ENDIF.

  v_max_ancho_txt = v_max_ancho - 3.
  v_botones = botones.
  CLEAR v_inicio.

  IF v_campo_usuario1 NE '' OR v_campo_usuario2 NE '' OR v_campo_usuario3 NE ''.
    DATA fields TYPE TABLE OF sval WITH HEADER LINE.
    PERFORM prepare_and_check TABLES fields.
  ENDIF.

  PERFORM get_boton IN PROGRAM zap_status CHANGING v_buttons.
  PERFORM clear_botones IN PROGRAM zap_status.
  CALL SCREEN 0100 STARTING AT 3 3 ENDING AT v_max_ancho l_alto.
  PERFORM set_boton IN PROGRAM zap_status USING v_buttons.

  IF NOT campo_usuario1 IS INITIAL.
    valor_campo_usuario1 = svald1-value.
  ENDIF.
  IF NOT campo_usuario2 IS INITIAL.
    valor_campo_usuario2 = svald2-value.
  ENDIF.
  IF NOT campo_usuario3 IS INITIAL.
    valor_campo_usuario3 = svald3-value.
  ENDIF.

  ok = v_ok.
  fila = v_row.
  ucomm = v_ucomm.
  comando = v_comando.

ENDFUNCTION.



*    DO.
*      CALL FUNCTION 'Z_POPUP_ALV_AP'
*        EXPORTING
*          check        = 'X'
*          botones      = '$B=F01&&T=Asociar anexo&&I=@R7@&&S=X||B=F02&&T=Salir&&I=@0V@'.
*          campos_texto = 'ICON=Asociado&&CREATIME=Hora'
*          campos_noout = 'ARC_DOC_ID,ARCHIV_ID,SAP_OBJECT,OBJECT_ID,AR_OBJECT'
*        IMPORTING
*          comando      = comando
**         UCOMM        = UCOMM
*          ok           = ok
*          fila         = fila
*        TABLES
*          t_datos      = i_docs.
*
*      IF ok = 'S'.
*        READ TABLE i_docs ASSIGNING <docs> INDEX fila.
*        IF sy-subrc = 0.
*           ACCION DOBLE CLICK
*        ENDIF.
*      ELSE.
*        IF comando = 'Asociar anexo'.
*          HACER ALGO
*        ELSE.
*          EXIT.
*        ENDIF.
*      ENDIF.
*    ENDDO.
