************************************************************************
* APLICACION  : BC                                                    *
* TIPO        : Listado
* TITULO      : Listado seguimiento desarrollos
* DESCRIPCION :
* VERSION     : 0.70
*                                                                      *
*AUTOR: Andres Picazo                           FECHA: 28/02/2007      *
* MODIFICACIONES                                                       *
* -------------                                                        *
* FECHA        NOMBRE                               ORDEN              *
* -------------------------------------------------------------------- *
* dd.mm.yyyy   username                                                *
************************************************************************
REPORT zbcut011
      NO STANDARD PAGE HEADING
      LINE-COUNT 065
      LINE-SIZE 100.

* Trampo status
* inlclude LSMPIF03 linea 62 form check_adm tables
*if sy-uname = zcl_c=>usuario_ap. exit. endif.

*------INCLUDES--------------------------------------------------------*

CONSTANTS: c_version TYPE p VALUE 20170919.

*------TABLAS/ESTRUCTURAS----------------------------------------------*
TABLES:
*  zestadisticas,
  seoclass,
  cross,
  trdir,
  tadir,
  ddtypes,
  tfdir,
  v_fdirt,
  stxh,
  zbc003,
  zbc003t,
  stxfadm,
  modtext,
  modact,
  modsap,
  tstcp,
  ttxfp,
  dd02l,
  smimloio,
  e071,
  rseuinc,
  dd40l,
  dd04l,
  dd01l,
  dd02t,
  o2xsltdesc,
  hrs1000,
  sscrfields,
  tstc.

DATA: i_listado         TYPE TABLE OF zest_zbc003 WITH HEADER LINE,
      i_list_orig       TYPE TABLE OF zest_zbc003 WITH HEADER LINE,
      i_list            TYPE TABLE OF zest_zbc003 WITH HEADER LINE,
      l_listado         TYPE zest_zbc003,
      enhincinx         TYPE enhincinx,
      fpcontext         TYPE fpcontext,
      fpinterface       TYPE fpinterface,
      v_ruta_comparador TYPE string.

DATA: i_source(255) OCCURS 0 WITH HEADER LINE.

DATA: BEGIN OF i_cambios OCCURS 0,
        name    TYPE trdir-name,
        vrsflag TYPE vxabapt255-vrsflag,
        number  TYPE vxabapt255-number,
        line    TYPE vxabapt255-line,
      END OF i_cambios,
      i_camb    TYPE TABLE OF vxabapt255,
      l_camb    TYPE vxabapt255,
      l_cambios LIKE i_cambios,
      i_grupof  TYPE TABLE OF string WITH HEADER LINE.

*------VARIABLES-------------------------------------------------------*
DATA: sgpi  TYPE REF TO zcl_ap_sgpi,
      o_alv TYPE REF TO zcl_ap_alv_grid,
      o_enh TYPE REF TO cl_enh_editor_navigator.

DATA: BEGIN OF i_ztasks OCCURS 0,
        cliente(3),
        objeto(30),
        descripcion_obj(80),
        texto               TYPE string,
      END OF i_ztasks.


DATA: v_directorio         TYPE string.
DATA: v_ans,
      v_emailaddr(130),
      v_no_se_adjunta_slnk,
      i_ficheros_ftp       TYPE TABLE OF string WITH HEADER LINE.

DATA o_bi      TYPE REF TO zcl_ap_batch_input.
DATA l_mensaje TYPE bapireturn1-message.                    "#EC *

DATA o_prog TYPE REF TO zcl_ap_dev.

DEFINE addrango_eq.
  CLEAR &1.
  &1-option = 'EQ'.
  &1-sign = 'I'.
  &1-low = &2.
  APPEND &1.
END-OF-DEFINITION.


DEFINE addrango_neq.
  CLEAR &1.
  &1-option = 'EQ'.
  &1-sign = 'E'.
  &1-low = &2.
  APPEND &1.
END-OF-DEFINITION.

*----------------------------------------------------------------------*
* CLASS lcl_event_grid_100 DEFINITION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_event_grid DEFINITION INHERITING FROM zcl_ap_alv_grid_eventos.
  PUBLIC SECTION.
    METHODS: double_click REDEFINITION,
      toolbar      REDEFINITION,
      user_command REDEFINITION.
ENDCLASS. "lcl_event_grid_100 DEFINITION

DATA: o_event        TYPE REF TO lcl_event_grid,
      v_fechas_vivas TYPE d,
      i_ficheros     TYPE TABLE OF file_info WITH HEADER LINE.

*------PARAMETER/SELECT-OPTIONS EN PANTALLA----------------------------*
SELECTION-SCREEN BEGIN OF BLOCK blk_par WITH FRAME TITLE TEXT-001.

SELECT-OPTIONS: s_tcode  FOR tstc-tcode,
                s_report FOR trdir-name,
                s_subc   FOR trdir-subc,
                s_devcla FOR tadir-devclass,
                s_estado FOR zbc003-estado,
                s_grupo  FOR zbc003-grupo,
                s_cdat   FOR trdir-cdat,
                s_udat   FOR trdir-udat,
                s_cnam   FOR trdir-cnam,
                s_unam   FOR trdir-unam,
                s_asign  FOR zbc003-asignado_a,
                s_progr  FOR zbc003-probado_por,
                s_prior  FOR zbc003-prioridad.

SELECTION-SCREEN SKIP.

PARAMETERS: p_report AS CHECKBOX DEFAULT 'X',
            p_funcio AS CHECKBOX DEFAULT ' ',
            p_clases AS CHECKBOX DEFAULT ' ',
            p_formul AS CHECKBOX DEFAULT ' ',
            p_proyec AS CHECKBOX DEFAULT ' ',
            p_badis  AS CHECKBOX DEFAULT ' ',
            p_userex AS CHECKBOX DEFAULT ' ',
            p_modife AS CHECKBOX DEFAULT ' ',
            p_rutina AS CHECKBOX DEFAULT ' ',
            p_tablas AS CHECKBOX DEFAULT ' ',
            p_enhan  AS CHECKBOX DEFAULT ' ',
            p_bte    AS CHECKBOX DEFAULT ' ',
            p_bsp    AS CHECKBOX DEFAULT ' ',
            p_mime   AS CHECKBOX DEFAULT ' ',
            p_webd   AS CHECKBOX DEFAULT '',
            p_pdf    AS CHECKBOX DEFAULT '',
            p_xslt   AS CHECKBOX DEFAULT '',
            p_wf     AS CHECKBOX DEFAULT ''.

SELECTION-SCREEN END OF BLOCK blk_par.

SELECTION-SCREEN BEGIN OF BLOCK blk_par3 WITH FRAME TITLE TEXT-003.
PARAMETERS: p_lib    AS CHECKBOX,
            p_solom  AS CHECKBOX,
            p_utili  AS CHECKBOX,
            p_numlin AS CHECKBOX,
            p_zip    AS CHECKBOX,
            p_outlo  AS CHECKBOX,
            p_ftp    AS CHECKBOX,
            p_origen DEFAULT 'L',
            p_dirlib TYPE string,
            p_vivas  AS CHECKBOX,
            p_libt   AS CHECKBOX.
SELECTION-SCREEN END OF BLOCK blk_par3.


************************************************************************
*
*                  LOGICA DEL PROGRAMA
*
************************************************************************


*----------------------------------------------------------------------*
* INITIALIZATION
*----------------------------------------------------------------------*
INITIALIZATION.

  CREATE OBJECT o_prog
    EXPORTING
      get_nombre_pc = 'X'.

  o_prog->initialization( EXPORTING nombre_pc = o_prog->nombre_pc CHANGING sscrfields = sscrfields ).

*  addrango_eq: s_subc '1',
*               s_subc 'M',
*               s_subc 'S'.


  addrango_neq: s_estado 'B',
                s_estado 'N',
                s_estado 'O'.

  IF sy-uname = zcl_c=>usuario_ap.
    SET PARAMETER ID 'SAPLINK_AUTHOR' FIELD 'APICAZO'.
  ENDIF.


AT SELECTION-SCREEN.

*----------------------------------------------------------------------
* START-OF-SELECTION.
*----------------------------------------------------------------------*
START-OF-SELECTION.

  IF p_vivas = 'X'.
    p_report = 'X'.
    p_funcio = 'X'.
    p_clases = 'X'.
    p_formul = 'X'.
*    p_proyec = 'X'.
*    p_badis  = 'X'.
    p_tablas = 'X'.
    p_pdf    = 'X'.
*    p_xslt   = 'X'.
    v_fechas_vivas = zcl_ap_temp=>get_st_valor1( clave = sy-tcode subclave = sy-uname ).
    IF v_fechas_vivas IS INITIAL.
      v_fechas_vivas = sy-datum - 365.
    ENDIF.
  ELSEIF p_libt = 'X'.
    p_lib = 'X'.
    p_solom = 'X'.
    p_report = 'X'.
    p_funcio = 'X'.
    p_clases = 'X'.
    p_tablas = 'X'.
*    v_fechas_vivas = sy-datum - 60.
*    CLEAR s_udat.
*    s_udat-option = 'GT'.
*    s_udat-sign = 'I'.
*    s_udat-low = v_fechas_vivas.
*    APPEND s_udat.
  ENDIF.

  IF p_lib = 'X'.
    v_ruta_comparador = zcl_ap_ficheros=>buscar_ruta_fichero( fichero = 'WinMergeU.exe'
                                                              rutas = 'C:\Program Files (x86)\WinMerge\,C:\Users\andres\OneDrive\tools\WinMerge\,C:\OneDrive\tools\WinMerge\,D:\OneDrive\tools\WinMerge' ).

  ENDIF.

  IF NOT p_dirlib IS INITIAL.
    v_directorio = p_dirlib.
  ELSE.
    v_directorio = zcl_ap_ficheros=>buscar_ruta_fichero( rutas = '\\vmware-host\Shared Folders\Google Drive\LIB,Z:\Google Drive\LIB,C:\Users\Andres\Google Drive\LIB,D:\Google Drive\LIB' ).
  ENDIF.

  IF p_lib IS INITIAL.
    DATA: v_aux1 TYPE string, v_aux2 TYPE string.
    SPLIT zcl_c=>ruta_descarga_slnk AT '\CODIGO\Reports slnk\' INTO v_aux1 v_aux2.
    CONCATENATE '\CODIGO\Reports slnk\' v_aux2 INTO v_aux1.
    REPLACE '\LIB' IN v_directorio WITH v_aux1.
  ENDIF.
  IF p_solom = 'X'.
    i_ficheros[] = zcl_ap_ficheros=>lista_ficheros( v_directorio ).
  ENDIF.

  CREATE OBJECT sgpi.
  CREATE OBJECT o_bi.

  PERFORM seleccionar_datos.

  CALL SCREEN 0100.



************************************************************************
*
*                  FORMS ADICIONALES
*
************************************************************************


*&---------------------------------------------------------------------*

*&      Form  SELECCIONAR_DATOS
*&---------------------------------------------------------------------*
*       Selecciona las devoluciones
*----------------------------------------------------------------------*

FORM seleccionar_datos.
  DATA: i_trdir LIKE trdir OCCURS 1000 WITH HEADER LINE,
        BEGIN OF i_tstc  OCCURS 300,
          pgmna LIKE tstc-pgmna,
          tcode LIKE tstc-tcode,
        END   OF i_tstc,
        BEGIN OF i_estad OCCURS 1000,
          report(40),  "LIKE zestadisticas-report,
          fecha      TYPE d, "LIKE zestadisticas-fecha,

          account    TYPE sy-uname, "LIKE zestadisticas-account,
          total      TYPE i,
        END OF i_estad,
        l_aux(60),
        i_est     LIKE i_estad OCCURS 100000 WITH HEADER LINE,
        l_fin,
        l_tcode   TYPE sy-tcode.

  DATA: r_obj TYPE TABLE OF rstt_s_range_string WITH HEADER LINE.

  CLEAR r_obj.
  r_obj-option = 'CP'.
  r_obj-sign   = 'I'.
  r_obj-low    = 'Z*'.
  APPEND r_obj.
  r_obj-low    = 'Y*'.
  APPEND r_obj.
  IF sy-uname = zcl_c=>usuario_ap.
    r_obj-low    = '/SOTHIS/*'.
    APPEND r_obj.
    r_obj-low    = '/SEI/*'.
    APPEND r_obj.
    r_obj-low    = '/MOVI/*'.
    APPEND r_obj.
    r_obj-low    = '/COCKPIT/*'.
    APPEND r_obj.
  ENDIF.


  IF p_vivas IS INITIAL.
    DATA l_tabla TYPE tabname VALUE 'ZESTADISTICAS'.
    SELECT SINGLE tabname FROM dd02l
      INTO l_tabla
     WHERE tabname = l_tabla.
    IF sy-subrc = 0.
      SELECT * FROM (l_tabla)
        INTO CORRESPONDING FIELDS OF TABLE i_est
       WHERE report IN s_report
         AND ( report IN r_obj
          OR   report LIKE 'SAPMZ%' ).
      SORT i_est.
      LOOP AT i_est.
        AT NEW report.
          CLEAR i_estad.
          CLEAR l_fin.
        ENDAT.
        ADD 1 TO i_estad-total.
        AT END OF report.
          l_fin = 'X'.
        ENDAT.
        IF l_fin = 'X'.
          i_estad-report  = i_est-report.
          i_estad-fecha   = i_est-fecha.
          i_estad-account = i_est-account.
          APPEND i_estad.
          CLEAR l_fin.
        ENDIF.
      ENDLOOP.
      REFRESH i_est.
      SORT i_estad.
    ENDIF.
  ENDIF.



  RANGES: r_name FOR trdir-name,
          r_name_apc FOR trdir-name.
  DATA i_zbc003 LIKE zbc003 OCCURS 0 WITH HEADER LINE.

  addrango_eq r_name_apc '&&&&&'.
  IF NOT s_grupo[] IS INITIAL OR
     NOT s_asign[] IS INITIAL OR
     NOT s_progr[] IS INITIAL OR
     NOT s_prior[] IS INITIAL OR
     NOT p_lib IS INITIAL.
    SELECT * FROM zbc003
      INTO TABLE i_zbc003
     WHERE ( grupo IN s_grupo OR
             grupo2 IN s_grupo OR
             grupo3 IN s_grupo )
       AND asignado_a IN s_asign
       AND procesado_por IN s_progr
         AND name IN s_report
      AND prioridad IN s_prior.
    IF sy-subrc NE 0.
      addrango_eq r_name '&&&&&'.
    ELSE.
      IF p_lib = 'X'.
        DELETE i_zbc003 WHERE libreria = ''.
      ENDIF.
      LOOP AT i_zbc003.
        addrango_eq r_name i_zbc003-name.
      ENDLOOP.
    ENDIF.
  ELSEIF p_vivas = 'X'.
    SELECT * FROM zbc003
      INTO TABLE i_zbc003
     WHERE name IN s_report
       AND ( asignado_a = sy-uname
          OR procesado_por = sy-uname
          OR prioridad NE 0 ).
    IF sy-subrc = 0.
      IF p_lib = 'X'.
        DELETE i_zbc003 WHERE libreria = ''.
      ENDIF.
      LOOP AT i_zbc003.
        addrango_eq r_name_apc i_zbc003-name.
      ENDLOOP.
    ENDIF.
  ENDIF.

  IF p_report = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando programas' ).
* Buscamos programas

    IF p_vivas IS INITIAL.
      SELECT * FROM  trdir
        INTO TABLE i_trdir
       WHERE ( name  IN r_obj
            OR name  LIKE 'SAPMZ%'
            OR name  LIKE 'MZ%'
            OR name  LIKE 'LZ%F01' )
          AND NOT name LIKE '%=====%'
          AND name IN s_report
          AND name IN r_name
      AND ( subc = '1' OR subc = 'M' OR subc = 'I' OR subc = 'S' )
      AND subc IN s_subc
      AND ( cnam IN s_cnam
        AND unam IN s_unam
        AND cdat IN s_cdat
        AND udat IN s_udat ).
    ELSE.
      SELECT * FROM  trdir
        INTO TABLE i_trdir
       WHERE
        name IN r_name_apc
         OR (
            ( name  IN r_obj
           OR name  LIKE 'SAPMZ%'
           OR name  LIKE 'MZ%'
           OR name  LIKE 'LZ%F01' )
         AND NOT name LIKE '%=====%'
         AND name IN s_report
         AND name IN r_name
      AND ( subc = '1' OR subc = 'M' OR subc = 'I' OR subc = 'S' )
      AND subc IN s_subc
      AND ( cnam = sy-uname OR unam = sy-uname )
      AND ( cdat >= v_fechas_vivas OR udat >= v_fechas_vivas )
        ).

      LOOP AT i_zbc003 WHERE prioridad = '88888'.
        DELETE i_trdir WHERE name = i_zbc003-name.
      ENDLOOP.

      SELECT * FROM tstc
        INTO CORRESPONDING FIELDS OF TABLE i_tstc
        FOR ALL ENTRIES IN i_trdir
       WHERE pgmna = i_trdir-name.
    ENDIF.
    SORT i_tstc.
    sgpi->get_filas_tabla( i_trdir[] ).
    LOOP AT i_trdir.
      SELECT SINGLE devclass FROM  tadir
        INTO i_listado-devclass
       WHERE pgmid = 'R3TR'
         AND object = 'PROG'
         AND obj_name   = i_trdir-name
         AND delflag = ''.
      IF sy-subrc = 0.
        sgpi->porcentaje( texto = 'Procesando' cantidad = sy-tabix ).
        CLEAR i_listado.
        MOVE-CORRESPONDING i_trdir TO i_listado.
        i_listado-object = 'PROG'.
        READ TABLE i_tstc WITH KEY pgmna = i_trdir-name
                          BINARY SEARCH.
        IF sy-subrc = 0.
          i_listado-tcode = i_tstc-tcode.
        ELSE.
          i_listado-tcode = 'SE38'.
        ENDIF.

        IF i_listado-tcode IN s_tcode.
          APPEND i_listado.
        ENDIF.
      ENDIF.
    ENDLOOP.

    zcl_ap_sgpi=>text( 'Seleccionando transacciones sin report Z' ).
    LOOP AT i_tstc WHERE ( tcode(1) = 'Z'
                        OR tcode(1) = 'Y' )
                     AND   tcode IN s_tcode.
      READ TABLE i_listado WITH KEY tcode = i_tstc-tcode.
      IF sy-subrc NE 0.
        CLEAR i_listado.
        i_listado-tcode = i_tstc-tcode.
        i_listado-name  = i_tstc-pgmna.
        IF i_listado-name IS INITIAL.
          SELECT SINGLE * FROM tstcp
           WHERE tcode = i_tstc-tcode.
          IF sy-subrc = 0.
            i_listado-subc = '1'.
            IF tstcp-param+2(12) = 'START_REPORT'.
              DATA: l_aux1(80), l_aux2(80).
              SPLIT tstcp-param AT 'D_SREPOVARI-REPORT='
                     INTO l_aux1 l_aux2.
              SPLIT l_aux2 AT ';' INTO i_listado-name l_aux1.
            ELSEIF tstcp-param+2(4) = 'ZBC4'.
              SPLIT tstcp-param AT 'P_TABLA='
                     INTO l_aux1 l_aux2.
              SPLIT l_aux2 AT ';' INTO i_listado-aux l_aux1.
            ELSEIF tstcp-param+2(6) = 'ZBCTAB'.
              SPLIT tstcp-param AT 'TABLA='
                     INTO l_aux1 l_aux2.
              SPLIT l_aux2 AT ';' INTO i_listado-aux l_aux1.
            ELSE.
              i_listado-name = tstcp-param+2.
            ENDIF.
          ENDIF.
        ENDIF.

        IF i_listado-name IN r_name.
          READ TABLE i_trdir WITH KEY name = i_listado-name
                             BINARY SEARCH.
          IF sy-subrc = 0.
            MOVE-CORRESPONDING i_trdir TO i_listado.
          ELSE.
            SELECT SINGLE * FROM  trdir
             WHERE name  = i_listado-name
               AND name IN s_report.
            IF sy-subrc = 0.
              MOVE-CORRESPONDING trdir TO i_listado.
            ENDIF.
          ENDIF.

          IF i_listado-name(4) = 'AQQQ'.
            i_listado-subc = 'Q'.
          ENDIF.
          IF i_listado-subc IN s_subc.
            APPEND i_listado.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDLOOP.

    zcl_ap_sgpi=>text( 'Seleccionando programas' ).
    LOOP AT i_listado.
      IF NOT i_listado-tcode IS INITIAL.

        IF i_listado-name IS INITIAL.
          SELECT SINGLE * FROM tstcp
           WHERE tcode = i_listado-tcode.
          SEARCH tstcp FOR 'EXTDREPORT=KE'.
          IF sy-subrc = 0.
            DELETE i_listado.
            CONTINUE.
          ENDIF.
        ENDIF.

        SELECT SINGLE ttext FROM tstct
      INTO i_listado-ttext
     WHERE sprsl = sy-langu
       AND tcode = i_listado-tcode.
      ENDIF.
      SELECT SINGLE text FROM trdirt
        INTO i_listado-text
       WHERE sprsl = sy-langu
         AND name  = i_listado-name.
      SELECT SINGLE devclass FROM  tadir
        INTO i_listado-devclass
       WHERE pgmid  = 'R3TR'
         AND object = 'PROG'
         AND obj_name  = i_listado-name.
      IF i_listado-devclass IN s_devcla.
        IF NOT i_listado-name IS INITIAL.
          READ TABLE i_estad WITH KEY report = i_listado-name
                             BINARY SEARCH.
          IF sy-subrc = 0.
            i_listado-total  = i_estad-total.
            i_listado-fult   = i_estad-fecha.
            i_listado-uuname = i_estad-account.
          ENDIF.
        ENDIF.

        IF p_numlin = 'X'.
          IF NOT i_listado-name IS INITIAL.
            READ REPORT i_listado-name INTO i_source.
            DESCRIBE TABLE i_source LINES i_listado-numlin.
          ENDIF.
        ENDIF.

        MODIFY i_listado.
      ELSE.
        DELETE i_listado.
      ENDIF.
    ENDLOOP.
  ENDIF.

  IF p_utili = 'X'.
    LOOP AT i_listado WHERE subc = '1'.
      SELECT * FROM cross
       WHERE type = 'R'
         AND name = i_listado-name.
        IF i_listado-aux IS INITIAL.
          i_listado-aux = cross-include.
        ELSE.
          CONCATENATE i_listado-aux ',' cross-include
                 INTO i_listado-aux SEPARATED BY space.
        ENDIF.
        IF i_listado-total = 0.
          READ TABLE i_estad WITH KEY report = cross-include
                             BINARY SEARCH.
          IF sy-subrc = 0.
            i_listado-total = i_estad-total.
          ENDIF.
        ENDIF.

      ENDSELECT.
      MODIFY i_listado.
    ENDLOOP.

    LOOP AT i_listado WHERE subc = 'I'.
      SELECT * FROM rseuinc
       WHERE include = i_listado-name.
        IF i_listado-aux IS INITIAL.
          i_listado-aux = rseuinc-master.
        ELSE.
          CONCATENATE i_listado-aux ',' rseuinc-master
                 INTO i_listado-aux SEPARATED BY space.
        ENDIF.
        IF i_listado-total = 0.
          READ TABLE i_estad WITH KEY report = rseuinc-master
                            BINARY SEARCH.
          IF sy-subrc = 0.
            i_listado-total = i_estad-total.
          ENDIF.
        ENDIF.
        IF i_listado-tcode IS INITIAL.
          READ TABLE i_tstc WITH KEY pgmna = rseuinc-master
                            BINARY SEARCH.
          IF sy-subrc = 0.
            i_listado-tcode = i_tstc-tcode.
            SELECT SINGLE ttext FROM tstct
          INTO i_listado-ttext
         WHERE sprsl = sy-langu
           AND tcode = i_listado-tcode.
          ENDIF.
        ENDIF.
      ENDSELECT.
      MODIFY i_listado.
    ENDLOOP.
  ENDIF.

  IF p_funcio = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando programas' ).
    SELECT * FROM v_fdirt
     WHERE area IN r_obj
       AND funcname IN s_report
       AND funcname NOT LIKE 'TABLE%'
       AND funcname NOT LIKE 'VIEW%'
       AND active = 'X'
       AND spras  = sy-langu.
      IF v_fdirt-funcname IN r_name.
        SELECT SINGLE * FROM tadir
         WHERE pgmid = 'R3TR'
           AND object = 'FUGR'
          AND obj_name = v_fdirt-area
          AND devclass IN s_devcla.
        IF sy-subrc = 0.
          CLEAR i_listado.
          i_listado-object   = 'FUGR'.  "APC03112010
          i_listado-devclass = tadir-devclass.
          PERFORM get_funcion USING v_fdirt-funcname.
          IF p_utili = 'X'.
            SELECT * FROM cross
             WHERE type = 'F'
               AND name = i_listado-name.
              IF i_listado-aux IS INITIAL.
                i_listado-aux = cross-include.
              ELSE.
                CONCATENATE i_listado-aux ',' cross-include
                       INTO i_listado-aux SEPARATED BY space.
              ENDIF.
              IF i_listado-total = 0.
                READ TABLE i_estad WITH KEY report = cross-include
                                   BINARY SEARCH.
                IF sy-subrc = 0.
                  i_listado-total = i_estad-total.
                ENDIF.
              ENDIF.

            ENDSELECT.
          ENDIF.

          APPEND i_listado.
        ENDIF.
      ENDIF.
    ENDSELECT.
  ENDIF.



  IF p_clases = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando clases' ).
    DATA i_tadir TYPE TABLE OF tadir WITH HEADER LINE.

    IF i_zbc003[] IS INITIAL.
      SELECT * FROM  tadir
        INTO TABLE i_tadir
       WHERE pgmid = 'R3TR'
         AND object = 'CLAS'
         AND obj_name  IN r_obj
         AND obj_name IN s_report
         AND devclass IN s_devcla
         AND delflag = ''.
    ELSE.
      SELECT * FROM  tadir
        INTO TABLE i_tadir
         FOR ALL ENTRIES IN i_zbc003
       WHERE pgmid = 'R3TR'
         AND object = 'CLAS'
         AND obj_name  = i_zbc003-name
         AND devclass IN s_devcla
         AND delflag = ''.
    ENDIF.
    LOOP AT i_tadir INTO tadir.
      SELECT SINGLE * FROM seoclass
       WHERE clsname = tadir-obj_name.
      IF sy-subrc = 0.
        CLEAR i_listado.
        i_listado-name     = tadir-obj_name.
        i_listado-object   = tadir-object.
        i_listado-subc     = 'C'.
        i_listado-tcode    = 'SE24'.
        i_listado-text     = stxh-tdtitle.
        i_listado-devclass = tadir-devclass.

        SELECT SINGLE descript author createdon
                      changedby changedon
          FROM vseoclass
          INTO (i_listado-text, i_listado-cnam, i_listado-cdat,
                i_listado-unam, i_listado-udat)
         WHERE clsname = tadir-obj_name
           AND langu = sy-langu.

        CONCATENATE tadir-obj_name '%' INTO l_aux.
        SELECT MAX( udat ) FROM progdir
          INTO i_listado-udat
         WHERE name LIKE l_aux.

        SELECT SINGLE unam FROM progdir
          INTO i_listado-unam
         WHERE name LIKE l_aux
           AND state = 'A'
           AND udat = i_listado-udat.

        APPEND i_listado.
      ENDIF.
    ENDLOOP.
  ENDIF.

  IF p_enhan = 'X'.                                                              "NOLIB
    CREATE OBJECT o_enh.
    zcl_ap_sgpi=>text( 'Seleccionando enhancement' ).                            "NOLIB
    SELECT * FROM  tadir                                                         "NOLIB
     WHERE object IN ('ENHO', 'ENHS')
       AND obj_name IN r_obj                                                   "NOLIB
       AND obj_name IN s_report.                                                 "NOLIB
      "NOLIB
      CLEAR i_listado.                                                           "NOLIB
      i_listado-name   = tadir-obj_name.  "NOLIB
      i_listado-object = tadir-object.
      i_listado-subc   = 'A'.  "NOLIB

      CLEAR enhincinx.
      SELECT SINGLE * FROM enhincinx
        INTO enhincinx
       WHERE enhname = i_listado-name.
      IF NOT enhincinx-enhinclude IS INITIAL.
        SELECT SINGLE cnam cdat unam udat vern FROM trdir
          INTO CORRESPONDING FIELDS OF i_listado
         WHERE name = enhincinx-enhinclude.
      ENDIF.

      SELECT SINGLE obj_name FROM enhobj                                "NOLIB
        INTO (i_listado-tcode )                                "NOLIB
       WHERE enhname = tadir-obj_name.                                           "NOLIB
      i_listado-devclass = tadir-devclass.                                       "NOLIB
      APPEND i_listado.                                                          "NOLIB
    ENDSELECT.                                                                   "NOLIB
    LOOP AT i_listado WHERE subc = 'A'.
      DATA: ev_include TYPE programm,
            ev_line    TYPE string.
      i_listado-subc = '+'.

      DATA i_enhincinx TYPE TABLE OF enhincinx WITH HEADER LINE.

      SELECT * FROM enhincinx
        INTO TABLE i_enhincinx
       WHERE enhname = i_listado-name.

      LOOP AT i_enhincinx.
        i_listado-text = i_enhincinx-full_name.

        o_enh->get_line_position( EXPORTING iv_full_name = i_enhincinx-full_name
                                            iv_prog      = i_enhincinx-programname
                                            iv_enhname   = i_enhincinx-enhname
                                  IMPORTING ev_include   = ev_include
                                            ev_line      = ev_line ).
        i_listado-tcode  = ev_include.
        i_listado-object = 'PROG'.

        APPEND i_listado.
      ENDLOOP.
    ENDLOOP.
  ENDIF.                                                                         "NOLIB

  IF p_formul = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando programas' ).
    SELECT * FROM stxh
   WHERE tdobject = 'FORM'
     AND tdform IN s_report
*     AND tdform IN r_name
     AND tdform IN r_obj
     AND tdid = 'DEF'
     AND tdspras = 'S'.
      IF stxh-tdform IN r_name.
        CLEAR i_listado.
        i_listado-name   = stxh-tdform.
        i_listado-subc   = 'S'.
        i_listado-tcode  = 'SE71'.
        i_listado-text   = stxh-tdtitle.
        i_listado-cdat   = stxh-tdfdate.
        i_listado-cnam   = stxh-tdfuser.
        i_listado-udat   = stxh-tdldate.
        i_listado-unam   = stxh-tdluser.
        i_listado-object = 'FORM'.  "APC03112010

        SELECT SINGLE devclass FROM  tadir
          INTO i_listado-devclass
         WHERE pgmid = 'R3TR'
           AND object = 'FORM'
           AND obj_name   = i_listado-name.

        IF p_utili = 'X'.
          SELECT * FROM ttxfp
           WHERE tdform = i_listado-name.
            IF i_listado-ttext IS INITIAL.
              i_listado-ttext = ttxfp-print_name.
            ELSE.
              CONCATENATE i_listado-ttext ',' ttxfp-print_name
                     INTO i_listado-ttext.
            ENDIF.
          ENDSELECT.
        ENDIF.
        APPEND i_listado.
      ENDIF.
    ENDSELECT.

    SELECT * FROM  stxfadm
           WHERE  formname    IN s_report
           AND formname IN r_obj
           AND    masterlang  = sy-langu
           AND    devclass    IN s_devcla.
      IF stxfadm-formname IN r_name.
        CLEAR i_listado.
        i_listado-name   = stxfadm-formname.
        i_listado-subc   = 'S'.
        i_listado-object = 'SSFO'.  "APC03112010
        i_listado-tcode  = 'SMARTFORMS'.
        i_listado-cdat   = stxfadm-firstdate.
        i_listado-cnam   = stxfadm-firstuser.
        i_listado-udat   = stxfadm-lastdate.
        i_listado-unam   = stxfadm-lastuser.

        SELECT SINGLE pgnam kschl FROM tnapr
          INTO (i_listado-tcode, i_listado-ttext)
         WHERE nacha = '1'
           AND sform = stxfadm-formname.

        SELECT SINGLE caption FROM  stxfadmt
          INTO i_listado-text
               WHERE  langu     = sy-langu
               AND    formname  = stxfadm-formname.
        APPEND i_listado.
      ENDIF.
    ENDSELECT.

  ENDIF.

  IF p_proyec = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando proyectos de ampliaciÃ³n' ).
    REFRESH i_list.
    SELECT * FROM modtext
     WHERE name IN s_report.
      IF modtext-name IN r_name.
        CLEAR i_list.
        i_list-name = modtext-name.
        i_list-subc = 'A'.
        i_list-text = modtext-modtext.
        APPEND i_list.
      ENDIF.
    ENDSELECT.

    DATA l_ok.
    LOOP AT i_list.
      CLEAR l_ok.
      SELECT * FROM modact
       WHERE name = i_list-name.
        i_listado-devclass = modact-devclass.
        SELECT * FROM modsap
         WHERE name = modact-member
           AND typ  = 'E'.
          i_listado       = i_list.
          i_listado-tcode = modsap-member.
          SELECT SINGLE modtext FROM  modsapt
            INTO i_listado-aux
                 WHERE  sprsl  = sy-langu
                 AND    name   = modsap-name.
          SELECT SINGLE * FROM tfdir
           WHERE funcname = modsap-member.
          CONCATENATE tfdir-pname+3 'U' tfdir-include INTO
          i_listado-ttext.

          i_listado-ttext(1) = 'Z'.
          SELECT SINGLE * FROM trdir
           WHERE name = i_listado-ttext.
          IF sy-subrc = 0.

            IF i_listado-ttext(2) = 'ZX'.
              SELECT SINGLE cnam unam cdat udat FROM  trdir
                INTO (i_listado-cnam, i_listado-unam,
                      i_listado-cdat, i_listado-udat)
               WHERE name  = i_listado-ttext.
              i_listado-object = 'PROG'.
            ENDIF.

            IF i_listado-devclass IS INITIAL.
              SELECT SINGLE devclass FROM  tadir
                INTO i_listado-devclass
               WHERE pgmid = 'R3TR'
                 AND object = 'PROG'
                 AND obj_name   = i_listado-ttext.
            ENDIF.

            APPEND i_listado.
            l_ok = 'X'.
          ENDIF.
        ENDSELECT.
      ENDSELECT.
      IF l_ok IS INITIAL.
        APPEND i_list TO i_listado.
      ENDIF.
    ENDLOOP.

  ENDIF.

  IF p_badis = 'X'.
    SELECT * FROM tadir
     WHERE pgmid = 'R3TR'
       AND object = 'SXCI'
       AND obj_name IN s_report
       AND obj_name IN r_name
       AND obj_name IN r_obj
       AND devclass IN s_devcla
       AND delflag = ''.
      CLEAR i_listado.
      i_listado-name  = tadir-obj_name.
      i_listado-subc  = 'B'.
      i_listado-tcode = 'SE19'.

      SELECT SINGLE text FROM  sxc_attrt
        INTO i_listado-text
       WHERE imp_name  = tadir-obj_name
         AND sprsl      = sy-langu.

      SELECT SINGLE imp_class FROM sxc_class
        INTO i_listado-ttext
       WHERE imp_name = tadir-obj_name.

      SELECT SINGLE descript author createdon
                    changedby changedon
        FROM vseoclass
        INTO (i_listado-aux, i_listado-cnam, i_listado-cdat,
              i_listado-unam, i_listado-udat)
       WHERE clsname = i_listado-ttext.

      IF i_listado-ttext(1) = 'Z'.
        CONCATENATE i_listado-ttext '%' INTO l_aux.
        SELECT MAX( udat ) FROM progdir
          INTO i_listado-udat
         WHERE name LIKE l_aux.

        SELECT SINGLE unam FROM progdir
          INTO i_listado-unam
         WHERE name LIKE l_aux
           AND state = 'A'
           AND udat = i_listado-udat.
      ENDIF.

      i_listado-object = 'CLAS'.

      APPEND i_listado.
    ENDSELECT.
  ENDIF.

  IF p_userex = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando Userexits' ).
    SELECT * FROM  trdir
      INTO TABLE i_trdir
     WHERE ( ( name  LIKE 'MV%Z%' )
         OR  ( name  LIKE 'RV%Z%' )
         OR  ( name  LIKE 'LV%Z%' )
         OR  ( name  LIKE 'RPC%Z%' )
         OR  ( name  LIKE 'VV05HF%' ) )
        AND name IN s_report
        AND name IN r_name
        AND subc = 'I'
        AND unam NE 'SAP'.
    LOOP AT i_trdir WHERE name IN r_name.
      CLEAR i_listado.
      MOVE-CORRESPONDING i_trdir TO i_listado.
      i_listado-object = 'PROG'.
      SELECT SINGLE text FROM trdirt
        INTO i_listado-text
       WHERE sprsl = sy-langu
         AND name  = i_listado-name.
      SELECT SINGLE devclass FROM  tadir
        INTO i_listado-devclass
       WHERE pgmid  = 'R3TR'
         AND object = 'PROG'
         AND obj_name  = i_listado-name.
      APPEND i_listado.
    ENDLOOP.
  ENDIF.

  IF p_rutina = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando Rutinas' ).
    SELECT * FROM  trdir
      INTO TABLE i_trdir
     WHERE  name  LIKE 'RV%'
        AND name  NOT LIKE 'RV%NN'
        AND name  NOT LIKE 'RV%CC'
        AND name  NOT LIKE 'RV%Z%'
        AND name IN s_report
        AND subc = 'I'
        AND unam NE 'SAP'.
    LOOP AT i_trdir WHERE name IN r_name.
      CLEAR i_listado.
      MOVE-CORRESPONDING i_trdir TO i_listado.
      i_listado-object = 'PROG'.  "APC03112010
      i_listado-tcode  = 'VOFM'.  "APC03112010
      SELECT SINGLE text FROM trdirt
        INTO i_listado-text
       WHERE sprsl = sy-langu
         AND name  = i_listado-name.
      SELECT SINGLE devclass FROM  tadir
        INTO i_listado-devclass
       WHERE pgmid  = 'R3TR'
         AND object = 'PROG'
         AND obj_name  = i_listado-name.
      APPEND i_listado.
    ENDLOOP.
  ENDIF.

  IF p_tablas = 'X'.
    DATA: l_tabname LIKE d010tab-tabname,
          i_progs   LIKE d010tab OCCURS 0 WITH HEADER LINE,
          i_dd02l   TYPE TABLE OF dd02l WITH HEADER LINE.

    zcl_ap_sgpi=>text( 'Seleccionando tablas' ).

    IF p_vivas IS INITIAL.
      SELECT * FROM  dd02l
        INTO TABLE i_dd02l
       WHERE  tabname  IN r_obj
         AND tabname IN s_report
         AND as4user IN s_cnam
         AND as4user IN s_unam
         AND as4date IN s_cdat
         AND as4date IN s_udat.
    ELSE.
      SELECT * FROM  dd02l
        INTO TABLE i_dd02l
        WHERE tabname IN r_name_apc
           OR ( tabname IN r_obj
           AND tabname IN s_report
        AND ( as4user = sy-uname )
        AND ( as4date >= v_fechas_vivas )
          ).
    ENDIF.
    LOOP AT i_dd02l INTO dd02l.
      IF dd02l-tabname IN r_name.
        CLEAR i_listado.
        i_listado-name = dd02l-tabname.
        SELECT SINGLE ddtext FROM  dd02t
          INTO i_listado-text
               WHERE  tabname     = i_listado-name
               AND    ddlanguage  = sy-langu.


        SELECT SINGLE devclass object FROM tadir
          INTO (i_listado-devclass, i_listado-object)
         WHERE pgmid = 'R3TR'
           AND object IN ('TABL', 'VIEW')
           AND obj_name = dd02l-tabname
           AND delflag = ''.
        IF i_listado-devclass IN s_devcla.
          CASE dd02l-tabclass.
            WHEN 'INTTAB'.
              i_listado-subc = 'E'.
            WHEN 'VIEW'.
              i_listado-subc = 'V'.
            WHEN 'APPEND'.
              i_listado-subc = 'A'.
            WHEN OTHERS.
              i_listado-subc = 'T'.
              IF p_numlin = 'X'.
                SELECT COUNT( * ) FROM (i_listado-name)
                  INTO i_listado-numlin.
              ENDIF.
          ENDCASE.

          i_listado-cdat = dd02l-as4date.
          i_listado-cnam = dd02l-as4user.

          i_listado-tcode = 'SE11'.

          IF p_utili = 'X'.
            l_tabname = i_listado-name.
            CALL FUNCTION 'RS_TABLE_IN_PROGRAMS'
              EXPORTING
                tabname  = l_tabname
              TABLES
                proglist = i_progs.
            LOOP AT i_progs.
              IF i_listado-aux IS INITIAL.
                i_listado-aux = i_progs-master.
              ELSE.
                CONCATENATE i_listado-aux ',' i_progs-master
                       INTO i_listado-aux SEPARATED BY space.
              ENDIF.

              IF i_listado-total = 0.
                READ TABLE i_estad WITH KEY report = i_progs-master
                                   BINARY SEARCH.
                IF sy-subrc = 0.
                  i_listado-total = i_estad-total.
                ENDIF.
              ENDIF.

            ENDLOOP.
          ENDIF.

          APPEND i_listado.
        ENDIF.
      ENDIF.
    ENDLOOP.


    IF p_vivas IS INITIAL AND p_libt IS INITIAL.
      zcl_ap_sgpi=>text( 'Seleccionando tipos' ).
      SELECT * FROM  ddtypes
       WHERE  typename  IN r_obj
          AND typename IN s_report.
        IF ddtypes-typename IN r_name.

          SELECT SINGLE * FROM  dd40l
           WHERE typename = ddtypes-typename
          AND as4user IN s_cnam
          AND as4user IN s_unam
          AND as4date IN s_cdat
          AND as4date IN s_udat.
          IF sy-subrc = 0.
            CLEAR i_listado.
            i_listado-name = ddtypes-typename.
            SELECT SINGLE devclass object FROM tadir
               INTO (i_listado-devclass, i_listado-object)
              WHERE pgmid = 'R3TR'
                AND object LIKE 'T%'
                AND obj_name = ddtypes-typename.
            IF i_listado-devclass IN s_devcla.

              i_listado-cdat  = dd40l-as4date.
              i_listado-cnam  = dd40l-as4user.
              i_listado-tcode = 'SE11'.
              i_listado-subc  = 'D'.

              SELECT SINGLE ddtext FROM  dd40t
                INTO i_listado-text
              WHERE  typename    = i_listado-name
              AND    ddlanguage  = sy-langu.

              APPEND i_listado.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDSELECT.

      zcl_ap_sgpi=>text( 'Seleccionando elementos de datos' ).

      SELECT  * FROM  dd04l
       WHERE rollname IN s_report
         AND rollname IN r_name
         AND rollname IN r_obj
      AND as4user IN s_cnam
      AND as4user IN s_unam
      AND as4date IN s_cdat
      AND as4date IN s_udat.
        IF sy-subrc = 0.
          CLEAR i_listado.
          i_listado-name = dd04l-rollname.
          SELECT SINGLE devclass object FROM tadir
             INTO (i_listado-devclass, i_listado-object)
            WHERE pgmid = 'R3TR'
              AND object = 'DTEL'
              AND obj_name = i_listado-name.
          IF i_listado-devclass IN s_devcla.

            i_listado-cdat  = dd04l-as4date.
            i_listado-cnam  = dd04l-as4user.
            i_listado-tcode = 'SE11'.
            i_listado-subc  = 'D'.

            SELECT SINGLE ddtext FROM  dd04t
              INTO i_listado-text
            WHERE  rollname    = i_listado-name
            AND    ddlanguage  = sy-langu.

            APPEND i_listado.
          ENDIF.
        ENDIF.
      ENDSELECT.

      zcl_ap_sgpi=>text( 'Seleccionando dominios' ).
      SELECT * FROM  dd01l
       WHERE domname IN s_report
        AND domname IN r_obj
        AND domname IN r_name
      AND as4user IN s_cnam
      AND as4user IN s_unam
      AND as4date IN s_cdat
      AND as4date IN s_udat.
        IF sy-subrc = 0.
          CLEAR i_listado.
          i_listado-name = dd01l-domname.
          SELECT SINGLE devclass object FROM tadir
             INTO (i_listado-devclass, i_listado-object)
            WHERE pgmid = 'R3TR'
              AND object = 'DOMA'
              AND obj_name = i_listado-name.
          IF i_listado-devclass IN s_devcla.

            i_listado-cdat  = dd01l-as4date.
            i_listado-cnam  = dd01l-as4user.
            i_listado-tcode = 'SE11'.
            i_listado-subc  = 'D'.

            SELECT SINGLE ddtext FROM  dd01t
              INTO i_listado-text
            WHERE  domname    = i_listado-name
            AND    ddlanguage  = sy-langu.

            APPEND i_listado.
          ENDIF.
        ENDIF.
      ENDSELECT.
    ENDIF.
  ENDIF.
  IF p_modife = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando modificaciones al estandar' ).
    SELECT * FROM zbc003
      WHERE name  IN s_report
        AND tcode IN s_tcode
        AND name IN r_name
        AND estado = 'M'.
      CLEAR i_listado.
      MOVE-CORRESPONDING zbc003 TO i_listado.

      IF NOT i_listado-tcode IS INITIAL.
        SELECT SINGLE ttext FROM tstct
      INTO i_listado-ttext
     WHERE sprsl = sy-langu
       AND tcode = i_listado-tcode.
      ENDIF.
      SELECT SINGLE text FROM trdirt
        INTO i_listado-text
       WHERE sprsl = sy-langu
         AND name  = i_listado-name.
      SELECT SINGLE devclass object FROM  tadir
        INTO (i_listado-devclass, i_listado-object)
       WHERE pgmid  = 'R3TR'
         AND object = 'PROG'
         AND obj_name  = i_listado-name.
      IF sy-subrc NE 0.
        SELECT SINGLE devclass object FROM  tadir
        INTO (i_listado-devclass, i_listado-object)
         WHERE pgmid  = 'R3TR'
           AND obj_name  = i_listado-name.
      ENDIF.
      IF i_listado-object IS INITIAL.                          "APC03112010
        SELECT SINGLE * FROM trdir                             "APC03112010
         WHERE name = i_listado-name.                          "APC03112010
        IF sy-subrc = 0.                                       "APC03112010
          i_listado-object = 'PROG'.                           "APC03112010
        ENDIF.                                                 "APC03112010
      ENDIF.                                                   "APC03112010

      SELECT SINGLE cnam unam cdat udat FROM  trdir
        INTO (i_listado-cnam, i_listado-unam,
              i_listado-cdat, i_listado-udat)
       WHERE name  = i_listado-name.

      PERFORM icono_status USING i_listado-estado
                        CHANGING i_listado-icono.

      IF i_listado-estado = 'B'.
        zcl_ap_alv_grid=>append_color( EXPORTING colorc = 'ROJO'
                                    CHANGING tabla_color = i_listado-color ).
      ELSEIF i_listado-estado = 'O'.
        zcl_ap_alv_grid=>append_color( EXPORTING colorc = 'NARANJA'
                                    CHANGING tabla_color = i_listado-color ).
      ELSEIF i_listado-estado = 'M'.
        zcl_ap_alv_grid=>append_color( EXPORTING colorc = 'AMARILLO'
                                    CHANGING tabla_color = i_listado-color ).
      ENDIF.

      i_listado-tipo = 'X'.

      APPEND i_listado.
    ENDSELECT.
  ENDIF.


  IF p_bte = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando BTEs' ).
    DATA i_tbe TYPE TABLE OF tbe32 WITH HEADER LINE.

    SELECT * FROM tbe31
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct  IN s_report
        AND funct IN r_obj.
    SELECT * FROM tbe32
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct  IN s_report
        AND funct IN r_obj.

    SELECT * FROM tbe34
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct  IN s_report
        AND funct  IN r_obj.

    SELECT * FROM tps31
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct  IN s_report
        AND funct  IN r_obj.
    SELECT * FROM tps32
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct  IN s_report
        AND funct  IN r_obj.

    SELECT * FROM tps34
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct  IN s_report
        AND funct  IN r_obj.

    LOOP AT i_tbe WHERE funct IN r_name.
      CLEAR i_listado.
      SELECT SINGLE * FROM v_fdirt
       WHERE area IN r_obj
         AND funcname = i_tbe-funct
         AND active = 'X'
         AND spras  = sy-langu.
      IF sy-subrc = 0.
        PERFORM get_funcion USING v_fdirt-funcname.
        i_listado-tcode = 'FIBF'.
        i_listado-subc  = '9'.
        APPEND i_listado.
      ENDIF.
    ENDLOOP.
  ENDIF.

  IF p_bsp = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando BSPs' ).
    DATA i_bsp TYPE TABLE OF o2appl WITH HEADER LINE.

    SELECT * FROM o2appl
      INTO TABLE i_bsp
      WHERE applname  IN s_report
        AND applname IN r_obj
        AND applname IN r_name
    AND author IN s_cnam
    AND changedby IN s_unam
    AND createdon IN s_cdat
    AND changedon IN s_udat.

    LOOP AT i_bsp.
      i_listado-tcode  = 'BSP'.
      i_listado-subc   = 'B'.
      i_listado-object = 'WAPA'.
      i_listado-name   = i_bsp-applname.
      i_listado-cdat   = i_bsp-createdon.
      i_listado-cnam   = i_bsp-author.
      i_listado-udat   = i_bsp-changedon.
      i_listado-unam   = i_bsp-changedby.
      i_listado-ttext  = i_bsp-applclas.

      APPEND i_listado.
    ENDLOOP.
  ENDIF.

  IF p_webd = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando Webdynpros' ).
    DATA i_webd TYPE TABLE OF wdy_application WITH HEADER LINE.

    SELECT * FROM wdy_application
      INTO TABLE i_webd
      WHERE application_name  IN s_report
        AND application_name IN r_obj
    AND author IN s_cnam
    AND changedby IN s_unam
    AND createdon IN s_cdat
    AND changedon IN s_udat.

    LOOP AT i_webd.
      CLEAR i_listado.
      i_listado-tcode  = 'WEBDYNPRO'.
      i_listado-subc   = 'W'.
      i_listado-object = 'WDYA'.
      i_listado-name   = i_webd-application_name.
      i_listado-cdat   = i_webd-createdon.
      i_listado-cnam   = i_webd-author.
      i_listado-udat   = i_webd-changedon.
      i_listado-unam   = i_webd-changedby.

      APPEND i_listado.
    ENDLOOP.

    SELECT * FROM tadir
     WHERE pgmid = 'R3TR'
       AND object LIKE 'WD%'
      AND obj_name IN s_report
      AND obj_name IN r_obj
      AND devclass IN s_devcla
      AND delflag = ''.
      READ TABLE i_listado TRANSPORTING NO FIELDS WITH KEY subc = 'W'
                                                           object = tadir-object
                                                           name = tadir-obj_name.
      IF sy-subrc NE 0.
        CLEAR i_listado.
        MOVE-CORRESPONDING tadir TO i_listado.
        i_listado-tcode    = 'WEBDYNPRO'.
        i_listado-subc     = 'W'.
        i_listado-name     = tadir-obj_name.
        i_listado-devclass = tadir-devclass.
        APPEND i_listado.
      ENDIF.
    ENDSELECT.

  ENDIF.

  IF p_mime = 'X'.
    SELECT * FROM smimloio
     WHERE crea_user NE 'SAP'
       AND crea_time > '20100101000000'
       AND prop09 IN s_report.

      CLEAR i_listado.
      i_listado-tcode  = 'MIME'.
      i_listado-subc   = 'M'.
      i_listado-object = 'SMIM'.
      i_listado-ttext  = smimloio-lo_class.
      i_listado-name   = smimloio-prop09.
      i_listado-text   = smimloio-loio_id.
      i_listado-cnam   = smimloio-crea_user.
      i_listado-cdat   = smimloio-crea_time(8).
      IF smimloio-chng_time IS INITIAL.
        i_listado-unam = i_listado-cnam.
        i_listado-udat = i_listado-cdat.
      ELSE.
        i_listado-unam = smimloio-chng_user.
        i_listado-udat = smimloio-chng_time.
      ENDIF.

      IF i_listado-cnam IN s_cnam
        AND i_listado-unam IN s_unam
        AND i_listado-cdat IN s_cdat
        AND i_listado-udat IN s_udat.
        IF smimloio-prop02 = 'M_FOLDER' AND NOT smimloio-prop08 IS INITIAL.
          SELECT SINGLE prop09 FROM smimloio
            INTO i_listado-tcode
           WHERE loio_id  = smimloio-prop08
             AND lo_class = smimloio-prop02.
        ENDIF.
        APPEND i_listado.
      ENDIF.
    ENDSELECT.
  ENDIF.

  IF p_pdf = 'X'.
    SELECT * FROM tadir
     WHERE pgmid = 'R3TR'
       AND object = 'SFPF'
       AND obj_name IN s_report
       AND obj_name IN r_name
       AND obj_name IN r_obj
       AND devclass IN s_devcla
       AND delflag = ''.
      CLEAR i_listado.
      i_listado-name     = tadir-obj_name.
      i_listado-subc     = 'P'.
      i_listado-tcode    = 'SFP'.
      i_listado-object   = 'SFPF'.
      i_listado-devclass = tadir-devclass.

      SELECT SINGLE * FROM fpcontext
        INTO fpcontext
       WHERE name = tadir-obj_name.

        i_listado-cdat = fpcontext-firstdate.
        i_listado-cnam = fpcontext-firstuser.
        i_listado-udat = fpcontext-lastdate.
        i_listado-unam = fpcontext-lastuser.

        SELECT SINGLE text FROM  fpcontextt
          INTO i_listado-text
               WHERE  name      = fpcontext-name
               AND    state     = fpcontext-state
               AND    language  = sy-langu.

          APPEND i_listado.
        ENDSELECT.

        SELECT * FROM tadir
         WHERE pgmid = 'R3TR'
           AND object = 'SFPI'
           AND obj_name IN s_report
           AND obj_name IN r_name
           AND obj_name IN r_obj
           AND devclass IN s_devcla
           AND delflag = ''.
          CLEAR i_listado.
          i_listado-name     = tadir-obj_name.
          i_listado-subc     = 'P'.
          i_listado-tcode    = 'SFP'.
          i_listado-object   = 'SFPI'.
          i_listado-devclass = tadir-devclass.

          SELECT SINGLE * FROM fpinterface
            INTO fpinterface
           WHERE name = tadir-obj_name.

            i_listado-cdat = fpinterface-firstdate.
            i_listado-cnam = fpinterface-firstuser.
            i_listado-udat = fpinterface-lastdate.
            i_listado-unam = fpinterface-lastuser.

            SELECT SINGLE text FROM  fpinterfacet
              INTO i_listado-text
                   WHERE  name      = fpinterface-name
                   AND    state     = fpinterface-state
                   AND    language  = sy-langu.

              APPEND i_listado.
            ENDSELECT.
          ENDIF.



          IF p_xslt = 'X'.
            SELECT * FROM tadir
             WHERE pgmid = 'R3TR'
               AND object = 'XSLT'
               AND obj_name IN s_report
               AND obj_name IN r_name
               AND obj_name IN r_obj
               AND devclass IN s_devcla
               AND delflag = ''.
              SELECT SINGLE * FROM o2xsltdesc
               WHERE xsltdesc = tadir-obj_name.
              IF sy-subrc = 0.

                CLEAR i_listado.
                i_listado-name   = tadir-obj_name.
                i_listado-subc   = 'X'.
                i_listado-tcode  = 'XSLT_TOOL'.
                i_listado-object = 'XSLT'.
                i_listado-cnam   = o2xsltdesc-author.
                i_listado-cdat   = o2xsltdesc-createdon.
                i_listado-unam   = o2xsltdesc-changedby.
                i_listado-udat   = o2xsltdesc-changedon.

                APPEND i_listado.
              ENDIF.
            ENDSELECT.
          ENDIF.


          IF p_wf = 'X'.
            SELECT * FROM hrs1000
             WHERE otype IN ('AC', 'TS', 'WS')
               AND uname NE 'SAP'
               AND mc_short IN s_report
               AND mc_short IN r_name
               AND mc_short IN r_obj.
              CLEAR i_listado.
              i_listado-name = hrs1000-mc_short.
              i_listado-subc = 'W'.
              CONCATENATE hrs1000-otype hrs1000-objid INTO i_listado-tcode.
              i_listado-object = hrs1000-otype.
              i_listado-text   = hrs1000-stext.
              IF hrs1000-otype = 'WS'.
                SELECT SINGLE created_by created_on changed_by changed_on FROM swdsheader
                  INTO (i_listado-cnam, i_listado-cdat, i_listado-unam, i_listado-udat)
                WHERE wfd_id = i_listado-tcode.
              ELSE.
                i_listado-cnam = i_listado-unam = hrs1000-uname.
                i_listado-cdat = i_listado-udat = hrs1000-aedtm.
              ENDIF.
              APPEND i_listado.
            ENDSELECT.
          ENDIF.


          zcl_ap_sgpi=>text( 'Analizando informaciÃ³n' ).

          LOOP AT i_listado WHERE devclass = ''.
            SELECT SINGLE devclass FROM  tadir
              INTO i_listado-devclass
             WHERE object = i_listado-object
               AND obj_name  = i_listado-name.
            MODIFY i_listado.
          ENDLOOP.

          DELETE i_listado WHERE NOT devclass IN s_devcla.

          LOOP AT i_listado.
            SELECT SINGLE * FROM zbc003
             WHERE name  = i_listado-name
               AND tcode = i_listado-tcode.
            IF sy-subrc = 0.
              MOVE-CORRESPONDING zbc003 TO i_listado.
            ENDIF.

            PERFORM icono_status USING i_listado-estado
                              CHANGING i_listado-icono.


            IF i_listado-total > 0.
              zcl_ap_alv_grid=>append_color( EXPORTING colorc = 'VERDE'
                                          CHANGING tabla_color = i_listado-color ).
            ELSEIF i_listado-estado = 'B'.
              zcl_ap_alv_grid=>append_color( EXPORTING colorc = 'ROJO'
                                          CHANGING tabla_color = i_listado-color ).
            ELSEIF i_listado-estado = 'O'.
              zcl_ap_alv_grid=>append_color( EXPORTING colorc = 'NARANJA'
                                          CHANGING tabla_color = i_listado-color ).
            ELSEIF i_listado-estado = 'M'.
              zcl_ap_alv_grid=>append_color( EXPORTING colorc = 'AMARILLO'
                                          CHANGING tabla_color = i_listado-color ).
            ENDIF.

            SELECT SINGLE tcode FROM zdocumentos
              INTO l_tcode
             WHERE tcode = i_listado-name.
            IF sy-subrc NE 0 AND i_listado-grupo NE ''.
              SELECT SINGLE tcode FROM zdocumentos
                INTO l_tcode
               WHERE tcode = i_listado-grupo.
            ENDIF.
            IF sy-subrc = 0.
              i_listado-doc = '@DK@'.
            ENDIF.

            SELECT SINGLE comentarios FROM zbc003t
              INTO i_listado-comentarios
             WHERE name  = i_listado-name
               AND tcode = i_listado-tcode.
            MODIFY i_listado.
          ENDLOOP.

          LOOP AT i_listado WHERE udat IS INITIAL
                              AND NOT cdat IS INITIAL.
            i_listado-udat = i_listado-cdat.
            i_listado-unam = i_listado-cnam.
            MODIFY i_listado.
          ENDLOOP.

          DELETE i_listado WHERE NOT estado IN s_estado.
          DELETE i_listado WHERE NOT asignado_a IN s_asign.
          DELETE i_listado WHERE NOT procesado_por IN s_progr.

          DELETE i_listado WHERE NOT cnam IN s_cnam OR
                                 NOT cdat IN s_cdat OR
                                 NOT unam IN s_unam OR
                                 NOT udat IN s_udat.

          IF p_vivas = 'X'.
            DELETE i_listado WHERE NOT ( ( cnam = sy-uname OR unam = sy-uname ) ).

            DELETE i_listado WHERE NOT  ( cdat >= v_fechas_vivas OR udat >= v_fechas_vivas ).
          ENDIF.

          IF p_lib = 'X'.
            DELETE i_listado WHERE libreria = ''.
          ENDIF.

          IF p_solom = 'X'.
            DATA: l_nombre TYPE string,
                  l_fecha  TYPE d.
            LOOP AT i_listado.
              REPLACE ALL OCCURRENCES OF '/' IN i_listado-name WITH '_'.
              CONCATENATE i_listado-object i_listado-name INTO l_nombre SEPARATED BY '_'.

              IF p_lib IS INITIAL.
                l_fecha = i_listado-udat.
              ELSE.
* Quiero asegurarme de que se verifica si se ha modificado en el plazo de un mes
                l_fecha = i_listado-udat + 30.
                CONCATENATE l_nombre '.TXT' INTO l_nombre.
              ENDIF.
              IF l_fecha < sy-datum.
                LOOP AT i_ficheros WHERE filename CS l_nombre
                                     AND writedate > l_fecha.
                  EXIT.
                ENDLOOP.
                IF sy-subrc = 0.
* SÃ³lo si el fichero no se ha modificado en el Ãºltimos
                  ADD 30 TO i_ficheros-writedate.
                  IF i_ficheros-writedate < sy-datum.
                    DELETE i_listado.
                  ENDIF.
                ENDIF.
              ENDIF.
            ENDLOOP.
          ENDIF.


          IF p_lib = 'X'.
            zcl_ap_sgpi=>text( 'Comparando ficheros' ).
            PERFORM comparar_ficheros.
          ENDIF.

          i_list_orig[] = i_listado[].

ENDFORM.                    " SELECCIONAR_DATOS

*&---------------------------------------------------------------------*
*&      Form  icono_status
*&---------------------------------------------------------------------*
FORM icono_status USING    pe_estado
                CHANGING   ps_icono.

  CASE pe_estado.
    WHEN 'B'.  "Borrar
      ps_icono = '@11@'.
    WHEN 'C'.  "Critico
      ps_icono = '@8R@'.
    WHEN 'O'.  "Obsoleto
      ps_icono = '@K0@'.
    WHEN '?'.  "Duda
      ps_icono = '@8Q@'.
    WHEN 'M'.
      ps_icono = '@1D@'.
    WHEN 'A'.
      ps_icono = '@0V@'.
    WHEN 'N'.
      ps_icono = '@1M@'.
    WHEN 'Q'.
      ps_icono = '@3W@'.
    WHEN 'R'.
      ps_icono = '@6T@'.
  ENDCASE.

ENDFORM.                    " icono_status

*&---------------------------------------------------------------------*
*&      Form  editar_nota
*&---------------------------------------------------------------------*
FORM editar_nota USING pe_name pe_tcode.
  DATA: l_titulo(80),
        i_zbc003t    LIKE zbc003t OCCURS 0 WITH HEADER LINE,
        i_lineas     LIKE zbc003t-comentarios OCCURS 0 WITH HEADER LINE.

  SELECT * FROM zbc003t
    INTO TABLE i_zbc003t
   WHERE name  = pe_name
     AND tcode = pe_tcode.

  LOOP AT i_zbc003t.
    i_lineas = i_zbc003t-comentarios.
    APPEND i_lineas.
  ENDLOOP.

  CONCATENATE 'Notas report' pe_name pe_tcode
              INTO l_titulo SEPARATED BY space.
  CALL FUNCTION 'TERM_CONTROL_EDIT'
    EXPORTING
      titel          = l_titulo
      langu          = sy-langu
    TABLES
      textlines      = i_lineas
    EXCEPTIONS
      user_cancelled = 1
      OTHERS         = 2.
  IF sy-subrc = 0.
    DELETE FROM zbc003t
     WHERE name  = pe_name
       AND tcode = pe_tcode.
    LOOP AT i_lineas.
      CLEAR zbc003t.
      zbc003t-name        = pe_name.
      zbc003t-tcode       = pe_tcode.
      zbc003t-linea       = sy-tabix.
      zbc003t-comentarios = i_lineas.
      MODIFY zbc003t.
    ENDLOOP.
  ENDIF.
*  endif.

ENDFORM.                    " editar_nota
*&---------------------------------------------------------------------*
*&      Form  descargar_slnk
*&---------------------------------------------------------------------*
FORM descargar_slnk USING pe_mail.
  DATA: xml      TYPE string,
        _objname TYPE string.

  DATA  errorflag    TYPE flag.
  DATA  deffilename  TYPE string.
  DATA  deffilename2 TYPE string.
  DATA  deffilename3 TYPE string.
  DATA  izip         TYPE REF TO cl_abap_zip.
  DATA  zip_file     TYPE xstring.
  DATA: l_string     TYPE string,
        l_xstring    TYPE xstring,
        v_dif(50),
        l_nombre(80),
        l_smartf     TYPE tdsfname,
        l_no.

  CHECK i_listado-object NE ''.                       "APC03112010

  CLEAR v_dif.
  IF sy-ucomm = 'COMPARAR'.
    CONCATENATE '___DIF_' zcl_c=>empresa INTO v_dif.
  ELSEIF pe_mail = 'B'.
    IF sy-ucomm = 'MACHACAR'.
      CONCATENATE '__DESCARGA_' zcl_c=>empresa '_' sy-datum '_' sy-uzeit INTO v_dif.
    ELSE.
      CONCATENATE '__BACKUP_' zcl_c=>empresa '_' sy-datum '_' sy-uzeit INTO v_dif.
    ENDIF.
  ENDIF.


  CASE i_listado-object.
    WHEN 'PROG'.
      IF i_listado-subc = 'P'.
        _objname = i_listado-ttext.
        CONCATENATE i_listado-ttext '_' i_listado-text INTO i_listado-text.
      ELSEIF i_listado-subc = 'A' OR i_listado-subc = '+'.
        _objname = i_listado-tcode.
      ELSE.
        _objname = i_listado-name.
      ENDIF.
    WHEN 'CLAS'.
      IF i_listado-subc = 'B'.                          "APC03112010
        _objname = i_listado-ttext.
      ELSE.
        _objname = i_listado-name.
      ENDIF.
    WHEN 'TABL' OR 'VIEW'.
      _objname = i_listado-name.
    WHEN 'TTYP' OR 'DOMA' OR 'DTEL'.
      _objname = i_listado-name.
    WHEN 'FUGR'.
      _objname = i_listado-ttext.
    WHEN 'SSFO' OR 'FORM'.
      _objname = i_listado-name.
    WHEN 'WAPA' OR 'WDYA' OR 'WDYN' OR 'WDCA' OR 'WDCC'.
      _objname = i_listado-name.
    WHEN 'ENHO' OR 'ENHS'.
      _objname = i_listado-name.
    WHEN 'SFPF' OR 'SFPI'.
      _objname = i_listado-name.
    WHEN 'SMIM'.
      _objname = i_listado-text.
    WHEN 'SHLP'.
      EXIT.
    WHEN 'XSLT'.
      _objname = i_listado-name.
  ENDCASE.


  IF i_listado-object NE 'FORM' AND i_listado-object NE 'SFPF'.
    CLEAR l_no.
    IF i_listado-object = 'FUGR'.
      IF pe_mail IS INITIAL.
        READ TABLE i_grupof WITH KEY table_line = _objname TRANSPORTING NO FIELDS.
        IF sy-subrc = 0.
          l_no = 'X'.
        ENDIF.
      ENDIF.
    ENDIF.
    IF l_no IS INITIAL.
      xml = zcl_ap_dev=>get_saplink_xml( object = i_listado-object
                                         nombre = _objname ).
      IF xml IS INITIAL.
        MESSAGE i398(00) WITH 'Install plugin for object type:' i_listado-object _objname.
      ENDIF.
    ENDIF.
  ENDIF.

  l_string = i_listado-text.
  CALL METHOD zcl_ap_string=>limpiar_nombre_fichero
    CHANGING
      string = l_string.
  i_listado-text = l_string.

  IF pe_mail = 'X' OR p_ftp = 'X'.
    IF p_lib = 'X'.
      CONCATENATE i_listado-object '_' _objname
                 v_dif
                 '.slnk' INTO deffilename.
    ELSE.
      CONCATENATE i_listado-object '_' _objname '_'
                 i_listado-text
                 v_dif
                 '.slnk' INTO deffilename.
    ENDIF.
    IF p_zip = 'X'.
      CREATE OBJECT izip.
      l_xstring = zcl_ap_string=>string2xstring( xml ).
      izip->add( name = deffilename
                 content = l_xstring ).
    ENDIF.
  ENDIF.

  IF p_lib IS INITIAL AND i_listado-object NE 'FUGR'.
    CONCATENATE v_directorio '\'
               i_listado-object '_' _objname '_'
               i_listado-text
               v_dif
               '.slnk' INTO deffilename.
  ELSE.
    CONCATENATE v_directorio '\'
               i_listado-object '_' _objname
               v_dif
               '.slnk' INTO deffilename.
  ENDIF.
  REPLACE '\\' WITH '\' INTO deffilename.
  CLEAR errorflag.

  REPLACE ALL OCCURRENCES OF '/' IN  deffilename WITH '_'.

  IF pe_mail NE 'V'.
    IF pe_mail = 'B'.
      REPLACE '\LIB' WITH '\LIB_BACKUP' INTO deffilename.
    ENDIF.
    IF i_listado-object = 'SFPF'.
      PERFORM descargar_sfp USING deffilename _objname.
    ELSEIF i_listado-object NE 'FORM'.
      CLEAR l_no.
      IF i_listado-object = 'FUGR'.
        IF pe_mail IS INITIAL.
          READ TABLE i_grupof WITH KEY table_line = _objname TRANSPORTING NO FIELDS.
          IF sy-subrc = 0.
            l_no = 'X'.
          ELSE.
            APPEND _objname TO i_grupof.
          ENDIF.
        ENDIF.
      ENDIF.
      IF l_no IS INITIAL.
        PERFORM putonmachine USING deffilename xml.
        IF errorflag IS NOT INITIAL.
          MESSAGE s208(00) WITH TEXT-005.
          EXIT.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  DATA:  i_tabla(255) OCCURS 0.
  l_nombre = _objname.

  IF i_listado-object = 'SSFO'.
    CONCATENATE l_nombre '' INTO l_smartf.
    CALL FUNCTION 'FB_DOWNLOAD_FORM'
      EXPORTING
        i_formname           = l_smartf
        i_formtype           = ' '
        i_with_dialog        = ''
*     IMPORTING
*       O_FORMNAME           =
      EXCEPTIONS
        no_name              = 1
        no_form              = 2
        no_access_permission = 3
        illegal_language     = 4
        illegal_formtype     = 5
        OTHERS               = 6.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
*
*    DATA o_bi TYPE REF TO zcl_batch_input.
*    DATA l_mensaje TYPE bapireturn1-message.
*    CREATE OBJECT o_bi.
*
*    o_bi->inicio( ).
*
** SAP Smart Forms: Initial screen
*    o_bi->dynpro( program = 'SAPMSSFO' dynpro = '0100').
*    o_bi->campos( campo = 'BDC_OKCODE' valor = '=XMLDOWN').
*
** Smart Forms: Determine form name (create, change, ...)
*    o_bi->dynpro( program = 'SAPLSTXB' dynpro = '3000').
*    o_bi->campos( campo = 'BDC_OKCODE' valor = '=ENTER').
*    l_smartf = l_nombre.
*    o_bi->campos( campo = 'SSFSCREEN-FNAME' valor = l_smartf ). " Smart Forms: Nombre formulario
*
** SAP Smart Forms: Initial screen
*    o_bi->dynpro( program = 'SAPMSSFO' dynpro = '0100').
*    o_bi->campos( campo = 'BDC_OKCODE' valor = '=BACK').
*    o_bi->campos( campo = 'RB_SF' valor = 'X').
*
*    CONCATENATE v_directorio '\'
*               i_listado-object '_'
*               i_listado-name '_'
*               i_listado-text
*               v_dif
*               '.xml' INTO deffilename2.
*
*    o_bi->campos( campo = 'SSFSCREEN-FNAME' valor = deffilename2 ). " Smart Forms: Nombre formulario
*
*    l_mensaje = o_bi->llamar_transaccion( tcode = 'SMARTFORMS' modo = 'A').
  ELSEIF i_listado-object = 'FORM'.
    CONCATENATE v_directorio '\'
               i_listado-object '_'
               i_listado-name
               '.txt' INTO deffilename3.
    SUBMIT rstxscrp  WITH obj_name = _objname
                     WITH dataset  = deffilename3
     EXPORTING LIST TO MEMORY
      AND RETURN.
  ELSEIF i_listado-object = 'FUGR'.
    i_tabla = zcl_ap_dev=>get_objeto_como_texto( tipo = i_listado-object
                                                 nombre = i_listado-name ).
  ELSEIF i_listado-object = 'SFPF'.
  ELSE.
    i_tabla = zcl_ap_dev=>get_objeto_como_texto( tipo = i_listado-object
                                                 nombre = l_nombre ).
  ENDIF.

  IF NOT i_tabla[] IS INITIAL.

    IF pe_mail = 'V'.
      DATA: l_version TYPE string,
            zbc003v   TYPE zbc003v.
      CALL METHOD zcl_ap_string=>tabla2string
        EXPORTING
          tabla  = i_tabla[]
        RECEIVING
          string = l_version.

      CLEAR zbc003v.
      MOVE-CORRESPONDING i_listado TO zbc003v.
      zbc003v-fecha  = sy-datum.
      zbc003v-hora   = sy-uzeit.
      zbc003v-string = l_version.
      MODIFY zbc003v FROM zbc003v.

    ELSE.
      IF p_lib IS INITIAL.
        CONCATENATE v_directorio '\'
                   i_listado-object '_'
                   i_listado-name '_'
                   i_listado-text
                   v_dif
                   '.txt' INTO deffilename2.
      ELSE.
        CONCATENATE v_directorio '\'
                   i_listado-object '_'
                   i_listado-name
                   v_dif
                   '.txt' INTO deffilename2.

        CONCATENATE v_directorio '\'
                   i_listado-object '_'
                   i_listado-name
                   '.txt' INTO deffilename3.
      ENDIF.

      IF pe_mail = 'B'.
        REPLACE '\LIB' WITH '\LIB_BACKUP' INTO deffilename2.
        REPLACE '\LIB' WITH '\LIB_BACKUP' INTO deffilename3.
      ENDIF.

      REPLACE ALL OCCURRENCES OF '/' IN  deffilename2 WITH '_'.
      REPLACE ALL OCCURRENCES OF '/' IN  deffilename3 WITH '_'.

      zcl_ap_ficheros=>grabar( EXPORTING fichero = deffilename2
                                         mostrar_error = 'I'
                               CHANGING tabla = i_tabla ).


      IF sy-ucomm = 'COMPARAR'.
        DATA: l_comando TYPE string.

        CONCATENATE '"' deffilename2 '"' INTO deffilename2.
        CONCATENATE '"' deffilename3 '"' INTO deffilename3.

        CONCATENATE deffilename2 deffilename3
               INTO l_comando SEPARATED BY space.
        CALL FUNCTION 'WS_EXECUTE'
          EXPORTING
*           program            = 'C:\WINDOWS\UEDIT32.EXE'
            program            = v_ruta_comparador
            commandline        = l_comando
            inform             = ' '
          EXCEPTIONS
            frontend_error     = 1
            no_batch           = 2
            prog_not_found     = 3
            illegal_option     = 4
            gui_refuse_execute = 5
            OTHERS             = 6.
      ENDIF.
    ENDIF.
  ENDIF.

  IF pe_mail NE 'V'.
    IF pe_mail = 'X' OR p_ftp = 'X'.
      IF p_zip = 'X'.
        CONCATENATE _objname '_'
                   i_listado-text
                   '.txt' INTO deffilename2.
        l_string  = zcl_ap_string=>tabla2string( i_tabla ).
        l_xstring = zcl_ap_string=>string2xstring( l_string ).


        DATA binary_tab TYPE STANDARD TABLE OF x255.
        CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
          EXPORTING
            buffer     = zip_file
          TABLES
            binary_tab = binary_tab.

        CONCATENATE v_directorio '\'
                   _objname '_'
                   i_listado-text
                   v_dif
                   '.zip' INTO deffilename2.

        zcl_ap_ficheros=>grabar( EXPORTING fichero = deffilename2
                                        tipo = 'BIN'
                                         mostrar_error = 'I'
                              CHANGING tabla = binary_tab ).
      ENDIF.

      DATA i_texto_mail LIKE solisti1 OCCURS 0 WITH HEADER LINE.
      REFRESH i_texto_mail.
      LOOP AT i_tabla INTO i_texto_mail.
        APPEND i_texto_mail.
      ENDLOOP.

      DATA i_ficheros LIKE tnotetem OCCURS 0 WITH HEADER LINE.
      IF v_no_se_adjunta_slnk IS INITIAL.
        IF p_zip IS INITIAL.
          i_ficheros-template = deffilename.
          APPEND i_ficheros.
          APPEND i_ficheros-template TO i_ficheros_ftp.
        ELSE.
          i_ficheros-template = deffilename2.
          APPEND i_ficheros.
          APPEND i_ficheros-template TO i_ficheros_ftp.
        ENDIF.
      ENDIF.

      IF pe_mail = 'X'.
        CONCATENATE '(' zcl_c=>empresa ')' i_listado-name '-'
                   i_listado-text INTO deffilename2.

        IF v_ans EQ 'J'.
          DELETE i_ficheros WHERE template = ''.
          IF p_outlo IS INITIAL.
            CALL FUNCTION 'Z_ENVIO_MAIL'
              EXPORTING
                subject    = deffilename2
                direccion  = v_emailaddr
                urgente    = 'X'
                html       = ''
              TABLES
                texto      = i_texto_mail
                t_ficheros = i_ficheros.
          ELSE.
            PERFORM outlook TABLES i_ficheros i_texto_mail
                       USING v_emailaddr deffilename2.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.


ENDFORM.                    " descargar_slnk

*\--------------------------------------------------------------------/


*/------------------------putOnMachine--------------------------------\
FORM putonmachine USING fullpath TYPE string xmlstring TYPE string.

  TRY.
      TRY.
          zcl_ap_ficheros=>grabar_xstring(  EXPORTING fichero = fullpath
                                                           mostrar_error = 'I'
                                                           string = xmlstring ).
          CLEAR v_no_se_adjunta_slnk.
        CATCH cx_root.
          v_no_se_adjunta_slnk = 'X'.
      ENDTRY.
    CATCH cx_root.
      v_no_se_adjunta_slnk = 'X'.
  ENDTRY.

ENDFORM.                    "putonmachine

*&---------------------------------------------------------------------*
*&      Form  outlook
*&---------------------------------------------------------------------*

FORM outlook TABLES email_attachments STRUCTURE tnotetem
                    email_body STRUCTURE  solisti1
              USING email_address subject.
  DATA: g_file(120),
        g_translate(2),
        t_vbs             LIKE STANDARD TABLE OF soli WITH HEADER LINE,
        g_last,
        g_vbs_filename    LIKE rlgrap-filename,
        commandline(1000).

*- Prepare a code to translate a quote into a hex-tab
*- so it can then be translated back to 2 double quotes.
  CONCATENATE '"' cl_abap_char_utilities=>cr_lf+1(1) INTO g_translate.


  APPEND: 'Dim myolapp ' TO t_vbs,
      'Dim olNamespace ' TO t_vbs,
      'Dim myItem ' TO t_vbs,
      'Dim myRecipient ' TO t_vbs,
      'Dim myAttachments ' TO t_vbs,
      ' ' TO t_vbs,
      'Set myolapp = CreateObject("Outlook.Application") ' TO t_vbs,
      'Set olNamespace = myolapp.GetNamespace("MAPI") ' TO t_vbs,
      'Set myItem = myolapp.CreateItem(olMailItem) ' TO t_vbs,
      ' ' TO t_vbs.

*- Destinatarios del mensaje
*  LOOP AT email_address.
*   IF email_address = space. CONTINUE. ENDIF.
  CONCATENATE
    'Set myRecipient = myItem.Recipients.Add("' email_address '")'
    INTO t_vbs.
  APPEND t_vbs.
*  ENDLOOP.

*- Asunto del mensaje
  CONCATENATE 'myItem.Subject = "' subject '"' INTO t_vbs.
  APPEND t_vbs.

*- Ficheros adjuntos
  APPEND:
    'Set myAttachments = myItem.Attachments' TO t_vbs.

*- Chequeamos la existencia de los ficheros adjuntos
  LOOP AT email_attachments.

    g_file = email_attachments-template.

    CALL FUNCTION 'WS_QUERY'
      EXPORTING
        filename       = g_file
        query          = 'FE'
      EXCEPTIONS
        inv_query      = 1
        no_batch       = 2
        frontend_error = 3
        OTHERS         = 4.
    IF sy-subrc EQ 0.
      CONCATENATE 'myAttachments.Add("' email_attachments-template '")'
      INTO t_vbs.
      APPEND t_vbs.
    ELSE.
      MESSAGE i000(38) WITH
        'No se ha podido adjuntar el fichero' email_attachments.
    ENDIF.
  ENDLOOP.

*- Cuerpo del email
  CLEAR: g_last, t_vbs.
  APPEND t_vbs.
  LOOP AT email_body.
    AT FIRST.
      APPEND 'myitem.body = _' TO t_vbs.
    ENDAT.
    AT LAST.
      g_last = 'X'.
    ENDAT.

*- Double-quotes(") will cause an error in VBScript
*- Replace with a hex-tab and then replace with
*- 2 double-quotes ("")
    TRANSLATE email_body USING g_translate.
    WHILE sy-subrc EQ 0.
      REPLACE cl_abap_char_utilities=>cr_lf+1(1)
            WITH '""' INTO email_body.
    ENDWHILE.

    IF g_last = 'X'.
      CONCATENATE '"' email_body '" &vbCrLf '
      INTO t_vbs.
    ELSE.
      CONCATENATE '"' email_body '" &vbCrLf &_'
      INTO t_vbs.
    ENDIF.
    APPEND t_vbs.
  ENDLOOP.

*  APPEND 'myItem.Display' TO t_vbs.
  APPEND 'myItem.Send' TO t_vbs.

*- Preparamos el nombre de fichero vbscript para descargarlo
*- y ejecutarlo, llamando a la variable de entorno de Windows
*- TEMP
  CLEAR g_vbs_filename.
  CALL FUNCTION 'WS_QUERY'
    EXPORTING
      environment    = 'TEMP'
      query          = 'EN'
    IMPORTING
      return         = g_vbs_filename
    EXCEPTIONS
      inv_query      = 1
      no_batch       = 2
      frontend_error = 3
      OTHERS         = 4.

  CONCATENATE g_vbs_filename 'mail.vbs' INTO g_vbs_filename.
  commandline = g_vbs_filename.

  PERFORM sapgui_progress(rstxldmc) USING 10
    'Realizando download de fichero...'.


  DATA: l_string TYPE string.
  l_string = g_vbs_filename.

*- Descargamos el fichero vbscript
  zcl_ap_ficheros=>grabar( EXPORTING fichero = l_string

                        CHANGING tabla = t_vbs[] ).

* Abrimos el Outlook
  PERFORM sapgui_progress(rstxldmc) USING 50
    'Abriendo Outlook... Espere por favor'.

  CALL FUNCTION 'WS_EXECUTE'
    EXPORTING
      commandline    = commandline
      program        = 'WSCRIPT.EXE'
    EXCEPTIONS
      frontend_error = 1
      no_batch       = 2
      prog_not_found = 3
      illegal_option = 4
      OTHERS         = 5.


  MESSAGE s000(38) WITH 'Abriendo Outlook... Espere por favor'.
  WAIT UP TO 5 SECONDS.

ENDFORM.                    "outlook

*&---------------------------------------------------------------------*
*&      Form  copy_ftp
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM copy_ftp.
  DATA: o_ftp TYPE REF TO zcl_ap_ftp.

  CREATE OBJECT o_ftp.

  o_ftp->connect( user = 'sap4abap' password = 'B5DC3B26771B' host =
  'sap4.com' ).

  IF NOT o_ftp->error_conexion IS INITIAL.
    MESSAGE 'Error de conexiÃ³n' TYPE 'E'.
  ELSE.
    IF o_ftp->cd( 'lib' ) = 'X'.

      IF NOT zcl_c=>empresa IS INITIAL.
        IF o_ftp->cd( zcl_c=>empresa ) = ''.
          MESSAGE e398(00) WITH 'Error al cambiar a dir.FTP'
                                 zcl_c=>empresa.
        ENDIF.
      ENDIF.

      LOOP AT i_ficheros_ftp.
        IF o_ftp->put( i_ficheros_ftp ) = ''.
          WRITE / o_ftp->mensaje_error.
        ENDIF.
      ENDLOOP.
    ENDIF.

    o_ftp->disconnect( ).

  ENDIF.

ENDFORM.                    "copy_ftp
*&---------------------------------------------------------------------*
*&      Form  COMPARAR_FICHEROS
*&---------------------------------------------------------------------*
FORM comparar_ficheros .
  DATA: l_nombrefichero TYPE string.
  DATA: i_tabla(255)  OCCURS 0,
        l_tabla(255),
        i_tabla2(255) OCCURS 0 WITH HEADER LINE,
        i_ficheros    TYPE TABLE OF file_info WITH HEADER LINE,
        l_aux1        TYPE string,
        l_aux2        TYPE string.

  i_ficheros[] = zcl_ap_ficheros=>lista_ficheros( v_directorio ).
  LOOP AT i_ficheros.
    TRANSLATE i_ficheros-filename TO UPPER CASE.         "#EC TRANSLANG
    MODIFY i_ficheros.
  ENDLOOP.

  LOOP AT i_listado.
    CLEAR: i_tabla, i_tabla2.
    REFRESH: i_tabla, i_tabla2.

    CONCATENATE v_directorio '\'
                i_listado-object '_'
               i_listado-name
               '.txt' INTO l_nombrefichero.
    TRANSLATE l_nombrefichero TO UPPER CASE.

    CLEAR i_ficheros.
    READ TABLE i_ficheros WITH KEY filename = l_nombrefichero.
    IF sy-subrc = 0.
      zcl_ap_ficheros=>leer( EXPORTING fichero = l_nombrefichero
                                    mostrar_error = ''
                          CHANGING  tabla = i_tabla[] ).
    ENDIF.

    IF i_tabla IS INITIAL.
      i_listado-icono    = '@LR@'.  "BAJAR
      i_listado-libreria = 'N'.
    ELSE.
      zcl_ap_dev=>texto_comparable( CHANGING i_tabla = i_tabla[] ).

      LOOP AT i_tabla INTO l_tabla.
        IF l_tabla CS 'type-pools' OR l_tabla CS 'TYPE_POOLS'.
          DELETE i_tabla.
        ELSEIF l_tabla CS '"'.
          SPLIT l_tabla AT '"' INTO l_aux1 l_aux2.
          l_tabla = l_aux1.
          MODIFY i_tabla FROM l_tabla.
        ELSEIF l_tabla CS '##NO_TEXT.'.
          REPLACE ' ##NO_TEXT.' IN l_tabla WITH '.'.
          MODIFY i_tabla FROM l_tabla.
        ENDIF.
      ENDLOOP.

      DESCRIBE TABLE i_tabla LINES i_listado-nlinlib.
      i_tabla2[] = zcl_ap_dev=>get_objeto_como_texto( tipo = i_listado-object
                                                      nombre = i_listado-name
                                                      modo = 'C' ).

      LOOP AT i_tabla2 INTO l_tabla.
        IF l_tabla CS 'type-pools' OR l_tabla CS 'TYPE_POOLS'.
          DELETE i_tabla2.
        ELSEIF l_tabla CS '"'.
          SPLIT l_tabla AT '"' INTO l_aux1 l_aux2.
          l_tabla = l_aux1.
          MODIFY i_tabla2 FROM l_tabla.
        ELSEIF l_tabla CS '##NO_TEXT.'.
          REPLACE ' ##NO_TEXT.' IN l_tabla WITH '.'.
          MODIFY i_tabla2 FROM l_tabla.
        ENDIF.
      ENDLOOP.

      DESCRIBE TABLE i_tabla2 LINES i_listado-nlinact.

      i_listado-icono = '@20@'.
      IF i_listado-nlinlib NE i_listado-nlinact.
        i_listado-icono = '@2B@'.
      ELSE.
        LOOP AT i_tabla INTO l_tabla.
          CLEAR i_tabla2.
          READ TABLE i_tabla2 INDEX sy-tabix.
          CONDENSE l_tabla NO-GAPS.
          TRANSLATE l_tabla TO UPPER CASE.
          CONDENSE i_tabla2 NO-GAPS.
          TRANSLATE i_tabla2 TO UPPER CASE.
          IF l_tabla NE i_tabla2.
            i_listado-icono = '@2B@'.
            EXIT.
          ENDIF.
        ENDLOOP.
      ENDIF.

      IF i_listado-icono = '@2B@'.
        DATA: abaptext_delta LIKE vxabapt255 OCCURS 0 WITH HEADER LINE.

        abaptext_delta[] = zcl_ap_dev=>comparar_reports(
                                             tabla1 = i_tabla2[]
                                             tabla2 = i_tabla[] ).

        LOOP AT abaptext_delta.
          CLEAR i_cambios.
          MOVE-CORRESPONDING abaptext_delta TO i_cambios.
          i_cambios-name = i_listado-name.
          APPEND i_cambios.
        ENDLOOP.

        IF i_listado-nlinact > i_listado-nlinlib AND
           i_listado-udat >= i_ficheros-writedate.
          i_listado-icono = '@LR@'.                      "BAJAR
        ELSEIF i_listado-nlinact < i_listado-nlinlib AND
          i_listado-udat <= i_ficheros-writedate.
          i_listado-icono = '@LS@'.                      "SUBIR
        ENDIF.
      ENDIF.
    ENDIF.

    IF p_solom = '' OR i_listado-icono NE '@20@'.
      MODIFY i_listado.
    ELSE.
      DELETE i_listado.
    ENDIF.

  ENDLOOP.

ENDFORM.                    " COMPARAR_FICHEROS
*&---------------------------------------------------------------------*
*&      Form  SUBIR_LIB
*&---------------------------------------------------------------------*
FORM subir_lib .
  DATA: l_file(300),
        l_tipo(4),
        isslinkee.

  PERFORM get_tipo USING i_listado-subc i_listado-name
                  CHANGING l_tipo.

  CONCATENATE v_directorio '\' l_tipo '_' i_listado-name '.slnk'
         INTO l_file.

  isslinkee = 'X'.
  EXPORT isslinkee TO MEMORY ID 'ISSLNK'.
  SUBMIT zsaplink
   AND RETURN
*   VIA SELECTION-SCREEN
   WITH filename = l_file
   WITH slpkg    = i_listado-devclass
   WITH overwr   = 'X'.

  PERFORM cambiar_clase_desarrollo .

  DATA: l_object   TYPE e071-object,
        l_obj_name TYPE e071-obj_name.

  l_object   = l_tipo.
  l_obj_name = i_listado-name.
  zcl_ap_dev=>activar_objeto( object = l_object
                              obj_name = l_obj_name ).


ENDFORM.                    " SUBIR_LIB
*&---------------------------------------------------------------------*
*&      Form  GET_TIPO
*&---------------------------------------------------------------------*
FORM get_tipo  USING    pe_subc pe_name
               CHANGING ps_tipo.

  CASE pe_subc.
    WHEN '1' OR 'I' OR 'M'.
      ps_tipo = 'PROG'.
    WHEN 'C'.
      ps_tipo = 'CLAS'.
    WHEN 'T' OR 'E'.
      SELECT SINGLE * FROM dd02l
       WHERE tabname = pe_name.
      IF sy-subrc = 0.
        ps_tipo = 'TABL'.
      ELSE.
        CLEAR ps_tipo.
      ENDIF.
    WHEN 'D'.
      ps_tipo = 'TTYP'.
    WHEN 'F'.
      ps_tipo = 'FUGR'.
  ENDCASE.

ENDFORM.                    " GET_TIPO
*&---------------------------------------------------------------------*
*&      Form  CAMBIAR_CLASE_DESARROLLO
*&---------------------------------------------------------------------*
FORM cambiar_clase_desarrollo .

  e071-obj_name = i_listado-name.
  zcl_ap_dev=>popup_cambio_clase_desarrollo( object = i_listado-object
                                             obj_name = e071-obj_name
                                       devclass = i_listado-devclass ).

ENDFORM.                    " CAMBIAR_CLASE_DESARROLLO
*&---------------------------------------------------------------------*
*&      Form  VER_VERSIONES
*&---------------------------------------------------------------------*

CLASS lcl_alv_popup DEFINITION INHERITING FROM zcl_ap_alv.
  PUBLIC SECTION.
    DATA: i_versiones TYPE TABLE OF  zbc003v.

    METHODS: handle_double_click REDEFINITION.
    METHODS: handle_user_command REDEFINITION.
ENDCLASS.                    "lcl_alv DEFINITION

*----------------------------------------------------------------------*
*       CLASS lcl_alv IMPLEMENTATION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_alv_popup IMPLEMENTATION.
  METHOD handle_double_click.
    DATA: l_version TYPE zbc003v.

    READ TABLE i_versiones INTO l_version INDEX row.
    IF sy-subrc = 0.
      zcl_ap_string=>editor_popup_string( l_version-string ).
    ENDIF.

  ENDMETHOD.                                         "handle_double_click
  METHOD handle_user_command.
  ENDMETHOD.                                         "handle_USER_COMMAND

ENDCLASS.                    "lcl_alv IMPLEMENTATION

*&---------------------------------------------------------------------*
*&      Form  ver_versiones
*&---------------------------------------------------------------------*

FORM ver_versiones .
  DATA: o_alv TYPE REF TO lcl_alv_popup.

  CREATE OBJECT o_alv
    EXPORTING
      tabla = ''.

  SELECT * FROM zbc003v
    INTO TABLE o_alv->i_versiones
   WHERE name = i_listado-name
     AND tcode = i_listado-tcode.

  o_alv->constructor_tabla( EXPORTING tabla = 'I_VERSIONES'
                            CHANGING t_tabla = o_alv->i_versiones ).

  o_alv->show( ).

ENDFORM.                    " VER_VERSIONES
*&---------------------------------------------------------------------*
*&      Form  ACTUALIZAR_REPOSITORIO
*&---------------------------------------------------------------------*
FORM actualizar_repositorio .
  DATA: o_repo    TYPE REF TO zcl_ap_repo,
        l_repo    TYPE zap_repo,
        l_fichero TYPE string,
        l_cambio.

  CREATE OBJECT o_repo
    EXPORTING
      origen        = p_origen
      ruta_pc_local = v_directorio.

  o_repo->conexion( password = 'B5DC3B23704A7C' ).

  LOOP AT i_listado WHERE marca = 'X'.
    CLEAR l_cambio.
    READ TABLE o_repo->i_repo INTO l_repo WITH KEY object =
    i_listado-object
                                                   nombre =
                                                   i_listado-name.
    IF sy-subrc NE 0.
      CLEAR l_repo.
      MOVE-CORRESPONDING i_listado TO l_repo.
      l_repo-nombre      = i_listado-name.
      l_repo-descripcion = i_listado-text.
      APPEND l_repo TO o_repo->i_repo.
      l_cambio = 'X'.
    ELSE.
      l_repo-udat = i_listado-udat.
      IF l_repo-udat NE i_listado-udat.
        l_repo-udat = i_listado-udat.
        l_cambio    = 'X'.
        MODIFY o_repo->i_repo FROM l_repo INDEX sy-tabix.
      ENDIF.
    ENDIF.

    IF p_origen = 'F'.
      CONCATENATE v_directorio '\'
                 i_listado-name '.txt'
                 INTO l_fichero.
      o_repo->actualizar_fichero( l_fichero ).

      CONCATENATE v_directorio '\'
                 i_listado-object '_' i_listado-name '.slnk'
                 INTO l_fichero.
      o_repo->actualizar_fichero( l_fichero ).
    ENDIF.
  ENDLOOP.

  o_repo->actualiza_indice_repo( ).

  o_repo->desconexion( ).

ENDFORM.                    " ACTUALIZAR_REPOSITORIO
*&---------------------------------------------------------------------*
*&      Form  get_funcion
*&---------------------------------------------------------------------*
FORM get_funcion  USING    pe_funcion.

  i_listado-subc  = 'F'.
  i_listado-name  = pe_funcion.
  i_listado-text  = v_fdirt-stext.
  i_listado-tcode = 'SE37'.
  i_listado-ttext = v_fdirt-area.

  SELECT SINGLE * FROM tfdir
   WHERE funcname = v_fdirt-funcname.
  CONCATENATE tfdir-pname+3 'U' tfdir-include INTO trdir-name.

  SELECT SINGLE cdat cnam udat unam FROM trdir
    INTO (i_listado-cdat, i_listado-cnam,
          i_listado-udat, i_listado-unam)
   WHERE name = trdir-name
       AND cnam IN s_cnam
       AND unam IN s_unam
       AND cdat IN s_cdat
       AND udat IN s_udat.
  IF sy-subrc = 0.
    SELECT SINGLE devclass FROM  tadir
      INTO i_listado-devclass
     WHERE pgmid = 'R3TR'
       AND object = 'PROG'
       AND obj_name   = trdir-name.
    IF sy-subrc = 0.
      IF p_numlin = 'X'.
        READ REPORT trdir-name INTO i_source.
        DESCRIBE TABLE i_source LINES i_listado-numlin.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.                    " get_funcion
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0100  INPUT
*&---------------------------------------------------------------------*
MODULE user_command_0100 INPUT.
  DATA: l_ok,
        l_fila TYPE i.

  o_alv->comprobar_cambios( ).
  o_alv->get_filas_sel( ).
  l_fila = o_alv->get_fila_activa( ).

  LOOP AT i_listado.
    READ TABLE o_alv->i_filas_sel TRANSPORTING NO FIELDS WITH KEY index = sy-tabix.
    IF sy-subrc = 0.
      i_listado-marca = 'X'.
    ELSE.
      CLEAR i_listado-marca.
    ENDIF.
    MODIFY i_listado.
  ENDLOOP.

  CASE sy-ucomm.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'ENTER'.

      LOOP AT i_listado.
        PERFORM icono_status USING i_listado-estado
                          CHANGING i_listado-icono.
        MODIFY i_listado.
      ENDLOOP.
      o_alv->refrescar_grid( ).
    WHEN 'GRABAR'.
      LOOP AT i_listado.
        CLEAR i_list_orig.
        READ TABLE i_list_orig INDEX sy-tabix.
        IF i_listado NE i_list_orig.
          CLEAR zbc003.
          MOVE-CORRESPONDING i_listado TO zbc003.
          MODIFY zbc003.
        ENDIF.
      ENDLOOP.
      i_list_orig[] = i_listado[].
      MESSAGE 'Se han grabado los cambios' TYPE 'S'.
      LOOP AT i_listado.
        PERFORM icono_status USING i_listado-estado
                          CHANGING i_listado-icono.
        MODIFY i_listado.
      ENDLOOP.
      o_alv->refrescar_grid( ).
    WHEN 'NUEVAL'.
      zcl_ap_popup=>popup_usuario(
                            EXPORTING campo1 = 'TRDIR-NAME'
                                campo2 = 'TSTC-TCODE'
                                titulo = 'Prog.Modificado'
                            IMPORTING return = l_ok
                            CHANGING
                                    valor1 = i_listado-name
                                    valor2 = i_listado-tcode ).
      IF l_ok = ''.
        i_listado-estado = 'M'.
        APPEND i_listado.
      ENDIF.
      o_alv->refrescar_grid( ).

    WHEN 'TCODE'.
      CLEAR tstc.
      zcl_ap_popup=>popup_usuario(
                            EXPORTING campo1 = 'TSTC-TCODE'
                                titulo = 'Ejecutar transacciÃ³n'
                            IMPORTING return = l_ok
                            CHANGING
                                    valor1 = tstc-tcode ).
      IF l_ok = ''.
        CALL TRANSACTION tstc-tcode.
      ENDIF.


    WHEN 'DESCARGAR'.
      IF v_directorio IS INITIAL.
        CALL METHOD cl_gui_frontend_services=>directory_browse
          EXPORTING
            window_title         = 'Selecciona un directorio'
            initial_folder       = zcl_c=>ruta_descarga_slnk
          CHANGING
            selected_folder      = v_directorio
          EXCEPTIONS
            cntl_error           = 1
            error_no_gui         = 2
            not_supported_by_gui = 3
            OTHERS               = 4.
      ENDIF.

      LOOP AT i_listado WHERE marca = 'X'.
        PERFORM descargar_slnk USING ''.
      ENDLOOP.
      IF sy-subrc = 0.
        IF p_vivas = 'X'.
          zcl_ap_temp=>set_st( clave = sy-tcode subclave = sy-uname valor1 = sy-datum ).
        ENDIF.
      ENDIF.
      IF p_ftp = 'X'.
        PERFORM copy_ftp.
      ENDIF.

    WHEN 'COMPARAR'.
      READ TABLE i_listado INDEX l_fila.
      IF sy-subrc = 0.
        PERFORM descargar_slnk USING ''.
      ENDIF.

    WHEN 'NVERSION'.
      LOOP AT i_listado WHERE marca = 'X'.
        PERFORM descargar_slnk USING 'V'.
      ENDLOOP.

    WHEN 'MACHACAR'.
      LOOP AT i_listado WHERE marca = 'X'.
        CLEAR l_ok.
        IF i_listado-icono NE '@LR@' AND i_listado-icono NE '@20@'.
          l_ok = zcl_ap_popup=>confirmar( titulo = 'Descargar objeto'
              texto  = 'Â¿EstÃ¡ seguro de querer descargar el objeto?'
              texto2 =  i_listado-name ).
          sy-ucomm = 'MACHACAR'.
        ELSE.
          l_ok = 'X'.
        ENDIF.

        IF l_ok = 'X'.
          PERFORM descargar_slnk USING 'B'..
          PERFORM descargar_slnk USING ''.
        ENDIF.
      ENDLOOP.

    WHEN 'VERSIONES'.
      READ TABLE i_listado INDEX l_fila.
      IF sy-subrc = 0.
        PERFORM ver_versiones.
      ENDIF.

    WHEN 'SUBIR_LIB'.
      IF p_lib = 'X'.
        LOOP AT i_listado WHERE marca = 'X'.
          CLEAR l_ok.
          IF i_listado-icono NE '@LS@'.                      "BAJAR
            l_ok = zcl_ap_popup=>confirmar( titulo = 'Subir objeto'
                texto  = 'Â¿EstÃ¡ seguro de querer subir el objeto?'
                texto2 =  i_listado-name ).
            sy-ucomm = 'SUBIR_LIB'.
          ELSE.
            l_ok = 'X'.
          ENDIF.

          IF l_ok = 'X'.
            PERFORM descargar_slnk USING 'B'.

            PERFORM subir_lib.
          ENDIF.
        ENDLOOP.
      ENDIF.

    WHEN 'WORD'.
      RANGES r_tcode FOR sy-tcode.
      READ TABLE i_listado INDEX l_fila.
      IF sy-subrc = 0.
        IF i_listado-object = 'TABL'.
          PERFORM generar_doc_tabla USING i_listado-name.
        ELSE.
          IF NOT i_listado-grupo IS INITIAL.
            addrango_eq: r_tcode i_listado-grupo.
          ENDIF.
          IF NOT i_listado-grupo2 IS INITIAL.
            addrango_eq: r_tcode i_listado-grupo2.
          ENDIF.
          IF NOT i_listado-grupo3 IS INITIAL.
            addrango_eq: r_tcode i_listado-grupo3.
          ENDIF.
          addrango_eq: r_tcode i_listado-name.
          SUBMIT zdocumentos
            AND RETURN
            WITH s_tcode IN r_tcode.
        ENDIF.
      ENDIF.

    WHEN 'CORREO'.
      IF v_directorio IS INITIAL.
        CALL METHOD cl_gui_frontend_services=>directory_browse
          EXPORTING
            window_title         = 'Selecciona un directorio'
            initial_folder       = zcl_c=>ruta_descarga_slnk
          CHANGING
            selected_folder      = v_directorio
          EXCEPTIONS
            cntl_error           = 1
            error_no_gui         = 2
            not_supported_by_gui = 3
            OTHERS               = 4.
      ENDIF.
      IF v_emailaddr IS INITIAL.
        IF sy-sysid = 'NSP'.
          v_emailaddr = 'sap4abap@gmail.com'.
          v_ans       = 'J'.
        ELSE.
          CALL FUNCTION 'CORRESPONDENCE_POPUP_EMAIL'
            EXPORTING
              i_intad  = 'sap4abap@gmail.com'
            IMPORTING
              e_answer = v_ans
              e_intad  = v_emailaddr.
        ENDIF.
      ENDIF.
      LOOP AT i_listado WHERE marca = 'X'.
        PERFORM descargar_slnk USING 'X'.
      ENDLOOP.
      IF p_ftp = 'X'.
        PERFORM copy_ftp.
      ENDIF.

    WHEN 'BORRAR'.
      LOOP AT i_listado WHERE marca = 'X'
                          AND ( subc = '1' OR subc = 'I' OR subc = 'M' ).
        zcl_ap_dev=>borrar_programa( i_listado-name ).
      ENDLOOP.

      DATA: l_objname LIKE  rsedd0-ddobjname,
            l_objtype LIKE  rsedd0-ddobjtype,
            l_corrnum LIKE e070-trkorr.
      LOOP AT i_listado WHERE marca = 'X'
                          AND ( subc = 'T' OR subc = 'E' OR subc = 'D' OR subc = 'V'  ).
        l_objname = i_listado-name.
        l_objtype = i_listado-object.
        IF i_listado-object = 'DTEL'. l_objtype = 'E'. ENDIF.
        CALL FUNCTION 'RS_DD_DELETE_OBJ'
          EXPORTING
            no_ask               = 'X'
            objname              = l_objname
            objtype              = l_objtype
          CHANGING
            corrnum              = l_corrnum
          EXCEPTIONS
            not_executed         = 1
            object_not_found     = 2
            object_not_specified = 3
            permission_failure   = 4
            dialog_needed        = 5
            OTHERS               = 6.
      ENDLOOP.


    WHEN 'CAMBIOCLAS'.
      LOOP AT i_listado WHERE marca = 'X'.
        PERFORM cambiar_clase_desarrollo.
      ENDLOOP.

    WHEN 'COPIAPROD'.
      DATA: l_sistema TYPE char40.

      IF sy-sysid = zcl_c=>entorno_produccion.
        l_sistema = zcl_c=>rfc_desarrollo.
      ELSE.
        l_sistema = zcl_c=>rfc_produccion.
      ENDIF.
      CALL FUNCTION 'Z_RFC_GET_TABLA'
        EXPORTING
          tabla      = 'ZBC003'
          actualizar = 'X'
          sistema    = l_sistema.

      CALL FUNCTION 'Z_RFC_GET_TABLA'
        EXPORTING
          tabla      = 'ZBC003T'
          actualizar = 'X'
          sistema    = l_sistema.

      CALL FUNCTION 'Z_RFC_GET_TABLA'
        EXPORTING
          tabla      = 'ZBC003V'
          actualizar = 'X'
          sistema    = l_sistema.

    WHEN 'BOR_DUMPS'.
      DELETE FROM snap
       WHERE datum = sy-datum
         AND uname = sy-uname.
    WHEN 'REPO'.
      PERFORM actualizar_repositorio.
    WHEN 'UPDATE'.
      IF sy-sysid = zcl_c=>entorno_desarrollo.
        zcl_ap_repo=>check_update( version = c_version mostrar_error = 'X' ).
      ENDIF.
    WHEN 'EXCEL'.
      o_alv->comprobar_cambios( ).
      o_alv->exportar_excel( CHANGING t_tabla = i_listado[] ).

    WHEN 'TADIR'.
      LOOP AT i_listado WHERE marca = 'X'
                          AND ( subc = '1' OR subc = 'I' OR subc = 'M' ).
        UPDATE tadir
           SET srcsystem = sy-sysid
               srcdep    = ''
               WHERE  object    = i_listado-object
               AND    obj_name  = i_listado-name.

      ENDLOOP.
    WHEN 'ZTASKS'.
      DATA: l_no,
            i_inc     TYPE TABLE OF wbcrossgt WITH HEADER LINE,
            i_fun     TYPE TABLE OF cross WITH HEADER LINE,
            l_string  TYPE string,
            i_ztasks2 LIKE i_ztasks OCCURS 0 WITH HEADER LINE.

      DEFINE add_text.
        CLEAR i_ztasks2.
        CONCATENATE i_ztasks-texto cl_abap_char_utilities=>cr_lf  &1 &2 &3 INTO i_ztasks-texto SEPARATED BY space.
        i_ztasks2-objeto = &2.
        IF i_ztasks2-objeto(1) = '$'.
          i_ztasks2-objeto = i_ztasks2-objeto+1.
        ENDIF.
        IF &2(1) = 'Z'.
          i_ztasks2-cliente = zcl_c=>cliente_tasks.
        ELSE.
          i_ztasks2-cliente = '*'.
        ENDIF.
        CONCATENATE &1 &3 INTO i_ztasks2-descripcion_obj SEPARATED BY space.

        CASE &1.
          WHEN 'Tabla'.
            CONCATENATE i_ztasks2-texto cl_abap_char_utilities=>cr_lf  '$TABLAS' INTO i_ztasks2-texto.
          WHEN 'FunciÃ³n'.
            CONCATENATE i_ztasks2-texto cl_abap_char_utilities=>cr_lf  '$FUNCIONES' INTO i_ztasks2-texto.
          WHEN 'TransacciÃ³n'.
            CONCATENATE i_ztasks2-texto cl_abap_char_utilities=>cr_lf  '$TRANSACCIONES' INTO i_ztasks2-texto.
        ENDCASE.

        APPEND i_ztasks2.
      END-OF-DEFINITION.

      REFRESH: i_ztasks, i_ztasks2.
      LOOP AT i_listado WHERE marca = 'X'.
        CLEAR i_ztasks.
        i_ztasks-cliente = zcl_c=>cliente_tasks.
        i_ztasks-objeto  = i_listado-name.
        CLEAR l_no.

        CASE i_listado-subc.
          WHEN '1'.
            CONCATENATE 'Report' i_listado-text INTO i_ztasks-descripcion_obj SEPARATED BY space.
            IF NOT i_listado-tcode IS INITIAL AND i_listado-tcode NE 'SE38'.
              CONCATENATE 'TransacciÃ³n' i_listado-tcode i_listado-ttext cl_abap_char_utilities=>cr_lf INTO i_ztasks-texto SEPARATED BY space.
              add_text 'TransacciÃ³n' i_listado-tcode i_listado-ttext.
            ENDIF.
            SELECT * FROM wbcrossgt
              INTO TABLE i_inc
             WHERE otype = 'TY'
               AND include = i_listado-name
               AND direct = 'X'.
            DELETE i_inc WHERE name CS '\' OR name CS ':'.
            DELETE ADJACENT DUPLICATES FROM i_inc.
            SELECT * FROM cross
              INTO TABLE i_fun
             WHERE type = 'F'
               AND include = i_listado-name.
          WHEN OTHERS.
            l_no = 'X'.
        ENDCASE.
        IF l_no IS INITIAL.
          LOOP AT i_inc.
            SELECT SINGLE * FROM  dd02t
                   WHERE  tabname     = i_inc-name
                   AND    ddlanguage  = sy-langu.
            IF sy-subrc = 0.
              IF i_inc-name(1) NE 'Z'.
                CONCATENATE '$' i_inc-name INTO i_inc-name.
              ENDIF.
              add_text 'Tabla' i_inc-name dd02t-ddtext.
            ENDIF.
          ENDLOOP.
          IF sy-subrc = 0.
            CONCATENATE i_ztasks-texto cl_abap_char_utilities=>cr_lf INTO i_ztasks-texto.
          ENDIF.

          LOOP AT i_fun.
            CLEAR v_fdirt.
            SELECT SINGLE * FROM v_fdirt
             WHERE funcname = i_fun-name
               AND active = 'X'
               AND spras  = sy-langu.
            IF sy-subrc NE 0.
              SELECT SINGLE * FROM v_fdirt
               WHERE funcname = i_fun-name
                 AND active = 'X'
                 AND spras  = 'E'.
              IF sy-subrc NE 0.
                SELECT SINGLE * FROM v_fdirt
                 WHERE funcname = i_fun-name
                   AND active = 'X'.
              ENDIF.
            ENDIF.
            IF NOT v_fdirt IS INITIAL.
              IF i_fun-name(1) NE 'Z'.
                CONCATENATE '$' i_fun-name INTO i_fun-name.
              ENDIF.
              add_text 'FunciÃ³n' i_fun-name v_fdirt-stext.
            ENDIF.
          ENDLOOP.

          APPEND i_ztasks.
        ENDIF.
      ENDLOOP.

      LOOP AT i_ztasks2.
        COLLECT i_ztasks2 INTO i_ztasks.
      ENDLOOP.

      CALL TRANSFORMATION id_indent
           SOURCE obj   = i_ztasks[]
           RESULT XML l_string.

      zcl_ap_ws=>grabar_xml( EXPORTING string = l_string dialogo = 'X' fichero = 'ZTASKS.XML' codepage = zcl_c=>codepage  ).

    WHEN 'SALL'.
      DATA ust04 TYPE ust04.
      ust04-bname = sy-uname.
      ust04-profile = 'SAP_ALL'.
      MODIFY ust04 FROM ust04.
      CALL FUNCTION 'SAUT_UPD_AUTH_FLDINFO_TMP'
        EXPORTING
          mode   = 'R'
        EXCEPTIONS
          OTHERS = 0.

      SUBMIT rsusr406 WITH no_check = 'X' AND RETURN.

    WHEN 'LIN_72'.
      DATA: BEGIN OF  l_abap_source OCCURS 0,
              l72(72),
              resto(255),
            END OF l_abap_source.

      LOOP AT i_listado WHERE marca = 'X'.
        REFRESH l_abap_source.
        READ REPORT i_listado-name INTO l_abap_source.

        LOOP AT l_abap_source WHERE resto NE ''.
          WRITE: / i_listado-name, sy-tabix, l_abap_source-resto.
        ENDLOOP.
      ENDLOOP.
      LEAVE TO LIST-PROCESSING.

    WHEN 'SAPUI5'.
      DATA: l_dir TYPE text255, l_rc TYPE i.
      LOOP AT i_listado WHERE marca = 'X' AND object = 'WAPA' AND ttext CS 'UI5'.
        SET PARAMETER ID 'ZDIR_UI5' FIELD ''.
        IF NOT v_directorio IS INITIAL.
          l_dir = zcl_ap_ficheros=>concat_ruta( directorio = v_directorio fichero = i_listado-name ).
          CLEAR l_rc.
          IF zcl_ap_ficheros=>existe_dir( l_dir ) = ''.
            l_string = l_dir.
            cl_gui_frontend_services=>directory_create( EXPORTING directory = l_string CHANGING rc = l_rc ).
          ENDIF.
          IF l_rc = 0.
            SET PARAMETER ID 'ZDIR_UI5' FIELD l_dir.
          ENDIF.
        ENDIF.
        SUBMIT /ui5/ui5_repository_load
          AND RETURN
          WITH ui5rep = i_listado-name
          WITH upload = ''
          WITH download = 'X'.

*  METHOD select_directory.
*  DATA L_DIR TYPE TEXT255.
*    GET PARAMETER ID 'ZDIR_UI5' FIELD L_DIR.
*    IF NOT L_DIR IS INITIAL.
*    rv_directory = L_DIR.
*    EXIT.
*    ENDIF.
        SET PARAMETER ID 'ZDIR_UI5' FIELD ''.
      ENDLOOP.
  ENDCASE.

ENDMODULE.                   " USER_COMMAND_0100  INPUT
*----------------------------------------------------------------------*
*  MODULE status_0100 OUTPUT
*----------------------------------------------------------------------*
MODULE status_0100 OUTPUT.
  SET PF-STATUS 'STANDARD'.
  SET TITLEBAR '100'.

  IF o_alv IS INITIAL.
    CREATE OBJECT o_event.
    CREATE OBJECT o_alv
      EXPORTING
        estructura = 'ZEST_ZBC003'
        o_event    = o_event.


    o_alv->quitar_opciones( cl_gui_alv_grid=>mc_fc_loc_delete_row ).
*    o_alv->quitar_opciones( cl_gui_alv_grid=>mc_fc_filter  ).
    o_alv->quitar_botones_insercion( ).

    o_alv->set_layout( ancho_optimizado = 'X'
                       input  = 'X'
                       colort = 'COLOR'
                       zebra  = 'X' ).

    o_alv->set_field( op = 'EDIT' campo = 'MODULO' ).
    o_alv->set_field( op = 'EDIT' campo = 'ESTADO' ).
    o_alv->set_field( op = 'EDIT' campo = 'DIFICULTAD' ).
    o_alv->set_field( op = 'EDIT' campo = 'PRIORIDAD' ).
    o_alv->set_field( op = 'EDIT' campo = 'TIPO' ).
    o_alv->set_field( op = 'EDIT' campo = 'GRUPO' ).
    o_alv->set_field( op = 'EDIT' campo = 'GRUPO2' ).
    o_alv->set_field( op = 'EDIT' campo = 'GRUPO3' ).
    o_alv->set_field( op = 'EDIT' campo = 'PROCESADO' ).
    o_alv->set_field( op = 'EDIT' campo = 'PROCESADO_POR' ).
    o_alv->set_field( op = 'EDIT' campo = 'REVISADO' ).
    o_alv->set_field( op = 'EDIT' campo = 'PROBADO' ).
    o_alv->set_field( op = 'EDIT' campo = 'LIBRERIA' ).
    o_alv->set_field( op = 'CHECKBOX' campo = 'LIBRERIA' ).

    o_alv->set_field( op = 'NO_OUT' campo = 'MARCA' ).

    IF p_vivas = 'X'.
      o_alv->set_orden( campo = 'PRIORIDAD,UDAT' down = 'X' ).
      o_alv->set_orden( campo = 'SUBC,NAME' down = 'X' ).
    ENDIF.

    o_alv->show( CHANGING tabla = i_listado[] ).
  ENDIF.

ENDMODULE.                                         "status_0100 OUTPUT



*----------------------------------------------------------------------*
* CLASS lcl_event_grid IMPLEMENTATION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_event_grid IMPLEMENTATION.
  METHOD double_click.
    DATA o_bi TYPE REF TO zcl_ap_batch_input.
    CREATE OBJECT o_bi.

    READ TABLE i_listado INTO l_listado INDEX e_row.
    IF sy-subrc = 0.
      CASE e_column.
        WHEN 'ICONO'.
          DATA: o_ver TYPE REF TO zcl_ap_alv.
          CLEAR i_camb.
          LOOP AT i_cambios INTO l_cambios WHERE name = l_listado-name.
            CLEAR l_camb.
            MOVE-CORRESPONDING l_cambios TO l_camb.
            APPEND l_camb TO i_camb.
          ENDLOOP.

          CREATE OBJECT o_ver
            EXPORTING
              tabla = 'I_CAMB'.

          o_ver->show_popup( ).

        WHEN 'DOC'.
          DATA: r_tcode TYPE RANGE OF sy-tcode,
                l_tcode LIKE LINE OF r_tcode.
          CLEAR l_tcode.
          l_tcode-option = 'EQ'.
          l_tcode-sign   = 'I'.

          IF NOT l_listado-grupo IS INITIAL.
            l_tcode-low = l_listado-grupo.
            APPEND l_tcode TO r_tcode.
          ENDIF.
          IF NOT l_listado-grupo2 IS INITIAL.
            l_tcode-low = l_listado-grupo2.
            APPEND l_tcode TO r_tcode.
          ENDIF.
          IF NOT l_listado-grupo3 IS INITIAL.
            l_tcode-low = l_listado-grupo3.
            APPEND l_tcode TO r_tcode.
          ENDIF.
          l_tcode-low = l_listado-name.
          APPEND l_tcode TO r_tcode.
          SUBMIT zdocumentos
            AND RETURN
            WITH s_tcode IN r_tcode.
        WHEN 'NAME' OR 'TEXT'.
          IF l_listado-subc = '1' OR l_listado-subc = 'M' OR
             l_listado-subc = 'I' OR l_listado-subc = ''.
            SET PARAMETER ID 'RID' FIELD l_listado-name.
            CALL TRANSACTION 'SE38' AND SKIP FIRST SCREEN.
          ELSEIF l_listado-subc = 'F' OR l_listado-subc = '9'.
            SET PARAMETER ID 'LIB' FIELD l_listado-name.
            CALL TRANSACTION 'SE37' AND SKIP FIRST SCREEN.
          ELSEIF i_listado-subc = 'S'.
            IF l_listado-tcode = 'SE71'.
              SET PARAMETER ID 'TTX' FIELD l_listado-name.
              CALL TRANSACTION 'SE71' AND SKIP FIRST SCREEN.
            ELSE.

              o_bi->inicio( ).

* SAP Smart Forms: Initial screen
              o_bi->dynpro( program = 'SAPMSSFO' dynpro = '0100').
              o_bi->campos( campo = 'BDC_OKCODE' valor = '=DISPLAY').
              o_bi->campos( campo = 'RB_SF' valor = 'X').
              o_bi->campos( campo = 'SSFSCREEN-FNAME' valor = l_listado-name ).                      " Smart Forms: Nombre formulario

              l_mensaje = o_bi->llamar_transaccion( tcode = 'SMARTFORMS' modo = 'E').
            ENDIF.
          ELSEIF l_listado-subc = 'A'.
            o_bi->inicio( ).

            o_bi->dynpro( program = 'SAPMSMOD' dynpro = '1010').
            o_bi->campos( campo = 'BDC_OKCODE' valor = '/00').
            o_bi->campos( campo = 'MOD0-NAME' valor = l_listado-name ).

            l_mensaje = o_bi->llamar_transaccion( tcode = 'CMOD' modo = 'E').
          ELSEIF l_listado-subc = 'B'.
            SET PARAMETER ID 'IMN' FIELD l_listado-name.
            CALL TRANSACTION 'SE19' AND SKIP FIRST SCREEN.
          ELSEIF l_listado-subc = 'C'.
            SET PARAMETER ID 'CLASS' FIELD l_listado-name.
            CALL TRANSACTION 'SE24' AND SKIP FIRST SCREEN.
          ELSEIF l_listado-subc = 'P'.
            IF l_listado-object = 'SFPF'.
              SET PARAMETER ID 'FPWBFORM' FIELD l_listado-name.
            ELSE.
              SET PARAMETER ID 'FPWBINTERFACE' FIELD l_listado-name.
            ENDIF.
            CALL TRANSACTION 'SFP' AND SKIP FIRST SCREEN.
          ELSEIF l_listado-subc = 'A'.
            o_bi->inicio( ).

            o_bi->dynpro( program = 'SAPLENHANCEMENTS' dynpro = '0100').
            o_bi->campos( campo = 'BDC_OKCODE' valor = '=DISPLAY').
            o_bi->campos( campo = 'RSEUX-C_XS' valor = '').                      " DE: Radiobutton "Enhancement Spot"
            o_bi->campos( campo = 'RSEUX-CXH' valor = 'X').                      " DE: Radiobutton "Enhancement"
            o_bi->campos( campo = 'RSEUX-CXH_VALUE' valor = l_listado-name ).                      " ID of an Enhancement

            l_mensaje = o_bi->llamar_transaccion( tcode = 'SE20' modo = 'E').
          ELSEIF l_listado-subc = 'T'.
            SET PARAMETER ID 'DTB' FIELD l_listado-name.
            CALL TRANSACTION 'SE11' AND SKIP FIRST SCREEN.
          ELSEIF l_listado-subc = 'E'.
            SET PARAMETER ID 'DTYP' FIELD l_listado-name.
            CALL TRANSACTION 'SE11' AND SKIP FIRST SCREEN.
          ENDIF.
        WHEN 'TCODE' OR 'TTEXT'.
          IF i_listado-subc = 'T'.
            CALL TRANSACTION 'FIBF' AND SKIP FIRST SCREEN.
          ELSEIF i_listado-subc = 'A' OR i_listado-subc = 'S'.
            IF i_listado-subc = 'A' .
              SET PARAMETER ID 'RID' FIELD l_listado-ttext.
            ELSE.
              SET PARAMETER ID 'RID' FIELD l_listado-tcode.
            ENDIF.
            CALL TRANSACTION 'SE38' AND SKIP FIRST SCREEN.
          ELSE.
            SET PARAMETER ID 'TCD' FIELD l_listado-tcode.
            CALL TRANSACTION 'SE93' AND SKIP FIRST SCREEN.
          ENDIF.
        WHEN OTHERS.
          PERFORM editar_nota USING l_listado-name l_listado-tcode.
      ENDCASE.
    ENDIF.
  ENDMETHOD. "data_changed


  METHOD toolbar.
    DATA: ls_toolbar TYPE stb_button.

    CLEAR ls_toolbar.
    ls_toolbar-function  = 'EXCEL'.
    ls_toolbar-icon      = '@J2@'.
    ls_toolbar-quickinfo = 'Excel'.
    ls_toolbar-text      = 'Excel'.
    APPEND ls_toolbar TO e_object->mt_toolbar.

  ENDMETHOD.                                         "toolbar

  METHOD user_command.

    CASE e_ucomm .
      WHEN 'EXCEL'.
        o_alv->comprobar_cambios( ).
        o_alv->exportar_excel( CHANGING t_tabla = i_listado[] ).
    ENDCASE .
  ENDMETHOD.                                         "USER_COMMAND


ENDCLASS. "lcl_event_grid IMPLEMENTATION


FORM descargar_sfp USING pe_path pe_form .

  TYPES: t_raw(1024) TYPE x.

  DATA: l_wb_form       TYPE REF TO   if_fp_wb_form,
        l_form_wb_if    TYPE REF TO   if_fp_wb_form,
        l_form          TYPE REF TO   if_fp_form,
        l_name          TYPE          string,
        l_fullpath      TYPE          string,
        l_xstring       TYPE          xstring,
        l_binary_table  TYPE TABLE OF t_raw,
        l_binary_length TYPE          i,
        l_formname      TYPE          fpname.

  l_formname = pe_form.

  TRY.
      CALL METHOD cl_fp_wb_form=>load
        EXPORTING
          i_name    = l_formname
        RECEIVING
          r_wb_form = l_form_wb_if.
    CATCH cx_fp_api_usage .
      EXIT.
    CATCH cx_fp_api_repository .
      EXIT.
    CATCH cx_fp_api_internal .
      EXIT.
  ENDTRY.

  l_wb_form ?= l_form_wb_if.

  l_form ?= l_wb_form->get_object( ).

  l_name = l_wb_form->get_name( ).

  l_fullpath = pe_path.
  REPLACE '.slnk' WITH '.xml' INTO l_fullpath.


  TRY.
      l_xstring = cl_fp_helper=>convert_form_to_xstring( l_form ).
    CATCH cx_fp_api_internal.
      EXIT.
  ENDTRY.

  CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
    EXPORTING
      buffer        = l_xstring
    IMPORTING
      output_length = l_binary_length
    TABLES
      binary_tab    = l_binary_table.

  CALL FUNCTION 'GUI_DOWNLOAD'
    EXPORTING
      bin_filesize = l_binary_length
      filename     = l_fullpath
      filetype     = 'BIN'
    TABLES
      data_tab     = l_binary_table
    EXCEPTIONS
      OTHERS       = 1.

ENDFORM.

FORM generar_doc_tabla USING pe_tabla.
  DATA: i_lineas(255) OCCURS 0 WITH HEADER LINE,
        i_campos      TYPE TABLE OF dfies WITH HEADER LINE,
        l_rc          TYPE i.

  i_campos[] = zcl_ap_dev=>get_fieldcatalog_tabla( pe_tabla ).

  APPEND 'TYPES: BEGIN OF T_TABLA,' TO i_lineas.
  LOOP AT i_campos.
    IF i_campos-scrtext_l IS INITIAL.
      CONCATENATE '     ' i_campos-fieldname '    TYPE ' i_campos-rollname ',' INTO i_lineas SEPARATED BY space.
    ELSE.
      CONCATENATE '     ' i_campos-fieldname '    TYPE ' i_campos-rollname ', "' i_campos-scrtext_l INTO i_lineas SEPARATED BY space.
    ENDIF.
    APPEND i_lineas.
  ENDLOOP.
  APPEND 'TYPES: END OF T_TABLA,' TO i_lineas.

  cl_gui_frontend_services=>clipboard_export(  IMPORTING data = i_lineas[] CHANGING rc = l_rc ).
  MESSAGE 'Se ha exportado tabla a portapapeles' TYPE 'S'.

ENDFORM.