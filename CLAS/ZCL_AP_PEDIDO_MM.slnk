<?xml version="1.0" encoding="utf-8"?>
<CLAS CLSNAME="ZCL_AP_PEDIDO_MM" VERSION="1" LANGU="S" DESCRIPT="Pedido MM" CATEGORY="00" EXPOSURE="2" STATE="1" RELEASE="0" CLSCCINCL="X" FIXPT="X" UNICODE="X" CLSBCCAT="00" DURATION_TYPE="0 " RISK_LEVEL="0 ">
 <types CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="T_DIF_CTD" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="1 " TYPTYPE="4" SRCROW1="7 " SRCCOLUMN1="6 " SRCROW2="12 " SRCCOLUMN2="21 " TYPESRC_LENG="180 " TYPESRC="BEGIN OF t_dif_ctd,
        ebelp    TYPE ebelp,
        menge_ok TYPE ekpo-menge,
        menge_bd TYPE ekpo-menge,
        meins    TYPE ekpo-meins,
      END OF t_dif_ctd
"/>
 <types CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="TT_DIF_CTD" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="2 " TYPTYPE="4" SRCROW1="13 " SRCCOLUMN1="10 " SRCROW2="13 " SRCCOLUMN2="53 " TYPESRC_LENG="46 " TYPESRC="tt_dif_ctd           TYPE TABLE OF t_dif_ctd
"/>
 <types CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="TT_REL_FINAL" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="3 " TYPTYPE="4" SRCROW1="14 " SRCCOLUMN1="10 " SRCROW2="14 " SRCCOLUMN2="54 " TYPESRC_LENG="47 " TYPESRC="tt_rel_final         TYPE TABLE OF bapirlcorq
"/>
 <types CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="TT_REL_INFO_GEN" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="4 " TYPTYPE="4" SRCROW1="15 " SRCCOLUMN1="10 " SRCROW2="15 " SRCCOLUMN2="54 " TYPESRC_LENG="47 " TYPESRC="tt_rel_info_gen      TYPE TABLE OF bapirlgnrq
"/>
 <types CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="TT_REL_POSTED" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="5 " TYPTYPE="4" SRCROW1="16 " SRCCOLUMN1="10 " SRCROW2="16 " SRCCOLUMN2="54 " TYPESRC_LENG="47 " TYPESRC="tt_rel_posted        TYPE TABLE OF bapirlcorq
"/>
 <types CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="TT_REL_PREREQUISITES" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="6 " TYPTYPE="4" SRCROW1="17 " SRCCOLUMN1="10 " SRCROW2="17 " SRCCOLUMN2="54 " TYPESRC_LENG="47 " TYPESRC="tt_rel_prerequisites TYPE TABLE OF bapirlcorq
"/>
 <localImplementation>*&quot;* local class implementation for public class*&quot;* use this source file for the implementation part of*&quot;* local helper classes</localImplementation>
 <localTypes>*&quot;* use this source file for any type declarations (class*&quot;* definitions, interfaces or data types) you need for method*&quot;* implementation or private method&apos;s signature</localTypes>
 <localMacros>*&quot;* use this source file for any macro definitions you need*&quot;* in the implementation part of the class</localMacros>
 <typeUsage CLSNAME="ZCL_AP_PEDIDO_MM" TYPEGROUP="ABAP" VERSION="1" TPUTYPE="0" IMPLICIT="X"/>
 <forwardDeclaration>ABAP</forwardDeclaration>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ACCOUNT" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="17 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOACCOUNT" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ACCOUNTX" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="19 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOACCOUNTX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ADDRESS" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="25 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOADDRDELIVERY" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BAPIRET2" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="7 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIRET2" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="C_HIST_ENTREGA" VERSION="1" LANGU="S" DESCRIPT="Entregas" EXPOSURE="2" STATE="1" EDITORDER="4 " ATTDECLTYP="2" ATTVALUE="&apos;E&apos;" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BEWTP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="C_HIST_FACTURA" VERSION="1" LANGU="S" DESCRIPT="Factura" EXPOSURE="2" STATE="1" EDITORDER="3 " ATTDECLTYP="2" ATTVALUE="&apos;Q&apos;" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BEWTP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="C_HIST_SALIDAS" VERSION="1" LANGU="S" DESCRIPT="Factura" EXPOSURE="2" STATE="1" EDITORDER="6 " ATTDECLTYP="2" ATTVALUE="&apos;U&apos;" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BEWTP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="C_OBJECTCLAS" VERSION="1" LANGU="S" DESCRIPT="Clase de objeto" EXPOSURE="2" STATE="1" EDITORDER="1 " ATTDECLTYP="2" ATTVALUE="&apos;EINKBELEG&apos;" ATTEXPVIRT="0" TYPTYPE="1" TYPE="CDHDR-OBJECTCLAS" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="C_OBJETO" VERSION="1" LANGU="S" DESCRIPT="Tipo de objeto" EXPOSURE="2" STATE="1" EDITORDER="5 " ATTDECLTYP="2" ATTVALUE="&apos;BUS2012&apos;" ATTEXPVIRT="0" TYPTYPE="1" TYPE="SRGBTBREL-TYPEID_A" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="IMPHEADER" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="15 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIEIKP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="IMPHEADERX" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="16 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIEIKPX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_ACCOUNT" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="18 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOACCOUNT_TP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_ACCOUNTX" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="20 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOACCOUNTX_TP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_ADDRESS" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="26 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WSPO_T_MEPOADDRDELIVERY" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_COMPONENTS" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="29 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPO_T_COMPONENT" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_COMPONENTSX" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="30 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPO_T_COMPONENTX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_DIF_CTD" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="9 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="TT_DIF_CTD" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_ERRORES" VERSION="1" LANGU="S" DESCRIPT="Tabla de salida p.mensajes" EXPOSURE="2" STATE="1" EDITORDER="2 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WTY_RETURN_TAB" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_EXTENSION_IN" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="28 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="T_BAPIPAREX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_PARTNERS" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="27 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIEKKOP_TP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_POCOND" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="9 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WSPO_T_MEPOCOND" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_POCONDX" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="10 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WSPO_T_MEPOCONDX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_POHEADER" VERSION="1" LANGU="S" DESCRIPT="Datos de cabecera pedido" EXPOSURE="0" STATE="1" EDITORDER="1 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WRF_POHF_BAPIMEPOHEADER_TTY" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_POHEADERX" VERSION="1" LANGU="S" DESCRIPT="Datos de cabecera pedido (barra de modificación)" EXPOSURE="0" STATE="1" EDITORDER="5 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WRF_POHF_BAPIMEPOHEADERX_TTY" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_POITEM" VERSION="1" LANGU="S" DESCRIPT="Posición de pedido" EXPOSURE="0" STATE="1" EDITORDER="3 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WRF_POHF_BAPIMEPOITEM_TTY" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_POITEMX" VERSION="1" LANGU="S" DESCRIPT="Datos de posición pedido (barra de modificación)" EXPOSURE="0" STATE="1" EDITORDER="7 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WRF_POHF_BAPIMEPOITEMX_TTY" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_SCHEDULE" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="12 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WSPO_T_MEPOSCHEDULE" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_SCHEDULEX" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="14 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="WSPO_T_MEPOSCHEDULEX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_SHIPPING" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="22 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIITEMSHIP_TP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="I_SHIPPINGX" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="24 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIITEMSHIPX_TP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MESSAGE" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="8 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPI_MSG" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="POHEADER" VERSION="1" LANGU="S" DESCRIPT="Datos de cabecera pedido" EXPOSURE="0" STATE="1" EDITORDER="2 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOHEADER" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="POHEADERX" VERSION="1" LANGU="S" DESCRIPT="Datos de cabecera pedido (barra de modificación)" EXPOSURE="0" STATE="1" EDITORDER="6 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOHEADERX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="POITEM" VERSION="1" LANGU="S" DESCRIPT="Posición de pedido" EXPOSURE="0" STATE="1" EDITORDER="4 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOITEM" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="POITEMX" VERSION="1" LANGU="S" DESCRIPT="Posición de pedido" EXPOSURE="0" STATE="1" EDITORDER="8 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOITEMX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SCHEDULE" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="11 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOSCHEDULE" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SCHEDULEX" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="13 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIMEPOSCHEDULX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SHIPPING" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="21 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIITEMSHIP" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SHIPPINGX" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="23 " ATTDECLTYP="0" ATTEXPVIRT="0" TYPTYPE="1" TYPE="BAPIITEMSHIPX" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ADD_POS_PEDIDO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="24 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ADD_POS_PEDIDO" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKET-EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ADD_POS_PEDIDO" SCONAME="EINDT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EINDT" PARVALUE="SY-DATUM"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ADD_POS_PEDIDO" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ADD_POS_PEDIDO" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ADD_POS_PEDIDO" SCONAME="EKPO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="2" PARPASSTYP="1" TYPTYPE="1" TYPE="EKPO"/>
  <source>METHOD add_pos_pedido.
    DATA: l_tabla TYPE tabname,
          ekko    TYPE ekko,
          o_ped   TYPE REF TO zcl_ap_pedido_mm,
          l_ekpo  TYPE ekpo,
          i_ekpo  TYPE TABLE OF ekpo,
          eket    TYPE eket,
          i_eket  TYPE TABLE OF eket.

    l_tabla = &apos;EKKO&apos;.
    SELECT SINGLE * FROM (l_tabla)
      INTO ekko
     WHERE ebeln = ebeln.
    IF sy-subrc &lt;&gt; 0.
      CONCATENATE &apos;No existe el pedido&apos;(nep) ebeln INTO message SEPARATED BY space.
    ELSE.
      o_ped = NEW #( ).

      ekpo-ebeln = ebeln.
      SELECT SINGLE ebelp FROM ekpo
        INTO ekpo-ebelp
       WHERE ebeln = ebeln
         AND ebelp = ekpo-ebelp.
      IF sy-subrc = 0 OR ekpo-ebelp IS INITIAL.
        SELECT MAX( ebelp ) FROM ekpo
          INTO ekpo-ebelp
         WHERE ebeln = ebeln.
        ekpo-ebelp = ekpo-ebelp + 10.
      ENDIF.

      l_tabla = &apos;EKPO&apos;.
      SELECT * FROM (l_tabla)                 &quot;#EC CI_ALL_FIELDS_NEEDED
        INTO l_ekpo
        UP TO 1 ROWS
       WHERE ebeln = ebeln
         AND loekz = &apos;&apos;
        ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc = 0.
        IF ekpo-werks IS INITIAL.
          ekpo-werks = l_ekpo-werks.
        ENDIF.
        IF ekpo-lgort IS INITIAL.
          ekpo-lgort = l_ekpo-lgort.
        ENDIF.
      ENDIF.

      IF ekpo-txz01 IS INITIAL.
        ekpo-txz01 = zcl_ap_material=&gt;get_descripcion( ekpo-matnr ).
      ENDIF.
      APPEND ekpo TO i_ekpo.

      CLEAR eket.
      MOVE-CORRESPONDING ekpo TO eket.
      eket-etenr = &apos;0001&apos;.
      eket-eindt = eindt.
      APPEND eket TO i_eket.

      message = o_ped-&gt;modificar_pedido( ekko   = ekko
                                         i_ekpo = i_ekpo
                                         i_eket = i_eket
                                         commit = commit ).

    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ATTA_GOS_ST" VERSION="1" LANGU="S" DESCRIPT="Devuelve lista de URLs de GOS" EXPOSURE="2" STATE="1" EDITORDER="17 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ATTA_GOS_ST" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ATTA_GOS_ST" SCONAME="TABLA" VERSION="1" LANGU="S" DESCRIPT="URL GOS" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ZTAB_URL_GOS"/>
  <source>METHOD atta_gos_st.
    DATA l_clave TYPE srgbtbrel-instid_a.

    l_clave = ebeln.
    tabla = zcl_ap_gos=&gt;atta_gos_st( tipo = c_objeto clave = l_clave ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_PEDIDO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="29 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_PEDIDO" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_PEDIDO" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_PEDIDO" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_PEDIDO" SCONAME="I_ERRORES" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="WTY_RETURN_TAB"/>
  <source>METHOD borrar_pedido.
    DATA: l_tabla TYPE tabname,
          ekko    TYPE ekko,
          i_ekpo  TYPE TABLE OF ekpo,
          o_ped   TYPE REF TO zcl_ap_pedido_mm.

    FIELD-SYMBOLS: &lt;ekpo&gt;  TYPE ekpo,
                   &lt;error&gt; TYPE bapiret2.

    l_tabla = &apos;EKKO&apos;.
    SELECT SINGLE * FROM (l_tabla)
      INTO ekko
     WHERE ebeln = ebeln.
    IF sy-subrc &lt;&gt; 0.
      __concat2 message &apos;No existe el pedido&apos;(nep) ebeln.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = message ).
      ENDIF.
      return.
    ENDIF.

    l_tabla = &apos;EKPO&apos;.
    SELECT * FROM (l_tabla)
      INTO TABLE i_ekpo
     WHERE ebeln = ebeln
       AND loekz = &apos;&apos;.
    IF sy-subrc &lt;&gt; 0.
      __concat3 message &apos;Pedido&apos;(ped) ebeln &apos;no tiene posiciones sin borrar&apos;(npb).
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = message ).
      ENDIF.
      return.
    ENDIF.

    LOOP AT i_ekpo ASSIGNING &lt;ekpo&gt;.
      &lt;ekpo&gt;-loekz = &apos;L&apos;.
    ENDLOOP.

    o_ped = NEW #( ).
    o_ped-&gt;modificar_pedido( ekko   = ekko
                             i_ekpo = i_ekpo
                             o_log  = o_log ).

    LOOP AT o_ped-&gt;i_errores ASSIGNING &lt;error&gt; WHERE type = &apos;E&apos;.
      __concat_a message &lt;error&gt;-message.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_POS_PEDIDO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="25 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_POS_PEDIDO" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_POS_PEDIDO" SCONAME="EBELP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_POS_PEDIDO" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_POS_PEDIDO" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="BORRAR_POS_PEDIDO" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD borrar_pos_pedido.
    DATA: l_tabla TYPE tabname,
          ekko    TYPE ekko,
          o_ped   TYPE REF TO zcl_ap_pedido_mm,
          l_ekpo  TYPE ekpo,
          i_ekpo  TYPE TABLE OF ekpo,
          i_eket  TYPE TABLE OF eket.

    l_tabla = &apos;EKKO&apos;.
    SELECT SINGLE * FROM (l_tabla)
      INTO ekko
     WHERE ebeln = ebeln.
    IF sy-subrc &lt;&gt; 0.
      CONCATENATE &apos;No existe el pedido&apos;(nep) ebeln INTO message SEPARATED BY space.
    ELSE.
      o_ped = NEW #( ).

      l_tabla = &apos;EKPO&apos;.
      SELECT SINGLE * FROM (l_tabla)
      INTO l_ekpo
     WHERE ebeln = ebeln
       AND ebelp = ebelp.
      IF sy-subrc &lt;&gt; 0.
        message = &apos;Posición de pedido no existe&apos;(ppn).
      ENDIF.

      IF l_ekpo-loekz IS NOT INITIAL.
        RETURN.
      ENDIF.

      l_ekpo-loekz = &apos;L&apos;.
      APPEND l_ekpo TO i_ekpo.

      message = o_ped-&gt;modificar_pedido( ekko   = ekko
                                         i_ekpo = i_ekpo
                                         i_eket = i_eket ).

    ENDIF.

    IF NOT o_log IS INITIAL.
      IF NOT message IS INITIAL.
        o_log-&gt;log( p1 = &apos;Error borrando pos.&apos;(ebp) p2 = ebelp p3 = &apos;de pedido&apos;(dpe) p4 = ebeln p5 = message ).
      ELSE.
        o_log-&gt;log( p1 = &apos;Se ha borrado la posicion&apos;(sbp) p2 = ebelp p3 = &apos;de pedido&apos;(dpe) p4 = ebeln msgty = &apos;S&apos; ).
      ENDIF.
    ENDIF.

    IF message IS INITIAL AND commit = &apos;X&apos;.
      zcl_ap_dev=&gt;commit( ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CAMBIAR_PEDIDO" VERSION="1" LANGU="S" DESCRIPT="Cambiar valores del pedido" EXPOSURE="2" STATE="1" EDITORDER="11 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="0" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CAMBIAR_PEDIDO" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CAMBIAR_PEDIDO" SCONAME="I_CAMPOS" VERSION="1" LANGU="S" DESCRIPT="Tipo tabla campos a cambiar en pedido" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ZTAB_CAMPOS_CAMBIO_PEDIDO"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CAMBIAR_PEDIDO" SCONAME="I_ERRORES" VERSION="1" LANGU="S" DESCRIPT="Tabla de salida p.mensajes" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="WTY_RETURN_TAB"/>
  <source>METHOD cambiar_pedido.
    DATA: l_campo TYPE zest_campos_cambio_pedido,
          l_aux   TYPE string,
          l_error TYPE bapiret2.

    FIELD-SYMBOLS &lt;fs&gt; TYPE any.

    CLEAR: i_poheader,
           i_poheaderx,
           i_poitem,
           i_poitemx.

    LOOP AT i_campos INTO l_campo WHERE ebelp IS INITIAL.
      CONCATENATE &apos;POHEADER-&apos; l_campo-campo INTO l_aux.
      ASSIGN (l_aux) TO &lt;fs&gt;.
      IF &lt;fs&gt; IS ASSIGNED.
        &lt;fs&gt; = l_campo-valor.
      ELSE.
        l_error-type = &apos;E&apos;.
        CONCATENATE &apos;Campo&apos;(cam) l_campo-campo
                    &apos;no existe en estructura POHEADER&apos;(neh)
                    INTO l_error-message SEPARATED BY space.
        APPEND l_error TO i_errores.
      ENDIF.

      CONCATENATE &apos;POHEADERX-&apos; l_campo-campo INTO l_aux.
      ASSIGN (l_aux) TO &lt;fs&gt;.
      IF &lt;fs&gt; IS ASSIGNED.
        &lt;fs&gt; = l_campo-valor.
      ENDIF.

    ENDLOOP.

    LOOP AT i_campos INTO l_campo WHERE NOT ebelp IS INITIAL.
      CLEAR poitem.
      poitem-po_item = l_campo-ebelp.
      IF l_campo-delete_ind = &apos;X&apos;.
        poitem-delete_ind = l_campo-delete_ind.
        APPEND poitem TO i_poitem.
      ELSE.
        CONCATENATE &apos;POITEM-&apos; l_campo-campo INTO l_aux.
        ASSIGN (l_aux) TO &lt;fs&gt;.
        IF &lt;fs&gt; IS ASSIGNED.
          &lt;fs&gt; = l_campo-valor.
          APPEND poitem TO i_poitem.
        ELSE.
          l_error-type = &apos;E&apos;.
          CONCATENATE &apos;Campo&apos;(cam) l_campo-campo &apos;no existe en estructura POITEM&apos;(nei)
                      INTO l_error-message SEPARATED BY space.
          APPEND l_error TO i_errores.
        ENDIF.
      ENDIF.

      CLEAR poitemx.
      poitemx-po_item = l_campo-ebelp.
      IF l_campo-delete_ind = &apos;X&apos;.
        poitemx-delete_ind = l_campo-delete_ind.
        APPEND poitemx TO i_poitemx.
      ELSE.
        CONCATENATE &apos;POITEMX-&apos; l_campo-campo INTO l_aux.
        ASSIGN (l_aux) TO &lt;fs&gt;.
        IF &lt;fs&gt; IS ASSIGNED.
          &lt;fs&gt; = &apos;X&apos;.
          APPEND poitemx TO i_poitemx.
        ENDIF.
      ENDIF.
    ENDLOOP.

    IF i_errores IS NOT INITIAL.
      RETURN.
    ENDIF.

    CALL FUNCTION &apos;BAPI_PO_CHANGE&apos;
      EXPORTING
        purchaseorder = ebeln
        poheader      = poheader
        poheaderx     = poheaderx
      TABLES
        return        = i_errores
        poitem        = i_poitem
        poitemx       = i_poitemx.

    me-&gt;i_errores = i_errores.

    IF NOT line_exists( i_errores[ type = &apos;E&apos; ] ).

      CALL FUNCTION &apos;BAPI_TRANSACTION_COMMIT&apos;
        EXPORTING
          wait = &apos;X&apos;.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="28 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="BSART_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BSART" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="EINDT_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EINDT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="BEDAT_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BEDAT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="LIFNR_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIFNR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="PSTYP_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKPO-PSTYP" PARVALUE="&apos;!&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="WERKS_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="WERKS_D" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="LGORT_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LGORT_D" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="ABSGR_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABSGR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="I_EKPO_I" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="11 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKPO_TTY" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="12 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="EBELN_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="13 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="14 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_PEDIDO" SCONAME="I_ERRORES" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="15 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="WTY_RETURN_TAB"/>
  <source>METHOD copiar_pedido.
    DATA: l_tabla TYPE tabname,
          ekko    TYPE ekko,
          i_ekpo  TYPE TABLE OF ekpo,
          i_eket  TYPE TABLE OF eket,
          i_ekkn  TYPE TABLE OF ekkn,
          i_ekpa  TYPE TABLE OF ekpa,
          o_ped   TYPE REF TO zcl_ap_pedido_mm,
          eikp    TYPE eikp.

    FIELD-SYMBOLS: &lt;ekpo&gt;  TYPE ekpo,
                   &lt;eket&gt;  TYPE eket,
                   &lt;ekpa&gt;  TYPE ekpa,
                   &lt;ekkn&gt;  TYPE ekkn,
                   &lt;error&gt; TYPE bapiret2.

    l_tabla = &apos;EKKO&apos;.
    SELECT SINGLE * FROM (l_tabla)
      INTO ekko
     WHERE ebeln = ebeln.
    IF sy-subrc &lt;&gt; 0.
      __concat2 message &apos;No existe el pedido&apos;(nep) ebeln.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = message ).
      ENDIF.
      return.
    ENDIF.

    IF NOT i_ekpo_i IS INITIAL.
      i_ekpo = i_ekpo_i.
    ELSE.
      l_tabla = &apos;EKPO&apos;.
      SELECT * FROM (l_tabla)
        INTO TABLE i_ekpo
       WHERE ebeln = ebeln
         AND loekz = &apos;&apos;.
      IF sy-subrc &lt;&gt; 0.
        __concat3 message &apos;Pedido&apos;(ped) ebeln &apos;no tiene posiciones sin borrar&apos;(ntp).
        IF NOT o_log IS INITIAL.
          o_log-&gt;log( p1 = message ).
        ENDIF.
        return.
      ENDIF.

      LOOP AT i_ekpo ASSIGNING &lt;ekpo&gt;.
        CLEAR &lt;ekpo&gt;-ebeln.
        IF NOT werks_new IS INITIAL.
          IF &lt;ekpo&gt;-werks = &lt;ekpo&gt;-berid.
            &lt;ekpo&gt;-berid = werks_new.
          ENDIF.
          &lt;ekpo&gt;-werks = werks_new.
        ENDIF.
        IF NOT lgort_new IS INITIAL.
          &lt;ekpo&gt;-lgort = lgort_new.
        ENDIF.
        IF pstyp_new &lt;&gt; &apos;!&apos;.
          &lt;ekpo&gt;-pstyp = pstyp_new.
        ENDIF.

        CLEAR: &lt;ekpo&gt;-banfn,
               &lt;ekpo&gt;-bnfpo.
      ENDLOOP.
    ENDIF.

    l_tabla = &apos;EKET&apos;.
    SELECT * FROM (l_tabla)
      INTO TABLE i_eket
     WHERE ebeln = ebeln.

    IF NOT bsart_new IS INITIAL.
      ekko-bsart = bsart_new.
    ENDIF.

    DATA(l_lifnr) = ekko-lifnr.
    IF NOT lifnr_new IS INITIAL.
      ekko-lifnr = lifnr_new.
      IF ekko-lifre = l_lifnr.
        ekko-lifre = lifnr_new.
      ENDIF.
    ENDIF.

    IF NOT bedat_new IS INITIAL.
      ekko-bedat = bedat_new.
    ENDIF.

    IF NOT absgr_new IS INITIAL.
      ekko-absgr = absgr_new.
    ENDIF.

    IF NOT eindt_new IS INITIAL.
      LOOP AT i_eket ASSIGNING &lt;eket&gt;.
        CLEAR &lt;eket&gt;-ebeln.
        &lt;eket&gt;-eindt = eindt_new.
      ENDLOOP.
    ENDIF.

*    SELECT SINGLE * FROM eikp
*      INTO eikp
*     WHERE ebeln = ebeln.

    l_tabla = &apos;EKKN&apos;.
    SELECT * FROM (l_tabla)
      INTO TABLE i_ekkn
     WHERE ebeln = ebeln.

    l_tabla = &apos;EKPA&apos;.
    SELECT * FROM (l_tabla)
      INTO TABLE i_ekpa
     WHERE ebeln = ebeln.
    IF NOT lifnr_new IS INITIAL.
      LOOP AT i_ekpa ASSIGNING &lt;ekpa&gt; WHERE lifn2 = l_lifnr.
        &lt;ekpa&gt;-lifn2 = lifnr_new.
      ENDLOOP.
    ENDIF.

    CLEAR ekko-ebeln.

    LOOP AT i_ekkn ASSIGNING &lt;ekkn&gt;. CLEAR &lt;ekkn&gt;-ebeln. ENDLOOP.
    LOOP AT i_ekpa ASSIGNING &lt;ekpa&gt;. CLEAR &lt;ekpa&gt;-ebeln. ENDLOOP.
    o_ped = NEW #( ).
    ebeln_new = o_ped-&gt;crear_pedido( ekko   = ekko
                                     i_ekpo = i_ekpo
                                     i_eket = i_eket
                                     eikp   = eikp
                                     i_ekkn = i_ekkn
                                     i_ekpa = i_ekpa
                                     o_log  = o_log
                                     commit = commit ).

    LOOP AT o_ped-&gt;i_errores ASSIGNING &lt;error&gt; WHERE type = &apos;E&apos;.
      __concat_a message &lt;error&gt;-message.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="33 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="EBELP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="MATNR_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="MATNR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="MENGE_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="0"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="KONNR_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="KONNR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="KTPNR_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="KTPNR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="BORRAR_POS_ORIGEN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="EBELP_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="11 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="COPIAR_POSICION" SCONAME="I_ERRORES" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="12 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="WTY_RETURN_TAB"/>
  <source>METHOD copiar_posicion.
    DATA: l_tabla TYPE tabname,
          ekko    TYPE ekko,
          i_ekpo  TYPE TABLE OF ekpo,
          l_ekpo  TYPE ekpo,
          l_eket  TYPE eket,
          i_eket  TYPE TABLE OF eket,
          i_ekkn  TYPE TABLE OF ekkn,
          i_ekpa  TYPE TABLE OF ekpa,
          o_ped   TYPE REF TO zcl_ap_pedido_mm,
          eikp    TYPE eikp.

    FIELD-SYMBOLS: &lt;ekpo&gt;  TYPE ekpo,
                   &lt;ekkn&gt;  TYPE ekkn,
                   &lt;ekpa&gt;  TYPE ekpa,
                   &lt;error&gt; TYPE bapiret2.

    IF NOT matnr_new IS INITIAL.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = &apos;Copiamos posicion&apos;(cpo) p2 = ebelp p3 = &apos;a nueva posición con nuevo material&apos;(npm) p4 = matnr_new p5 = menge_new msgty = &apos;I&apos; ).
      ENDIF.
    ENDIF.

    l_tabla = &apos;EKKO&apos;.
    SELECT SINGLE * FROM (l_tabla)
      INTO ekko
     WHERE ebeln = ebeln.
    IF sy-subrc &lt;&gt; 0.
      __concat2 message &apos;No existe el pedido&apos;(nep) ebeln.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = message ).
      ENDIF.
      return.
    ENDIF.

    SELECT * FROM ekpo
      INTO TABLE i_ekpo
     WHERE ebeln = ebeln
       AND ebelp = ebelp.
*     AND loekz = &apos;&apos;.
    IF sy-subrc &lt;&gt; 0.
      __concat2 message &apos;No existe la posicion&apos;(nps) ebelp.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = message ).
      ENDIF.
      return.
    ENDIF.

    LOOP AT i_ekpo ASSIGNING &lt;ekpo&gt;.
      DATA(l_ekpo_orig) = &lt;ekpo&gt;.
      IF NOT matnr_new IS INITIAL.
        &lt;ekpo&gt;-matnr = matnr_new.
        &lt;ekpo&gt;-ematn = matnr_new.
        &lt;ekpo&gt;-txz01 = zcl_ap_material=&gt;get_descripcion( matnr_new ).
      ENDIF.
      IF NOT menge_new IS INITIAL.
        &lt;ekpo&gt;-menge = menge_new.
      ENDIF.
      SELECT MAX( ebelp ) FROM ekpo
        INTO ebelp_new
       WHERE ebeln = ebeln.
      ebelp_new = ebelp_new + 10.
      &lt;ekpo&gt;-ebelp = ebelp_new.
      CLEAR &lt;ekpo&gt;-loekz.
    ENDLOOP.

    IF borrar_pos_origen = &apos;X&apos; AND l_ekpo_orig-loekz &lt;&gt; &apos;L&apos;.
      l_ekpo_orig-loekz = &apos;L&apos;.
      APPEND l_ekpo_orig TO i_ekpo.
    ENDIF.

    IF NOT &lt;ekpo&gt; IS INITIAL.
      IF NOT matnr_new IS INITIAL OR NOT menge_new IS INITIAL.
        l_ekpo = &lt;ekpo&gt;.
        CLEAR &lt;ekpo&gt;.
        &lt;ekpo&gt;-ebeln = l_ekpo-ebeln.
        &lt;ekpo&gt;-ebelp = l_ekpo-ebelp.
        &lt;ekpo&gt;-matnr = l_ekpo-matnr.
        &lt;ekpo&gt;-menge = l_ekpo-menge.
        &lt;ekpo&gt;-meins = l_ekpo-meins.
        &lt;ekpo&gt;-werks = l_ekpo-werks.
        &lt;ekpo&gt;-lgort = l_ekpo-lgort.
      ENDIF.

      IF NOT konnr_new IS INITIAL.
        &lt;ekpo&gt;-konnr = konnr_new.
        &lt;ekpo&gt;-ktpnr = ktpnr_new.
      ENDIF.

      MOVE-CORRESPONDING &lt;ekpo&gt; TO l_eket.
      SELECT eindt FROM eket
        INTO l_eket-eindt
        UP TO 1 ROWS
       WHERE ebeln = ebeln
         AND ebelp = ebelp
        ORDER BY PRIMARY KEY.
      ENDSELECT.

      l_eket-etenr = &apos;0001&apos;.
      l_eket-ebelp = ebelp_new.
      APPEND l_eket TO i_eket.
    ENDIF.

    SELECT * FROM ekkn
      INTO TABLE i_ekkn
     WHERE ebeln = ebeln
       AND ebelp = ebelp.

    LOOP AT i_ekkn ASSIGNING &lt;ekkn&gt;.
      &lt;ekkn&gt;-ebelp = ebelp_new.
    ENDLOOP.

    l_tabla = &apos;EKPA&apos;.
    SELECT * FROM (l_tabla)
      INTO TABLE i_ekpa
     WHERE ebeln = ebeln
       AND ebelp = ebelp.
    LOOP AT i_ekpa ASSIGNING &lt;ekpa&gt;.
      &lt;ekpa&gt;-ebelp = ebelp_new.
    ENDLOOP.

    o_ped = NEW #( ).
    o_ped-&gt;modificar_pedido( ekko   = ekko
                             i_ekpo = i_ekpo
                             i_eket = i_eket
                             eikp   = eikp
                             i_ekkn = i_ekkn
                             i_ekpa = i_ekpa
                             o_log  = o_log
                             commit = commit ).

    LOOP AT o_ped-&gt;i_errores ASSIGNING &lt;error&gt; WHERE type = &apos;E&apos;.
      __concat_a message &lt;error&gt;-message.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="20 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="0" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="EKKO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="I_EKPO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKPO_TTY"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="I_EKET" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKET_TT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="EIKP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EIKP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="I_EKKN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TY_EKKN" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="I_EKPA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="MEOUT_T_EKPA" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="I_EKPV" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="MMPR_EKPV" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="NO_WARNINGS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="VERIFICAR_CANTIDADES" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="11 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="CREAR_PEDIDO" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="12 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="EBELN"/>
  <source>METHOD crear_pedido.
    DATA l_dif_ctd TYPE t_dif_ctd.

    FIELD-SYMBOLS &lt;ekpo&gt; TYPE ekpo.

    CLEAR: ebeln,
           message,
           i_dif_ctd.
    informar_tablas_bapi( ekko   = ekko
                          eikp   = eikp
                          i_ekpo = i_ekpo
                          i_eket = i_eket
                          i_ekkn = i_ekkn
                          i_ekpa = i_ekpa
                          i_ekpv = i_ekpv ).

    CALL FUNCTION &apos;BAPI_PO_CREATE1&apos;
      EXPORTING
        poheader         = poheader
        poheaderx        = poheaderx
*       POADDRVENDOR     =
*       TESTRUN          =
*       MEMORY_UNCOMPLETE =
*       MEMORY_COMPLETE  =
        poexpimpheader   = impheader
        poexpimpheaderx  = impheaderx
*       VERSIONS         =
*       NO_MESSAGING     =
*       NO_MESSAGE_REQ   =
*       NO_AUTHORITY     =
*       NO_PRICE_FROM_PO =
      IMPORTING
        exppurchaseorder = ebeln
*       EXPHEADER        =
*       EXPPOEXPIMPHEADER =
      TABLES
        return           = i_errores
        poitem           = i_poitem
        poitemx          = i_poitemx
        poaddrdelivery   = i_address
        pocond           = i_pocond
        pocondx          = i_pocondx
        poschedule       = i_schedule
        poschedulex      = i_schedulex
        poaccount        = i_account
        poaccountx       = i_accountx
        poshipping       = i_shipping
        poshippingx      = i_shippingx
        popartner        = i_partners.

    IF NOT ebeln IS INITIAL.
      IF NOT verificar_cantidades IS INITIAL.
        LOOP AT i_ekpo ASSIGNING &lt;ekpo&gt;.
          READ TABLE i_poitem INTO poitem WITH KEY po_item = &lt;ekpo&gt;-ebelp.
          IF sy-subrc = 0.
            IF &lt;ekpo&gt;-meins &lt;&gt; poitem-po_unit.
*            poitem-quantity = zcl_ap_material=&gt;convertir_unidad( matnr = &lt;ekpo&gt;-matnr unidad_origen = poitem-po_unit unidad_destino = &lt;ekpo&gt;-meins cantidad = poitem-quantity ).
              DATA(l_menge) = zcl_ap_material=&gt;convertir_unidad( matnr          = &lt;ekpo&gt;-matnr
                                                                 unidad_origen  = &lt;ekpo&gt;-meins
                                                                 unidad_destino = poitem-po_unit
                                                                 cantidad       = &lt;ekpo&gt;-menge ).
              DATA(l_meins) = poitem-po_unit.
            ELSE.
              l_menge = &lt;ekpo&gt;-menge.
              l_meins = &lt;ekpo&gt;-meins.
            ENDIF.
            IF l_menge &lt;&gt; poitem-quantity.
* Verificamos si el registro info tiene perfil de redondeo y si es así ignoramos la diferencia
              SELECT rdprf FROM  eine JOIN eina ON eine~infnr = eina~infnr
                INTO @DATA(l_rdprf)
                UP TO 1 ROWS
               WHERE matnr      = @&lt;ekpo&gt;-matnr
                 AND lifnr      = @ekko-lifnr
                 AND eina~loekz = &apos;&apos;
                 AND eine~loekz = &apos;&apos;
                 AND ekorg      = @ekko-ekorg
                 AND esokz      = &apos;0&apos;
                 AND werks      = @&lt;ekpo&gt;-werks.
              ENDSELECT.
              IF sy-subrc = 0 AND NOT l_rdprf IS INITIAL.
                CONTINUE.
              ENDIF.

              CLEAR l_dif_ctd.
              l_dif_ctd-ebelp    = &lt;ekpo&gt;-ebelp.
              l_dif_ctd-menge_ok = l_menge.
              l_dif_ctd-menge_bd = poitem-quantity.
              l_dif_ctd-meins    = l_meins.
              APPEND l_dif_ctd TO i_dif_ctd.
            ENDIF.
          ELSE.
            CLEAR l_dif_ctd.
            l_dif_ctd-ebelp    = &lt;ekpo&gt;-ebelp.
            l_dif_ctd-menge_ok = &lt;ekpo&gt;-menge.
            l_dif_ctd-meins    = &lt;ekpo&gt;-meins.
            APPEND l_dif_ctd TO i_dif_ctd.
          ENDIF.
        ENDLOOP.
      ENDIF.

      IF commit = &apos;X&apos;.
        zcl_ap_dev=&gt;commit( ).
      ENDIF.
    ELSE.
      CALL FUNCTION &apos;DEQUEUE_ALL&apos;.
    ENDIF.

* Borramos mensaje de ampliación
    DELETE i_errores WHERE type = &apos;W&apos; AND message CS &apos;CI_EK&apos;.
    DELETE i_errores WHERE message = &apos;No se ha creado ninguna instancia de tipo objeto PurchaseOrder; ref.externa:&apos;(nrf).
    DELETE i_errores WHERE message CS &apos;ME_PROCESS_PO_CUST&apos;.

    LOOP AT i_errores INTO bapiret2 WHERE type = &apos;E&apos;.
      __add_lista message bapiret2-message.
    ENDLOOP.

    IF NOT i_dif_ctd IS INITIAL.
      bapiret2-type    = &apos;E&apos;.
      bapiret2-message = &apos;Existen diferencias en cantidades creadas&apos;(edc).
      APPEND bapiret2 TO i_errores.
    ENDIF.

    IF NOT o_log IS INITIAL.
      IF no_warnings = &apos;X&apos;.
        DELETE i_errores WHERE type = &apos;W&apos;.
      ENDIF.
      o_log-&gt;set_tabla_log_from_bapiret2_t( i_errores ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ESPERA_SI_BLOQUEADO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="35 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ESPERA_SI_BLOQUEADO" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ESPERA_SI_BLOQUEADO" SCONAME="SEGUNDOS_ESPERA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="INT2" PARVALUE="10"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ESPERA_SI_BLOQUEADO" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD espera_si_bloqueado.
    DATA bloqueado TYPE c LENGTH 1.

    DO segundos_espera TIMES.
      bloqueado = esta_bloqueado( ebeln ).
      IF bloqueado = &apos;X&apos;.
        __concat4 message &apos;Pedido&apos; ebeln &apos;bloqueado por&apos; sy-msgv1.
        WAIT UP TO 1 SECONDS.
      ELSE.
        CLEAR message.
        EXIT.
      ENDIF.
    ENDDO.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ESTA_BLOQUEADO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="34 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ESTA_BLOQUEADO" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ESTA_BLOQUEADO" SCONAME="BORRAR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ESTA_BLOQUEADO" SCONAME="BLOQUEADO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ABAP_BOOL"/>
  <source>METHOD esta_bloqueado.
    bloqueado = zcl_ap_utils=&gt;comprobar_bloqueo( tabla  = &apos;EKKO&apos;
                                                 clave  = sy-mandt
                                                 clave2 = ebeln
                                                 borrar = borrar ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ES_BORRADO" VERSION="1" LANGU="S" DESCRIPT="¿El pedido está borrado?" EXPOSURE="2" STATE="1" EDITORDER="6 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ES_BORRADO" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ES_BORRADO" SCONAME="BORRADO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ABAP_BOOL"/>
  <source>METHOD es_borrado.
    &quot; TODO: variable is assigned but never used (ABAP cleaner)
    DATA l_ebeln TYPE ebeln.

    borrado = &apos;X&apos;.
    SELECT SINGLE ebeln FROM ekpo
      INTO l_ebeln
     WHERE ebeln = ebeln
       AND loekz = &apos;&apos;.
    IF sy-subrc = 0.
      CLEAR borrado.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ES_LIBERADO_COD" VERSION="1" LANGU="S" DESCRIPT="Pedido está liberado" EXPOSURE="2" STATE="1" EDITORDER="16 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ES_LIBERADO_COD" SCONAME="T_COD" VERSION="1" LANGU="S" DESCRIPT="Tipo tabla estrategias ficticas" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ZTAB_COD"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="ES_LIBERADO_COD" SCONAME="LIBERADO" VERSION="1" LANGU="S" DESCRIPT="Texto, longitud 80" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ABAP_BOOL"/>
  <source>METHOD es_liberado_cod.
    DATA l_cod TYPE zest_cod.

    CLEAR liberado.
    DESCRIBE TABLE t_cod LINES sy-tfill.
    IF sy-tfill &lt;= 0.
      RETURN.
    ENDIF.

    READ TABLE t_cod INTO l_cod INDEX sy-tfill.
    liberado = l_cod-liberada.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ADJUNTOS" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="37 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ADJUNTOS" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ADJUNTOS" SCONAME="I_ADJ" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="ZCL_AP_GOS=&gt;TT_ADJ"/>
  <source>METHOD get_adjuntos.
    zcl_ap_gos=&gt;get_file_list( EXPORTING typeid       = c_objeto
                                         instid       = ebeln
                                         get_adj_mail = &apos;X&apos;
                               CHANGING  i_adj        = i_adj ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_DATOS_PEDIDO_FROM_OBJETO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="30 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_DATOS_PEDIDO_FROM_OBJETO" SCONAME="IM_HEADER" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="IF_PURCHASE_ORDER_MM"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_DATOS_PEDIDO_FROM_OBJETO" SCONAME="GET_XEKPO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_DATOS_PEDIDO_FROM_OBJETO" SCONAME="EKKO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_DATOS_PEDIDO_FROM_OBJETO" SCONAME="I_EKPO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="ME_EKPO"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_DATOS_PEDIDO_FROM_OBJETO" SCONAME="I_EKPV" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="MMPR_EKPV"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_DATOS_PEDIDO_FROM_OBJETO" SCONAME="XEKPO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="MMPR_UEKPO"/>
  <source>METHOD get_datos_pedido_from_objeto.
    DATA: header    TYPE mepoheader,
          items     TYPE purchase_order_items,
          line_item TYPE purchase_order_item,
          po_line   TYPE mepoitem,
          l_ekpo    TYPE ekpo,
          l_uekpo   TYPE uekpo,
          l_ekpv    TYPE ekpv.

    header = im_header-&gt;get_data( ).
    MOVE-CORRESPONDING header TO ekko.

    items = im_header-&gt;get_items( ).
    LOOP AT items INTO line_item.
      po_line = line_item-item-&gt;get_data( ).
      MOVE-CORRESPONDING po_line TO l_ekpo.
      APPEND l_ekpo TO i_ekpo.
      IF get_xekpo = &apos;X&apos;.
        MOVE-CORRESPONDING l_ekpo TO l_uekpo.
        APPEND l_uekpo TO xekpo.
      ENDIF.

      l_ekpv = line_item-item-&gt;get_shipping_data( ).
      IF NOT l_ekpv IS INITIAL.
        APPEND l_ekpv TO i_ekpv.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ENTREGA" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="31 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ENTREGA" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN" PAROPTIONL="X" PARPREFERD="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ENTREGA" SCONAME="EBELP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ENTREGA" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="VBELN_VL"/>
  <source>METHOD get_entrega.
    DATA: i_vbeln TYPE TABLE OF vbeln_vl,
          l_vbeln TYPE vbeln_vl.

    IF ebelp IS INITIAL.
      SELECT DISTINCT belnr FROM ekbe
        INTO TABLE i_vbeln
       WHERE ebeln = ebeln
         AND vgabe = &apos;8&apos;
         AND bewtp = &apos;L&apos;
      ORDER BY belnr.
    ELSE.
      SELECT DISTINCT belnr FROM ekbe
        INTO TABLE i_vbeln
       WHERE ebeln = ebeln
         AND ebelp = ebelp
         AND vgabe = &apos;8&apos;
         AND bewtp = &apos;L&apos;
       ORDER BY belnr.
    ENDIF.

    LOOP AT i_vbeln INTO l_vbeln.
      SELECT SINGLE vbeln FROM likp
        INTO l_vbeln
       WHERE vbeln = l_vbeln.
      IF sy-subrc = 0.
        vbeln = l_vbeln.
        EXIT.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ERROR_FORMATEADO" VERSION="1" LANGU="S" DESCRIPT="Devuelve texto de error" EXPOSURE="2" STATE="1" EDITORDER="12 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="0" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ERROR_FORMATEADO" SCONAME="MESSAGE" VERSION="1" LANGU="S" DESCRIPT="Texto de mensaje" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRETURN1-MESSAGE"/>
  <source>METHOD get_error_formateado.
    DATA l_error TYPE bapiret2.
    DATA l_cont  TYPE i.

    CLEAR message.
    LOOP AT i_errores INTO l_error WHERE id = &apos;06&apos; AND number = &apos;022&apos;.
      l_error-type = &apos;E&apos;.
      MODIFY i_errores FROM l_error.
    ENDLOOP.

    LOOP AT i_errores TRANSPORTING NO FIELDS WHERE type = &apos;E&apos;.
      l_cont = l_cont + 1.
    ENDLOOP.
    IF l_cont &gt; 1.
      DELETE i_errores WHERE id = &apos;BAPI&apos;.
    ENDIF.

    LOOP AT i_errores INTO l_error WHERE type = &apos;E&apos;.
      IF message IS INITIAL.
        message = l_error-message.
      ELSE.
        CONCATENATE message &apos;,&apos; INTO message.
        CONCATENATE message l_error-message INTO message
                    SEPARATED BY space.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ESTADO_LIBERACION" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="3 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ESTADO_LIBERACION" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ESTADO_LIBERACION" SCONAME="ESTADO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="CHAR1"/>
  <source>METHOD get_estado_liberacion.
    DATA ekko TYPE ekko.

    SELECT SINGLE frggr frgsx frgke frgzu frgrl FROM ekko
    INTO CORRESPONDING FIELDS OF ekko
    WHERE ebeln = ebeln.

    IF ekko-frggr IS INITIAL. &quot; No hay estrategia
      estado = &apos;S&apos;. &quot; SIN ESTRATEGIA DE LIBERACION
    ELSE.
      IF ekko-frgrl = &apos;X&apos;. &quot; Liberación incompleta
        IF ekko-frgzu IS INITIAL. &quot; No se ha efectuado ningún paso de liberación
          estado = &apos;I&apos;. &quot; LIBERACION NO INICIADA
        ELSE.
          estado = &apos;P&apos;. &quot; LIBERACION PARCIAL
        ENDIF.
      ELSE.
        estado = &apos;L&apos;. &quot; LIBERADO
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ESTRATEGIAS" VERSION="1" LANGU="S" DESCRIPT="Devuelve las estrategias reales" EXPOSURE="2" STATE="1" EDITORDER="8 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ESTRATEGIAS" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO-EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ESTRATEGIAS" SCONAME="INFO_USUARIOS" VERSION="1" LANGU="S" DESCRIPT="Información usuarios de liberación" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_ESTRATEGIAS" SCONAME="T_COD" VERSION="1" LANGU="S" DESCRIPT="Tipo tabla estrategias ficticas" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ZTAB_COD"/>
  <source>METHOD get_estrategias.
    DATA: l_relp TYPE bapirlcopo,
          i_rel  TYPE TABLE OF bapirlcopo,
          l_rel  TYPE bapirlcopo,
          l_cod  TYPE zest_cod.
    DATA: i_cdpos TYPE iscdpos_tab,
          l_cdpos TYPE iscdpos,
          l_ind   TYPE i,
          l_lib   TYPE c LENGTH 10.

    CALL FUNCTION &apos;BAPI_PO_GETRELINFO&apos;
      EXPORTING
        purchaseorder          = ebeln
*       PO_REL_CODE            =
      IMPORTING
*       GENERAL_RELEASE_INFO   =
*       RELEASE_PREREQUISITES  =
        release_already_posted = l_relp
      TABLES
        release_final          = i_rel.
*       RETURN                 =

    DEFINE get_rel.
      CLEAR l_cod.
      IF NOT l_rel-rel_code&amp;1 IS INITIAL.
        l_cod-frgco = l_rel-rel_code&amp;1.
        IF NOT l_relp-rel_code&amp;1 IS INITIAL.
          l_cod-liberada = &apos;X&apos;.
        ENDIF.
        APPEND l_cod TO t_cod.
      ENDIF.
    END-OF-DEFINITION.

    LOOP AT i_rel INTO l_rel.
      get_rel: 1, 2, 3, 4, 5, 6, 7, 8.
    ENDLOOP.

    IF info_usuarios = &apos;X&apos;.
      i_cdpos =
       zcl_ap_control_cambios=&gt;get_cdpos( objectclas = c_objectclas
                                          objectid   = ebeln
                                          tabname    = &apos;EKKO&apos;
                                          fname      = &apos;FRGZU&apos; ).
      CLEAR l_cdpos.
      LOOP AT t_cod INTO l_cod WHERE liberada = &apos;X&apos;.
        l_ind = sy-tabix.
        CLEAR l_lib.
        DO l_ind TIMES.
          CONCATENATE &apos;X&apos; l_lib INTO l_lib.
        ENDDO.
        READ TABLE i_cdpos INTO l_cdpos WITH KEY value_new = l_lib.
        IF sy-subrc = 0.
          l_cod-liberado_por = l_cdpos-username.
          l_cod-liberado_el  = l_cdpos-udate.
          l_cod-liberado_a   = l_cdpos-utime.
          MODIFY t_cod FROM l_cod.
        ENDIF.
      ENDLOOP.

    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="26 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="TODAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="MOSTRAR_ULT_LIB" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="ULT_LIB" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRLCORQ-REL_CODE1"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="ULT_LIB_DESC" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRLCORQ-REL_CD_TX1"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="SIG_LIB" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRLCORQ-REL_CODE1"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="SIG_LIB_DESC" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRLCORQ-REL_CD_TX1"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="FECHA_ULT_LIB" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="DATS"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="HORA_ULT_LIB" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="TIMS"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="USUARIO_ULT_LIB" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="SY-UNAME"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="LIBERADO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="11 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="REL_INFO_GEN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="12 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_REL_INFO_GEN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="REL_PREREQUISITES" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="13 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_REL_PREREQUISITES"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="REL_POSTED" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="14 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_REL_POSTED"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_INFO_LIB" SCONAME="REL_FINAL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="15 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_REL_FINAL"/>
  <source>METHOD get_info_lib.
    DATA l_ekko TYPE ekko.
    DATA: l_cdhdr TYPE cdhdr,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_cdpos TYPE cdpos.

    FIELD-SYMBOLS: &lt;info_gen&gt;   TYPE bapirlgnrq,
                   &lt;rel_posted&gt; TYPE bapirlcorq.

    CLEAR: liberado,
           ult_lib,
           sig_lib,
           fecha_ult_lib,
           usuario_ult_lib,
           ult_lib_desc,
           sig_lib_desc,
           rel_info_gen,
           rel_prerequisites,
           rel_posted,
           rel_final.

    SELECT SINGLE frggr frgke frgsx frgzu FROM ekko
      INTO CORRESPONDING FIELDS OF l_ekko
     WHERE ebeln = ebeln.
    IF sy-subrc &lt;&gt; 0.
      RETURN.
    ENDIF.

    IF todas = &apos;X&apos;.
      CLEAR l_ekko-frgzu.
    ENDIF.

    REFRESH rel_info_gen.
    CLEAR rel_info_gen.
    CALL FUNCTION &apos;ME_REL_INFO&apos;
      EXPORTING
*       I_TITLE           = &apos; &apos;
*       I_FRGCO           = l_ekko-frgco
        i_frgkz           = l_ekko-frgke
        i_frggr           = l_ekko-frggr
        i_frgst           = l_ekko-frgsx
        i_frgzu           = l_ekko-frgzu
        i_frgot           = &apos;2&apos;
        i_no_dialog       = &apos;2&apos;
*       I_SUBSCREEN       = &apos; &apos;
      TABLES
        rel_info_gen      = rel_info_gen
        rel_prerequisites = rel_prerequisites
        rel_posted        = rel_posted
        rel_final         = rel_final
      EXCEPTIONS
        not_active        = 1
        OTHERS            = 2.
    IF sy-subrc = 0.
      ASSIGN rel_info_gen[ 1 ] TO &lt;info_gen&gt;.
      IF sy-subrc = 0.
        IF    &lt;info_gen&gt;-rel_ind = &apos;L&apos; &quot; Liberado
           OR (     &lt;info_gen&gt;-rel_ind   IS INITIAL
                AND &lt;info_gen&gt;-rel_group IS INITIAL
                AND &lt;info_gen&gt;-rel_strat IS INITIAL
                AND &lt;info_gen&gt;-rel_code  IS INITIAL ).
          liberado = &apos;X&apos;.
        ENDIF.
      ELSE.
        liberado = &apos;X&apos;.
      ENDIF.
    ENDIF.

    ASSIGN rel_posted[ 1 ] TO &lt;rel_posted&gt;.
    IF sy-subrc = 0.
      IF NOT &lt;rel_posted&gt;-rel_code8 IS INITIAL.  &quot;#EC PREFER_CASE
        ult_lib = &lt;rel_posted&gt;-rel_code8.
        ult_lib_desc = &lt;rel_posted&gt;-rel_cd_tx8.
      ELSEIF NOT &lt;rel_posted&gt;-rel_code7 IS INITIAL.
        ult_lib = &lt;rel_posted&gt;-rel_code7.
        ult_lib_desc = &lt;rel_posted&gt;-rel_cd_tx7.
      ELSEIF NOT &lt;rel_posted&gt;-rel_code6 IS INITIAL.
        ult_lib = &lt;rel_posted&gt;-rel_code6.
        ult_lib_desc = &lt;rel_posted&gt;-rel_cd_tx6.
      ELSEIF NOT &lt;rel_posted&gt;-rel_code5 IS INITIAL.
        ult_lib = &lt;rel_posted&gt;-rel_code5.
        ult_lib_desc = &lt;rel_posted&gt;-rel_cd_tx5.
      ELSEIF NOT &lt;rel_posted&gt;-rel_code4 IS INITIAL.
        ult_lib = &lt;rel_posted&gt;-rel_code4.
        ult_lib_desc = &lt;rel_posted&gt;-rel_cd_tx4.
      ELSEIF NOT &lt;rel_posted&gt;-rel_code3 IS INITIAL.
        ult_lib = &lt;rel_posted&gt;-rel_code3.
        ult_lib_desc = &lt;rel_posted&gt;-rel_cd_tx3.
      ELSEIF NOT &lt;rel_posted&gt;-rel_code2 IS INITIAL.
        ult_lib = &lt;rel_posted&gt;-rel_code2.
        ult_lib_desc = &lt;rel_posted&gt;-rel_cd_tx2.
      ELSEIF NOT &lt;rel_posted&gt;-rel_code1 IS INITIAL.
        ult_lib = &lt;rel_posted&gt;-rel_code1.
        ult_lib_desc = &lt;rel_posted&gt;-rel_cd_tx1.
      ENDIF.
    ENDIF.

    ASSIGN rel_final[ 1 ] TO FIELD-SYMBOL(&lt;rel_final&gt;).
    IF sy-subrc = 0.
      IF ult_lib IS INITIAL.
        sig_lib = &lt;rel_final&gt;-rel_code1.
        sig_lib_desc = &lt;rel_final&gt;-rel_cd_tx1.
      ELSEIF &lt;rel_final&gt;-rel_code1 = ult_lib.
        sig_lib = &lt;rel_final&gt;-rel_code2.
        sig_lib_desc = &lt;rel_final&gt;-rel_cd_tx2.
      ELSEIF &lt;rel_final&gt;-rel_code2 = ult_lib.
        sig_lib = &lt;rel_final&gt;-rel_code3.
        sig_lib_desc = &lt;rel_final&gt;-rel_cd_tx3.
      ELSEIF &lt;rel_final&gt;-rel_code3 = ult_lib.
        sig_lib = &lt;rel_final&gt;-rel_code4.
        sig_lib_desc = &lt;rel_final&gt;-rel_cd_tx4.
      ELSEIF &lt;rel_final&gt;-rel_code4 = ult_lib.
        sig_lib = &lt;rel_final&gt;-rel_code5.
        sig_lib_desc = &lt;rel_final&gt;-rel_cd_tx5.
      ELSEIF &lt;rel_final&gt;-rel_code5 = ult_lib.
        sig_lib = &lt;rel_final&gt;-rel_code6.
        sig_lib_desc = &lt;rel_final&gt;-rel_cd_tx6.
      ELSEIF &lt;rel_final&gt;-rel_code6 = ult_lib.
        sig_lib = &lt;rel_final&gt;-rel_code7.
        sig_lib_desc = &lt;rel_final&gt;-rel_cd_tx7.
      ELSEIF &lt;rel_final&gt;-rel_code7 = ult_lib.
        sig_lib = &lt;rel_final&gt;-rel_code8.
        sig_lib_desc = &lt;rel_final&gt;-rel_cd_tx8.
      ENDIF.
    ENDIF.

    IF NOT mostrar_ult_lib IS INITIAL.
      IF NOT ult_lib IS INITIAL.
        SELECT * FROM  cdhdr
          INTO l_cdhdr
         WHERE objectclas = &apos;EINKBELEG&apos;
           AND objectid   = ebeln
         ORDER BY udate ASCENDING
                  utime ASCENDING.
          SELECT objectclas FROM  cdpos
            INTO l_cdpos-objectclas
                 WHERE objectclas = l_cdhdr-objectclas
                   AND objectid   = l_cdhdr-objectid
                   AND changenr   = l_cdhdr-changenr
                   AND tabname    = &apos;EKKO&apos;
                   AND fname      = &apos;FRGZU&apos;
                   AND chngind    = &apos;U&apos;
           ORDER BY PRIMARY KEY.
            fecha_ult_lib   = l_cdhdr-udate.
            hora_ult_lib    = l_cdhdr-utime.
            usuario_ult_lib = l_cdhdr-username.
            EXIT.                                  &quot;#EC CI_EXIT_SELECT.
          ENDSELECT.
        ENDSELECT.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_STATUS_HEADER" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="38 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_STATUS_HEADER" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_STATUS_HEADER" SCONAME="STATUS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="MEPO_STATUS"/>
  <source>METHOD get_status_header.
    DATA: gr_po      TYPE REF TO cl_po_header_handle_mm,
          l_document TYPE mepo_document,
          l_result   TYPE mmpur_bool.

    CLEAR status.

    gr_po = NEW #( ).

    l_document-doc_type    = &apos;F&apos;.
    l_document-process     = &apos;PO_PROCESS&apos;.
    l_document-trtyp       = &apos;A&apos;.
    l_document-doc_key(10) = ebeln.

    gr_po-&gt;po_initialize( im_document = l_document ).

    gr_po-&gt;po_read( EXPORTING im_tcode     = &apos;ME23N&apos;
                              im_trtyp     = l_document-trtyp
                              im_aktyp     = l_document-trtyp
                              im_po_number = l_document-doc_key(10)
                              im_document  = l_document
                    IMPORTING ex_result    = l_result ).

    IF l_result &lt;&gt; mmpur_yes.
      RETURN.
    ENDIF.

    PERFORM get_status_header IN PROGRAM saplmepo
            CHANGING status.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO" VERSION="1" LANGU="S" DESCRIPT="Recupera texto pedido" EXPOSURE="2" STATE="1" EDITORDER="9 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO" SCONAME="EBELP" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO" SCONAME="ID" VERSION="1" LANGU="S" DESCRIPT="ID de texto" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STXH-TDID"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO" SCONAME="SPRAS" VERSION="1" LANGU="S" DESCRIPT="Clave de idioma" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STXH-TDSPRAS" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO" SCONAME="LINEAS" VERSION="1" LANGU="S" DESCRIPT="Tipo tabla tline" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="OIJ_TLINE"/>
  <source>METHOD get_texto.
    DATA l_name TYPE stxh-tdname.

    IF ebelp IS INITIAL.
      l_name = ebeln.
      lineas = zcl_ap_textos=&gt;get_texto( id     = id
                                         name   = l_name
                                         spras  = spras
                                         object = &apos;EKKO&apos; ).
    ELSE.
      CONCATENATE ebeln ebelp INTO l_name.
      lineas = zcl_ap_textos=&gt;get_texto( id     = id
                                         name   = l_name
                                         spras  = spras
                                         object = &apos;EKPO&apos; ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO_STRING" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="22 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO_STRING" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO_STRING" SCONAME="EBELP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO_STRING" SCONAME="ID" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STXH-TDID"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO_STRING" SCONAME="SPRAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STXH-TDSPRAS" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_TEXTO_STRING" SCONAME="STRING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="STRING"/>
  <source>METHOD get_texto_string.
    DATA l_name TYPE stxh-tdname.

    IF ebelp IS INITIAL.
      l_name = ebeln.
      string = zcl_ap_textos=&gt;get_texto_string( id     = id
                                                name   = l_name
                                                spras  = spras
                                                object = &apos;EKKO&apos; ).
    ELSE.
      CONCATENATE ebeln ebelp INTO l_name.
      string = zcl_ap_textos=&gt;get_texto_string( id     = id
                                                name   = l_name
                                                spras  = spras
                                                object = &apos;EKPO&apos; ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_URL_POR_TITULO_ST" VERSION="1" LANGU="S" DESCRIPT="Devuelve URL por tipo adjunto" EXPOSURE="2" STATE="1" EDITORDER="5 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO-EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="TITULO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="URL" VERSION="1" LANGU="S" DESCRIPT="Documentos URL GOS" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="STRING"/>
  <source>METHOD get_url_por_titulo_st.
    DATA l_clave TYPE srgbtbrel-instid_a.

    l_clave = ebeln.
    url = zcl_ap_gos=&gt;get_url_por_titulo_st( tipo   = &apos;BUS2012&apos;
                                             clave  = l_clave
                                             titulo = titulo ).
    IF url IS INITIAL.
      url = zcl_ap_gos=&gt;get_url_por_titulo_st( tipo   = &apos;BUS2014&apos;
                                               clave  = l_clave
                                               titulo = titulo ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_CONDICION" VERSION="1" LANGU="S" DESCRIPT="Devuelve el valor de la condición" EXPOSURE="2" STATE="1" EDITORDER="18 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_CONDICION" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Factura" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKPO-EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_CONDICION" SCONAME="EBELP" VERSION="1" LANGU="S" DESCRIPT="Posición de factura" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKPO-EBELP"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_CONDICION" SCONAME="KSCHL" VERSION="1" LANGU="S" DESCRIPT="Clase de condición" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="KSCHL"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_CONDICION" SCONAME="CAMPO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING" PARVALUE="&apos;KWERT&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_CONDICION" SCONAME="VALOR" VERSION="1" LANGU="S" DESCRIPT="Valor de la condición" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="KOMV-KWERT"/>
  <source>METHOD get_valor_condicion.
    FIELD-SYMBOLS &lt;valor&gt; TYPE any.

    DATA: r_kposn TYPE RANGE OF konv-kposn,
          l_knumv TYPE ekko-knumv,
          l_kposn LIKE LINE OF r_kposn,
          i_konv  TYPE TABLE OF konv,
          l_campo TYPE string,
          l_konv  TYPE konv,
          l_tabla TYPE tabname     VALUE &apos;KONV&apos;.

    SELECT SINGLE knumv FROM ekko
      INTO l_knumv
     WHERE ebeln = ebeln.
    IF sy-subrc &lt;&gt; 0.
      RETURN.
    ENDIF.

    IF NOT ebelp IS INITIAL.
      l_kposn-option = &apos;EQ&apos;.
      l_kposn-sign   = &apos;I&apos;.
      l_kposn-low    = ebelp.
      APPEND l_kposn TO r_kposn.
    ENDIF.

    IF zcl_c=&gt;hana = &apos;X&apos;.
      l_tabla = &apos;V_KONV_CDS&apos;.
    ENDIF.

    SELECT * FROM (l_tabla)
      INTO CORRESPONDING FIELDS OF TABLE i_konv
     WHERE knumv  = l_knumv
       AND kposn IN r_kposn
       AND kschl  = kschl
     ORDER BY PRIMARY KEY.

    CONCATENATE &apos;L_KONV-&apos; campo INTO l_campo.
    ASSIGN (l_campo) TO &lt;valor&gt;.
    IF sy-subrc = 0.
      LOOP AT i_konv INTO l_konv.
        valor = valor + &lt;valor&gt;.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_ENTREGAS" VERSION="1" LANGU="S" DESCRIPT="Devuelve el valor de las entregas" EXPOSURE="2" STATE="1" EDITORDER="15 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_ENTREGAS" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_ENTREGAS" SCONAME="EBELP" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_ENTREGAS" SCONAME="CANTIDAD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_ENTREGAS" SCONAME="VALOR" VERSION="1" LANGU="S" DESCRIPT="Arrastre de saldos en moneda de transacción" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="TSLVT"/>
  <source>METHOD get_valor_entregas.
    valor = get_valor_historial( ebeln    = ebeln
                                 ebelp    = ebelp
                                 bewtp    = c_hist_entrega
                                 cantidad = cantidad ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_FACTURAS" VERSION="1" LANGU="S" DESCRIPT="Devuelve el valor de las facturas" EXPOSURE="2" STATE="1" EDITORDER="14 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_FACTURAS" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_FACTURAS" SCONAME="EBELP" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_FACTURAS" SCONAME="CANTIDAD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_FACTURAS" SCONAME="VALOR" VERSION="1" LANGU="S" DESCRIPT="Arrastre de saldos en moneda de transacción" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="TSLVT"/>
  <source>METHOD get_valor_facturas.
    valor = get_valor_historial( ebeln    = ebeln
                                 ebelp    = ebelp
                                 bewtp    = c_hist_factura
                                 cantidad = cantidad  ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_HISTORIAL" VERSION="1" LANGU="S" DESCRIPT="Devuelve el valor del historial" EXPOSURE="2" STATE="1" EDITORDER="13 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_HISTORIAL" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_HISTORIAL" SCONAME="EBELP" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_HISTORIAL" SCONAME="BEWTP" VERSION="1" LANGU="S" DESCRIPT="Tipo de historial de pedido" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BEWTP"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_HISTORIAL" SCONAME="CANTIDAD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_HISTORIAL" SCONAME="VALOR" VERSION="1" LANGU="S" DESCRIPT="Arrastre de saldos en moneda de transacción" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="TSLVT"/>
  <source>METHOD get_valor_historial.
    TYPES: BEGIN OF t_ekbe,
             wrbtr TYPE ekbe-wrbtr,
             menge TYPE ekbe-menge,
             shkzg TYPE ekbe-shkzg,
           END OF t_ekbe.

    DATA: i_ekbe TYPE TABLE OF ekbe,
          l_ekbe TYPE ekbe.

    CLEAR valor.

    IF ebelp IS INITIAL.
      SELECT dmbtr menge shkzg FROM ekbe
        INTO CORRESPONDING FIELDS OF TABLE i_ekbe
       WHERE ebeln = ebeln
         AND bewtp = bewtp.
    ELSE.
      SELECT dmbtr menge shkzg FROM ekbe
        INTO CORRESPONDING FIELDS OF TABLE i_ekbe
       WHERE ebeln = ebeln
         AND ebelp = ebelp
         AND bewtp = bewtp.
    ENDIF.

    LOOP AT i_ekbe INTO l_ekbe.
      IF l_ekbe-shkzg = &apos;S&apos;.
        IF cantidad IS INITIAL.
          valor = valor + l_ekbe-dmbtr.
        ELSE.
          valor = valor + l_ekbe-menge.
        ENDIF.
      ELSE.
        IF cantidad IS INITIAL.
          valor = valor - l_ekbe-dmbtr.
        ELSE.
          valor = valor - l_ekbe-menge.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_SALIDAS" VERSION="1" LANGU="S" DESCRIPT="Devuelve el valor de las salidas" EXPOSURE="2" STATE="1" EDITORDER="19 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_SALIDAS" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_SALIDAS" SCONAME="EBELP" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_SALIDAS" SCONAME="CANTIDAD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="GET_VALOR_SALIDAS" SCONAME="VALOR" VERSION="1" LANGU="S" DESCRIPT="Arrastre de saldos en moneda de transacción" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="TSLVT"/>
  <source>METHOD get_valor_salidas.
    valor = get_valor_historial( ebeln    = ebeln
                                 ebelp    = ebelp
                                 bewtp    = c_hist_salidas
                                 cantidad = cantidad ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" VERSION="1" LANGU="S" EXPOSURE="0" STATE="1" EDITORDER="1 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="0" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" SCONAME="EKKO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" SCONAME="I_EKPO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKPO_TTY" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" SCONAME="I_EKET" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKET_TT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" SCONAME="EIKP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EIKP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" SCONAME="I_EKKN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TY_EKKN" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" SCONAME="I_EKPA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="MEOUT_T_EKPA" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" SCONAME="I_KONV" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TAB_KONV" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" SCONAME="I_EKPV" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="MMPR_EKPV" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INFORMAR_TABLAS_BAPI" SCONAME="CAMPOS_USUARIO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <source>METHOD informar_tablas_bapi.
    DATA: wrf_pohf_data_ekko_sty   TYPE wrf_pohf_data_ekko_sty,
          l_tabla                  TYPE tabname,
          l_ekko                   TYPE ekko,
          l_poheader               TYPE bapimepoheader,
          s_bapi_te_mepoheaderx    TYPE bapi_te_mepoheaderx,
          s_bapi_te_mepoheader     TYPE bapi_te_mepoheader,
          l_extension_in           TYPE bapiparex,
          wrf_pohf_data_eikp_sty   TYPE wrf_pohf_data_eikp_sty,
          l_impheader              TYPE bapieikp,
          l_ekpo                   TYPE ekpo,
          wrf_pohf_data_ekpo_sty   TYPE wrf_pohf_data_ekpo_sty,
          l_eket                   TYPE eket,
          l_adrn2                  TYPE ekpo-adrn2,
          l_poitem                 TYPE bapimepoitem,
          l_ekkn                   TYPE ekkn,
          mepoaccounting           TYPE mepoaccounting,
          l_account                TYPE bapimepoaccount,
          l_borrado                TYPE char1,
          wrf_pohf_data_eket_sty   TYPE wrf_pohf_data_eket_sty,
          l_schedule               TYPE bapimeposchedule,
          l_ekpa                   TYPE ekpa,
          l_wrf_pohf_data_ekpa_sty TYPE wrf_pohf_data_ekpa_sty,
          l_partner                TYPE bapiekkop,
          l_konv                   TYPE konv,
          l_komv                   TYPE komv,
          l_bapimepocond           TYPE bapimepocond,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_knumv                  TYPE ekko-knumv,
          l_bapimepocond_bd        TYPE bapimepocond,
          l_konv_bd                TYPE konv,
          l_komv_bd                TYPE komv,
          l_bapimepocondx          TYPE bapimepocondx,
          l_ekpv                   TYPE ekpv,
          bapimeposhippexp         TYPE bapimeposhippexp,
          l_shipping               TYPE bapiitemship.

    FIELD-SYMBOLS &lt;fs&gt; TYPE any.

    CLEAR: poheader,
           impheader,
           i_errores,
           i_poitem,
           i_poitemx,
           i_schedule,
           i_schedulex,
           i_pocond,
           i_pocondx,
           address,
           i_address,
           i_partners,
           i_extension_in.

    MOVE-CORRESPONDING ekko TO wrf_pohf_data_ekko_sty.
    CALL FUNCTION &apos;MAP2E_EKKO_TO_MEPOHEADER&apos;
      EXPORTING
        wrf_pohf_data_ekko_sty = wrf_pohf_data_ekko_sty
      CHANGING
        bapimepoheader         = poheader.

    IF NOT ekko-ebeln IS INITIAL.
      l_tabla = &apos;EKKO&apos;.
      SELECT SINGLE * FROM (l_tabla)          &quot;#EC CI_ALL_FIELDS_NEEDED
        INTO l_ekko
       WHERE ebeln = ekko-ebeln.
      IF sy-subrc = 0.
        MOVE-CORRESPONDING l_ekko TO wrf_pohf_data_ekko_sty.
        CALL FUNCTION &apos;MAP2E_EKKO_TO_MEPOHEADER&apos;
          EXPORTING
            wrf_pohf_data_ekko_sty = wrf_pohf_data_ekko_sty
          CHANGING
            bapimepoheader         = l_poheader.
      ENDIF.
    ENDIF.

*  zcl_ap_material=&gt;determina_cambios_campos( EXPORTING original     = poheader
*                                                       modificacion = l_poheader
*                                             CHANGING  cambios      = poheaderx ).
    zcl_ap_utils=&gt;busca_cambios_datos( EXPORTING original     = l_poheader
                                                 modificacion = poheader
                                                 ddic         = &apos;X&apos;
                                       CHANGING  cambios      = poheaderx ).

    poheaderx-item_intvl = &apos;X&apos;. &quot; Respetar numeración posiciones

    IF campos_usuario = &apos;X&apos;.
      zcl_ap_utils=&gt;busca_cambios_datos( EXPORTING original     = l_ekko
                                                   modificacion = ekko
                                                   ddic         = &apos;X&apos;
                                         CHANGING  cambios      = s_bapi_te_mepoheaderx ).
      s_bapi_te_mepoheaderx-po_number = ekko-ebeln.
      s_bapi_te_mepoheader-po_number = ekko-ebeln.
      MOVE-CORRESPONDING ekko TO s_bapi_te_mepoheader.
      l_extension_in-structure = &apos;BAPI_TE_MEPOHEADER&apos;.
      cl_abap_container_utilities=&gt;fill_container_c( EXPORTING  im_value               = s_bapi_te_mepoheader
                                                     IMPORTING  ex_container           = l_extension_in-valuepart1
                                                     EXCEPTIONS illegal_parameter_type = 1
                                                                OTHERS                 = 2 ).
      IF sy-subrc &lt;&gt; 0.
        MESSAGE &apos;Error en campos usuario&apos; TYPE &apos;S&apos;.
      ELSE.
        APPEND l_extension_in TO i_extension_in.
        l_extension_in-structure  = &apos;BAPI_TE_MEPOHEADERX&apos;.
        l_extension_in-valuepart1 = s_bapi_te_mepoheaderx.
        APPEND l_extension_in TO i_extension_in.
      ENDIF.
    ENDIF.

***************** EIKP DATOS CABECERA IMPORTACIÓN
    MOVE-CORRESPONDING eikp TO wrf_pohf_data_eikp_sty.
    CALL FUNCTION &apos;MAP2E_EIKP_TO_BAPIEIKP&apos;
      EXPORTING
        wrf_pohf_data_eikp_sty = wrf_pohf_data_eikp_sty
      CHANGING
        bapieikp               = impheader.

*  zcl_ap_material=&gt;determina_cambios_campos( EXPORTING original     = impheader
*                                                       modificacion = l_impheader
*                                             CHANGING  cambios      = impheaderx ).
    zcl_ap_utils=&gt;busca_cambios_datos( EXPORTING original     = l_impheader
                                                 modificacion = impheader
                                                 ddic         = &apos;X&apos;
                                       CHANGING  cambios      = impheaderx ).

**************** EKPO POSICIONES

    LOOP AT i_ekpo INTO l_ekpo.
      MOVE-CORRESPONDING l_ekpo TO wrf_pohf_data_ekpo_sty.

* Ñapa para poder especificar posiciones gratuitas
      ASSIGN (&apos;L_EKPO-SPE_CRM_FKREL&apos;) TO &lt;fs&gt;.
      IF sy-subrc = 0.
        IF &lt;fs&gt; = &apos;X&apos;.
          wrf_pohf_data_ekpo_sty-umson = &apos;X&apos;.
        ENDIF.
      ENDIF.

      CALL FUNCTION &apos;MAP2E_EKPO_TO_MEPOITEM&apos;
        EXPORTING
          wrf_pohf_data_ekpo_sty = wrf_pohf_data_ekpo_sty
        CHANGING
          bapimepoitem           = poitem.

* Como no podemos indicar que no queremos factura final, si detectamos una N en este campo
* luego indicadmos que es posición sin cargo.
      IF poitem-ir_ind = &apos;N&apos;.
        CLEAR poitem-ir_ind.
        poitem-free_item = &apos;X&apos;.
      ENDIF.

      poitem-gi_based_gr = l_ekpo-wabwe.

      READ TABLE i_eket INTO l_eket WITH KEY ebelp = l_ekpo-ebelp.
      IF sy-subrc = 0.
        poitem-batch = l_eket-charg.
      ENDIF.

      APPEND poitem TO i_poitem.

      IF NOT l_ekpo-adrn2 IS INITIAL.
        SELECT SINGLE adrn2 FROM ekpo
          INTO l_adrn2
         WHERE ebeln = l_ekpo-ebeln
           AND ebelp = l_ekpo-ebelp.
        IF l_ekpo-adrn2 &lt;&gt; l_adrn2.
          CLEAR address.
          MOVE-CORRESPONDING poitem TO address.
          address-addr_no = l_ekpo-adrn2.
          APPEND address TO i_address.
        ENDIF.
      ENDIF.

      IF NOT ekko-ebeln IS INITIAL.
        l_tabla = &apos;EKPO&apos;.
        SELECT SINGLE * FROM (l_tabla)        &quot;#EC CI_ALL_FIELDS_NEEDED
          INTO l_ekpo
         WHERE ebeln = ekko-ebeln
           AND ebelp = l_ekpo-ebelp.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING l_ekpo TO wrf_pohf_data_ekpo_sty.
          CALL FUNCTION &apos;MAP2E_EKPO_TO_MEPOITEM&apos;
            EXPORTING
              wrf_pohf_data_ekpo_sty = wrf_pohf_data_ekpo_sty
            CHANGING
              bapimepoitem           = l_poitem.
          IF l_ekpo-wabwe &lt;&gt; wrf_pohf_data_ekpo_sty-wabwe.
            l_poitem-gi_based_gr = &apos;X&apos;.
          ENDIF.
        ELSE.
          CLEAR l_poitem.
        ENDIF.
      ENDIF.

*    zcl_ap_material=&gt;determina_cambios_campos( EXPORTING original     = poitem
*                                                         modificacion = l_poitem
*                                                         pos_ini_cambios = 1
*                                               CHANGING  cambios      = poitemx ).
      zcl_ap_utils=&gt;busca_cambios_datos( EXPORTING original     = l_poitem
                                                   modificacion = poitem
                                                   ddic         = &apos;X&apos;
                                         CHANGING  cambios      = poitemx ).
      poitemx-po_item = poitem-po_item.
      APPEND poitemx TO i_poitemx.
    ENDLOOP.

    LOOP AT i_ekkn INTO l_ekkn.
      MOVE-CORRESPONDING l_ekkn TO mepoaccounting.
      mepoaccounting-zexkn = l_ekkn-zekkn.

      CALL FUNCTION &apos;MAP2E_ACCOUNT_TO_BAPIACCOUNT&apos;
        EXPORTING
          mepoaccounting  = mepoaccounting
        CHANGING
          bapimepoaccount = account.

      IF NOT l_ekkn-ps_psp_pnr IS INITIAL.
        WRITE l_ekkn-ps_psp_pnr TO account-wbs_element.
      ENDIF.
      APPEND account TO i_account.

      IF NOT ekko-ebeln IS INITIAL.
        SELECT * FROM ekkn
          INTO l_ekkn
          UP TO 1 ROWS
         WHERE ebeln = l_ekkn-ebeln
           AND ebelp = l_ekkn-ebelp
         ORDER BY PRIMARY KEY.
        ENDSELECT.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING l_ekkn TO mepoaccounting.

          CALL FUNCTION &apos;MAP2E_ACCOUNT_TO_BAPIACCOUNT&apos;
            EXPORTING
              mepoaccounting  = mepoaccounting
            CHANGING
              bapimepoaccount = l_account.

          IF NOT l_ekkn-ps_psp_pnr IS INITIAL.
            WRITE l_ekkn-ps_psp_pnr TO l_account-wbs_element.
          ENDIF.
        ELSE.
          CLEAR l_account.
        ENDIF.
      ENDIF.

*    zcl_ap_material=&gt;determina_cambios_campos( EXPORTING original     = account
*                                                         modificacion = l_account
*                                                         pos_ini_cambios = 2
*                                               CHANGING  cambios      = accountx ).
      zcl_ap_utils=&gt;busca_cambios_datos( EXPORTING original     = l_account
                                                   modificacion = account
                                                   ddic         = &apos;X&apos;
                                         CHANGING  cambios      = accountx ).
      accountx-po_item   = account-po_item.
      accountx-serial_no = account-serial_no.
      APPEND accountx TO i_accountx.
    ENDLOOP.

    LOOP AT i_eket INTO l_eket.
      CLEAR l_borrado.
      IF l_eket-cd_loctype = &apos;!D!&apos;. &quot; Truco para pasar indicador de borrado.
        l_borrado = &apos;X&apos;.
        CLEAR l_eket-cd_loctype.
      ENDIF.
      MOVE-CORRESPONDING l_eket TO wrf_pohf_data_eket_sty.

      CALL FUNCTION &apos;MAP2E_EKET_TO_MEPOSCHEDULE&apos;
        EXPORTING
          wrf_pohf_data_eket_sty = wrf_pohf_data_eket_sty
        CHANGING
          bapimeposchedule       = schedule.

      schedule-delete_ind = l_borrado.
      APPEND schedule TO i_schedule.

      IF NOT ekko-ebeln IS INITIAL.
        l_tabla = &apos;EKET&apos;.
        SELECT SINGLE * FROM (l_tabla)        &quot;#EC CI_ALL_FIELDS_NEEDED
          INTO l_eket
         WHERE ebeln = ekko-ebeln
           AND ebelp = l_eket-ebelp
           AND etenr = l_eket-etenr.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING l_eket TO wrf_pohf_data_eket_sty.

          CALL FUNCTION &apos;MAP2E_EKET_TO_MEPOSCHEDULE&apos;
            EXPORTING
              wrf_pohf_data_eket_sty = wrf_pohf_data_eket_sty
            CHANGING
              bapimeposchedule       = l_schedule.
        ELSE.
          CLEAR l_schedule.
        ENDIF.
      ENDIF.

      zcl_ap_utils=&gt;busca_cambios_datos( EXPORTING original     = l_schedule
                                                   modificacion = schedule
                                                   ddic         = &apos;X&apos;
                                         CHANGING  cambios      = schedulex ).

      schedulex-po_item    = schedule-po_item.
      schedulex-sched_line = schedule-sched_line.
      APPEND schedulex TO i_schedulex.
    ENDLOOP.

    LOOP AT i_ekpa INTO l_ekpa.
      MOVE-CORRESPONDING l_ekpa TO l_wrf_pohf_data_ekpa_sty.
      CALL FUNCTION &apos;MAP2E_EKPA_TO_BAPIEKKOP&apos;
        EXPORTING
          wrf_pohf_data_ekpa_sty = l_wrf_pohf_data_ekpa_sty
        CHANGING
          bapiekkop              = l_partner.

      APPEND l_partner TO i_partners.
    ENDLOOP.

    LOOP AT i_konv INTO l_konv.
      MOVE-CORRESPONDING l_konv TO l_komv.
      CALL FUNCTION &apos;MAP2E_KOMV_TO_BAPIMEPOCOND&apos;
        EXPORTING
          komv         = l_komv
        CHANGING
          bapimepocond = l_bapimepocond.
      IF NOT l_konv-lifnr IS INITIAL.
        l_bapimepocond-vendor_no = l_konv-lifnr.
      ENDIF.

      IF NOT ekko-ebeln IS INITIAL.
        SELECT SINGLE knumv FROM ekko
          INTO l_knumv
         WHERE ebeln = ekko-ebeln.

        CLEAR l_bapimepocond_bd.
        SELECT SINGLE * FROM konv
          INTO l_konv_bd
         WHERE knumv = l_konv-knumv
           AND kposn = l_konv-kposn
           AND stunr = l_konv-stunr
           AND zaehk = l_konv-zaehk.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING l_konv_bd TO l_komv_bd.
          CALL FUNCTION &apos;MAP2E_KOMV_TO_BAPIMEPOCOND&apos;
            EXPORTING
              komv         = l_komv_bd
            CHANGING
              bapimepocond = l_bapimepocond_bd.

          IF NOT l_konv_bd-lifnr IS INITIAL.
            l_bapimepocond_bd-vendor_no = l_konv_bd-lifnr.
          ENDIF.
        ENDIF.
      ENDIF.

      IF l_bapimepocond &lt;&gt; l_bapimepocond_bd.
        zcl_ap_utils=&gt;busca_cambios_datos( EXPORTING original     = l_bapimepocond_bd
                                                     modificacion = l_bapimepocond
                                                     ddic         = &apos;X&apos;
                                           CHANGING  cambios      = l_bapimepocondx ).

        l_bapimepocondx-condition_no = l_konv-knumv.
        l_bapimepocondx-itm_number   = l_konv-kposn.
        l_bapimepocondx-cond_st_no   = l_konv-stunr.
        APPEND l_bapimepocondx TO i_pocondx.
        IF NOT l_konv_bd IS INITIAL.
          l_bapimepocond-change_id = &apos;U&apos;.
        ENDIF.
        APPEND l_bapimepocond TO i_pocond.
      ENDIF.

    ENDLOOP.

    LOOP AT i_ekpv INTO l_ekpv.
      CLEAR bapimeposhippexp.
      CALL FUNCTION &apos;MAP2E_EKPV_TO_BAPISHIPPING&apos;
        EXPORTING
          ekpv             = l_ekpv
        CHANGING
          bapimeposhippexp = bapimeposhippexp.

      MOVE-CORRESPONDING bapimeposhippexp TO shipping.
      APPEND shipping TO i_shipping.

      IF NOT ekko-ebeln IS INITIAL.
        l_tabla = &apos;EKPV&apos;.
        SELECT SINGLE * FROM (l_tabla)        &quot;#EC CI_ALL_FIELDS_NEEDED
          INTO l_ekpv
         WHERE ebeln = ekko-ebeln
           AND ebelp = l_ekpv-ebelp.
        IF sy-subrc = 0.
          CLEAR bapimeposhippexp.
          CALL FUNCTION &apos;MAP2E_EKPV_TO_BAPISHIPPING&apos;
            EXPORTING
              ekpv             = l_ekpv
            CHANGING
              bapimeposhippexp = bapimeposhippexp.
          MOVE-CORRESPONDING bapimeposhippexp TO l_shipping.
        ELSE.
          CLEAR l_shipping.
        ENDIF.
      ENDIF.

      zcl_ap_utils=&gt;busca_cambios_datos( EXPORTING original     = l_shipping
                                                   modificacion = shipping
                                                   ddic         = &apos;X&apos;
                                         CHANGING  cambios      = shippingx ).
      shippingx-po_item = shipping-po_item.
      APPEND shippingx TO i_shippingx.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INSERTAR_URL_GOS_ST" VERSION="1" LANGU="S" DESCRIPT="Insertar URL en proveedor" EXPOSURE="2" STATE="1" EDITORDER="2 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO-EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="URL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="TITULO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <source>METHOD insertar_url_gos_st.
    DATA l_clave TYPE srgbtbrel-instid_a.

    l_clave = ebeln.
    zcl_ap_gos=&gt;insertar_url_gos_st( tipo   = &apos;BUS2012&apos;
                                     clave  = l_clave
                                     titulo = titulo
                                     url    = url ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="LIBERAR" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="27 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="LIBERAR" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="LIBERAR" SCONAME="REL_CODE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIMMPARA-PO_REL_COD"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="LIBERAR" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="LIBERAR" SCONAME="REL_STATUS_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIMMPARA-REL_STATUS"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="LIBERAR" SCONAME="REL_INDICATOR_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIMMPARA-PO_REL_IND"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="LIBERAR" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD liberar.
    DATA: i_return TYPE TABLE OF bapireturn,
          l_return TYPE bapireturn.

    CALL FUNCTION &apos;BAPI_PO_RELEASE&apos;
      EXPORTING
        purchaseorder          = ebeln
        po_rel_code            = rel_code
        use_exceptions         = &apos;X&apos;
      IMPORTING
        rel_status_new         = rel_status_new
        rel_indicator_new      = rel_indicator_new
      TABLES
        return                 = i_return
      EXCEPTIONS
        authority_check_fail   = 1
        document_not_found     = 2
        enqueue_fail           = 3
        prerequisite_fail      = 4
        release_already_posted = 5
        responsibility_fail    = 6
        OTHERS                 = 7.

    IF sy-subrc = 0 AND i_return IS INITIAL.
      IF commit = &apos;X&apos;.
        CALL FUNCTION &apos;BAPI_TRANSACTION_COMMIT&apos;
          EXPORTING
            wait = &apos;X&apos;.
      ENDIF.
    ELSE.
      LOOP AT i_return INTO l_return.
        __concat_a message l_return-message.
      ENDLOOP.
      IF sy-subrc &lt;&gt; 0.
        message = &apos;Error al liberar el pedido&apos;(elp).
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MARCA_POS_ENTREGA_FINAL" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="32 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MARCA_POS_ENTREGA_FINAL" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MARCA_POS_ENTREGA_FINAL" SCONAME="EBELP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MARCA_POS_ENTREGA_FINAL" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MARCA_POS_ENTREGA_FINAL" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MARCA_POS_ENTREGA_FINAL" SCONAME="ELIKZ" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ELIKZ" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MARCA_POS_ENTREGA_FINAL" SCONAME="EGLKZ" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EGLKZ" PARVALUE="&apos;?&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MARCA_POS_ENTREGA_FINAL" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD marca_pos_entrega_final.
    DATA: l_tabla TYPE tabname,
          ekko    TYPE ekko,
          o_ped   TYPE REF TO zcl_ap_pedido_mm,
          l_ekpo  TYPE ekpo,
          i_ekpo  TYPE TABLE OF ekpo,
          i_eket  TYPE TABLE OF eket.

    CLEAR message.
    l_tabla = &apos;EKKO&apos;.
    SELECT SINGLE * FROM (l_tabla)            &quot;#EC CI_ALL_FIELDS_NEEDED
      INTO ekko
     WHERE ebeln = ebeln.
    IF sy-subrc &lt;&gt; 0.
      CONCATENATE &apos;No existe el pedido&apos;(nep) ebeln INTO message SEPARATED BY space.
    ELSE.
      o_ped = NEW #( ).

      l_tabla = &apos;EKPO&apos;.
      SELECT SINGLE * FROM (l_tabla)          &quot;#EC CI_ALL_FIELDS_NEEDED
        INTO l_ekpo
       WHERE ebeln = ebeln
         AND ebelp = ebelp.
      IF sy-subrc &lt;&gt; 0.
        message = &apos;Posición de pedido no existe&apos;(ppn).
      ENDIF.

* Han solicitado modificar flag de entrega completa
      IF eglkz &lt;&gt; &apos;?&apos;.
        IF l_ekpo-eglkz = eglkz.
          IF NOT o_log IS INITIAL.
            IF eglkz = &apos;X&apos;.
              o_log-&gt;log( p1 = &apos;La posicion&apos;(lap) p2 = ebelp p3 = &apos;del pedido&apos;(del) p4 = ebeln p5 = &apos;ya tenía entrega completa&apos; msgty = &apos;W&apos; ).
            ELSE.
              o_log-&gt;log( p1 = &apos;La posicion&apos;(lap) p2 = ebelp p3 = &apos;del pedido&apos;(del) p4 = ebeln p5 = &apos;no tenía entrega completa&apos; msgty = &apos;W&apos; ).
            ENDIF.
          ENDIF.
        ELSE.
          DATA(l_mod_eglkz) = &apos;X&apos;.
        ENDIF.
      ENDIF.

      IF l_ekpo-elikz = elikz.
        IF NOT o_log IS INITIAL.
          IF elikz = &apos;X&apos;.
            o_log-&gt;log( p1 = &apos;La posicion&apos;(lap) p2 = ebelp p3 = &apos;del pedido&apos;(del) p4 = ebeln p5 = &apos;ya tenía entrega final&apos;(yte) msgty = &apos;W&apos; ).
          ELSE.
            o_log-&gt;log( p1 = &apos;La posicion&apos;(lap) p2 = ebelp p3 = &apos;del pedido&apos;(del) p4 = ebeln p5 = &apos;no tenía entrega final&apos;(nef) msgty = &apos;W&apos; ).
          ENDIF.
        ENDIF.
      ELSE.
        DATA(l_mod_elikz) = &apos;X&apos;.
      ENDIF.

      IF l_mod_eglkz IS INITIAL AND l_mod_elikz IS INITIAL.
        RETURN.
      ENDIF.

      l_ekpo-elikz = elikz.
      IF eglkz &lt;&gt; &apos;?&apos;.
        l_ekpo-eglkz = eglkz.
      ENDIF.
      APPEND l_ekpo TO i_ekpo.

      message = o_ped-&gt;modificar_pedido( ekko   = ekko
                                         i_ekpo = i_ekpo
                                         i_eket = i_eket ).

    ENDIF.

    IF NOT o_log IS INITIAL.
      IF NOT message IS INITIAL.
        o_log-&gt;log( p1 = message ).
      ELSE.
        IF l_mod_elikz = &apos;X&apos;.
          IF NOT o_log IS INITIAL.
            IF elikz = &apos;X&apos;.
              o_log-&gt;log( p1 = &apos;Se ha marcado la posicion&apos;(smp) p2 = ebelp p3 = &apos;del pedido&apos;(del) p4 = ebeln p5 = &apos;con entrega final&apos;(cef) msgty = &apos;S&apos; ).
            ELSE.
              o_log-&gt;log( p1 = &apos;Se ha desmarcado la posicion&apos;(sdp) p2 = ebelp p3 = &apos;del pedido&apos;(del) p4 = ebeln p5 = &apos;de entrega final&apos;(def) msgty = &apos;S&apos; ).
            ENDIF.
          ENDIF.
        ENDIF.
        IF l_mod_eglkz = &apos;X&apos;.
          IF NOT o_log IS INITIAL.
            IF eglkz = &apos;X&apos;.
              o_log-&gt;log( p1 = &apos;Se ha marcado la posicion&apos;(smp) p2 = ebelp p3 = &apos;del pedido&apos;(del) p4 = ebeln p5 = &apos;con entrega completa&apos; msgty = &apos;S&apos; ).
            ELSE.
              o_log-&gt;log( p1 = &apos;Se ha desmarcado la posicion&apos;(sdp) p2 = ebelp p3 = &apos;del pedido&apos;(del) p4 = ebeln p5 = &apos;de entrega completa&apos; msgty = &apos;S&apos; ).
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

    IF message IS INITIAL AND commit = &apos;X&apos;.
      zcl_ap_dev=&gt;commit( ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="21 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="0" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="EKKO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="I_EKPO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKPO_TTY" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="I_EKET" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKET_TT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="EIKP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EIKP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="I_EKKN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TY_EKKN" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="I_EKPA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="MEOUT_T_EKPA" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="I_KONV" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TAB_KONV" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="NO_WARNINGS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="CAMPOS_USUARIO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="11 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="I_EKPV" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="12 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="MMPR_EKPV" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="NO_AUT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="13 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="ERROR_SI_NO_MOD_CAMPOS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="14 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="I_COMPONENTS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="15 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIMEPO_T_COMPONENT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="I_COMPONENTSX" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="16 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIMEPO_T_COMPONENTX" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_PEDIDO" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="17 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRET2-MESSAGE"/>
  <source>METHOD modificar_pedido.
    DATA: l_contract_item     TYPE bapimeoutitem,
          i_contract_item     TYPE TABLE OF bapimeoutitem,
          l_contract_itemx    TYPE bapimeoutitemx,
          i_contract_itemx    TYPE TABLE OF bapimeoutitemx,
          l_contract_account  TYPE bapimeoutaccount,
          i_contract_account  TYPE TABLE OF bapimeoutaccount,
          l_contract_accountx TYPE bapimeoutaccountx,
          i_contract_accountx TYPE TABLE OF bapimeoutaccountx,
          l_funcion           TYPE string,
          l_contract_header   TYPE bapimeoutheader,
          l_contract_headerx  TYPE bapimeoutheaderx.

    informar_tablas_bapi( ekko           = ekko
                          eikp           = eikp
                          i_ekpo         = i_ekpo
                          i_eket         = i_eket
                          i_ekkn         = i_ekkn
                          i_ekpa         = i_ekpa
                          i_ekpv         = i_ekpv
                          i_konv         = i_konv
                          campos_usuario = campos_usuario ).

    IF i_components IS SUPPLIED.
      me-&gt;i_components  = i_components.
      me-&gt;i_componentsx = i_componentsx.
    ENDIF.

    IF ekko-bstyp = &apos;K&apos; OR ekko-bstyp = &apos;L&apos;.
      LOOP AT i_poitem INTO poitem.
        CLEAR l_contract_item.
        MOVE-CORRESPONDING poitem TO l_contract_item.
        l_contract_item-item_no = poitem-po_item.
        APPEND l_contract_item TO i_contract_item.
      ENDLOOP.
      LOOP AT i_poitemx INTO poitemx.
        CLEAR l_contract_itemx.
        MOVE-CORRESPONDING poitemx TO l_contract_itemx.
        l_contract_itemx-item_no  = poitemx-po_item.
        l_contract_itemx-item_nox = poitemx-po_itemx.
        APPEND l_contract_itemx TO i_contract_itemx.
      ENDLOOP.
      LOOP AT i_account INTO account.
        CLEAR l_contract_account.
        MOVE-CORRESPONDING account TO l_contract_account.
        l_contract_account-item_no = account-po_item.
        APPEND l_contract_account TO i_contract_account.
      ENDLOOP.
      LOOP AT i_accountx INTO accountx.
        CLEAR l_contract_accountx.
        MOVE-CORRESPONDING accountx TO l_contract_accountx.
        l_contract_accountx-item_no  = accountx-po_item.
        l_contract_accountx-item_nox = accountx-po_itemx.
        APPEND l_contract_accountx TO i_contract_accountx.
      ENDLOOP.

      IF ekko-bstyp = &apos;K&apos;.
        l_funcion = &apos;BAPI_CONTRACT_CHANGE&apos;.
      ELSEIF ekko-bstyp = &apos;L&apos;.
        l_funcion = &apos;BAPI_SAG_CHANGE&apos;.
      ENDIF.

      CALL FUNCTION l_funcion
        EXPORTING
          purchasingdocument = ekko-ebeln
          header             = l_contract_header
          headerx            = l_contract_headerx
*         VENDOR_ADDRESS     = VENDOR_ADDRESS
*         TESTRUN            = TESTRUN
*         TECHNICAL_DATA     = TECHNICAL_DATA
* IMPORTING
*         EXP_HEADER         = EXP_HEADER
        TABLES
          item               = i_contract_item
          itemx              = i_contract_itemx
          account            = i_contract_account
*         ACCOUNTPROFITSEGMENT = ACCOUNTPROFITSEGMENT
          accountx           = i_contract_accountx
*         DELIVERY_ADDRESS   = DELIVERY_ADDRESS
*         ITEM_COND_VALIDITY = ITEM_COND_VALIDITY
*         ITEM_COND_VALIDITYX = ITEM_COND_VALIDITYX
*         item_condition     = i_conditions
*         item_conditionx    = i_conditionsx
*         ITEM_COND_SCALE_VALUE = ITEM_COND_SCALE_VALUE
*         ITEM_COND_SCALE_QUAN = ITEM_COND_SCALE_QUAN
*         ITEM_TEXT          = ITEM_TEXT
*         HEADER_TEXT        = HEADER_TEXT
*         HEAD_COND_VALIDITY = HEAD_COND_VALIDITY
*         HEAD_COND_VALIDITYX = HEAD_COND_VALIDITYX
*         HEAD_CONDITION     = HEAD_CONDITION
*         HEAD_CONDITIONX    = HEAD_CONDITIONX
*         HEAD_COND_SCALE_VAL = HEAD_COND_SCALE_VAL
*         HEAD_COND_SCALE_QUAN = HEAD_COND_SCALE_QUAN
*         PARTNER            = PARTNER
*         PARTNERX           = PARTNERX
*         RELEASE_DOCU       = RELEASE_DOCU
          extensionin        = i_extension_in
*         EXTENSIONOUT       = EXTENSIONOUT
          return             = i_errores.
    ELSE.
      CALL FUNCTION &apos;BAPI_PO_CHANGE&apos;
        EXPORTING
          purchaseorder   = ekko-ebeln
          poheader        = poheader
          poheaderx       = poheaderx
*         POADDRVENDOR    = POADDRVENDOR
*         TESTRUN         = TESTRUN
*         MEMORY_UNCOMPLETE = MEMORY_UNCOMPLETE
*         MEMORY_COMPLETE = MEMORY_COMPLETE
          poexpimpheader  = impheader
          poexpimpheaderx = impheaderx
*         VERSIONS        = VERSIONS
*         NO_MESSAGING    = NO_MESSAGING
*         NO_MESSAGE_REQ  = NO_MESSAGE_REQ
          no_authority    = no_aut
*         NO_PRICE_FROM_PO = NO_PRICE_FROM_PO
* IMPORTING
*         EXPHEADER       = EXPHEADER
*         EXPPOEXPIMPHEADER = EXPPOEXPIMPHEADER
        TABLES
          return          = i_errores
          poitem          = i_poitem
          poitemx         = i_poitemx
*         POADDRDELIVERY  = POADDRDELIVERY
          poschedule      = i_schedule
          poschedulex     = i_schedulex
          poaccount       = i_account
          poaccountx      = i_accountx
*         POCONDHEADER    = POCONDHEADER
*         POCONDHEADERX   = POCONDHEADERX
          pocond          = i_pocond
          pocondx         = i_pocondx
*         POLIMITS        = POLIMITS
*         POCONTRACTLIMITS = POCONTRACTLIMITS
*         POSERVICES      = POSERVICES
*         POSRVACCESSVALUES = POSRVACCESSVALUES
*         POSERVICESTEXT  = POSERVICESTEXT
          extensionin     = i_extension_in
*         EXTENSIONOUT    = EXTENSIONOUT
*         POEXPIMPITEM    = POEXPIMPITEM
*         POEXPIMPITEMX   = POEXPIMPITEMX
*         POTEXTHEADER    = POTEXTHEADER
*         POTEXTITEM      = POTEXTITEM
*         ALLVERSIONS     = ALLVERSIONS
          popartner       = i_partners
          pocomponents    = me-&gt;i_components
          pocomponentsx   = me-&gt;i_componentsx
          poshipping      = i_shipping
          poshippingx     = i_shippingx.
*         POSHIPPINGEXP   = POSHIPPINGEXP
*         POHISTORY       = POHISTORY
*         POHISTORY_TOTALS = POHISTORY_TOTALS
*         POCONFIRMATION  = POCONFIRMATION
    ENDIF.

    IF error_si_no_mod_campos = &apos;X&apos;.
* A veces la BAPI no hace lo que se le indica, pero sólo da una advertencia de la que no nos damos cuenta
      LOOP AT i_errores ASSIGNING FIELD-SYMBOL(&lt;error&gt;) WHERE type = &apos;I&apos; AND id = &apos;ME&apos; AND number = &apos;664&apos;. &quot; No se ha podido ejecutar la modificación de XXX
        &lt;error&gt;-type = &apos;E&apos;.
      ENDLOOP.
    ENDIF.

    READ TABLE i_errores INTO bapiret2 WITH KEY type = &apos;E&apos;.
    IF sy-subrc &lt;&gt; 0.
      IF commit = &apos;X&apos;.
        zcl_ap_dev=&gt;commit( ).
      ENDIF.
    ELSE.
      DESCRIBE TABLE i_errores LINES sy-tfill.
      IF sy-tfill &gt; 1.
        DELETE i_errores WHERE    message CS &apos;Imposible modificar la instancia&apos;(imi)
                               OR message CS &apos;No se ha creado ninguna instancia&apos;(nni).
      ENDIF.

* Devolvemos el último mensaje de error, que es el más explicativo
      LOOP AT i_errores INTO bapiret2 WHERE type = &apos;E&apos;.
        message = bapiret2-message.
      ENDLOOP.
      CALL FUNCTION &apos;DEQUEUE_ALL&apos;.
    ENDIF.

* Borramos mensaje de ampliación
    DELETE i_errores WHERE type = &apos;W&apos; AND message CS &apos;CI_EK&apos;.
    DELETE i_errores WHERE message = &apos;No se ha creado ninguna instancia de tipo objeto PurchaseOrder; ref.externa:&apos;(nrf).

    IF NOT o_log IS INITIAL.
      IF no_warnings = &apos;X&apos;.
        DELETE i_errores WHERE type = &apos;W&apos;.
      ENDIF.
      o_log-&gt;set_tabla_log_from_bapiret2_t( i_errores ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_REPARTO" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="23 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_REPARTO" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKET-EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_REPARTO" SCONAME="EBELP" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKET-EBELP"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_REPARTO" SCONAME="ETENR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKET-ETENR" PARVALUE="&apos;0001&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_REPARTO" SCONAME="EINDT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKET-EINDT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_REPARTO" SCONAME="UZEIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKET-UZEIT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_REPARTO" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_REPARTO" SCONAME="BORRAR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="MODIFICAR_REPARTO" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD modificar_reparto.
    DATA: l_tabla TYPE tabname,
          l_eket  TYPE eket,
          o_ped   TYPE REF TO zcl_ap_pedido_mm,
          ekko    TYPE ekko,
          i_ekpo  TYPE TABLE OF ekpo,
          i_eket  TYPE TABLE OF eket.

    FIELD-SYMBOLS &lt;eket&gt; TYPE eket.

    l_tabla = &apos;EKET&apos;.
    SELECT SINGLE * FROM (l_tabla)            &quot;#EC CI_ALL_FIELDS_NEEDED
      INTO l_eket
     WHERE ebeln = ebeln
       AND ebelp = ebelp
       AND etenr = etenr.
    IF sy-subrc &lt;&gt; 0.
      CONCATENATE &apos;No existe el reparto&apos;(ner) ebeln ebelp etenr INTO message SEPARATED BY space.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = message ).
      ENDIF.
    ELSE.
      IF    ( NOT eindt IS INITIAL AND l_eket-eindt &lt;&gt; eindt )
         OR ( NOT uzeit IS INITIAL AND l_eket-uzeit &lt;&gt; uzeit )
         OR borrar = &apos;X&apos;.
        o_ped = NEW #( ).

        l_tabla = &apos;EKKO&apos;.
        SELECT SINGLE * FROM (l_tabla)        &quot;#EC CI_ALL_FIELDS_NEEDED
          INTO ekko
         WHERE ebeln = ebeln.

        l_tabla = &apos;EKPO&apos;.
        SELECT * FROM (l_tabla)               &quot;#EC CI_ALL_FIELDS_NEEDED
          INTO TABLE i_ekpo
         WHERE ebeln = ebeln
           AND ebelp = ebelp.

        l_tabla = &apos;EKET&apos;.
        SELECT * FROM (l_tabla)               &quot;#EC CI_ALL_FIELDS_NEEDED
          INTO TABLE i_eket
         WHERE ebeln = ebeln
           AND ebelp = ebelp
           AND etenr = etenr.

        LOOP AT i_eket ASSIGNING &lt;eket&gt;.
          IF NOT eindt IS INITIAL.
            &lt;eket&gt;-eindt = eindt.
          ENDIF.
          IF NOT uzeit IS INITIAL.
            &lt;eket&gt;-uzeit = uzeit.
          ENDIF.
          IF borrar = &apos;X&apos;.
            &lt;eket&gt;-cd_loctype = &apos;!D!&apos;.
          ENDIF.
        ENDLOOP.

        message = o_ped-&gt;modificar_pedido( ekko   = ekko
                                           i_ekpo = i_ekpo
                                           i_eket = i_eket
                                           o_log  = o_log ).

        IF NOT o_log IS INITIAL.
          IF message IS INITIAL.
            o_log-&gt;log( p1    = &apos;Se modifica la fecha de reparto en el pedido&apos;(smf)
                        p2    = ebeln
                        p3    = ebelp
                        p4    = &apos;Nueva fecha&apos;(nuf)
                        p5    = eindt
                        p6    = &apos;F.anterior&apos;(fan)
                        p7    = l_eket-eindt
                        msgty = &apos;S&apos; ).
          ELSE.
            o_log-&gt;log( p1 = &apos;Error modificando la fecha de reparto en el pedido&apos;(emf)
                        p2 = ebeln
                        p3 = ebelp
                        p4 = &apos;Nueva fecha&apos;(nuf)
                        p5 = eindt
                        p6 = &apos;F.anterior&apos;(fan)
                        p7 = l_eket-eindt ).
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="RECHAZAR" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="36 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="RECHAZAR" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="RECHAZAR" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="RECHAZAR" SCONAME="ANULAR_RECHAZO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="RECHAZAR" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD rechazar.
    DATA: ls_document TYPE mepo_document,
          lr_po       TYPE REF TO cl_po_header_handle_mm,
          l_result    TYPE mmpur_bool,
          ls_bapi     TYPE bapiret2.

    IF esta_bloqueado( ebeln ) = &apos;X&apos;.
      message = |Pedido bloqueado por { sy-msgv1 }|.
      RETURN.
    ENDIF.

*  prepare creation of PO instance
    ls_document-process     = &apos;PO_PROCESS&apos;.
    ls_document-trtyp       = &apos;V&apos;.
    ls_document-doc_key(10) = ebeln.
    IF anular_rechazo IS INITIAL.
      ls_document-initiator-initiator = &apos;RELEASE&apos;.
    ENDIF.

    lr_po = NEW #( ).
    lr_po-&gt;for_bapi = &apos;X&apos;.
    lr_po-&gt;po_initialize( ls_document ).
    lr_po-&gt;set_po_number( ebeln ).

    TRY.
        lr_po-&gt;po_read( EXPORTING im_tcode     = &apos;ME29N&apos;
                                  im_trtyp     = ls_document-trtyp
                                  im_aktyp     = ls_document-trtyp
                                  im_po_number = ebeln
                                  im_document  = ls_document
                        IMPORTING ex_result    = l_result ). &quot; 2212877
      CATCH cx_root ##CATCH_ALL.
        l_result = mmpur_no.                                &quot; 2212877
    ENDTRY.

    IF l_result = mmpur_no.
      message = &apos;Error recuperando datos del pedido&apos;.
      RETURN.
    ENDIF.

    IF    lr_po-&gt;if_releasable_mm~is_rejection_allowed( ) = &apos;X&apos;
       OR anular_rechazo = &apos;X&apos;.
      lr_po-&gt;if_releasable_mm~reject( EXPORTING  im_reset = anular_rechazo
                                      EXCEPTIONS
                                          failed   = 1
                                          OTHERS   = 2 ).
      IF sy-subrc = 0.
        &quot; Success here...
        lr_po-&gt;po_post( EXCEPTIONS failure = 1
                                   OTHERS  = 2 ).
        IF sy-subrc &gt; 0.
          lr_po-&gt;po_initialize( ).
        ELSE.
          lr_po-&gt;po_close( ).
          FREE lr_po.
        ENDIF.
        IF commit = &apos;X&apos;.
          COMMIT WORK AND WAIT.
        ENDIF.
      ELSE.
        &quot; Error here...
        CALL FUNCTION &apos;BALW_BAPIRETURN_GET2&apos;
          EXPORTING
            type   = sy-msgty
            cl     = sy-msgid
            number = sy-msgno
            par1   = sy-msgv1
            par2   = sy-msgv2
            par3   = sy-msgv3
          IMPORTING
            return = ls_bapi.
        message = ls_bapi-message.
      ENDIF.
    ELSE.
      message = &apos;Rechazo no permitido&apos;.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SAVE_TEXTO" VERSION="1" LANGU="S" DESCRIPT="Graba texto pedido" EXPOSURE="2" STATE="1" EDITORDER="10 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SAVE_TEXTO" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SAVE_TEXTO" SCONAME="EBELP" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SAVE_TEXTO" SCONAME="ID" VERSION="1" LANGU="S" DESCRIPT="ID de texto" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STXH-TDID"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SAVE_TEXTO" SCONAME="SPRAS" VERSION="1" LANGU="S" DESCRIPT="Clave de idioma" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STXH-TDSPRAS" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="SAVE_TEXTO" SCONAME="LINEAS" VERSION="1" LANGU="S" DESCRIPT="Tipo tabla tline" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="OIJ_TLINE"/>
  <source>METHOD save_texto.
    DATA l_name TYPE stxh-tdname.

    IF ebelp IS INITIAL.
      l_name = ebeln.
      zcl_ap_textos=&gt;save_texto( id     = id
                                 name   = l_name
                                 spras  = spras
                                 object = &apos;EKKO&apos;
                                 lineas = lineas ).
    ELSE.
      CONCATENATE ebeln ebelp INTO l_name.
      zcl_ap_textos=&gt;save_texto( id     = id
                                 name   = l_name
                                 spras  = spras
                                 object = &apos;EKPO&apos;
                                 lineas = lineas ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="URLS_GOS_ST" VERSION="1" LANGU="S" DESCRIPT="Devuelve lista de URLs de GOS" EXPOSURE="2" STATE="1" EDITORDER="1 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="URLS_GOS_ST" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO-EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="URLS_GOS_ST" SCONAME="TABLA" VERSION="1" LANGU="S" DESCRIPT="URL GOS" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ZTAB_URL_GOS"/>
  <source>METHOD urls_gos_st.
    DATA l_clave TYPE srgbtbrel-instid_a.

    l_clave = ebeln.
    tabla = zcl_ap_gos=&gt;urls_gos_st( tipo = &apos;BUS2012&apos; clave = l_clave ).

    DATA(tabla2) = zcl_ap_gos=&gt;urls_gos_st( tipo = &apos;BUS2014&apos; clave = l_clave ).
    APPEND LINES OF tabla2 TO tabla.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="VISUALIZAR" VERSION="1" LANGU="S" DESCRIPT="Visualizar pedido" EXPOSURE="2" STATE="1" EDITORDER="7 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="VISUALIZAR" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PAROPTIONL="X" PARPREFERD="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="VISUALIZAR" SCONAME="EBELP" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELP" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="VISUALIZAR" SCONAME="EDIT" VERSION="1" LANGU="S" DESCRIPT="Casilla de selección" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="XFELD" PARVALUE="&apos;&apos;"/>
  <source>METHOD visualizar.
    CALL FUNCTION &apos;ME_DISPLAY_PURCHASE_DOCUMENT&apos;
      EXPORTING
        i_ebeln              = ebeln
        i_ebelp              = ebelp
        i_enjoy              = &apos;X&apos;
        i_edit               = edit
      EXCEPTIONS
        not_found            = 1
        no_authority         = 2
        invalid_call         = 3
        preview_not_possible = 4
        OTHERS               = 5.
    IF sy-subrc &lt;&gt; 0.
      MESSAGE &apos;Error mostrando pedido&apos; TYPE &apos;S&apos;.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="VISUALIZAR_PEDIDO_ST" VERSION="1" LANGU="S" DESCRIPT="Visualizar pedido" EXPOSURE="2" STATE="1" EDITORDER="4 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0" MTDTYPE2="00">
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="VISUALIZAR_PEDIDO_ST" SCONAME="EBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO-EBELN"/>
  <parameter CLSNAME="ZCL_AP_PEDIDO_MM" CMPNAME="VISUALIZAR_PEDIDO_ST" SCONAME="EBELP" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKPO-EBELP" PAROPTIONL="X"/>
  <source>METHOD visualizar_pedido_st.
    CALL FUNCTION &apos;ME_DISPLAY_PURCHASE_DOCUMENT&apos;
      EXPORTING
        i_ebeln              = ebeln
        i_ebelp              = ebelp
        i_enjoy              = &apos;X&apos;
      EXCEPTIONS
        not_found            = 1
        no_authority         = 2
        invalid_call         = 3
        preview_not_possible = 4
        OTHERS               = 5.
    IF sy-subrc &lt;&gt; 0.
      MESSAGE &apos;Error mostrando pedido&apos; TYPE &apos;S&apos;.
    ENDIF.
  ENDMETHOD.</source>
 </method>
</CLAS>
