<?xml version="1.0" encoding="utf-8"?>
<CLAS CLSNAME="ZCL_AP_ENTREGAS" VERSION="1" LANGU="S" DESCRIPT="Entregas" CATEGORY="00" EXPOSURE="2" STATE="1" RELEASE="0" CLSCCINCL="X" FIXPT="X" UNICODE="X" CLSBCCAT="00" DURATION_TYPE="0 " RISK_LEVEL="0 ">
 <types CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="T_EMBALAJE" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="1 " TYPTYPE="4" SRCROW1="7 " SRCCOLUMN1="6 " SRCROW2="15 " SRCCOLUMN2="22 " TYPESRC_LENG="238 " TYPESRC="BEGIN OF t_embalaje,
        posnr TYPE posnr,
        matnr TYPE matnr,
        charg TYPE charg_d,
        lfimg TYPE lfimg,
        vrkme TYPE vrkme,
        exidv TYPE exidv,
        vhilm TYPE vhilm,
      END OF t_embalaje
"/>
 <types CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="TT_EMBALAJE" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="2 " TYPTYPE="4" SRCROW1="16 " SRCCOLUMN1="10 " SRCROW2="16 " SRCCOLUMN2="45 " TYPESRC_LENG="38 " TYPESRC="tt_embalaje TYPE TABLE OF t_embalaje
"/>
 <types CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="T_VLPOD" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="3 " TYPTYPE="4" SRCROW1="18 " SRCCOLUMN1="6 " SRCROW2="22 " SRCCOLUMN2="19 " TYPESRC_LENG="127 " TYPESRC="BEGIN OF t_vlpod,
        posnr TYPE posnr,
        grund TYPE reacd,
        diff  TYPE lfimg_diff,
      END OF t_vlpod
"/>
 <types CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="TT_VLPOD" VERSION="1" LANGU="S" EXPOSURE="2" STATE="1" EDITORDER="4 " TYPTYPE="4" SRCROW1="23 " SRCCOLUMN1="10 " SRCROW2="23 " SRCCOLUMN2="39 " TYPESRC_LENG="32 " TYPESRC="tt_vlpod TYPE TABLE OF t_vlpod
"/>
 <localImplementation>*&quot;* local class implementation for public class
*&quot;* use this source file for the implementation part of
*&quot;* local helper classes</localImplementation>
 <localTypes>*&quot;* use this source file for any type declarations (class
*&quot;* definitions, interfaces or data types) you need for method
*&quot;* implementation or private method&apos;s signature</localTypes>
 <localMacros>*&quot;* use this source file for any macro definitions you need
*&quot;* in the implementation part of the class</localMacros>
 <typeUsage CLSNAME="ZCL_AP_ENTREGAS" TYPEGROUP="ABAP" VERSION="1" TPUTYPE="0" IMPLICIT="X"/>
 <forwardDeclaration>ABAP</forwardDeclaration>
 <attribute CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="C_OBJECTCLAS" VERSION="1" LANGU="S" DESCRIPT="Clase de objeto" EXPOSURE="2" STATE="1" EDITORDER="1 " ATTDECLTYP="2" ATTVALUE="&apos;LIEFERUNG&apos;" ATTEXPVIRT="0" TYPTYPE="1" TYPE="CDOBJECTCL" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <attribute CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="C_TIPO_GOS" VERSION="1" LANGU="S" DESCRIPT="Tipo de objetos en referencias de objeto persistentes" EXPOSURE="2" STATE="1" EDITORDER="2 " ATTDECLTYP="2" ATTVALUE="&apos;LIKP&apos;" ATTEXPVIRT="0" TYPTYPE="1" TYPE="SRGBTBREL-TYPEID_A" SRCROW1="0 " SRCCOLUMN1="0 " SRCROW2="0 " SRCCOLUMN2="0 " TYPESRC_LENG="0 "/>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" VERSION="1" LANGU="S" DESCRIPT="Añadir posición desde pedido" EXPOSURE="2" STATE="1" EDITORDER="26 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" SCONAME="PEDIDO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VA"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" SCONAME="FORZAR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" SCONAME="POSNR_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ANYADIR_POS_PEDIDO" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD anyadir_pos_pedido.
    DATA: l_tabla TYPE tabname VALUE &apos;VBUP&apos;,
          l_vbap  TYPE vbap,
          l_vbup  TYPE vbup,
          l_vbep  TYPE vbep,
          l_lfimg TYPE lips-lfimg.
    DATA o_bi TYPE REF TO zcl_ap_batch_input.

    IF zcl_c=&gt;hana = &apos;X&apos;.
      l_tabla = &apos;LIPS&apos;.
    ENDIF.

    SELECT SINGLE kwmeng FROM vbap  ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO CORRESPONDING FIELDS OF l_vbap
     WHERE vbeln = pedido
       AND posnr = posnr.

    SELECT SINGLE uvvlk FROM (l_tabla)
      INTO l_vbup-uvvlk
     WHERE vbeln = pedido
       AND posnr = posnr.
    IF sy-subrc &lt;&gt; 0.
      __concat3 message &apos;No existe el pedido&apos; pedido posnr.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = message msgty = &apos;E&apos; ).
      ENDIF.
    ELSE.
      IF forzar = &apos;X&apos;.
        IF l_vbup-uvvlk = &apos;A&apos; OR l_vbup-uvvlk = &apos;B&apos;.
          UPDATE (l_tabla)
            SET uvvlk = &apos;C&apos;
          WHERE vbeln = pedido
            AND posnr = posnr.
          IF NOT o_log IS INITIAL.
            o_log-&gt;log( p1 = &apos;Marcamos posición pedido&apos; p2 = pedido p3 = posnr p4 = &apos;como completa. ¡REVISE PEDIDO!&apos; msgty = &apos;W&apos; ).
          ENDIF.
        ENDIF.

        SELECT SUM( bmeng ) FROM vbep
          INTO l_vbep-bmeng
        WHERE vbeln = pedido
          AND posnr = posnr.
        IF l_vbep-bmeng = 0.
          UPDATE vbep &quot;#EC AOC_STD_TABLE
            SET bmeng = l_vbap-kwmeng
          WHERE vbeln = pedido
            AND posnr = posnr
            AND etenr = &apos;0001&apos;.
          IF NOT o_log IS INITIAL.
            o_log-&gt;log( p1 = &apos;Marcamos posición pedido&apos; p2 = pedido p3 = posnr p4 = &apos;como completa&apos; msgty = &apos;W&apos; ).
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

    o_bi = NEW #( ).

    o_bi-&gt;inicio( ).

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
    o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=RAUF_T&apos; ).

* Entrega:     Popup para agrupación de pedidos
    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0105&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ENT1&apos; ).
    o_bi-&gt;campos( campo = &apos;LV50C-DATBI&apos; valor = &apos;31.12.9999&apos; ). &quot; Fecha de selección de entrega
    o_bi-&gt;campos( campo = &apos;LV50C-VBELN&apos; valor = pedido ). &quot; Pedido
    o_bi-&gt;campos( campo = &apos;LV50C-ABPOS&apos; valor = posnr ). &quot; Desde posición
    o_bi-&gt;campos( campo = &apos;LV50C-BIPOS&apos; valor = posnr ). &quot; Hasta posición

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

    message = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = modoct ).

    SELECT posnr lfimg FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO (posnr_new, l_lfimg)
      UP TO 1 ROWS
     WHERE vgbel = pedido
       AND vgpos = posnr
      ORDER BY posnr DESCENDING.
    ENDSELECT.
    IF sy-subrc = 0.
      CLEAR message.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = &apos;En en entrega&apos; p2 = vbeln p3 = &apos;se ha añadido la posición&apos; p4 = posnr p6 = &apos;del pedido&apos; p7 = pedido p8 = &apos;nueva posición entrega&apos; p9 = posnr_new msgty = &apos;S&apos; ).
      ENDIF.

      IF forzar = &apos;X&apos;.
* Si la cantidad de la entrega es inferior a la del pedido (por verificación de disponibilidad, modificamos la entrega)
        IF l_lfimg &lt; l_vbap-kwmeng.
          o_bi-&gt;inicio( ).

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
          o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; okcode = &apos;=WEIT&apos; ).
          o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = posnr_new ).

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; okcode = &apos;=SICH_T&apos; ).
          o_bi-&gt;campos( campo = &apos;LIPSD-G_LFIMG(01)&apos; valor = l_vbap-kwmeng ).

          DATA(l_msg) = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = modoct ).
          SELECT SINGLE lfimg FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
            INTO @DATA(l_lfimg2)
           WHERE vbeln = @vbeln
             AND posnr = @posnr.
          IF l_lfimg2 = l_vbap-kwmeng.
            IF NOT o_log IS INITIAL.
              o_log-&gt;log( p1 = &apos;La entrega &apos; p2 = vbeln p3 = posnr p4 = &apos;se creó por menos&apos; p5 = l_lfimg p6 = &apos;se cambia a&apos; p7 = l_vbap-kwmeng msgty = &apos;W&apos; ).
            ENDIF.
          ELSE.
            UPDATE lips &quot;#EC AOC_STD_TABLE
              SET lfimg = l_vbap-kwmeng
             WHERE vbeln = vbeln
               AND posnr = posnr.
            IF NOT o_log IS INITIAL.
              o_log-&gt;log( p1 = &apos;La entrega &apos; p2 = vbeln p3 = posnr p4 = &apos;se creó por menos&apos; p5 = l_lfimg p6 = &apos;se fuerza a&apos; p7 = l_vbap-kwmeng msgty = &apos;W&apos; ).
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = &apos;Error&apos; p2 = message p3 = &apos;añadiendo en entrega&apos; p4 = vbeln p5 = &apos;la posición&apos; p6 = posnr p7 = &apos;del pedido&apos; p8 = pedido msgty = &apos;E&apos; ).
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR" VERSION="1" LANGU="S" DESCRIPT="Borrar entregas" EXPOSURE="2" STATE="1" EDITORDER="46 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR" SCONAME="O_LOG" VERSION="1" LANGU="S" DESCRIPT="Log" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR" SCONAME="SACAR_DE_TRANSPORTE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR" SCONAME="I_RETURN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRET2_T"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD borrar.
    DATA: header_control TYPE bapiobdlvhdrctrlchg,
          header_data    TYPE bapiobdlvhdrchg,
          return         TYPE bapiret2.

    SELECT SINGLE vbtyp FROM likp
      INTO @DATA(l_vbtyp)
     WHERE vbeln = @vbeln.
    IF sy-subrc &lt;&gt; 0.
      message = &apos;No existe la entrega&apos;.
      RETURN.
    ENDIF.

    SELECT SINGLE tknum FROM vttp
      INTO @DATA(l_tknum)
     WHERE vbeln = @vbeln.
    IF sy-subrc = 0.
      SELECT SINGLE stdis FROM vttk
        INTO @DATA(l_stdis)
       WHERE tknum = @l_tknum.
      IF sy-subrc = 0.
        IF NOT sacar_de_transporte IS INITIAL.
          IF sacar_de_transporte = &apos;F&apos;.
            message = zcl_ap_transporte=&gt;desvincular_entrega( tknum = l_tknum vbeln = vbeln forzar = &apos;X&apos; o_log = o_log commit = commit ).
          ELSE.
            message = zcl_ap_transporte=&gt;desvincular_entrega( tknum = l_tknum vbeln = vbeln o_log = o_log commit = commit ).
          ENDIF.
          IF NOT message IS INITIAL.
            RETURN.
          ENDIF.
        ELSE.
          IF l_stdis = &apos;X&apos;.
            message = |No se puede borrar la entrega al estar asignada al transporte planificado { l_tknum ALPHA = OUT }|.
            RETURN.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

    header_control-deliv_numb = vbeln.
    header_data-deliv_numb = header_control-deliv_numb.
    header_control-dlv_del = &apos;X&apos;.

    CALL FUNCTION &apos;BAPI_OUTB_DELIVERY_CHANGE&apos;
      EXPORTING
        header_data    = header_data
        header_control = header_control
        delivery       = header_data-deliv_numb
*       TECHN_CONTROL  =
*       HEADER_DATA_SPL   =
*       HEADER_CONTROL_SPL            =
*       SENDER_SYSTEM  =
      TABLES
*       HEADER_PARTNER =
*       HEADER_PARTNER_ADDR           =
*       HEADER_DEADLINES  =
*       item_data      = i_item_data
*       item_control   = i_item_control
*       ITEM_SERIAL_NO =
*       SUPPLIER_CONS_DATA            =
*       EXTENSION1     =
*       EXTENSION2     =
        return         = i_return.
*     TOKENREFERENCE =
*     ITEM_DATA_SPL  =
*     COLLECTIVE_CHANGE_ITEMS       =
*     new_item_data  = new_item_data
*     new_item_data_spl = new_item_data_spl.
*     new_item_org   = new_item_org
*     ITEM_DATA_DOCU_BATCH          =

    LOOP AT i_return INTO return WHERE message IS INITIAL.
      MESSAGE ID return-id TYPE return-type NUMBER return-number WITH return-message_v1 return-message_v2
              INTO message.
      return-message = message.
      MODIFY i_return FROM return.
    ENDLOOP.
    LOOP AT i_return INTO return WHERE type = &apos;E&apos;.
      __add_lista message return-message.
    ENDLOOP.

    IF NOT o_log IS INITIAL.
      o_log-&gt;set_tabla_log_from_bapiret2_t( i_return ).
    ENDIF.

    IF message IS INITIAL AND commit = &apos;X&apos;.
      zcl_ap_dev=&gt;commit( dequeue_all = &apos;X&apos; ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR_PART_LOTE" VERSION="1" LANGU="S" DESCRIPT="Borrar partición de lote" EXPOSURE="2" STATE="1" EDITORDER="11 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR_PART_LOTE" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR_PART_LOTE" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIPS-POSNR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR_PART_LOTE" SCONAME="POSNR_PART" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIPS-POSNR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR_PART_LOTE" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BORRAR_PART_LOTE" SCONAME="MENSAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRET2-MESSAGE"/>
  <source>METHOD borrar_part_lote.
    DATA: l_lips        TYPE lips,
          o_bi          TYPE REF TO zcl_ap_batch_input,
          l_vbfa        TYPE vbfa,
          l_ctd_picking TYPE lipsd-pikmg.

    SELECT SINGLE posnr uecha FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO CORRESPONDING FIELDS OF l_lips
     WHERE vbeln = vbeln
       AND posnr = posnr_part.
    IF sy-subrc &lt;&gt; 0.
      RETURN.
    ENDIF.

    IF l_lips-uecha &lt;&gt; posnr.
      mensaje = &apos;Posición de la partición no cuadra con posición principal&apos;.
      RETURN.
    ENDIF.

    o_bi = NEW #( ).

    o_bi-&gt;inicio( ).

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
    o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

* Pulsamos para seleccionar posición
    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

* Entrega                Ventana   Posicionar    Posición
    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
    o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-uecha ). &quot; Número de posición del documento comercial

* Marcamos la primera fila y puslsamos sobre selección de lotes
    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHSP_T&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).
    o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de selección en dynpros de lista

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
    o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-posnr ).

* Borramos posición
    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).
    o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de selección en dynpros de lista
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POLO_T&apos; ).

* Volvemos a la pantalla inicial (picking)
    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK_T&apos; ).

* Nos aseguramos que estamos en la pestaÃ±a de picking
    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=T\02&apos; ).

* Seleccionamos la posicion
    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
    o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-uecha ).

* A la cantidad de picking existente, le restamos la que acabamos de borrar
    SELECT SUM( rfmng_flo )  FROM vbfa
      INTO l_vbfa-rfmng_flo
     WHERE vbelv    = vbeln
       AND posnv    = l_lips-uecha
       AND vbeln    = vbeln
       AND posnn   &lt;&gt; l_lips-posnr
       AND vbtyp_n  = &apos;Q&apos;.

    l_ctd_picking = l_vbfa-rfmng_flo.

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).
    o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = l_ctd_picking ).

    mensaje = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = modoct ).

    IF mensaje CS &apos;grabado&apos;.
      CLEAR mensaje.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BUSCAR_PART_LOTE_SIN_HU" VERSION="1" LANGU="S" DESCRIPT="Busca partición de lotes sin HU" EXPOSURE="2" STATE="1" EDITORDER="10 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BUSCAR_PART_LOTE_SIN_HU" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BUSCAR_PART_LOTE_SIN_HU" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="BUSCAR_PART_LOTE_SIN_HU" SCONAME="POSNR_SIN_HU" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="POSNR"/>
  <source>METHOD buscar_part_lote_sin_hu.
    DATA: l_lips TYPE lips,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_vepo TYPE vepo.

    SELECT posnr FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1] &quot;#EC CI_EXIT_SELECT
      INTO l_lips-posnr
     WHERE vbeln = vbeln
       AND uecha = posnr.
* Verificamos si ya está asignada a entrega
      SELECT SINGLE * FROM vepo JOIN vekp ON vepo~venum = vekp~venum
        INTO CORRESPONDING FIELDS OF l_vepo
       WHERE vbeln     = vbeln
         AND posnr     = l_lips-posnr
         AND vpobj    IN ( &apos;01&apos;, &apos;03&apos; )
         AND vpobjkey  = vbeln.
* Si no encuentro equivalencia en HU es que esa particición no tiene HU asignada
      IF sy-subrc &lt;&gt; 0.
        posnr_sin_hu = l_lips-posnr.
        EXIT.
      ENDIF.
    ENDSELECT.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" VERSION="1" LANGU="S" DESCRIPT="Crea pedido desde VL10A" EXPOSURE="2" STATE="1" EDITORDER="37 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" SCONAME="PEDIDO" VERSION="1" LANGU="S" DESCRIPT="Documento de ventas" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VA"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BDCMODE" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" SCONAME="DIAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="INT2" PARVALUE="-1"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" SCONAME="LOG_EXIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" SCONAME="BAPI" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" SCONAME="VBELN" VERSION="1" LANGU="S" DESCRIPT="Entrega" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10A" SCONAME="WARNING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD crear_desde_vl10a.
    DATA: o_bi      TYPE REF TO zcl_ap_batch_input,
          l_fecha   TYPE dats,
          l_hora    TYPE sy-uzeit,
          l_vbsk    TYPE vbsk,
          l_vbfs    TYPE vbfs,
          l_msg     TYPE bapi_msg,
          l_msgc    TYPE bapi_msg,
          l_pos_ped TYPE i.
    DATA: l_request   TYPE bapideliciousrequest,
          tbl_request TYPE TABLE OF bapideliciousrequest,
          tbl_items   TYPE TABLE OF bapideliciouscreateditems,
          tbl_return  TYPE TABLE OF bapiret2,
          l_return    TYPE bapiret2,
          l_items     TYPE bapideliciouscreateditems.

    __data_set_vart vbap.

    IF bapi IS INITIAL OR modoct = &apos;A&apos;.
      o_bi = NEW #( ).

      o_bi-&gt;inicio( ).
      o_bi-&gt;dynpro( program = &apos;RVV50R10C&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;==S0S_TAB2&apos; ).
      IF dias = -1.
        o_bi-&gt;campos( campo = &apos;ST_LEDAT-HIGH&apos; valor = &apos;&apos; ).
      ELSEIF dias &gt; 0.
        l_fecha = sy-datum + dias.
        o_bi-&gt;campos( campo = &apos;ST_LEDAT-HIGH&apos; valor = l_fecha ).
      ENDIF.
      o_bi-&gt;dynpro( program = &apos;RVV50R10C&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ONLI&apos; ).
      o_bi-&gt;campos( campo = &apos;ST_VBELN-LOW&apos; valor = pedido ).

      o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=&amp;ALL&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=VL01&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=&amp;F03&apos; ).

      o_bi-&gt;dynpro( program = &apos;RVV50R10C&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/EE&apos; ).

      GET TIME.
      l_fecha = sy-datum.
      l_hora  = sy-uzeit.

      message = o_bi-&gt;llamar_transaccion( tcode = &apos;VL10A&apos; modo = modoct ).

      SELECT SINGLE sammg anzlp FROM vbsk               &quot;#EC CI_NOFIELD
        INTO (l_vbsk-sammg, l_vbsk-anzlp)
       WHERE smart  = &apos;L&apos;
         AND ernam  = sy-uname
         AND erdat  = l_fecha
         AND uzeit &gt;= l_hora.
      IF sy-subrc = 0.
        SELECT * FROM vbfs
          INTO l_vbfs
         WHERE sammg = l_vbsk-sammg
           AND ( msgno &lt;&gt; &apos;544&apos; )
           AND msgid &lt;&gt; &apos;&apos;.
          MESSAGE ID l_vbfs-msgid TYPE &apos;S&apos; NUMBER l_vbfs-msgno WITH l_vbfs-msgv1 l_vbfs-msgv2 l_vbfs-msgv3 l_vbfs-msgv4 INTO l_msg.
          __add_lista l_msgc l_msg.
        ENDSELECT.
      ENDIF.

      SELECT SINGLE vbeln FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO vbeln
       WHERE vgbel  = pedido
         AND erdat  = l_fecha
         AND erzet &gt;= l_hora.
      IF sy-subrc = 0.
        CLEAR message.
        warning = l_msgc.

        SELECT COUNT( * ) FROM vbap ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
          INTO l_pos_ped
         WHERE vbeln = pedido
           AND abgru = &apos;&apos;.

        IF l_vbsk-anzlp &lt; l_pos_ped.
          l_msg = zcl_ap_utils=&gt;concat( p1 = &apos;Sólo se han creado&apos; p2 = l_vbsk-anzlp p3 = &apos;pos.en entrega de las&apos; p4 = l_pos_ped p5 = &apos;del pedido&apos; ).
          __add_lista warning l_msg.
        ENDIF.
      ELSE.
        IF message CS &apos;producido un error inesperado&apos;.
          CLEAR message.
        ENDIF.
        IF NOT log_exit IS INITIAL.
          SELECT SINGLE message FROM (zcl_c=&gt;tabla_zlog)
            INTO l_msg
           WHERE proceso   = &apos;EXITS&apos;
             AND clave     = pedido
             AND progname  = log_exit
             AND fecha     = l_fecha
             AND hora     &gt;= l_hora.
          IF sy-subrc = 0.
            __concat2 message l_msg message.
          ENDIF.
        ENDIF.
        IF NOT l_msgc IS INITIAL.
          __concat_a message l_msgc.
        ENDIF.
        IF message IS INITIAL.
          message = &apos;No se ha podido crear la entrega&apos;.
        ENDIF.
      ENDIF.
    ELSE.
      SELECT matnr posnr vbeln vrkme werks zmeng FROM vbap ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO CORRESPONDING FIELDS OF TABLE i_vbap
        WHERE vbeln = pedido
          AND abgru = &apos;&apos;.
      IF sy-subrc &lt;&gt; 0.
        message = &apos;No existen posiciones del pedido&apos;.
      ELSE.
        LOOP AT i_vbap INTO l_vbap.
          l_request-document_numb      = l_vbap-vbeln.
          l_request-document_item      = l_vbap-posnr.
          l_request-quantity_sales_uom = l_vbap-zmeng.
          l_request-quantity_base__uom = l_vbap-zmeng.
          l_request-sales_unit         = l_vbap-vrkme.
          l_request-id                 = 1.
          l_request-document_type      = &apos;A&apos;.
          l_request-delivery_date      = sy-datum.
          l_request-material           = l_vbap-matnr.
          l_request-plant              = l_vbap-werks.
          l_request-date               = sy-datum.
          l_request-goods_issue_date   = sy-datum.
          l_request-goods_issue_time   = sy-uzeit.
          APPEND l_request TO tbl_request.
        ENDLOOP.

        CALL FUNCTION &apos;BAPI_DELIVERYPROCESSING_EXEC&apos;
          TABLES
            request      = tbl_request
            createditems = tbl_items
            return       = tbl_return.

        IF NOT log_exit IS INITIAL.
          SELECT SINGLE message FROM (zcl_c=&gt;tabla_zlog)
            INTO l_msg
           WHERE proceso   = &apos;EXITS&apos;
             AND clave     = pedido
             AND progname  = log_exit
             AND fecha     = l_fecha
             AND hora     &gt;= l_hora.
          IF sy-subrc = 0.
            __concat2 message l_msg message.
          ENDIF.
        ENDIF.
        IF NOT l_msgc IS INITIAL.
          __concat_a message l_msgc.
        ENDIF.
        LOOP AT tbl_return INTO l_return WHERE type = &apos;E&apos;.
          __concat_a message l_return-message.
        ENDLOOP.
        IF tbl_return IS INITIAL AND tbl_items IS INITIAL.
          message = &apos;No se ha creado entrega.&apos;.
        ENDIF.

        LOOP AT tbl_items INTO l_items WHERE document_numb &lt;&gt; &apos;&apos;.
          vbeln = l_items-document_numb.
          l_vbsk-anzlp = l_vbsk-anzlp + 1.
        ENDLOOP.

        IF l_vbsk-anzlp &lt; l_pos_ped.
          l_msg = zcl_ap_utils=&gt;concat( p1 = &apos;Sólo se han creado&apos; p2 = l_vbsk-anzlp p3 = &apos;pos.en entrega de las&apos; p4 = l_pos_ped p5 = &apos;del pedido&apos; ).
          __add_lista warning l_msg.
        ENDIF.

        IF NOT vbeln IS INITIAL.
          CALL FUNCTION &apos;BAPI_TRANSACTION_COMMIT&apos;.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" VERSION="1" LANGU="S" DESCRIPT="Crea pedido desde VL10B" EXPOSURE="2" STATE="1" EDITORDER="32 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" SCONAME="EBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BDCMODE" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" SCONAME="DIAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="INT2" PARVALUE="-1"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" SCONAME="LOG_EXIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" SCONAME="BAPI" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_DESDE_VL10B" SCONAME="WARNING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD crear_desde_vl10b.
    DATA: o_bi      TYPE REF TO zcl_ap_batch_input,
          l_fecha   TYPE dats,
          l_hora    TYPE sy-uzeit,
          l_vbsk    TYPE vbsk,
          l_vbfs    TYPE vbfs,
          l_msg     TYPE bapi_msg,
          l_msgc    TYPE bapi_msg,
          l_pos_ped TYPE i,
          i_ekpo    TYPE STANDARD TABLE OF ekpo.

    DATA: l_request   TYPE bapideliciousrequest,
          tbl_request TYPE TABLE OF bapideliciousrequest,
          tbl_items   TYPE TABLE OF bapideliciouscreateditems,
          tbl_return  TYPE TABLE OF bapiret2,
          l_return    TYPE bapiret2,
          l_items     TYPE bapideliciouscreateditems.

    IF bapi IS INITIAL OR modoct = &apos;A&apos;.
      o_bi = NEW #( ).

      o_bi-&gt;inicio( ).
      o_bi-&gt;dynpro( program = &apos;RVV50R10C&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=S0S_TAB5&apos; ).
      o_bi-&gt;campos( campo = &apos;ST_VSTEL-LOW&apos; valor = &apos;&apos; ).
      IF dias = -1.
        o_bi-&gt;campos( campo = &apos;ST_LEDAT-HIGH&apos; valor = &apos;&apos; ).
      ELSEIF dias &gt; 0.
        l_fecha = sy-datum + dias.
        o_bi-&gt;campos( campo = &apos;ST_LEDAT-HIGH&apos; valor = l_fecha ).
      ENDIF.
      o_bi-&gt;dynpro( program = &apos;RVV50R10C&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ONLI&apos; ).
      o_bi-&gt;campos( campo = &apos;ST_EBELN-LOW&apos; valor = ebeln ).
      o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=&amp;ALL&apos; ).
      o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SAMD&apos; ).
      o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=&amp;F03&apos; ).
      o_bi-&gt;dynpro( program = &apos;RVV50R10C&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/EE&apos; ).

      GET TIME.
      l_fecha = sy-datum.
      l_hora  = sy-uzeit.

      message = o_bi-&gt;llamar_transaccion( tcode = &apos;VL10B&apos; modo = modoct ).

      SELECT SINGLE sammg anzlp FROM vbsk               &quot;#EC CI_NOFIELD
        INTO (l_vbsk-sammg, l_vbsk-anzlp)
       WHERE smart  = &apos;L&apos;
         AND ernam  = sy-uname
         AND erdat  = l_fecha
         AND uzeit &gt;= l_hora.
      IF sy-subrc = 0.
        SELECT * FROM vbfs
          INTO l_vbfs
         WHERE sammg = l_vbsk-sammg
           AND ( msgno &lt;&gt; &apos;544&apos; )
           AND msgid &lt;&gt; &apos;&apos;.
          MESSAGE ID l_vbfs-msgid TYPE &apos;S&apos; NUMBER l_vbfs-msgno WITH l_vbfs-msgv1 l_vbfs-msgv2 l_vbfs-msgv3 l_vbfs-msgv4 INTO l_msg.
          __add_lista l_msgc l_msg.
        ENDSELECT.
      ENDIF.

      SELECT belnr FROM ekbe
        INTO vbeln
        UP TO 1 ROWS
       WHERE ebeln  = ebeln
         AND vgabe  = &apos;8&apos;
         AND bewtp  = &apos;L&apos;
         AND cpudt  = l_fecha
         AND cputm &gt;= l_hora
       ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc = 0.
        CLEAR message.
        warning = l_msgc.

        SELECT COUNT( * ) FROM ekpo ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
          INTO l_pos_ped
         WHERE ebeln = ebeln
           AND loekz = &apos;&apos;.

        IF l_vbsk-anzlp &lt; l_pos_ped.
          l_msg = zcl_ap_utils=&gt;concat( p1 = &apos;Sólo se han creado&apos; p2 = l_vbsk-anzlp p3 = &apos;pos.en entrega de las&apos; p4 = l_pos_ped p5 = &apos;del pedido&apos; ).
          __add_lista warning l_msg.
        ENDIF.
      ELSE.
        IF message CS &apos;producido un error inesperado&apos;.
          CLEAR message.
        ENDIF.
        IF NOT log_exit IS INITIAL.
          SELECT SINGLE message FROM (zcl_c=&gt;tabla_zlog)
            INTO l_msg
           WHERE proceso   = &apos;EXITS&apos;
             AND clave     = ebeln
             AND progname  = log_exit
             AND fecha     = l_fecha
             AND hora     &gt;= l_hora.
          IF sy-subrc = 0.
            __concat2 message l_msg message.
          ENDIF.
        ENDIF.
        IF NOT l_msgc IS INITIAL.
          __concat_a message l_msgc.
        ENDIF.
        IF message IS INITIAL.
          message = &apos;No se ha podido crear la entrega&apos;.
        ENDIF.
      ENDIF.
    ELSE.
      SELECT  ebeln ebelp matnr meins menge werks FROM ekpo ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO CORRESPONDING FIELDS OF TABLE i_ekpo
        WHERE ebeln = ebeln
          AND loekz = &apos;&apos;.
      IF sy-subrc &lt;&gt; 0.
        message = &apos;No existen posiciones del pedido&apos;.
      ELSE.
        LOOP AT i_ekpo ASSIGNING FIELD-SYMBOL(&lt;ekpo&gt;).
          l_request-document_numb      = &lt;ekpo&gt;-ebeln.
          l_request-document_item      = &lt;ekpo&gt;-ebelp.
          l_request-plant              = &lt;ekpo&gt;-werks.
          l_request-quantity_sales_uom = &lt;ekpo&gt;-menge.
          l_request-base_uom           = &lt;ekpo&gt;-meins.
          l_request-material           = &lt;ekpo&gt;-matnr.
          l_request-delivery_date      = sy-datum.
          l_request-document_type      = &apos;B&apos;. &quot; Purchasing Ord
          APPEND l_request TO tbl_request.
          l_pos_ped = l_pos_ped + 1.
        ENDLOOP.

        CALL FUNCTION &apos;BAPI_DELIVERYPROCESSING_EXEC&apos;
          TABLES
            request      = tbl_request
            createditems = tbl_items
            return       = tbl_return.

        IF NOT log_exit IS INITIAL.
          SELECT SINGLE message FROM (zcl_c=&gt;tabla_zlog)
            INTO l_msg
           WHERE proceso   = &apos;EXITS&apos;
             AND clave     = ebeln
             AND progname  = log_exit
             AND fecha     = l_fecha
             AND hora     &gt;= l_hora.
          IF sy-subrc = 0.
            __concat2 message l_msg message.
          ENDIF.
        ENDIF.
        IF NOT l_msgc IS INITIAL.
          __concat_a message l_msgc.
        ENDIF.
        LOOP AT tbl_return INTO l_return WHERE type = &apos;E&apos;.
          __concat_a message l_return-message.
        ENDLOOP.

        IF tbl_return IS INITIAL AND tbl_items IS INITIAL.
          message = &apos;No se ha creado entrega.&apos;.
        ENDIF.

        LOOP AT tbl_items INTO l_items WHERE document_numb &lt;&gt; &apos;&apos;.
          vbeln = l_items-document_numb.
          l_vbsk-anzlp = l_vbsk-anzlp + 1.
        ENDLOOP.

        IF l_vbsk-anzlp &lt; l_pos_ped.
          l_msg = zcl_ap_utils=&gt;concat( p1 = &apos;Sólo se han creado&apos; p2 = l_vbsk-anzlp p3 = &apos;pos.en entrega de las&apos; p4 = l_pos_ped p5 = &apos;del pedido&apos; ).
          __add_lista warning l_msg.
        ENDIF.

        IF NOT vbeln IS INITIAL.
          CALL FUNCTION &apos;BAPI_TRANSACTION_COMMIT&apos;.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_ENTREGA_DESDE_PEDIDO" VERSION="1" LANGU="S" DESCRIPT="Crea entrega desde pedido" EXPOSURE="2" STATE="1" EDITORDER="41 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_ENTREGA_DESDE_PEDIDO" SCONAME="PEDIDO" VERSION="1" LANGU="S" DESCRIPT="Documento de ventas" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VA"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_ENTREGA_DESDE_PEDIDO" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_ENTREGA_DESDE_PEDIDO" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BDCMODE" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_ENTREGA_DESDE_PEDIDO" SCONAME="FECHA" VERSION="1" LANGU="S" DESCRIPT="Campo de tipo DATS" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="DATS" PARVALUE="&apos;99991231&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_ENTREGA_DESDE_PEDIDO" SCONAME="VBELN" VERSION="1" LANGU="S" DESCRIPT="Entrega" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="CREAR_ENTREGA_DESDE_PEDIDO" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD crear_entrega_desde_pedido.
    DATA: l_vstel TYPE vstel,
          o_bi    TYPE REF TO zcl_ap_batch_input.

    SELECT SINGLE vstel FROM vbap ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO l_vstel
     WHERE vbeln  = pedido
       AND vstel &lt;&gt; &apos;&apos;
       AND abgru  = &apos;&apos;.

    o_bi = NEW #( ).

    o_bi-&gt;inicio( ).

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4001&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
    o_bi-&gt;campos( campo = &apos;LIKP-VSTEL&apos; valor = l_vstel ). &quot; Pto.exped./depto.entrada mcía.
    o_bi-&gt;campos( campo = &apos;LV50C-DATBI&apos; valor = fecha ). &quot; Fecha de selección de entrega
    o_bi-&gt;campos( campo = &apos;LV50C-VBELN&apos; valor = pedido ). &quot; Pedido

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

    SET PARAMETER ID &apos;VL&apos; FIELD &apos;&apos;.
    message = o_bi-&gt;llamar_transaccion( tcode = &apos;VL01N&apos; modo = modoct ).

    GET PARAMETER ID &apos;VL&apos; FIELD vbeln.
    IF vbeln IS INITIAL.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = &apos;Error creando entrega&apos; p2 = message msgty = &apos;E&apos; ).
      ENDIF.
    ELSE.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = &apos;Se ha entrega&apos; p2 = vbeln p3 = &apos;desde el pedido&apos; p4 = pedido msgty = &apos;S&apos; ).
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAJE" VERSION="1" LANGU="S" DESCRIPT="Desembalaje" EXPOSURE="2" STATE="1" EDITORDER="9 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAJE" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAJE" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIPS-POSNR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAJE" SCONAME="CHARG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHARG_D" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAJE" SCONAME="LFIMG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAJE" SCONAME="VRKME" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIPS-VRKME" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAJE" SCONAME="EXIDV" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EXIDV"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAJE" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAJE" SCONAME="MENSAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRET2-MESSAGE"/>
  <source>METHOD desembalaje.
    &quot; TODO: parameter CHARG is never used (ABAP cleaner)
    &quot; TODO: parameter LFIMG is only used in commented-out code (ABAP cleaner)
    &quot; TODO: parameter VRKME is never used (ABAP cleaner)

    DATA: l_vekp        TYPE vekp,
          l_vepo        TYPE vepo,
          l_lips        TYPE lips,
          l_exidv       TYPE exidv,
          o_bi          TYPE REF TO zcl_ap_batch_input,
          l_vbfa        TYPE vbfa,
          l_ctd_picking TYPE lipsd-pikmg.

    mensaje = validar_entrega_modificable( vbeln ).
    IF mensaje IS NOT INITIAL.
      RETURN.
    ENDIF.

    SELECT SINGLE venum FROM vekp
      INTO l_vekp-venum
     WHERE exidv = exidv.
    IF sy-subrc &lt;&gt; 0.
      CONCATENATE &apos;No existe la SSCC&apos; exidv INTO mensaje SEPARATED BY space.
      RETURN.
    ENDIF.

    SELECT SINGLE posnr FROM vepo
      INTO l_vepo-posnr
     WHERE venum  = l_vekp-venum
       AND vbeln  = vbeln
       AND posnr &lt;&gt; &apos;&apos;.
    IF sy-subrc = 0.
      SELECT SINGLE * FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO l_lips
       WHERE vbeln = vbeln
         AND posnr = l_vepo-posnr.
    ENDIF.

    WRITE exidv TO l_exidv.

    o_bi = NEW #( ).

    o_bi-&gt;inicio( ).

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
    o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=VERP_T&apos; ).

*  o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos;).
*  o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ALL_INH&apos;).
*  o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;V51VE-VHILM(01)&apos; ).
*
**
*  o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos;).
*  o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=TRSE&apos;).
*  o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;02/03&apos; ).
*
** LIST_DISPLAY: Buscar
*  o_bi-&gt;dynpro( program = &apos;SAPLSEUT&apos; dynpro = &apos;0750&apos;).
*  o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=TRSE&apos;).
*  o_bi-&gt;campos( campo = &apos;SEARCHFOR&apos; valor = l_exidv ).
*  o_bi-&gt;campos( campo = &apos;RADIO_XPANDALL&apos; valor = &apos;X&apos;).
*
**
*  o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos;).
*  o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=TRMK&apos;).
*
**
*  o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos;).
*  o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=HUENTF&apos;).
*
**
*  o_bi-&gt;dynpro( program = &apos;SAPMSSY0&apos; dynpro = &apos;0120&apos;).

    o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=HUSUCH&apos; ).

    o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6001&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ENTR&apos; ).
    o_bi-&gt;campos( campo = &apos;VEKP-EXIDV&apos; valor = l_exidv ).

    o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=HUENTF&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;V51VE-VHILM(01)&apos; ).

    o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=HUENTF&apos; ).

    IF l_lips IS INITIAL.
* Si la HU no tiene asignada ninguna posición de la entrega, grabamos
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH&apos; ).
    ELSE.
* Si no borramos la posición de la entrega
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK&apos; ).

* Pulsamos para seleccionar posición
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

* Entrega                Ventana   Posicionar    Posición
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-uecha ). &quot; Número de posición del documento comercial

* Marcamos la primera fila y puslsamos sobre selección de lotes
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHSP_T&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de selección en dynpros de lista

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-posnr ).

* Borramos posición
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de selección en dynpros de lista
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POLO_T&apos; ).

* Volvemos a la pantalla inicial (picking)
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK_T&apos; ).

* Nos aseguramos que estamos en la pestaÃ±a de picking
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=T\02&apos; ).

* Seleccionamos la posicion
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-uecha ).

** A la cantidad de picking existente, le restamos la que acabamos de borrar
*    SELECT SINGLE lfimg FROM lips
*      INTO l_ctd_entrega
*     WHERE vbeln = vbeln
*       AND posnr = l_lips-uecha.
*
*    CLEAR l_ctd_picking.
*    DATA i_lips TYPE TABLE OF lips.
*
*    SELECT * FROM lips
*      INTO TABLE i_lips
*     WHERE vbeln = vbeln
*       AND posnr NE l_lips-posnr
*       AND uecha = l_lips-uecha.
*    IF sy-subrc = 0.
*      LOOP AT i_lips INTO l_lips2.
*        SELECT rfmng_flo FROM vbfa
*          INTO l_vbfa-rfmng_flo
*          WHERE vbelv = vbeln
*            AND posnv = l_lips2-posnr
*            AND vbtyp_n = &apos;Q&apos;.
*          ADD l_vbfa-rfmng_flo TO l_ctd_picking.
*        ENDSELECT.
*      ENDLOOP.
*    ELSE.
      SELECT SUM( rfmng_flo )  FROM vbfa
        INTO l_vbfa-rfmng_flo
       WHERE vbelv    = vbeln
         AND posnv    = l_lips-uecha
         AND vbeln    = vbeln
         AND posnn   &lt;&gt; l_lips-posnr
         AND vbtyp_n  = &apos;Q&apos;.
      l_ctd_picking = l_vbfa-rfmng_flo.
*    ENDIF.
*    IF l_ctd_entrega &gt; 0.
*      IF l_ctd_picking &gt; l_ctd_entrega.
*        l_ctd_picking = l_ctd_entrega.
*      ENDIF.
*    ENDIF.

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).
      o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = l_ctd_picking ).
    ENDIF.

    mensaje = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = modoct ).

    IF mensaje CS &apos;grabado&apos;.
      CLEAR mensaje.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAR_ENTREGA" VERSION="1" LANGU="S" DESCRIPT="Desembalar entrega" EXPOSURE="2" STATE="1" EDITORDER="6 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAR_ENTREGA" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAR_ENTREGA" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESEMBALAR_ENTREGA" SCONAME="MENSAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRET2-MESSAGE"/>
  <source>METHOD desembalar_entrega.
    DATA o_bi TYPE REF TO zcl_ap_batch_input.

    mensaje = validar_entrega_modificable( vbeln ).
    IF mensaje IS NOT INITIAL.
      RETURN.
    ENDIF.

    SELECT SINGLE vbtyp FROM likp
      INTO @DATA(l_vbtyp)
     WHERE vbeln = @vbeln.
    IF l_vbtyp = &apos;7&apos;.
      DATA(l_tcode) = &apos;VL32N&apos;.
      DATA(l_dynnr) = &apos;4104&apos;.
    ELSE.
      l_tcode = &apos;VL02N&apos;.
      l_dynnr = &apos;4004&apos;.
    ENDIF.

    o_bi = NEW #( ).

    o_bi-&gt;inicio( ).

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = CONV #(  l_dynnr ) ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
    o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=VERP_T&apos; ).

    o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=HUMARKHU&apos; ).

    o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=HUENTF&apos; ).

    o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH&apos; ).

    mensaje = o_bi-&gt;llamar_transaccion( tcode = CONV #( l_tcode ) modo = modoct ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESHACER_PICKING" VERSION="1" LANGU="S" DESCRIPT="Deshacer picking entrega" EXPOSURE="2" STATE="1" EDITORDER="5 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESHACER_PICKING" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESHACER_PICKING" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIPS-POSNR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESHACER_PICKING" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESHACER_PICKING" SCONAME="MOD_CTD_PICKING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESHACER_PICKING" SCONAME="O_LOG" VERSION="1" LANGU="S" DESCRIPT="Log" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="DESHACER_PICKING" SCONAME="MENSAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRET2-MESSAGE"/>
  <source>METHOD deshacer_picking.
    DATA: o_bi    TYPE REF TO zcl_ap_batch_input,
          l_lips  TYPE lips,
          i_lips2 TYPE TABLE OF lips.

    mensaje = validar_entrega_modificable( vbeln ).
    IF mensaje IS NOT INITIAL.
      RETURN.
    ENDIF.

    o_bi = NEW #( ).

    SELECT SINGLE vbtyp FROM likp
      INTO @DATA(l_vbtyp)
     WHERE vbeln = @vbeln.
    IF l_vbtyp = &apos;7&apos;.
      DATA(l_tcode) = &apos;VL32N&apos;.
      DATA(l_dynnr) = &apos;4104&apos;.
    ELSE.
      l_tcode = &apos;VL02N&apos;.
      l_dynnr = &apos;4004&apos;.
    ENDIF.

    IF NOT o_log IS INITIAL.
      o_log-&gt;log( p1 = &apos;Deshaciendo picking&apos; msgty = &apos;I&apos; ).
    ENDIF.

    IF posnr IS INITIAL.
      SELECT posnr FROM lips
        INTO CORRESPONDING FIELDS OF l_lips
        UP TO 1 ROWS
       WHERE vbeln  = vbeln
         AND uecha &lt;&gt; &apos;&apos;.
      ENDSELECT.
      IF sy-subrc &lt;&gt; 0.
        RETURN. &quot; No hay partición de picking.
      ENDIF.

      SELECT posnr FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO CORRESPONDING FIELDS OF TABLE i_lips2
       WHERE vbeln = vbeln
         AND uecha = &apos;&apos;
         AND xchpf = &apos;X&apos;
        ORDER BY vbeln posnr.

    ELSE.
      SELECT posnr FROM lips
        INTO CORRESPONDING FIELDS OF l_lips
        UP TO 1 ROWS
       WHERE vbeln = vbeln
         AND uecha = posnr.
      ENDSELECT.
      IF sy-subrc &lt;&gt; 0.
        RETURN. &quot; No hay partición de picking.
      ENDIF.

      SELECT posnr FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO CORRESPONDING FIELDS OF TABLE i_lips2
       WHERE vbeln = vbeln
         AND posnr = posnr
        ORDER BY vbeln posnr.
    ENDIF.

    LOOP AT i_lips2 INTO l_lips.
      AT FIRST.
        o_bi-&gt;inicio( ).
* Pantalla selcción de entrega
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = CONV #( l_dynnr ) ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
        o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega
      ENDAT.

* Pulsamos para seleccionar posición
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

* Entrega                Ventana   Posicionar    Posición
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-posnr ). &quot; Número de posición del documento comercial

* Marcamos la primera fila y puslsamos sobre selección de lotes
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHSP_T&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de selección en dynpros de lista

* Marcamos todo
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=MKAL_T&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POLO_T&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK_T&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      IF mod_ctd_picking = &apos;X&apos;.
        o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = &apos;&apos; ).
      ENDIF.
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).

      AT LAST.
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

        mensaje = o_bi-&gt;llamar_transaccion( tcode = CONV #( l_tcode ) modo = modoct ).

        IF NOT o_log IS INITIAL.
          o_log-&gt;log( p1 = mensaje msgty = o_bi-&gt;msgty ).
        ENDIF.

        IF o_bi-&gt;msgty = &apos;S&apos; OR mensaje CS &apos;grabado&apos;.
          CLEAR mensaje.
        ENDIF.
      ENDAT.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EFECTUAR_SM" VERSION="1" LANGU="S" DESCRIPT="Efectuar salida de mercancia" EXPOSURE="2" STATE="1" EDITORDER="30 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EFECTUAR_SM" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EFECTUAR_SM" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EFECTUAR_SM" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EFECTUAR_SM" SCONAME="SEGUNDOS_ESPERA_SI_BLOQUEOS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="INT2" PARVALUE="10"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EFECTUAR_SM" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD efectuar_sm.
    DATA: l_tabla TYPE tabname VALUE &apos;VBUK&apos;,
          l_wbstk TYPE vbuk-wbstk,
          o_bi    TYPE REF TO zcl_ap_batch_input.

    IF zcl_c=&gt;hana = &apos;X&apos;.
      l_tabla = &apos;LIKP&apos;.
    ENDIF.

    CLEAR message.

    SELECT SINGLE wbstk FROM (l_tabla)
      INTO l_wbstk
     WHERE vbeln = vbeln.
    IF sy-subrc &lt;&gt; 0.
      __concat2 message &apos;No existe la entrega&apos; vbeln.
    ELSE.
      IF l_wbstk = &apos;C&apos;.
        IF NOT o_log IS INITIAL.
          o_log-&gt;log( p1 = &apos;Entrega&apos; p2 = vbeln p3 = &apos;ya tenía efectuada SM&apos; msgty = &apos;I&apos; ).
        ENDIF.
      ELSE.
        message = espera_si_bloqueada( vbeln = vbeln segundos_espera = segundos_espera_si_bloqueos ).

        IF message IS INITIAL.
          o_bi = NEW #( ).

          o_bi-&gt;inicio( ).

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WABU_T&apos; ).
          o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

          message = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = modoct ).

          espera_si_bloqueada( vbeln = vbeln segundos_espera = segundos_espera_si_bloqueos ).

          CLEAR l_wbstk.
          SELECT SINGLE wbstk FROM (l_tabla)
            INTO l_wbstk
           WHERE vbeln = vbeln.
          IF l_wbstk = &apos;C&apos;.
            IF NOT o_log IS INITIAL.
              o_log-&gt;log( p1 = &apos;Se ha modificado SM de la entrega&apos; p2 = vbeln msgty = &apos;S&apos; ).
            ENDIF.
            CLEAR message.
          ELSE.
            IF NOT o_log IS INITIAL.
              o_log-&gt;log( p1 = &apos;Error efectuando  SM de la entrega&apos; p2 = vbeln p3 = message msgty = &apos;E&apos; ).
            ENDIF.
          ENDIF.
        ELSE.
          IF NOT o_log IS INITIAL.
            o_log-&gt;log( p1 = message msgty = &apos;E&apos; ).
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EMBALAR" VERSION="1" LANGU="S" DESCRIPT="Embalar" EXPOSURE="2" STATE="1" EDITORDER="24 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EMBALAR" SCONAME="I_POS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_EMBALAJE"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EMBALAR" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EMBALAR" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EMBALAR" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="EMBALAR" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD embalar.
    DATA: o_bi    TYPE REF TO zcl_ap_batch_input,
          l_vhilm TYPE vekp-vhilm,
          l_cont  TYPE i.

    FIELD-SYMBOLS &lt;hu&gt; TYPE t_embalaje.

    IF i_pos IS INITIAL.
      message = &apos;No ha informado SSCCs para embalar&apos;.
      RETURN.
    ENDIF.

    SELECT SINGLE vbtyp FROM likp
      INTO @DATA(l_vbtyp)
     WHERE vbeln = @vbeln.
    IF l_vbtyp = &apos;7&apos;.
      DATA(l_tcode) = &apos;VL32N&apos;.
      DATA(l_dynnr) = &apos;4104&apos;.
    ELSE.
      l_tcode = &apos;VL02N&apos;.
      l_dynnr = &apos;4004&apos;.
    ENDIF.

    message = validar_entrega_modificable( vbeln ).
    IF message IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(i_pos2) = i_pos.
    LOOP AT i_pos2 ASSIGNING &lt;hu&gt;.
      SELECT SINGLE venum FROM vekp
        INTO @DATA(l_venum)
       WHERE exidv = @&lt;hu&gt;-exidv
         AND ( vbeln_gen = @vbeln OR vpobjkey = @vbeln ).
      IF sy-subrc &lt;&gt; 0.
        CONTINUE.
      ENDIF.

      SELECT SINGLE venum FROM vepo
        INTO l_venum
       WHERE venum = l_venum.
      IF sy-subrc &lt;&gt; 0.
        CONTINUE.
      ENDIF.

      SELECT SINGLE venum FROM vepo
        INTO l_venum
       WHERE venum = l_venum
         AND matnr = &lt;hu&gt;-matnr
         AND charg = &lt;hu&gt;-charg
         AND vemng = &lt;hu&gt;-lfimg
         AND vemeh = &lt;hu&gt;-vrkme.
      IF sy-subrc = 0.
        DELETE i_pos2.
      ELSE.
        message = |SSCC { &lt;hu&gt;-exidv ALPHA = OUT } ya asignada a entrega, pero no cuadran datos de embalaje|.
        RETURN.
      ENDIF.
    ENDLOOP.

    IF i_pos2 IS INITIAL.
* Todo embalado correctamente.
      RETURN.
    ENDIF.

    o_bi = NEW #( ).

    o_bi-&gt;inicio( ).

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = CONV #( l_dynnr ) ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
    o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=VERP_T&apos; ). &quot; Embalaje

    o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=UE6VDIR&apos; ). &quot; Entrada individual

    LOOP AT i_pos ASSIGNING &lt;hu&gt;.
      o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ENTR&apos; ).
      o_bi-&gt;campos( campo = &apos;VEKP-EXIDV&apos; valor = &lt;hu&gt;-exidv ). &quot; Identificación externa de la unidad de manipulación

      CLEAR l_vhilm.
      SELECT COUNT( * ) FROM vekp
        INTO l_cont
       WHERE exidv = &lt;hu&gt;-exidv.
      IF l_cont = 1.
        SELECT SINGLE venum vhilm FROM vekp
          INTO (l_venum, l_vhilm)
         WHERE exidv = &lt;hu&gt;-exidv.
        SELECT SINGLE venum FROM vepo
          INTO l_venum
         WHERE venum = l_venum.
        IF sy-subrc &lt;&gt; 0.
          CLEAR l_vhilm.
        ENDIF.
      ENDIF.
      IF l_vhilm &lt;&gt; &lt;hu&gt;-vhilm.
        o_bi-&gt;campos( campo = &apos;VEKP-VHILM&apos; valor = &lt;hu&gt;-vhilm ). &quot; Material de embalaje
      ENDIF.
      o_bi-&gt;campos( campo = &apos;HUMV4-MATNR&apos; valor = &lt;hu&gt;-matnr ). &quot; Número de material
      o_bi-&gt;campos( campo = &apos;HUMV4-CHARG&apos; valor = &lt;hu&gt;-charg ). &quot; Número de lote
      o_bi-&gt;campos( campo = &apos;HUMV4-QUANTITY&apos; valor = &lt;hu&gt;-lfimg ). &quot; Cantidad base embalada en posición de unidad manipulación
      o_bi-&gt;campos( campo = &apos;HUMV4-VRKME&apos; valor = &lt;hu&gt;-vrkme ). &quot; Unidad de medida alternativa p.unidad de medida de stock
      o_bi-&gt;campos( campo = &apos;HUMV4-POSNR&apos; valor = &lt;hu&gt;-posnr ).
    ENDLOOP.

    o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH&apos; ).

    message = o_bi-&gt;llamar_transaccion( tcode = CONV #( l_tcode ) modo = modoct ).

    IF o_bi-&gt;msgty = &apos;S&apos;.
      CLEAR message.
      LOOP AT o_bi-&gt;i_mensajes ASSIGNING FIELD-SYMBOL(&lt;message&gt;) WHERE    ( msgnr = &apos;150&apos; OR msgnr = &apos;157&apos; AND msgid = &apos;HUDIALOG&apos; )
                                                                       OR msgid = &apos;HUGENERAL&apos;.
        MESSAGE ID &lt;message&gt;-msgid TYPE &lt;message&gt;-msgtyp NUMBER &lt;message&gt;-msgnr WITH
                &lt;message&gt;-msgv1 &lt;message&gt;-msgv2 &lt;message&gt;-msgv3 &lt;message&gt;-msgv4 INTO DATA(l_msg).
        IF message IS INITIAL.
          message = l_msg.
        ELSE.
          message = |{ message }, { l_msg }|.
        ENDIF.
      ENDLOOP.
    ENDIF.

    IF message IS INITIAL.
* Verificamos que todo esté ok.
      LOOP AT i_pos ASSIGNING &lt;hu&gt;.
        SELECT SINGLE venum FROM vekp
          INTO @l_venum
         WHERE exidv = @&lt;hu&gt;-exidv
           AND ( vbeln_gen = @vbeln OR vpobjkey = @vbeln ).
        IF sy-subrc &lt;&gt; 0.
          message = |La SSCC { &lt;hu&gt;-exidv ALPHA = OUT } no está asignada a la entrega. Revise|.
        ENDIF.
      ENDLOOP.
    ENDIF.

    IF NOT o_log IS INITIAL.
      IF message IS INITIAL.
        o_log-&gt;log( p1 = &apos;Se ha realizado correctamente el embalaje de entrega&apos; p2 = vbeln msgty = &apos;S&apos; ).
      ELSE.
        o_log-&gt;log( p1 = message ).
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ESPERA_SI_BLOQUEADA" VERSION="1" LANGU="S" DESCRIPT="Espera si entrega bloqueada" EXPOSURE="2" STATE="1" EDITORDER="29 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ESPERA_SI_BLOQUEADA" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ESPERA_SI_BLOQUEADA" SCONAME="SEGUNDOS_ESPERA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="INT2" PARVALUE="10"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ESPERA_SI_BLOQUEADA" SCONAME="TIEMPO_ESPERA" VERSION="1" LANGU="S" DESCRIPT="Campo de texto, longitud 10" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="MENGV13" PARVALUE="1"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ESPERA_SI_BLOQUEADA" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD espera_si_bloqueada.
    DATA bloqueada TYPE c LENGTH 1.

    DO segundos_espera TIMES.
      bloqueada = esta_bloqueada( vbeln ).
      IF bloqueada = &apos;X&apos;.
        __concat4 message &apos;Entrega&apos; vbeln &apos;bloqueada por&apos; sy-msgv1.
        WAIT UP TO tiempo_espera SECONDS.
      ELSE.
        CLEAR message.
        EXIT.
      ENDIF.
    ENDDO.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ESTA_BLOQUEADA" VERSION="1" LANGU="S" DESCRIPT="Entrega bloqueada" EXPOSURE="2" STATE="1" EDITORDER="27 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ESTA_BLOQUEADA" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="ESTA_BLOQUEADA" SCONAME="BLOQUEADA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ABAP_BOOL"/>
  <source>METHOD esta_bloqueada.
    bloqueada = zcl_ap_utils=&gt;comprobar_bloqueo( tabla  = &apos;LIKP&apos;
                                                 clave  = sy-mandt
                                                 clave2 = vbeln ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_ENTREGA" VERSION="1" LANGU="S" DESCRIPT="Devuelve la cantidad de la entrega" EXPOSURE="2" STATE="1" EDITORDER="14 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_ENTREGA" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_ENTREGA" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_ENTREGA" SCONAME="UNIDAD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_ENTREGA" SCONAME="CANTIDAD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="MENGV13"/>
  <source>METHOD get_ctd_entrega.
    DATA: l_lips TYPE lips,
          i_lips TYPE TABLE OF lips.

    IF posnr IS INITIAL.
      SELECT matnr SUM( lfimg ) meins FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO (l_lips-matnr, l_lips-lfimg, l_lips-meins)
       WHERE vbeln = vbeln
      GROUP BY matnr meins.
        APPEND l_lips TO i_lips.
      ENDSELECT.
    ELSE.
      SELECT matnr SUM( lfimg ) meins FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO (l_lips-matnr, l_lips-lfimg, l_lips-meins)
       WHERE vbeln = vbeln
         AND ( posnr = posnr OR uecha = posnr )
      GROUP BY matnr meins.
        APPEND l_lips TO i_lips.
      ENDSELECT.
    ENDIF.

    IF NOT unidad IS INITIAL.
      LOOP AT i_lips INTO l_lips.
        IF unidad &lt;&gt; l_lips-meins.
          l_lips-lfimg = zcl_ap_material=&gt;convertir_unidad( matnr          = l_lips-matnr
                                                            unidad_origen  = l_lips-meins
                                                            unidad_destino = unidad
                                                            cantidad       = l_lips-lfimg ).
        ENDIF.
        cantidad = cantidad + l_lips-lfimg.
      ENDLOOP.
    ELSE.
      LOOP AT i_lips INTO l_lips.
        cantidad = cantidad + l_lips-lfimg.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_PICKING" VERSION="1" LANGU="S" DESCRIPT="Devuelve cantidad de picking" EXPOSURE="2" STATE="1" EDITORDER="17 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_PICKING" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_PICKING" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_PICKING" SCONAME="ADD_SUBPOS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_PICKING" SCONAME="BUFFER" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_PICKING" SCONAME="SELECT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_PICKING" SCONAME="PIKMG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="PIKMG"/>
  <source>METHOD get_ctd_picking.
    DATA: l_tabla TYPE tabname VALUE &apos;VBUP&apos;,
          l_kosta TYPE vbup-kosta,
          l_ctd   TYPE pikmg.

    IF zcl_c=&gt;hana = &apos;X&apos;.
      l_tabla = &apos;LIPS&apos;.
    ENDIF.

    SELECT SINGLE kosta FROM (l_tabla)
      INTO l_kosta
     WHERE vbeln = vbeln
       AND posnr = posnr.
    IF l_kosta IS INITIAL.
      CLEAR pikmg.
    ELSEIF l_kosta = &apos;C&apos; AND buffer &lt;&gt; &apos;N&apos;.
      SELECT SINGLE lfimg FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO pikmg
     WHERE vbeln = vbeln
       AND posnr = posnr.
    ELSE.
      IF select = &apos;X&apos;.
        SELECT SUM( rfmng ) FROM vbfa
          INTO pikmg
         WHERE vbelv   = vbeln
           AND posnv   = posnr
           AND vbtyp_n = &apos;Q&apos;.
      ELSE.
        IF buffer IS INITIAL OR buffer = &apos;N&apos;.
          CALL FUNCTION &apos;WB2_EXP_READ_DOCFLOW_REFRESH&apos;.
        ENDIF.

        CALL FUNCTION &apos;WB2_GET_PICK_QUANTITY&apos;
          EXPORTING
            i_vbeln             = vbeln
            i_posnr             = posnr
*           I_MODE              = &apos; &apos;
          IMPORTING
            e_pikmg             = pikmg
          EXCEPTIONS
            document_read_error = 1
            OTHERS              = 2.
      ENDIF.
      IF sy-subrc &lt;&gt; 0.
        IF zcl_c=&gt;hana IS INITIAL.
          SELECT lfimg FROM lips JOIN vbup ON  lips~vbeln = vbup~vbeln ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
                                           AND lips~posnr = vbup~posnr
             INTO pikmg
            UP TO 1 ROWS
            WHERE lips~vbeln = vbeln
              AND lips~posnr = posnr
              AND vbup~kosta = &apos;C&apos;
            ORDER BY lips~vbeln lips~posnr.
          ENDSELECT.
        ELSE.
          SELECT lfimg FROM (l_tabla)
             INTO pikmg
            UP TO 1 ROWS
            WHERE vbeln = vbeln
              AND posnr = posnr
              AND kosta = &apos;C&apos;
            ORDER BY vbeln posnr.
          ENDSELECT.
        ENDIF.
      ENDIF.
    ENDIF.

    IF add_subpos = &apos;X&apos;.
      IF zcl_c=&gt;hana IS INITIAL.
        SELECT SUM( lfimg ) FROM lips JOIN vbup ON  lips~vbeln = vbup~vbeln ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
                                                AND lips~posnr = vbup~posnr
           INTO l_ctd
          WHERE lips~vbeln = vbeln
            AND uecha      = posnr
            AND vbup~kosta = &apos;C&apos;.
      ELSE.
        SELECT SUM( lfimg ) FROM (l_tabla)
           INTO l_ctd
          WHERE vbeln = vbeln
            AND uecha = posnr
            AND kosta = &apos;C&apos;.
      ENDIF.

      pikmg = pikmg + l_ctd.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_POS" VERSION="1" LANGU="S" DESCRIPT="Devuelve cantidad de posición incluyendo subposiciones" EXPOSURE="2" STATE="1" EDITORDER="18 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_POS" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_POS" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_POS" SCONAME="ADD_SUBPOS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_POS" SCONAME="LFIMG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="LFIMG"/>
  <source>METHOD get_ctd_pos.
    IF add_subpos = &apos;X&apos;.
      SELECT SUM( lfimg ) FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO lfimg
       WHERE vbeln = vbeln
         AND ( posnr = posnr OR uecha = posnr ).
    ELSE.
      SELECT SUM( lfimg ) FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO lfimg
       WHERE vbeln = vbeln
         AND posnr = posnr.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_SM" VERSION="1" LANGU="S" DESCRIPT="Devuelve la cantidad de las salidas de mercancía" EXPOSURE="2" STATE="1" EDITORDER="15 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_SM" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_SM" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_SM" SCONAME="UNIDAD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_CTD_SM" SCONAME="CANTIDAD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="MENGV13"/>
  <source>METHOD get_ctd_sm.
    TYPES: BEGIN OF t_lips,
             matnr TYPE matnr,
             lfimg TYPE mengv13,
             meins TYPE meins,
             bwart TYPE bwart,
           END OF t_lips.

    DATA: l_lips TYPE t_lips,
          i_lips TYPE TABLE OF t_lips.

    IF posnr IS INITIAL.
      SELECT matnr SUM( rfmng ) meins bwart FROM vbfa
        INTO (l_lips-matnr, l_lips-lfimg, l_lips-meins, l_lips-bwart)
       WHERE vbelv  = vbeln
         AND bwart IN ( &apos;601&apos;, &apos;602&apos; )
      GROUP BY matnr meins bwart.
        IF l_lips-bwart = &apos;602&apos;.
          l_lips-lfimg = - l_lips-lfimg.
        ENDIF.
        APPEND l_lips TO i_lips.
      ENDSELECT.
    ELSE.
      SELECT matnr SUM( rfmng ) meins bwart FROM vbfa
        INTO (l_lips-matnr, l_lips-lfimg, l_lips-meins, l_lips-bwart)
       WHERE vbelv  = vbeln
         AND posnv  = posnr
         AND bwart IN ( &apos;601&apos;, &apos;602&apos; )
      GROUP BY matnr meins bwart.
        IF l_lips-bwart = &apos;602&apos;.
          l_lips-lfimg = - l_lips-lfimg.
        ENDIF.
        APPEND l_lips TO i_lips.
      ENDSELECT.
    ENDIF.

    IF NOT unidad IS INITIAL.
      LOOP AT i_lips INTO l_lips.
        IF unidad &lt;&gt; l_lips-meins.
          l_lips-lfimg = zcl_ap_material=&gt;convertir_unidad( matnr          = l_lips-matnr
                                                            unidad_origen  = l_lips-meins
                                                            unidad_destino = unidad
                                                            cantidad       = l_lips-lfimg ).
        ENDIF.
        cantidad = cantidad + l_lips-lfimg.
      ENDLOOP.
    ELSE.
      LOOP AT i_lips INTO l_lips.
        cantidad = cantidad + l_lips-lfimg.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_DIRECCION" VERSION="1" LANGU="S" DESCRIPT="Devuelve dirección de destinatario" EXPOSURE="2" STATE="1" EDITORDER="7 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_DIRECCION" SCONAME="KUNNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="KUNNR" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_DIRECCION" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_DIRECCION" SCONAME="AMPLIADA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_DIRECCION" SCONAME="DIRECCION" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="STRING"/>
  <source>METHOD get_direccion.
    DATA: l_kunnr  TYPE kunnr,
          ls_kupav TYPE kupav,
          lf_txtpa TYPE ad_line_s.

    IF NOT kunnr IS INITIAL.
      l_kunnr = kunnr.
    ELSE.
      SELECT SINGLE kunnr FROM likp
        INTO l_kunnr
       WHERE vbeln = vbeln.
    ENDIF.

    SELECT SINGLE adrnr FROM kna1
      INTO ls_kupav-adrnr
     WHERE kunnr = l_kunnr.

    IF ampliada IS INITIAL.
      ls_kupav-address_type = &apos;1&apos;.

      CALL FUNCTION &apos;SD_ADDRESS_BUILD&apos;
        EXPORTING
          i_kupav = ls_kupav
        IMPORTING
          e_txtpa = lf_txtpa.
*    tables
*      xvbadr  = ct_xvbadr.

      direccion = lf_txtpa.
    ELSE.
      direccion = zcl_ap_direcciones=&gt;get_direccion_stringf( adrnr = ls_kupav-adrnr ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FACTURA" VERSION="1" LANGU="S" DESCRIPT="Devuelve factura" EXPOSURE="2" STATE="1" EDITORDER="43 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FACTURA" SCONAME="VBELN" VERSION="1" LANGU="S" DESCRIPT="Entrega" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FACTURA" SCONAME="FACTURAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FACTURA" SCONAME="FACTURA" VERSION="1" LANGU="S" DESCRIPT="Factura" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="VBELN_VF"/>
  <source>METHOD get_factura.
    CLEAR: factura, facturas.

    SELECT vbfa~vbeln, vbfa~erdat, SUM( rfmng_flt ) AS ctd FROM vbfa JOIN vbrk ON vbfa~vbeln = vbrk~vbeln
      INTO TABLE @DATA(i_facturas)
     WHERE vbelv   = @vbeln
       AND vbtyp_n = &apos;M&apos; &quot; Factura
       AND stufe   = 0
       AND fksto   = &apos;&apos;  &quot; No anulada
     GROUP BY vbfa~vbeln, vbfa~erdat.

    SORT i_facturas BY ctd DESCENDING erdat DESCENDING.
    LOOP AT i_facturas ASSIGNING FIELD-SYMBOL(&lt;fact&gt;).
      IF factura IS INITIAL.
        factura = &lt;fact&gt;-vbeln.
      ENDIF.
      __add_lista facturas &lt;fact&gt;-vbeln.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FECHA_HORA_INICIO" VERSION="1" LANGU="S" DESCRIPT="Recupera fecha/hora de eventos de cabecera" EXPOSURE="2" STATE="1" EDITORDER="38 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FECHA_HORA_INICIO" SCONAME="VBELN" VERSION="1" LANGU="S" DESCRIPT="Entrega" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FECHA_HORA_INICIO" SCONAME="HANDLE" VERSION="1" LANGU="S" DESCRIPT="Clave unívoca mundial para LIKP-VBELN" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-HANDLE" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FECHA_HORA_INICIO" SCONAME="TIPO_FECHA" VERSION="1" LANGU="S" DESCRIPT="&apos;WSHDR0003&apos; &quot;Fecha descarga" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TSEGE-EVEN" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FECHA_HORA_INICIO" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="0-Plan, 1-Real" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TSEGE-EVEN_VERTY" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FECHA_HORA_INICIO" SCONAME="FECHA" VERSION="1" LANGU="S" DESCRIPT="Campo de tipo DATS" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="DATS"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_FECHA_HORA_INICIO" SCONAME="HORA" VERSION="1" LANGU="S" DESCRIPT="Hora del día" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="UZEIT"/>
  <source>METHOD get_fecha_hora_inicio.
    DATA: l_handle     TYPE likp-handle,
          l_even_tstfr TYPE tsege-even_tstfr,
          l_even_zonfr TYPE tsege-even_zonfr.

    IF handle IS INITIAL.
      SELECT SINGLE handle FROM likp
        INTO l_handle
       WHERE vbeln = vbeln.
    ELSE.
      l_handle = handle.
    ENDIF.

    IF NOT l_handle IS INITIAL.
      SELECT SINGLE even_tstfr even_zonfr FROM tsege
        INTO (l_even_tstfr, l_even_zonfr)
       WHERE head_hdl   = l_handle
         AND even       = tipo_fecha
         AND even_verty = tipo.
      IF sy-subrc = 0 AND NOT l_even_tstfr IS INITIAL.
        zcl_ap_fechas=&gt;timestamp_2_fechahora( EXPORTING timestamp = l_even_tstfr
                                                        tzone     = l_even_zonfr
                                              IMPORTING fecha     = fecha
                                                        hora      = hora ).
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_LOTE_ORIGEN_PEDIDO" VERSION="1" LANGU="S" DESCRIPT="Verifica si el lote de la entrega procede del pedido" EXPOSURE="2" STATE="1" EDITORDER="44 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_LOTE_ORIGEN_PEDIDO" SCONAME="VBELN" VERSION="1" LANGU="S" DESCRIPT="Entrega" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_LOTE_ORIGEN_PEDIDO" SCONAME="POSNR" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento comercial" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_LOTE_ORIGEN_PEDIDO" SCONAME="CHARG" VERSION="1" LANGU="S" DESCRIPT="Número de lote" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="CHARG_D"/>
  <source>METHOD get_lote_origen_pedido.
    SELECT SINGLE charg, vgbel, vgpos FROM lips  ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO (@DATA(l_lote_entrega), @DATA(l_vgbel), @DATA(l_vgpos))
     WHERE vbeln = @vbeln
       AND posnr = @posnr.
    IF NOT l_lote_entrega IS INITIAL.
      IF NOT l_vgbel IS INITIAL.
        SELECT SINGLE charg FROM vbap  ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
          INTO @DATA(l_lote_pedido)
         WHERE vbeln = @l_vgbel
           AND posnr = @l_vgpos.
        IF l_lote_pedido = l_lote_entrega.
          charg = l_lote_pedido.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_PART_LOTE_SIN_HU" VERSION="1" LANGU="S" DESCRIPT="Devuelve posiciones de entrega de lotes sin HU" EXPOSURE="2" STATE="1" EDITORDER="13 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_PART_LOTE_SIN_HU" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_PART_LOTE_SIN_HU" SCONAME="I_LIPS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="TAB_LIPS"/>
  <source>METHOD get_part_lote_sin_hu.
    DATA: i_lipsp TYPE TABLE OF lips,
          l_lips  TYPE lips,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_vepo  TYPE vepo.

    FIELD-SYMBOLS &lt;lips&gt; TYPE lips.

    CLEAR i_lips.

    SELECT posnr FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO CORRESPONDING FIELDS OF TABLE i_lipsp
     WHERE vbeln = vbeln
       AND uecha = &apos;&apos;.

    LOOP AT i_lipsp ASSIGNING &lt;lips&gt;.
      SELECT * FROM lips                             &quot;#EC CI_SEL_NESTED
        INTO l_lips                                  ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
       WHERE vbeln = vbeln
         AND uecha = &lt;lips&gt;-posnr.

* Verificamos si ya está asignada a entrega
        SELECT SINGLE * FROM vepo JOIN vekp ON vepo~venum = vekp~venum &quot;#EC CI_SEL_NESTED
          INTO CORRESPONDING FIELDS OF l_vepo
         WHERE vbeln     = vbeln
           AND posnr     = l_lips-posnr
           AND vpobj    IN ( &apos;01&apos;, &apos;03&apos; )
           AND vpobjkey  = vbeln.
* Si no encuentro equivalencia en HU es que esa particición no tiene HU asignada
        IF sy-subrc &lt;&gt; 0.
          APPEND l_lips TO i_lips.
        ENDIF.
      ENDSELECT.
    ENDLOOP.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_PEDIDO" VERSION="1" LANGU="S" DESCRIPT="Devuelve primer pedido de la entrega" EXPOSURE="2" STATE="1" EDITORDER="23 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_PEDIDO" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_PEDIDO" SCONAME="PEDIDO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="VBELN_VA"/>
  <source>METHOD get_pedido.
    SELECT vgbel FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1] &quot;#EC CI_EXIT_SELECT
      INTO pedido
     WHERE vbeln  = vbeln
       AND vgbel &lt;&gt; &apos;&apos;.
      SELECT SINGLE vbeln FROM vbak
        INTO pedido
       WHERE vbeln = pedido.
      IF sy-subrc = 0.
        EXIT.
      ENDIF.
    ENDSELECT.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_SOLICITANTEP" VERSION="1" LANGU="S" DESCRIPT="Devuelve solicitante del pedido" EXPOSURE="2" STATE="1" EDITORDER="22 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_SOLICITANTEP" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_SOLICITANTEP" SCONAME="KUNNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="KUNNR"/>
  <source>METHOD get_solicitantep.
    DATA l_pedido TYPE vbeln_va.

    l_pedido = get_pedido( vbeln ).
    IF NOT l_pedido IS INITIAL.
      SELECT SINGLE kunnr FROM vbak
        INTO kunnr
       WHERE vbeln = l_pedido.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_TEXTO_STRING" VERSION="1" LANGU="S" DESCRIPT="Devuelve texto" EXPOSURE="2" STATE="1" EDITORDER="2 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_TEXTO_STRING" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_TEXTO_STRING" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR_VL" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_TEXTO_STRING" SCONAME="ID" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STXH-TDID"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_TEXTO_STRING" SCONAME="SPRAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SPRAS" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_TEXTO_STRING" SCONAME="STRING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="STRING"/>
  <source>METHOD get_texto_string.
    IF posnr IS INITIAL.
      string = zcl_ap_textos=&gt;get_texto_string( id = id object = &apos;VBBK&apos; name = vbeln spras = spras ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_TRANSPORTE" VERSION="1" LANGU="S" DESCRIPT="Devuelve nº de transporte" EXPOSURE="2" STATE="1" EDITORDER="31 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_TRANSPORTE" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_TRANSPORTE" SCONAME="TKNUM" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="TKNUM"/>
  <source>METHOD get_transporte.
    SELECT tknum FROM vttp
      INTO tknum
      UP TO 1 ROWS
     WHERE vbeln = vbeln
      ORDER BY PRIMARY KEY.
    ENDSELECT.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_URL_POR_TITULO_ST" VERSION="1" LANGU="S" DESCRIPT="Devuelve URL por tipo adjunto" EXPOSURE="2" STATE="1" EDITORDER="34 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="VBELN" VERSION="1" LANGU="S" DESCRIPT="Número del documento de compras" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EKKO-EBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="TITULO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="GET_URL_POR_TITULO_ST" SCONAME="URL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="STRING"/>
  <source>METHOD get_url_por_titulo_st.
    DATA: l_clave  TYPE srgbtbrel-instid_a,
          l_titulo TYPE string.

    l_clave = vbeln.
    l_titulo = titulo.
    url = zcl_ap_gos=&gt;get_url_por_titulo_st( tipo   = c_tipo_gos
                                             clave  = l_clave
                                             titulo = l_titulo ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="HAY_MOD" VERSION="1" LANGU="S" DESCRIPT="Verifica si la entrega se ha actualizado en los últimos X se" EXPOSURE="2" STATE="1" EDITORDER="16 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="HAY_MOD" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="HAY_MOD" SCONAME="USERNAME" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CDHDR-USERNAME" PARVALUE="SY-UNAME"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="HAY_MOD" SCONAME="TCODE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CDHDR-TCODE" PARVALUE="&apos;VL02N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="HAY_MOD" SCONAME="SEGUNDOS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="I" PARVALUE="5"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="HAY_MOD" SCONAME="CHANGE_IND" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="CDHDR-CHANGE_IND"/>
  <source>METHOD hay_mod.
    change_ind = zcl_ap_control_cambios=&gt;hay_mod(
                     objectclas = c_objectclas
                     objectid   = vbeln
                     username   = username
                     tcode      = tcode
                     segundos   = segundos ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION" VERSION="1" LANGU="S" DESCRIPT="Inserta nueva posición" EXPOSURE="2" STATE="1" EDITORDER="20 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION" SCONAME="LIPS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIPS"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION" SCONAME="I_RETURN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRET2_T"/>
  <source>METHOD insertar_nueva_posicion ##NEEDED.
*    DATA: ls_vbkok         TYPE vbkok,
*          ls_delivery_head TYPE likpvb,
*          lt_new_items     TYPE TABLE OF /spe/add_delivery_item,
*          ls_new_items     TYPE /spe/add_delivery_item,
*          ls_return        TYPE bapiret2,
*          is_vbkok         TYPE vbkok,
*          lv_posnr         TYPE lips-posnr,
*          lv_meins         TYPE meins.
*
*
*    ls_delivery_head-vbeln = lips-vbeln.
*    ls_delivery_head-spe_le_scenario = &apos;S&apos;. &quot; STO (Stock Transfer Order)
*    &quot; Get last item number in delivery
*    SELECT SINGLE MAX( posnr )
*      FROM lips
*      INTO lv_posnr
*      WHERE vbeln = lips-vbeln
*        AND posnr &lt; &apos;900000&apos;.
*    &quot; Set new item number in delivery
*    ADD 10 TO lv_posnr.
*    &quot; get uom for material
*    SELECT SINGLE meins
*      FROM mara
*      INTO lv_meins
*      WHERE matnr = lips-matnr.
*    &quot; Set new item data
**    ls_new_items-rfpos  = lv_posnr.
*    ls_new_items-matnr  = lips-matnr.
*    ls_new_items-pstyv  = lips-pstyv.
*    ls_new_items-lfimg  = lips-lfimg.
*    ls_new_items-vrkme  = lips-vrkme.
*    ls_new_items-werks  = lips-werks.
*    ls_new_items-lgort  = lips-lgort.
*    ls_new_items-vbeln  = lips-vbeln.
*    ls_new_items-posnr  = lv_posnr.
*    ls_new_items-meins  = lv_meins.
*    APPEND ls_new_items TO lt_new_items.
*    &quot; Set new item to delivey
*    CALL FUNCTION &apos;/SPE/OUTB_DLV_CHG_ITEMS_INSERT&apos;
*      EXPORTING
*        if_delivery_number = lips-vbeln
*        is_vbkok           = ls_vbkok
*        is_delivery_head   = ls_delivery_head
*      TABLES
*        it_new_items       = lt_new_items
*        et_return          = i_return.
*
*    READ TABLE i_return WITH KEY type = &apos;E&apos; INTO ls_return.
*    IF sy-subrc NE 0.
*      CALL FUNCTION &apos;BAPI_TRANSACTION_COMMIT&apos;
*        EXPORTING
*          wait = &apos;X&apos;.
*    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION_CT" VERSION="1" LANGU="S" DESCRIPT="Inserta nueva posición (Call transaction)" EXPOSURE="2" STATE="1" EDITORDER="21 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION_CT" SCONAME="LIPS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIPS"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION_CT" SCONAME="MODO_BI" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION_CT" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_NUEVA_POSICION_CT" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR"/>
  <source>METHOD insertar_nueva_posicion_ct.
    DATA: l_vbtyp     TYPE likp-vbtyp,
          l_tcode     TYPE sy-tcode,
          l_dynnr     TYPE bdcdata-dynpro,
          l_posnr_max TYPE lips-posnr,
          o_bi        TYPE REF TO zcl_ap_batch_input,
          l_vbap      TYPE vbap,
          l_vbep      TYPE vbep.

    SELECT SINGLE vbtyp FROM likp
      INTO l_vbtyp
     WHERE vbeln = lips-vbeln.
    IF l_vbtyp = &apos;7&apos;.
      l_tcode = &apos;VL32N&apos;.
      l_dynnr = &apos;4104&apos;.
    ELSE.
      l_tcode = &apos;VL02N&apos;.
      l_dynnr = &apos;4004&apos;.
    ENDIF.

    SELECT MAX( posnr ) FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO l_posnr_max
     WHERE vbeln = lips-vbeln
       AND posnr &lt; &apos;900000&apos;.

    o_bi = NEW #( ).

    o_bi-&gt;inicio( ).

    IF NOT lips-vgbel IS INITIAL AND NOT lips-vgpos IS INITIAL.
      SELECT SINGLE * FROM vbap ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        INTO l_vbap
       WHERE vbeln = lips-vgbel
         AND posnr = lips-vgpos.
    ENDIF.

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = l_dynnr ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
    o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = lips-vbeln ). &quot; Entrega

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
    IF NOT l_vbap IS INITIAL.
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=RAUF_T&apos; ).
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0105&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ENT1&apos; ).

      SELECT SINGLE edatu FROM vbep
        INTO l_vbep-edatu
       WHERE vbeln = l_vbap-vbeln
         AND posnr = l_vbap-posnr
         AND bmeng &gt; 0
         AND edatu &gt; sy-datum.
      IF sy-subrc = 0.
        o_bi-&gt;campos( campo = &apos;LV50C-DATBI&apos; valor = l_vbep-edatu ). &quot; Pedido
      ENDIF.

      o_bi-&gt;campos( campo = &apos;LV50C-VBELN&apos; valor = l_vbap-vbeln ). &quot; Pedido
      o_bi-&gt;campos( campo = &apos;LV50C-ABPOS&apos; valor = l_vbap-posnr ). &quot; Desde posición
      o_bi-&gt;campos( campo = &apos;LV50C-BIPOS&apos; valor = l_vbap-posnr ). &quot; Desde posición
    ELSE.
* AÃ±adimos una nueva posición a la entrega
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POAN_T&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;LIPS-MATNR(02)&apos; valor = lips-matnr ).
      o_bi-&gt;campos( campo = &apos;LIPSD-G_LFIMG(02)&apos; valor = lips-lfimg ).
      o_bi-&gt;campos( campo = &apos;LIPS-VRKME(02)&apos; valor = lips-vrkme ).
      IF NOT lips-werks IS INITIAL.
        o_bi-&gt;campos( campo = &apos;LIPS-WERKS(02)&apos; valor = lips-werks ).
      ENDIF.
      IF NOT lips-lgort IS INITIAL.
        o_bi-&gt;campos( campo = &apos;LIPS-LGORT(02)&apos; valor = lips-lgort ).
      ENDIF.

    ENDIF.

    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

    message = espera_si_bloqueada( vbeln = lips-vbeln ). &quot; segundos_espera = segundos_espera_si_bloqueos ).

    message = o_bi-&gt;llamar_transaccion( tcode = l_tcode modo = modo_bi ).

    SELECT MAX( posnr ) FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO posnr
     WHERE vbeln = lips-vbeln
       AND posnr &lt; &apos;900000&apos;.
    IF posnr = l_posnr_max.
      CLEAR posnr.
    ELSE.
      CLEAR message.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_URL_GOS_ST" VERSION="1" LANGU="S" DESCRIPT="Insertar URL en entrega" EXPOSURE="2" STATE="1" EDITORDER="35 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="VBELN" VERSION="1" LANGU="S" DESCRIPT="Entrega" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="URL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERTAR_URL_GOS_ST" SCONAME="TITULO" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PAROPTIONL="X"/>
  <source>METHOD insertar_url_gos_st.
    DATA: l_clave  TYPE srgbtbrel-instid_a,
          l_titulo TYPE string,
          l_url    TYPE string.

    l_clave = vbeln.
    l_titulo = titulo.
    l_url = url.
    zcl_ap_gos=&gt;insertar_url_gos_st( tipo   = c_tipo_gos
                                     clave  = l_clave
                                     titulo = l_titulo
                                     url    = l_url ).
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERT_VBFA" VERSION="1" LANGU="S" DESCRIPT="Inserta documento en VBFA" EXPOSURE="2" STATE="1" EDITORDER="36 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERT_VBFA" SCONAME="VBELN" VERSION="1" LANGU="S" DESCRIPT="Entrega" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERT_VBFA" SCONAME="POSNR" VERSION="1" LANGU="S" DESCRIPT="Número de posición del documento comercial" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERT_VBFA" SCONAME="VBELN_N" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERT_VBFA" SCONAME="POSNR_N" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERT_VBFA" SCONAME="MJAHR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="INSERT_VBFA" SCONAME="VBTYP_N" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <source>METHOD insert_vbfa.
    DATA: l_vbfa TYPE vbfavb,
          i_vbfa TYPE TABLE OF vbfavb.

    SELECT SINGLE vbeln vbtyp FROM likp
      INTO (l_vbfa-vbelv, l_vbfa-vbtyp_v)
     WHERE vbeln = vbeln.
    IF sy-subrc &lt;&gt; 0.
      RETURN.
    ENDIF.
    SELECT SINGLE posnr matnr FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO (l_vbfa-posnv, l_vbfa-matnr)
     WHERE vbeln = vbeln
       AND posnr = posnr.
    IF sy-subrc &lt;&gt; 0.
      RETURN.
    ENDIF.

    l_vbfa-vbeln   = vbeln_n.
    l_vbfa-posnn   = posnr_n.
    l_vbfa-mjahr   = mjahr.
    l_vbfa-vbtyp_n = vbtyp_n.

    CASE vbtyp_n.
      WHEN &apos;R&apos;.
        SELECT SINGLE menge meins bwart FROM mseg
          INTO (l_vbfa-rfmng, l_vbfa-meins, l_vbfa-bwart)
         WHERE mblnr = vbeln_n
           AND mjahr = mjahr
           AND zeile = posnr_n.
    ENDCASE.
    l_vbfa-rfmng_flt = l_vbfa-rfmng.
    l_vbfa-rfmng_flo = l_vbfa-rfmng_flt.
    l_vbfa-vrkme     = l_vbfa-meins.
    l_vbfa-updkz     = &apos;I&apos;.
    l_vbfa-erdat     = sy-datum.
    l_vbfa-erzet     = sy-uzeit.
    APPEND l_vbfa TO i_vbfa.

    CALL FUNCTION &apos;RV_DOCUMENT_FLOW_ADD&apos;
      EXPORTING
        f_struktur = &apos;VBFA&apos;
        f_vbeln    = vbeln
      TABLES
        fxtabl     = i_vbfa
        fxvbfa     = i_vbfa.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" VERSION="1" LANGU="S" DESCRIPT="Modificar datos de entrega" EXPOSURE="2" STATE="1" EDITORDER="19 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="I_LIPS_MOD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TAB_LIPS" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="I_LIPS_NEW" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TAB_LIPS" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="I_LIPS_DEL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TAB_LIPS" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="MODO_BI" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="O_LOG" VERSION="1" LANGU="S" DESCRIPT="Log" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="MOD_PESOS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="I_RETURN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRET2_T"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD modificar.
    DATA: lips           TYPE lips,
          return         TYPE bapiret2,
          header_control TYPE bapiobdlvhdrctrlchg,
          header_data    TYPE bapiobdlvhdrchg,
          item_data      TYPE bapiobdlvitemchg,
          item_control   TYPE bapiobdlvitemctrlchg,
          l_lips         TYPE lips,
          i_item_data    TYPE TABLE OF bapiobdlvitemchg,
          i_item_control TYPE TABLE OF bapiobdlvitemctrlchg.

* Primero intentamos insertar, de forma que si falla no hamos el resto!
    LOOP AT i_lips_new INTO lips.
      insertar_nueva_posicion_ct( EXPORTING lips = lips modo_bi = modo_bi IMPORTING message = message ).

      IF NOT message IS INITIAL.
        return-type    = &apos;E&apos;.
        return-message = message.
        APPEND return TO i_return.
      ENDIF.
    ENDLOOP.

    IF message IS NOT INITIAL.
      RETURN.
    ENDIF.

    header_control-deliv_numb = vbeln.
    header_data-deliv_numb = header_control-deliv_numb.

    LOOP AT i_lips_mod INTO lips.
      CLEAR: item_data, item_control.

      item_data-deliv_numb = header_data-deliv_numb.
      item_data-deliv_item = lips-posnr.
      item_data-dlv_qty    = lips-lfimg.
      item_data-batch      = lips-charg.

      IF mod_pesos = &apos;X&apos;.
        item_data-gross_wt   = lips-brgew.
        item_data-net_weight = lips-ntgew.
      ENDIF.

      SELECT SINGLE matnr vrkme umvkz umvkn lfimg charg brgew ntgew FROM lips &quot;#EC CI_SEL_NESTED
        INTO (item_data-material, item_data-sales_unit, item_data-fact_unit_nom, item_data-fact_unit_denom,
              l_lips-lfimg, l_lips-charg, l_lips-brgew, l_lips-ntgew)
       WHERE vbeln = header_data-deliv_numb                                                                     ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
         AND posnr = item_data-deliv_item.

      IF mod_pesos = &apos;X&apos;.
        IF l_lips-brgew &lt;&gt; lips-brgew.
          item_control-gross_wt_flg = &apos;X&apos;.
        ENDIF.

        IF l_lips-ntgew &lt;&gt; lips-ntgew.
          item_control-net_wt_flg = &apos;X&apos;.
        ENDIF.
      ENDIF.

      IF    l_lips-lfimg              &lt;&gt; item_data-dlv_qty OR l_lips-charg &lt;&gt; lips-charg
         OR item_control-gross_wt_flg  = &apos;X&apos;
         OR item_control-net_wt_flg    = &apos;X&apos;.

        IF l_lips-lfimg &lt;&gt; item_data-dlv_qty.
          SELECT SINGLE isocode
            INTO item_data-sales_unit_iso
            FROM t006
           WHERE msehi = item_data-sales_unit.

          IF item_data-sales_unit_iso = item_data-sales_unit.
            item_data-dlv_qty_imunit = item_data-dlv_qty.
          ELSE.
            item_data-dlv_qty_imunit = zcl_ap_material=&gt;convertir_unidad( matnr          = item_data-material
                                                                          cantidad       = item_data-dlv_qty
                                                                          unidad_origen  = item_data-sales_unit
                                                                          unidad_destino = item_data-sales_unit_iso ).
            IF item_data-dlv_qty_imunit IS INITIAL.
              item_data-dlv_qty_imunit = item_data-dlv_qty.
            ENDIF.
          ENDIF.
        ENDIF.

        APPEND item_data TO i_item_data.

        item_control-deliv_numb = header_data-deliv_numb.
        item_control-deliv_item = item_data-deliv_item.
        item_control-chg_delqty = &apos;X&apos;.
        APPEND item_control TO i_item_control.
      ENDIF.
    ENDLOOP.

    LOOP AT i_lips_del INTO lips.
      item_data-deliv_numb = header_data-deliv_numb.
      item_data-deliv_item = lips-posnr.

      SELECT SINGLE matnr vrkme lfimg FROM lips      &quot;#EC CI_SEL_NESTED
        INTO (item_data-material, item_data-sales_unit, item_data-dlv_qty)  ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
       WHERE vbeln = header_data-deliv_numb
         AND posnr = item_data-deliv_item.

      SELECT SINGLE isocode
        INTO item_data-sales_unit_iso
        FROM t006
       WHERE msehi = item_data-sales_unit.

      IF item_data-sales_unit_iso = item_data-sales_unit.
        item_data-fact_unit_nom   = 1.
        item_data-fact_unit_denom = 1.
        item_data-dlv_qty_imunit  = item_data-dlv_qty.
      ELSE.
        item_data-dlv_qty_imunit  = zcl_ap_material=&gt;convertir_unidad( matnr          = item_data-material
                                                                       cantidad       = item_data-dlv_qty
                                                                       unidad_origen  = item_data-sales_unit
                                                                       unidad_destino = item_data-sales_unit_iso ).
        item_data-fact_unit_nom   = 1.
        item_data-fact_unit_denom = 1.

      ENDIF.

      APPEND item_data TO i_item_data.

      item_control-deliv_numb = header_data-deliv_numb.
      item_control-deliv_item = item_data-deliv_item.
      item_control-del_item   = &apos;X&apos;.
      APPEND item_control TO i_item_control.
    ENDLOOP.

    IF i_item_data IS INITIAL.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = &apos;No hay nada que modificar&apos; msgty = &apos;W&apos; ).
      ENDIF.
    ELSE.
      CALL FUNCTION &apos;BAPI_OUTB_DELIVERY_CHANGE&apos;
        EXPORTING
          header_data    = header_data
          header_control = header_control
          delivery       = header_data-deliv_numb
*         TECHN_CONTROL  =
*         HEADER_DATA_SPL   =
*         HEADER_CONTROL_SPL            =
*         SENDER_SYSTEM  =
        TABLES
*         HEADER_PARTNER =
*         HEADER_PARTNER_ADDR           =
*         HEADER_DEADLINES  =
          item_data      = i_item_data
          item_control   = i_item_control
*         ITEM_SERIAL_NO =
*         SUPPLIER_CONS_DATA            =
*         EXTENSION1     =
*         EXTENSION2     =
          return         = i_return.
*     TOKENREFERENCE =
*     ITEM_DATA_SPL  =
*     COLLECTIVE_CHANGE_ITEMS       =
*     new_item_data  = new_item_data
*     new_item_data_spl = new_item_data_spl.
*     new_item_org   = new_item_org
*     ITEM_DATA_DOCU_BATCH          =

      LOOP AT i_return INTO return WHERE message IS INITIAL.
        MESSAGE ID return-id TYPE return-type NUMBER return-number WITH return-message_v1 return-message_v2
                INTO message.
        return-message = message.
        MODIFY i_return FROM return.
      ENDLOOP.
      LOOP AT i_return INTO return WHERE type = &apos;E&apos;.
        __add_lista message return-message.
      ENDLOOP.

      IF NOT o_log IS INITIAL.
        IF i_return IS INITIAL.
          o_log-&gt;log( p1 = &apos;¿Se ha modificado la entrega?&apos; msgty = &apos;W&apos; ).
        ELSE.
          o_log-&gt;set_tabla_log_from_bapiret2_t( i_return ).
        ENDIF.
      ENDIF.

      IF message IS INITIAL AND commit = &apos;X&apos;.
        zcl_ap_dev=&gt;commit( dequeue_all = &apos;X&apos; ).
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_CTD_PICKING" VERSION="1" LANGU="S" DESCRIPT="Modificar Cantidades de picking" EXPOSURE="2" STATE="1" EDITORDER="42 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_CTD_PICKING" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_CTD_PICKING" SCONAME="I_POS" VERSION="1" LANGU="S" DESCRIPT="Table Type of VBPOK" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_VBPOK" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_CTD_PICKING" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_CTD_PICKING" SCONAME="MODO_BI" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_CTD_PICKING" SCONAME="O_LOG" VERSION="1" LANGU="S" DESCRIPT="Log" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_CTD_PICKING" SCONAME="I_RETURN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRET2_T"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_CTD_PICKING" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD modificar_ctd_picking ##NEEDED.
    &quot; TODO: parameter MODO_BI is never used (ABAP cleaner)
    &quot; TODO: parameter O_LOG is never used (ABAP cleaner)

    DATA: l_vbkok       TYPE vbkok,
          i_vbpok       TYPE TABLE OF vbpok,
          l_ctd_pick_ot TYPE vbfa-rfmng,
          i_prot        TYPE TABLE OF prott,
          l_return      TYPE bapiret2.
    DATA o_bi TYPE REF TO zcl_ap_batch_input.

    l_vbkok-vbeln_vl = vbeln.
    SELECT SINGLE vbtyp FROM likp
      INTO l_vbkok-vbtyp_vl
     WHERE vbeln = vbeln.
    l_vbkok-vbeln = vbeln.

    i_vbpok = i_pos.

    LOOP AT i_vbpok ASSIGNING FIELD-SYMBOL(&lt;pos&gt;).
      &lt;pos&gt;-vbeln_vl = vbeln.
      IF NOT &lt;pos&gt;-posnn IS INITIAL.
        &lt;pos&gt;-posnr_vl = &lt;pos&gt;-posnn.
      ENDIF.
      &lt;pos&gt;-vbeln = vbeln.
      &lt;pos&gt;-kzfme = &apos;X&apos;.

      IF NOT &lt;pos&gt;-charg IS INITIAL.
        &lt;pos&gt;-charg = &lt;pos&gt;-charg.
      ENDIF.
      IF NOT &lt;pos&gt;-vrkme IS INITIAL.
        &lt;pos&gt;-vrkme = &lt;pos&gt;-vrkme.
      ELSE.
        SELECT SINGLE vrkme FROM lips
          INTO &lt;pos&gt;-vrkme
         WHERE vbeln = vbeln
           AND posnr = &lt;pos&gt;-posnn.
      ENDIF.
      IF NOT &lt;pos&gt;-lgort IS INITIAL.
        SELECT SINGLE werks lgort FROM lips
          INTO CORRESPONDING FIELDS OF &lt;pos&gt;
         WHERE vbeln = vbeln
           AND posnr = &lt;pos&gt;-posnn.
      ENDIF.
    ENDLOOP.
    DATA(i_vbpok_orig) = i_vbpok.
    LOOP AT i_vbpok ASSIGNING &lt;pos&gt;.
      CLEAR l_ctd_pick_ot.
      SELECT SUM( rfmng ) FROM vbfa
        INTO l_ctd_pick_ot
       WHERE vbelv    = vbeln
         AND posnv    = &lt;pos&gt;-posnr_vl
         AND vbtyp_n  = &apos;Q&apos;
         AND vbeln   &lt;&gt; vbeln.
      IF l_ctd_pick_ot &gt; 0. &quot; Si hay cantidades de pocking por OT la función no hace el picking correctamente.
        IF l_ctd_pick_ot &gt; &lt;pos&gt;-pikmg.
*        &lt;pos&gt;-pikmg = - ( l_ctd_pick_ot - &lt;pos&gt;-pikmg ).
*        &lt;pos&gt;-plmin = &apos;-&apos;.
          DATA(l_error_ot) = &apos;X&apos;.
        ELSE.
          &lt;pos&gt;-pikmg = &lt;pos&gt;-pikmg - l_ctd_pick_ot.
          &lt;pos&gt;-plmin = &apos;+&apos;.
        ENDIF.
      ENDIF.
    ENDLOOP.

    IF l_error_ot = &apos;X&apos; AND lines( i_vbpok ) = 1.
      o_bi = NEW #( ).

      o_bi-&gt;inicio( ).

* Initial Screen: Create/Change Outbound Delivery
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; okcode = &apos;=ENT2&apos; ).
      o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; okcode = &apos;=POPO_T&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; okcode = &apos;=WEIT&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = i_vbpok[ 1 ]-posnr_vl ).

* Delivery: Item Overview (Subscreen Container)
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; okcode = &apos;=SICH_T&apos; ).
      o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = i_vbpok[ 1 ]-pikmg ).

      message = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = &apos;N&apos; ).
      DATA(l_pikmg2) = zcl_ap_entregas=&gt;get_ctd_picking( vbeln = vbeln posnr = i_vbpok[ 1 ]-posnr_vl select = &apos;X&apos; add_subpos = &apos;&apos; buffer = &apos;N&apos; ).
      IF l_pikmg2 = i_vbpok[ 1 ]-pikmg.
        CLEAR message.
        RETURN.
      ENDIF.
    ELSE.
      CALL FUNCTION &apos;WS_DELIVERY_UPDATE_2&apos;
        EXPORTING
          vbkok_wa             = l_vbkok
          synchron             = &apos;X&apos;
          commit               = commit
          delivery             = vbeln
          update_picking       = &apos;X&apos;
          nicht_sperren_1      = &apos;X&apos;
          if_confirm_central   = &apos; &apos;
          if_database_update_1 = &apos;1&apos;
        TABLES
          vbpok_tab            = i_vbpok
          prot                 = i_prot.

      LOOP AT i_prot ASSIGNING FIELD-SYMBOL(&lt;prot&gt;).
        CLEAR l_return.
        MOVE-CORRESPONDING &lt;prot&gt; TO l_return.
        MESSAGE ID &lt;prot&gt;-msgid TYPE &apos;S&apos; NUMBER &lt;prot&gt;-msgno WITH &lt;prot&gt;-msgv1 &lt;prot&gt;-msgv2 &lt;prot&gt;-msgv3 &lt;prot&gt;-msgv4 INTO l_return-message.
        APPEND l_return TO i_return.

        IF &lt;prot&gt;-msgty = &apos;E&apos;.
          message = l_return-message.
        ENDIF.
      ENDLOOP.
    ENDIF.

    IF message IS INITIAL AND commit = &apos;X&apos;.
      LOOP AT i_vbpok_orig ASSIGNING &lt;pos&gt;.
        DATA(l_pikmg) = zcl_ap_entregas=&gt;get_ctd_picking( vbeln = vbeln posnr = &lt;pos&gt;-posnr_vl select = &apos;X&apos; add_subpos = &apos;&apos; buffer = &apos;N&apos; ).
        IF l_pikmg &lt;&gt; &lt;pos&gt;-pikmg.
          message = |No se ha realizado correctamente el picking en posición { &lt;pos&gt;-posnr_vl ALPHA = OUT }|.
        ENDIF.
      ENDLOOP.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_FECHA_SM" VERSION="1" LANGU="S" DESCRIPT="Modificar fecha salida de mercancías" EXPOSURE="2" STATE="1" EDITORDER="28 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_FECHA_SM" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_FECHA_SM" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_FECHA_SM" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="BDCMODE" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_FECHA_SM" SCONAME="FORZAR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_FECHA_SM" SCONAME="WADAT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-WADAT_IST"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_FECHA_SM" SCONAME="SEGUNDOS_ESPERA_SI_BLOQUEOS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="INT2" PARVALUE="10"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_FECHA_SM" SCONAME="TAB" VERSION="1" LANGU="S" DESCRIPT="Ha veces es necesario poner =T\06" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="MODIFICAR_FECHA_SM" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD modificar_fecha_sm.
    DATA: l_wadat     TYPE wadat,
          o_bi        TYPE REF TO zcl_ap_batch_input,
          l_wadat_new TYPE wadat.

    CLEAR message.
    IF wadat IS INITIAL.
      RETURN.
    ENDIF.

    SELECT SINGLE wadat_ist FROM likp
      INTO l_wadat
     WHERE vbeln = vbeln.
    IF sy-subrc &lt;&gt; 0.
      RETURN.
    ENDIF.

    IF l_wadat = wadat.
      RETURN.
    ENDIF.

    message = espera_si_bloqueada( vbeln = vbeln segundos_espera = segundos_espera_si_bloqueos ).

    IF message IS INITIAL.
      o_bi = NEW #( ).

      o_bi-&gt;inicio( ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
      o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

      IF NOT tab IS INITIAL.
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = tab ).
      ENDIF.

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).
      o_bi-&gt;campos( campo = &apos;LIKP-WADAT_IST&apos; valor = wadat ). &quot; Fecha prevista para movimiento de mercancías

      message = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = modoct ).

      SELECT SINGLE wadat_ist FROM likp
        INTO l_wadat_new
       WHERE vbeln     = vbeln
         AND wadat_ist = wadat.
      IF sy-subrc = 0.
        IF NOT o_log IS INITIAL.
          o_log-&gt;log( p1    = &apos;Se ha modificado la fecha de  SM de la entrega&apos;
                      p2    = vbeln
                      p3    = &apos;de fecha anterior&apos;
                      p4    = l_wadat
                      p5    = &apos;a nueva fecha = &apos;
                      p6    = l_wadat_new
                      msgty = &apos;S&apos; ).
        ENDIF.
        CLEAR message.
      ELSE.
        IF forzar = &apos;X&apos;.
          UPDATE likp &quot;#EC AOC_STD_TABLE
            SET wadat_ist = wadat
           WHERE vbeln = vbeln.
          IF NOT o_log IS INITIAL.
            o_log-&gt;log( p1    = &apos;Se ha forzado modificación fecha de  SM de la entrega&apos;
                        p2    = vbeln
                        p3    = &apos;de fecha anterior&apos;
                        p4    = l_wadat
                        p5    = &apos;a nueva fecha = &apos;
                        p6    = wadat
                        msgty = &apos;S&apos; ).
          ENDIF.
          CLEAR message.
        ELSE.
          IF NOT o_log IS INITIAL.
            o_log-&gt;log( p1 = &apos;Error modificando la fecha de  SM de la entrega&apos; p2 = vbeln p3 = message msgty = &apos;E&apos; ).
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = message msgty = &apos;E&apos; ).
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING" VERSION="1" LANGU="S" DESCRIPT="Picking entrega" EXPOSURE="2" STATE="1" EDITORDER="3 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING" SCONAME="I_LIPS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TAB_LIPS"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING" SCONAME="CAMBIAR_CTD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING" SCONAME="SOLO_PART_LOTES" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING" SCONAME="AJUSTAR_CTD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING" SCONAME="I_EMBALAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_EMBALAJE" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING" SCONAME="MENSAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRET2-MESSAGE"/>
  <source>METHOD picking.
    &quot; TODO: parameter I_EMBALAJE is never used (ABAP cleaner)

    DATA: l_vbtyp     TYPE likp-vbtyp,
          l_tcode     TYPE sy-tcode,
          l_dynnr     TYPE bdcdata-dynpro,
          o_bi        TYPE REF TO zcl_ap_batch_input,
          i_lips3     TYPE TABLE OF lips,
          i_lips2     TYPE TABLE OF lips,
          l_lips      TYPE lips,
          i_lips_orig TYPE TABLE OF lips,
          l_lips2     TYPE lips,
          l_total_pos TYPE lips-lfimg,
          l_lips3     TYPE lips,
          l_msgbdc    TYPE bdcmsgcoll,
          l_vbfa      TYPE vbfa.

    FIELD-SYMBOLS &lt;lips&gt; TYPE lips.

    CLEAR mensaje.

    mensaje = validar_entrega_modificable( vbeln ).
    IF mensaje IS NOT INITIAL.
      RETURN.
    ENDIF.

    SELECT SINGLE vbtyp FROM likp
      INTO l_vbtyp
     WHERE vbeln = vbeln.
    IF l_vbtyp = &apos;7&apos;.
      l_tcode = &apos;VL32N&apos;.
      l_dynnr = &apos;4104&apos;.
    ELSE.
      l_tcode = &apos;VL02N&apos;.
      l_dynnr = &apos;4004&apos;.
    ENDIF.

    o_bi = NEW #( ).
    i_lips3 = i_lips.
    i_lips2 = i_lips3.
    SORT i_lips2.

* Descartamos aquellas posiciones sobre las que ya tengo el picking
    LOOP AT i_lips2 INTO l_lips.
      SELECT * FROM lips                      &quot;#EC CI_ALL_FIELDS_NEEDED
        INTO l_lips
        UP TO 1 ROWS
       WHERE vbeln = vbeln
         AND uecha = l_lips-posnr
         AND matnr = l_lips-matnr
         AND charg = l_lips-charg
        ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc = 0.
        DELETE i_lips2.
      ELSE.
        SELECT vbeln posnr charg FROM lips
          APPENDING CORRESPONDING FIELDS OF TABLE i_lips_orig
         WHERE vbeln = vbeln
           AND posnr = l_lips-posnr.
      ENDIF.
    ENDLOOP.
    SORT i_lips_orig.
    DELETE ADJACENT DUPLICATES FROM i_lips_orig.

    IF NOT i_lips2 IS INITIAL.
      o_bi-&gt;inicio( ).

* Pantalla selccion de entrega
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = l_dynnr ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
      o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

      LOOP AT i_lips2 INTO l_lips.
        l_lips2 = l_lips.
        AT NEW posnr.
* Pulsamos para seleccionar posicion
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

* Entrega                Ventana   Posicionar    Posicion
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
          o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-posnr ). &quot; Número de posicion del documento comercial

* Marcamos la primera fila y puslsamos sobre seleccion de lotes
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          IF solo_part_lotes &lt;&gt; &apos;N&apos;.
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHSP_T&apos; ).
          ELSE.
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
          ENDIF.
          o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).

          IF ajustar_ctd = &apos;X&apos;.
            CLEAR l_total_pos.
            LOOP AT i_lips3 INTO l_lips3 WHERE posnr = l_lips2-posnr.
*              ADD l_lips3-lfimg TO l_total_pos.
              l_total_pos = l_total_pos + l_lips3-lgmng.
            ENDLOOP.
            o_bi-&gt;campos( campo = &apos;LIPSD-G_LFIMG(01)&apos; valor = l_total_pos ).
          ENDIF.

          IF solo_part_lotes &lt;&gt; &apos;N&apos;.
*APC20150926 Si la posicion de entrega ya tenia lote informado, no me deja ir a la particion de lote.
* Por ello, veo si el lote que tiene es uno de los que voy a informar, y si es asi lo blanqueo
            IF NOT l_lips2-charg IS INITIAL.
              ASSIGN i_lips_orig[ posnr = l_lips2-posnr
                                  charg = l_lips2-charg ] TO &lt;lips&gt;.
              IF sy-subrc = 0.
                IF &lt;lips&gt;-charg &lt;&gt; &apos;&apos;.
                  o_bi-&gt;campos( campo = &apos;LIPS-CHARG(01)&apos; valor = &apos;&apos; ).
                ENDIF.
              ELSE.
                IF ajustar_ctd = &apos;X&apos;.
                  LOOP AT i_lips_orig ASSIGNING &lt;lips&gt; WHERE     posnr  = l_lips2-posnr
                                                             AND charg &lt;&gt; l_lips2-charg.
                    EXIT.
                  ENDLOOP.
                  IF sy-subrc = 0.
                    IF &lt;lips&gt;-charg &lt;&gt; &apos;&apos;.
                      o_bi-&gt;campos( campo = &apos;LIPS-CHARG(01)&apos; valor = &apos;&apos; ). &quot; Borramos lote si lo hubiera!
                    ENDIF.
                  ENDIF.
                ENDIF.
              ENDIF.
            ENDIF.

            o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de seleccion en dynpros de lista
          ENDIF.
        ENDAT.

        IF solo_part_lotes &lt;&gt; &apos;N&apos;.
* Pulsamos para aÃ±adir una nueva línbea
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POAN_T&apos; ).

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
          o_bi-&gt;campos( campo = &apos;LIPS-LGORT(02)&apos; valor = l_lips-lgort ).
          o_bi-&gt;campos( campo = &apos;LIPS-CHARG(02)&apos; valor = l_lips-charg ). &quot; Número de lote
          o_bi-&gt;campos( campo = &apos;LIPS-LFIMG(02)&apos; valor = l_lips-lgmng ). &quot; Cantidad entregada efectivamente en UMV
          IF NOT l_lips-vrkme IS INITIAL.
            o_bi-&gt;campos( campo = &apos;LIPS-VRKME(02)&apos; valor = l_lips-vrkme ).
          ENDIF.
          IF NOT l_lips-lichn IS INITIAL.
            o_bi-&gt;campos( campo = &apos;LIPS-LICHN(2)&apos; valor = l_lips-lichn ).
          ENDIF.

        ENDIF.

        AT END OF posnr.
          IF solo_part_lotes &lt;&gt; &apos;N&apos;.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK_T&apos; ).
          ENDIF.
        ENDAT.

        AT LAST.
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).
        ENDAT.
      ENDLOOP.

      mensaje = o_bi-&gt;llamar_transaccion( tcode = l_tcode modo = modoct ).
      IF mensaje = &apos;Los datos batch input para el dynpro SAPMV50A 1000 no existen.&apos;.
        READ TABLE o_bi-&gt;i_mensajes INTO l_msgbdc WITH KEY msgid = &apos;VL&apos; msgnr = &apos;221&apos;.
        IF sy-subrc = 0.
          MESSAGE ID l_msgbdc-msgid TYPE &apos;S&apos; NUMBER l_msgbdc-msgnr WITH l_msgbdc-msgv1 l_msgbdc-msgv2 l_msgbdc-msgv3 l_msgbdc-msgv4 INTO mensaje.
        ENDIF.
      ENDIF.

      IF o_bi-&gt;msgty = &apos;S&apos;.
        CLEAR mensaje.
      ENDIF.
    ENDIF.

    IF solo_part_lotes IS INITIAL.
      IF mensaje IS INITIAL.
        SELECT * FROM lips                    &quot;#EC CI_ALL_FIELDS_NEEDED
          INTO TABLE i_lips2
         WHERE vbeln  = vbeln
           AND uecha &lt;&gt; &apos;&apos;.

        i_lips3 = i_lips.
        LOOP AT i_lips2 ASSIGNING &lt;lips&gt;.
          LOOP AT i_lips3 INTO l_lips WHERE     posnr = &lt;lips&gt;-uecha
                                            AND matnr = &lt;lips&gt;-matnr
                                            AND charg = &lt;lips&gt;-charg
                                            AND lgmng = &lt;lips&gt;-lfimg.
*                                   and abart ne &apos;X&apos;.
*        l_lips-abart = &apos;X&apos;. &quot;Para no volverlo a coger
*        modify i_lips3 from l_lips.
            DELETE i_lips3.
            EXIT.
          ENDLOOP.
          IF sy-subrc = 0.
            CLEAR l_vbfa-rfmng.
            SELECT SINGLE rfmng FROM vbfa            &quot;#EC CI_SEL_NESTED
              INTO l_vbfa-rfmng
             WHERE vbelv   = vbeln
               AND posnv   = &lt;lips&gt;-posnr
               AND vbtyp_n = &apos;Q&apos;.
            IF &lt;lips&gt;-lgort = l_lips-lgort AND &lt;lips&gt;-lgmng = l_vbfa-rfmng.
              DELETE i_lips2.
            ELSE.
              IF &lt;lips&gt;-lgort = l_lips-lgort.
                CLEAR &lt;lips&gt;-lgort.
              ELSE.
                &lt;lips&gt;-lgort = l_lips-lgort.
              ENDIF.
              &lt;lips&gt;-lgmng = l_lips-lgmng.
            ENDIF.
          ELSE.
            DELETE i_lips2.
          ENDIF.
        ENDLOOP.

        LOOP AT i_lips2 ASSIGNING &lt;lips&gt;.
          l_lips = &lt;lips&gt;.
          &lt;lips&gt;-posnr = &lt;lips&gt;-uecha.
          &lt;lips&gt;-uecha = l_lips-posnr.
        ENDLOOP.
        SORT i_lips2.

        LOOP AT i_lips2 INTO l_lips.
          AT FIRST.
            o_bi-&gt;inicio( ).
* Pantalla selccion de entrega
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = l_dynnr ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
            o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

          ENDAT.

          AT NEW posnr.
* Pulsamos para seleccionar posicion
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

* Entrega                Ventana   Posicionar    Posicion
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
            o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-posnr ). &quot; Número de posicion del documento comercial

* Marcamos la primera fila y puslsamos sobre seleccion de lotes
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHPL_T01&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).
            o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de seleccion en dynpros de lista

            CLEAR l_total_pos.
          ENDAT.

* Pulsamos para aÃ±adir una nueva línbea
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
          o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-uecha ). &quot; Número de posicion del documento comercial

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
          IF NOT l_lips-lgort IS INITIAL.
            o_bi-&gt;campos( campo = &apos;LIPS-LGORT(01)&apos; valor = l_lips-lgort ). &quot; Número de lote
          ENDIF.
          o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = l_lips-lgmng ). &quot; Cantidad entregada efectivamente en UMV
          l_total_pos = l_total_pos + l_lips-lgmng.

          AT END OF posnr.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK_T&apos; ).

            IF cambiar_ctd = &apos;X&apos;.
              o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
              o_bi-&gt;campos( campo = &apos;LIPSD-G_LFIMG(01)&apos; valor = l_total_pos ).
              o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
            ENDIF.
          ENDAT.

          AT LAST.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

            mensaje = o_bi-&gt;llamar_transaccion( tcode = l_tcode modo = modoct ).

            IF o_bi-&gt;msgty = &apos;S&apos;.
              CLEAR mensaje.
            ENDIF.

          ENDAT.
        ENDLOOP.

* Ha habido errores en el picking!!, deshacemos!
        IF NOT mensaje IS INITIAL.
          deshacer_picking( vbeln = vbeln modoct = modoct ).
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_OPT" VERSION="1" LANGU="S" DESCRIPT="Picking entrega" EXPOSURE="2" STATE="1" EDITORDER="45 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_OPT" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_OPT" SCONAME="I_LIPS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TAB_LIPS"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_OPT" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_OPT" SCONAME="CAMBIAR_CTD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_OPT" SCONAME="SOLO_PART_LOTES" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_OPT" SCONAME="AJUSTAR_CTD" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_OPT" SCONAME="I_EMBALAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_EMBALAJE" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_OPT" SCONAME="MENSAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRET2-MESSAGE"/>
  <source>METHOD picking_opt.
    DATA: l_vbtyp     TYPE likp-vbtyp,
          l_tcode     TYPE sy-tcode,
          l_dynnr     TYPE bdcdata-dynpro,
          o_bi        TYPE REF TO zcl_ap_batch_input,
          i_lips3     TYPE TABLE OF lips,
          i_lips2     TYPE TABLE OF lips,
          l_tabla     TYPE tabname,
          l_max_posnr TYPE posnr,
          l_lips      TYPE lips,
          i_lips_orig TYPE TABLE OF lips,
          l_lips2     TYPE lips,
          l_kosta     TYPE kosta,
          l_total_pos TYPE lips-lfimg,
          l_lips3     TYPE lips,
          l_cont      TYPE i,
          l_msgbdc    TYPE bdcmsgcoll,
          l_vbfa      TYPE vbfa.
    DATA l_vhilm TYPE vekp-vhilm.

    FIELD-SYMBOLS &lt;lips&gt; TYPE lips.

    CLEAR mensaje.

    SET PARAMETER ID &apos;SHP_PROCESS_VIEW&apos; FIELD &apos;P&apos;. &quot; Nos posicionamos el tab de picking

    mensaje = validar_entrega_modificable( vbeln ).
    IF mensaje IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(i_embalaje_l) = i_embalaje.

    SELECT SINGLE vbtyp FROM likp
      INTO l_vbtyp
     WHERE vbeln = vbeln.
    IF l_vbtyp = &apos;7&apos;.
      l_tcode = &apos;VL32N&apos;.
      l_dynnr = &apos;4104&apos;.
    ELSE.
      l_tcode = &apos;VL02N&apos;.
      l_dynnr = &apos;4004&apos;.
    ENDIF.

    o_bi = NEW #( ).
    i_lips3 = i_lips.
    i_lips2 = i_lips3.
    SORT i_lips2.

    IF zcl_c=&gt;hana IS INITIAL.
      l_tabla = &apos;VBUP&apos;.
    ELSE.
      l_tabla = &apos;LIPS&apos;.
    ENDIF.

    SELECT MAX( posnr ) FROM lips
      INTO l_max_posnr
     WHERE vbeln = vbeln
       AND posnr &gt; &apos;900000&apos;.
    IF l_max_posnr IS INITIAL.
      l_max_posnr = &apos;900000&apos;.
    ENDIF.

* Descartamos aquellas posiciones sobre las que ya tengo el picking
    LOOP AT i_lips2 INTO l_lips.
      SELECT * FROM lips                      &quot;#EC CI_ALL_FIELDS_NEEDED
        INTO l_lips                             ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
        UP TO 1 ROWS
       WHERE vbeln = vbeln
         AND uecha = l_lips-posnr
         AND matnr = l_lips-matnr
         AND charg = l_lips-charg
        ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc = 0.
        DELETE i_lips2.
      ELSE.
        SELECT vbeln posnr charg FROM lips                 ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
          APPENDING CORRESPONDING FIELDS OF TABLE i_lips_orig
         WHERE vbeln = vbeln
           AND posnr = l_lips-posnr.
      ENDIF.
    ENDLOOP.
    SORT i_lips_orig.
    DELETE ADJACENT DUPLICATES FROM i_lips_orig.

    IF NOT i_lips2 IS INITIAL.
      o_bi-&gt;inicio( ).

* Pantalla selccion de entrega
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = l_dynnr ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
      o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

      LOOP AT i_lips2 INTO l_lips.
        l_lips2 = l_lips.
        AT NEW posnr.
          SELECT SINGLE kosta FROM (l_tabla)
            INTO l_kosta
           WHERE vbeln = vbeln
             AND posnr = l_lips-posnr.

* Pulsamos para seleccionar posicion
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

* Entrega                Ventana   Posicionar    Posicion
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
          o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-posnr ). &quot; Número de posicion del documento comercial

          DATA(l_n_particiones) = 0.
          LOOP AT i_lips TRANSPORTING NO FIELDS WHERE posnr = l_lips-posnr.
            l_n_particiones = l_n_particiones + 1.
          ENDLOOP.
          IF l_n_particiones = 1.
* Verificamos si no tenemos una partición previa
            SELECT COUNT( * ) FROM lips
              INTO @DATA(l_part_prev)
             WHERE vbeln  = @vbeln
               AND posnr &lt;&gt; @l_lips-posnr
               AND uecha  = @l_lips-posnr.
            l_n_particiones = l_n_particiones + l_part_prev.
          ENDIF.

* Marcamos la primera fila y puslsamos sobre seleccion de lotes
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          IF solo_part_lotes &lt;&gt; &apos;N&apos; AND l_n_particiones &gt; 1.
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHSP_T&apos; ).
          ELSE.
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
          ENDIF.
          o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).

          IF ajustar_ctd = &apos;X&apos;.
            CLEAR l_total_pos.
            LOOP AT i_lips3 INTO l_lips3 WHERE posnr = l_lips2-posnr.
*              ADD l_lips3-lfimg TO l_total_pos.
              l_total_pos = l_total_pos + l_lips3-lgmng.
            ENDLOOP.
            o_bi-&gt;campos( campo = &apos;LIPSD-G_LFIMG(01)&apos; valor = l_total_pos ).
          ENDIF.

          IF solo_part_lotes &lt;&gt; &apos;N&apos;.
*APC20150926 Si la posicion de entrega ya tenia lote informado, no me deja ir a la particion de lote.
* Por ello, veo si el lote que tiene es uno de los que voy a informar, y si es asi lo blanqueo
            IF NOT l_lips2-charg IS INITIAL.
              ASSIGN i_lips_orig[ posnr = l_lips2-posnr
                                  charg = l_lips2-charg ] TO &lt;lips&gt;.
              IF sy-subrc = 0.
                IF &lt;lips&gt;-charg &lt;&gt; &apos;&apos;.
                  o_bi-&gt;campos( campo = &apos;LIPS-CHARG(01)&apos; valor = &apos;&apos; ).
                ENDIF.
              ELSE.
                IF ajustar_ctd = &apos;X&apos;.
                  LOOP AT i_lips_orig ASSIGNING &lt;lips&gt; WHERE     posnr  = l_lips2-posnr
                                                             AND charg &lt;&gt; l_lips2-charg.
                    EXIT.
                  ENDLOOP.
                  IF sy-subrc = 0.
                    IF &lt;lips&gt;-charg &lt;&gt; &apos;&apos;.
                      o_bi-&gt;campos( campo = &apos;LIPS-CHARG(01)&apos; valor = &apos;&apos; ). &quot; Borramos lote si lo hubiera!
                    ENDIF.
                  ENDIF.
                ENDIF.
              ENDIF.
            ENDIF.

            o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de seleccion en dynpros de lista
          ENDIF.
        ENDAT.

        IF l_n_particiones = 1.
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
* Si se necesita cambiar el almacén, pero tenía lote informado, tenemos que borrarlo antes de volver a intentar ponerlo.
          ASSIGN i_lips_orig[ posnr = l_lips2-posnr
                              charg = l_lips2-charg ] TO &lt;lips&gt;.
          IF sy-subrc = 0.
            IF &lt;lips&gt;-charg &lt;&gt; &apos;&apos; AND ( &lt;lips&gt;-lgort &lt;&gt; l_lips-lgort AND l_lips-lgort NE &apos;&apos; ).
              o_bi-&gt;campos( campo = &apos;LIPS-CHARG(01)&apos; valor = &apos;&apos; ).
              o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = &apos;&apos; ).
              o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
              o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
            ENDIF.
          ENDIF.

          IF NOT l_lips-lgort IS INITIAL.
            o_bi-&gt;campos( campo = &apos;LIPS-LGORT(01)&apos; valor = l_lips-lgort ).
          ENDIF.
          o_bi-&gt;campos( campo = &apos;LIPS-CHARG(01)&apos; valor = l_lips-charg ).

          IF l_kosta = &apos;A&apos; OR l_kosta = &apos;B&apos;.
            o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = l_lips-lgmng ). &quot; Cantidad entregada efectivamente en UMV
          ENDIF.
        ELSE.
          DATA(l_hay_part_lotes) = &apos;X&apos;.
          IF solo_part_lotes &lt;&gt; &apos;N&apos;.
            IF solo_part_lotes = &apos;E&apos;. &quot; Caso especial para hacer embalaje en un solo paso
              CLEAR l_hay_part_lotes.
              l_max_posnr = l_max_posnr + 1.
              LOOP AT i_embalaje_l ASSIGNING FIELD-SYMBOL(&lt;hu&gt;) WHERE     posnr = l_lips-posnr
                                                                      AND charg = l_lips-charg.
                &lt;hu&gt;-posnr = l_max_posnr.
              ENDLOOP.
            ENDIF.
* Pulsamos para añadir una nueva línea
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POAN_T&apos; ).

            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
            IF l_lips-lgort IS INITIAL.
              o_bi-&gt;campos( campo = &apos;LIPS-LGORT(02)&apos; valor = l_lips-lgort ).
            ENDIF.
            o_bi-&gt;campos( campo = &apos;LIPS-CHARG(02)&apos; valor = l_lips-charg ). &quot; Número de lote
            o_bi-&gt;campos( campo = &apos;LIPS-LFIMG(02)&apos; valor = l_lips-lgmng ). &quot; Cantidad entregada efectivamente en UMV
            IF NOT l_lips-vrkme IS INITIAL.
              o_bi-&gt;campos( campo = &apos;LIPS-VRKME(02)&apos; valor = l_lips-vrkme ).
            ENDIF.
          ENDIF.
        ENDIF.

        AT END OF posnr.
          IF solo_part_lotes &lt;&gt; &apos;N&apos; AND l_n_particiones &gt; 1.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK_T&apos; ).
          ENDIF.
        ENDAT.

        AT LAST.
          IF l_hay_part_lotes IS INITIAL AND NOT i_embalaje IS INITIAL.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=VERP_T&apos; ). &quot; Embalaje

            o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=UE6VDIR&apos; ). &quot; Entrada individual

            LOOP AT i_embalaje_l ASSIGNING &lt;hu&gt;.
              o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
              o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ENTR&apos; ).
              o_bi-&gt;campos( campo = &apos;VEKP-EXIDV&apos; valor = &lt;hu&gt;-exidv ). &quot; Identificación externa de la unidad de manipulación

              CLEAR l_vhilm.
              SELECT COUNT( * ) FROM vekp
                INTO l_cont
               WHERE exidv = &lt;hu&gt;-exidv.
              IF l_cont = 1.
                SELECT vhilm
                  FROM vekp
                  WHERE exidv = @&lt;hu&gt;-exidv
                  ORDER BY PRIMARY KEY
                  INTO @l_vhilm
                  UP TO 1 ROWS.
                ENDSELECT.
              ENDIF.
              IF l_vhilm &lt;&gt; &lt;hu&gt;-vhilm.
                o_bi-&gt;campos( campo = &apos;VEKP-VHILM&apos; valor = &lt;hu&gt;-vhilm ). &quot; Material de embalaje
              ENDIF.
              o_bi-&gt;campos( campo = &apos;HUMV4-MATNR&apos; valor = &lt;hu&gt;-matnr ). &quot; Número de material
              o_bi-&gt;campos( campo = &apos;HUMV4-CHARG&apos; valor = &lt;hu&gt;-charg ). &quot; Número de lote
              o_bi-&gt;campos( campo = &apos;HUMV4-QUANTITY&apos; valor = &lt;hu&gt;-lfimg ). &quot; Cantidad base embalada en posición de unidad manipulación
              o_bi-&gt;campos( campo = &apos;HUMV4-VRKME&apos; valor = &lt;hu&gt;-vrkme ). &quot; Unidad de medida alternativa p.unidad de medida de stock
              o_bi-&gt;campos( campo = &apos;HUMV4-POSNR&apos; valor = &lt;hu&gt;-posnr ).
            ENDLOOP.

            o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH&apos; ).
          ELSE.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).
          ENDIF.
        ENDAT.
      ENDLOOP.

      mensaje = o_bi-&gt;llamar_transaccion( tcode = l_tcode modo = modoct ).
      IF mensaje = &apos;Los datos batch input para el dynpro SAPMV50A 1000 no existen.&apos;.
        READ TABLE o_bi-&gt;i_mensajes INTO l_msgbdc WITH KEY msgid = &apos;VL&apos; msgnr = &apos;221&apos;.
        IF sy-subrc = 0.
          MESSAGE ID l_msgbdc-msgid TYPE &apos;S&apos; NUMBER l_msgbdc-msgnr WITH l_msgbdc-msgv1 l_msgbdc-msgv2 l_msgbdc-msgv3 l_msgbdc-msgv4 INTO mensaje.
        ENDIF.
      ENDIF.

      IF o_bi-&gt;msgty = &apos;S&apos;.
        CLEAR mensaje.
      ENDIF.
    ENDIF.

    IF solo_part_lotes IS INITIAL AND l_hay_part_lotes = &apos;X&apos;.
      IF mensaje IS INITIAL.
        SELECT * FROM lips                    &quot;#EC CI_ALL_FIELDS_NEEDED
          INTO TABLE i_lips2                    ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
         WHERE vbeln  = vbeln
           AND uecha &lt;&gt; &apos;&apos;.

        i_lips3 = i_lips.
        LOOP AT i_lips2 ASSIGNING &lt;lips&gt;.
          LOOP AT i_lips3 INTO l_lips WHERE     posnr = &lt;lips&gt;-uecha
                                            AND matnr = &lt;lips&gt;-matnr
                                            AND charg = &lt;lips&gt;-charg
                                            AND lgmng = &lt;lips&gt;-lfimg.
*                                   and abart ne &apos;X&apos;.
*        l_lips-abart = &apos;X&apos;. &quot;Para no volverlo a coger
*        modify i_lips3 from l_lips.
            DELETE i_lips3.
            EXIT.
          ENDLOOP.
          IF sy-subrc = 0.
            CLEAR l_vbfa-rfmng.
            SELECT rfmng
              FROM vbfa                              &quot;#EC CI_SEL_NESTED
              WHERE vbelv   = @vbeln
                AND posnv   = @&lt;lips&gt;-posnr
                AND vbtyp_n = &apos;Q&apos;
              ORDER BY PRIMARY KEY
              INTO @l_vbfa-rfmng
              UP TO 1 ROWS.
            ENDSELECT.
            IF &lt;lips&gt;-lgort = l_lips-lgort AND &lt;lips&gt;-lgmng = l_vbfa-rfmng.
              DELETE i_lips2.
            ELSE.
              IF &lt;lips&gt;-lgort = l_lips-lgort.
                CLEAR &lt;lips&gt;-lgort.
              ELSE.
                &lt;lips&gt;-lgort = l_lips-lgort.
              ENDIF.
              &lt;lips&gt;-lgmng = l_lips-lgmng.
            ENDIF.
          ELSE.
            DELETE i_lips2.
          ENDIF.
        ENDLOOP.

        LOOP AT i_lips2 ASSIGNING &lt;lips&gt;.
          l_lips = &lt;lips&gt;.
          &lt;lips&gt;-posnr = &lt;lips&gt;-uecha.
          &lt;lips&gt;-uecha = l_lips-posnr.
        ENDLOOP.
        SORT i_lips2.

        LOOP AT i_lips2 INTO l_lips.
          AT FIRST.
            o_bi-&gt;inicio( ).
* Pantalla selccion de entrega
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = l_dynnr ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
            o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

          ENDAT.

          AT NEW posnr.
* Pulsamos para seleccionar posicion
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

* Entrega                Ventana   Posicionar    Posicion
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
            o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-posnr ). &quot; Número de posicion del documento comercial

* Marcamos la primera fila y puslsamos sobre seleccion de lotes
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHPL_T01&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).
            o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de seleccion en dynpros de lista

            CLEAR l_total_pos.
          ENDAT.

* Pulsamos para aÃ±adir una nueva línbea
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
          o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_lips-uecha ). &quot; Número de posicion del documento comercial

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
          IF NOT l_lips-lgort IS INITIAL.
            o_bi-&gt;campos( campo = &apos;LIPS-LGORT(01)&apos; valor = l_lips-lgort ). &quot; Número de lote
          ENDIF.
          o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = l_lips-lgmng ). &quot; Cantidad entregada efectivamente en UMV
          l_total_pos = l_total_pos + l_lips-lgmng.

          AT END OF posnr.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK_T&apos; ).

            IF cambiar_ctd = &apos;X&apos;.
              o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
              o_bi-&gt;campos( campo = &apos;LIPSD-G_LFIMG(01)&apos; valor = l_total_pos ).
              o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
            ENDIF.
          ENDAT.

          AT LAST.
            IF NOT i_embalaje IS INITIAL.
              o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
              o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=VERP_T&apos; ). &quot; Embalaje

              o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
              o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=UE6VDIR&apos; ). &quot; Entrada individual

              LOOP AT i_embalaje ASSIGNING &lt;hu&gt;.
                o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
                o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ENTR&apos; ).
                o_bi-&gt;campos( campo = &apos;VEKP-EXIDV&apos; valor = &lt;hu&gt;-exidv ). &quot; Identificación externa de la unidad de manipulación

                CLEAR l_vhilm.
                SELECT COUNT( * ) FROM vekp
                  INTO l_cont
                 WHERE exidv = &lt;hu&gt;-exidv.
                IF l_cont = 1.
                  SELECT vhilm
                    FROM vekp
                    WHERE exidv = @&lt;hu&gt;-exidv
                    ORDER BY PRIMARY KEY
                    INTO @l_vhilm
                    UP TO 1 ROWS.
                  ENDSELECT.
                ENDIF.
                IF l_vhilm &lt;&gt; &lt;hu&gt;-vhilm.
                  o_bi-&gt;campos( campo = &apos;VEKP-VHILM&apos; valor = &lt;hu&gt;-vhilm ). &quot; Material de embalaje
                ENDIF.
                o_bi-&gt;campos( campo = &apos;HUMV4-MATNR&apos; valor = &lt;hu&gt;-matnr ). &quot; Número de material
                o_bi-&gt;campos( campo = &apos;HUMV4-CHARG&apos; valor = &lt;hu&gt;-charg ). &quot; Número de lote
                o_bi-&gt;campos( campo = &apos;HUMV4-QUANTITY&apos; valor = &lt;hu&gt;-lfimg ). &quot; Cantidad base embalada en posición de unidad manipulación
                o_bi-&gt;campos( campo = &apos;HUMV4-VRKME&apos; valor = &lt;hu&gt;-vrkme ). &quot; Unidad de medida alternativa p.unidad de medida de stock
                o_bi-&gt;campos( campo = &apos;HUMV4-POSNR&apos; valor = &lt;hu&gt;-posnr ).
              ENDLOOP.

              o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
              o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH&apos; ).
            ELSE.
              o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
              o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).
            ENDIF.

            mensaje = o_bi-&gt;llamar_transaccion( tcode = l_tcode modo = modoct ).

            IF o_bi-&gt;msgty = &apos;S&apos;.
              CLEAR mensaje.
            ENDIF.

          ENDAT.
        ENDLOOP.

* Ha habido errores en el picking!!, deshacemos!
        IF NOT mensaje IS INITIAL.
          deshacer_picking( vbeln = vbeln modoct = modoct ).
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" VERSION="1" LANGU="S" DESCRIPT="Picking y embalaje" EXPOSURE="2" STATE="1" EDITORDER="8 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIPS-POSNR"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="CHARG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHARG_D"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="LFIMG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="VRKME" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIPS-VRKME" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="EXIDV" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="EXIDV" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="LSTEL" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-LSTEL" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="ALMACEN_HU" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="CONVERTIR_A_UN_POS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="10 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="PICKING_Y_EMBALAJE" SCONAME="MENSAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="11 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRET2-MESSAGE"/>
  <source>METHOD picking_y_embalaje.
    &quot; TODO: parameter CONVERTIR_A_UN_POS is never used (ABAP cleaner)

    DATA: l_tabla            TYPE tabname VALUE &apos;VBUP&apos;,
          l_likp             TYPE likp,
          l_venum            TYPE venum,
          l_lips             TYPE lips,
          l_unidad           TYPE meins,
          l_cantidad         TYPE mengv13,
          o_bi               TYPE REF TO zcl_ap_batch_input,
          l_vepo             TYPE vepo,
          l_particion_sin_hu TYPE c LENGTH 1,
          &quot; TODO: variable is assigned but never used (ABAP cleaner)
          l_vbup             TYPE vbup.

    FIELD-SYMBOLS &lt;bdcmsg&gt; TYPE bdcmsgcoll.

    IF zcl_c=&gt;hana = &apos;X&apos;.
      l_tabla = &apos;LIPS&apos;.
    ENDIF.

    SELECT SINGLE lstel FROM likp
      INTO l_likp-lstel
     WHERE vbeln = vbeln.
    IF sy-subrc &lt;&gt; 0.
      mensaje = &apos;No existe la entrega&apos;.
      RETURN.
    ENDIF.

    l_venum = zcl_ap_hu=&gt;get_venum( exidv ).
    IF l_venum IS INITIAL.
      mensaje = &apos;No existe la HU&apos;.
      RETURN.
    ENDIF.

    SELECT SINGLE matnr posnr vrkme lgort charg lfimg FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
      INTO CORRESPONDING FIELDS OF l_lips
     WHERE vbeln = vbeln
       AND posnr = posnr.
    IF sy-subrc &lt;&gt; 0.
      mensaje = &apos;No existe la posición de la entrega&apos;.
      RETURN.
    ELSE.
      IF vrkme = l_lips-vrkme OR lfimg IS INITIAL.
        l_unidad   = vrkme.
        l_cantidad = lfimg.
      ELSE.
        l_cantidad = zcl_ap_material=&gt;convertir_unidad( matnr          = l_lips-matnr
                                                        cantidad       = lfimg
                                                        unidad_origen  = vrkme
                                                        unidad_destino = l_lips-vrkme ).
        IF l_cantidad IS INITIAL.
          l_unidad   = vrkme.
          l_cantidad = lfimg.
        ELSE.
          l_unidad = l_lips-vrkme.
        ENDIF.
      ENDIF.
    ENDIF.

    mensaje = validar_entrega_modificable( vbeln ).
    IF NOT mensaje IS INITIAL.
      RETURN.
    ENDIF.

    o_bi = NEW #( ).

* Si la HU no esta asignada a la entrega, no continuamos
    SELECT posnr FROM vepo
      INTO l_vepo-posnr
      UP TO 1 ROWS
     WHERE vbeln = vbeln
       AND venum = l_venum
      ORDER BY PRIMARY KEY.
    ENDSELECT.
    IF sy-subrc &lt;&gt; 0.
      o_bi-&gt;inicio( ).

      SET PARAMETER ID &apos;SHP_PROCESS_VIEW&apos; FIELD &apos;P&apos;. &quot; Nos posicionamos el tab de picking

* Pantalla selccion de entrega
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
      o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

* Buscamos si tenemos alguna posicion de particion de lotes sin asignar a HU

* Buscamos particion de lotes de la posicion
      CLEAR l_particion_sin_hu.
      IF NOT exidv IS INITIAL.
        SELECT posnr FROM lips ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
          INTO l_lips-posnr
         WHERE vbeln = vbeln
           AND uecha = posnr.
* Verificamos si ya esta asignada a entrega
          SELECT * FROM vepo JOIN vekp ON vepo~venum = vekp~venum
            INTO CORRESPONDING FIELDS OF l_vepo
            UP TO 1 ROWS
           WHERE vbeln     = vbeln
             AND posnr     = l_lips-posnr
             AND vpobj    IN ( &apos;01&apos;, &apos;03&apos; )
             AND vpobjkey  = vbeln
           ORDER BY vepo~venum vepo~vepos.
          ENDSELECT.
* Si no encuentro equivalencia en HU es que esa particicion no tiene HU asignada
          IF sy-subrc &lt;&gt; 0.
            l_particion_sin_hu = &apos;X&apos;.
          ENDIF.
        ENDSELECT.
      ENDIF.

      IF l_particion_sin_hu IS INITIAL.
        IF NOT lstel IS INITIAL.
          IF lstel &lt;&gt; l_likp-lstel.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=T\03&apos; ).

            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
            o_bi-&gt;campos( campo = &apos;LIKP-LSTEL&apos; valor = lstel ).
          ENDIF.
        ENDIF.

* Pulsamos para seleccionar posición
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

* Entrega                Ventana   Posicionar    Posición
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
        o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = posnr ). &quot; Número de posición del documento comercial

*APC20200422 Verificamos si la entrega tiene lote informado y si viene de pedido
        DATA(l_lote_pedido) = get_lote_origen_pedido( vbeln = vbeln posnr = posnr ).
        IF NOT l_lote_pedido IS INITIAL.
          IF l_lote_pedido &lt;&gt; charg.
            mensaje = |El lote indicado { charg } no coincide con el del pedido { l_lote_pedido }|.
            RETURN.
          ENDIF.
        ELSEIF NOT l_lips-charg IS INITIAL.
          IF l_lips-charg = charg.
*APC20200518 Aunque no tenga el lote del pedido, si el lote de la entrega es el mismo que voy a informar, hacemos el mismo tratamiento
            l_lote_pedido = charg.
          ELSE.
            mensaje = |El lote indicado { charg } no coincide con el que hay en la entrega { l_lips-charg }|.
            RETURN.
          ENDIF.
        ENDIF.

        IF l_lote_pedido IS INITIAL.
* Marcamos la primera fila y pulsamos sobre seleccion de lotes
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHSP_T&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).
          o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de seleccion en dynpros de lista

* Pulsamos para añadir una nueva línbea
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POAN_T&apos; ).
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
          o_bi-&gt;campos( campo = &apos;LIPS-CHARG(02)&apos; valor = charg ). &quot; Numero de lote

          IF almacen_hu = &apos;X&apos;.
            SELECT SINGLE lgort FROM vepo
              INTO l_vepo-lgort
             WHERE venum = l_venum.
            o_bi-&gt;campos( campo = &apos;LIPS-LGORT(02)&apos; valor = l_vepo-lgort ).
          ENDIF.

          o_bi-&gt;campos( campo = &apos;LIPS-LFIMG(02)&apos; valor = l_cantidad ). &quot; Cantidad entregada efectivamente en UMV
          o_bi-&gt;campos( campo = &apos;LIPS-VRKME(02)&apos; valor = l_unidad ).
        ELSE.
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
* Si tenía un lote informado del pedido, directamente incrementamos la cantidad de picking
          DATA(l_ctd_picking) = get_ctd_picking( vbeln = vbeln posnr = posnr add_subpos = &apos;&apos; select = &apos;X&apos; ).
          l_cantidad = l_cantidad + l_ctd_picking.

          IF almacen_hu = &apos;X&apos;.
            SELECT SINGLE lgort FROM vepo
              INTO l_vepo-lgort
             WHERE venum = l_venum.
            IF l_vepo-lgort &lt;&gt; l_lips-lgort.
              IF l_ctd_picking = 0.
                o_bi-&gt;campos( campo = &apos;LIPS-LGORT(01)&apos; valor = l_vepo-lgort ).
              ELSE.
                mensaje = |Almacén de la HU es { l_vepo-lgort } diferente del de la posición { l_lips-lgort } que ya tiene picking|.
                RETURN.
              ENDIF.
            ENDIF.
          ENDIF.

*        o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = l_cantidad ). &quot; Cantidad de picking
        ENDIF.

        IF exidv IS INITIAL.
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH&apos; ).
        ELSE.
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
* Pulsamos para ir a embalaje
          IF l_lote_pedido IS INITIAL.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;3000&apos; ).
          ELSE.
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          ENDIF.
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=VERP_T&apos; ).

* Marcamos todos los lotes para embalajar
          o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=HU_MARKA&apos; ).
*
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=UE6VDIR&apos; ).
* Paso a pestaña Entrada individual

          o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH&apos; ).
          o_bi-&gt;campos( campo = &apos;VEKP-EXIDV&apos; valor = exidv ).
        ENDIF.
      ELSE.
* Pulsamos para ir a embalaje
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=VERP_T&apos; ).

* Marcamos todos los lotes para embalajar
        o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=HU_MARKA&apos; ).
*
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=UE6VDIR&apos; ).
* Paso a pestaña Entrada individual

        o_bi-&gt;dynpro( program = &apos;SAPLV51G&apos; dynpro = &apos;6000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH&apos; ).
        o_bi-&gt;campos( campo = &apos;VEKP-EXIDV&apos; valor = exidv ).
      ENDIF.

      mensaje = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = modoct ).

      IF mensaje CS &apos;grabado&apos;.
        CLEAR mensaje.

        CLEAR l_vepo.
        DO 5 TIMES.
          SELECT * FROM vepo
            INTO l_vepo
            UP TO 1 ROWS
           WHERE vbeln = vbeln
             AND venum = l_venum
            ORDER BY PRIMARY KEY.
          ENDSELECT.
          IF sy-subrc = 0.
            EXIT.
          ELSE.
            WAIT UP TO 1 SECONDS.
          ENDIF.
        ENDDO.
      ENDIF.

      IF mensaje IS INITIAL.
* Los mensajes de HU, los devuelve como informativos pero son errores!
        LOOP AT o_bi-&gt;i_mensajes ASSIGNING &lt;bdcmsg&gt; WHERE    ( msgid = &apos;HUDIALOG&apos;    AND msgnr = &apos;157&apos; )
                                                          OR ( msgid = &apos;HUFUNCTIONS&apos; AND msgnr = &apos;261&apos; ).
          MESSAGE ID &lt;bdcmsg&gt;-msgid TYPE &apos;S&apos; NUMBER &lt;bdcmsg&gt;-msgnr WITH
                  &lt;bdcmsg&gt;-msgv1 &lt;bdcmsg&gt;-msgv2 &lt;bdcmsg&gt;-msgv3 &lt;bdcmsg&gt;-msgv4 INTO mensaje.
        ENDLOOP.
      ENDIF.
    ENDIF.

    IF mensaje IS NOT INITIAL.
      RETURN.
    ENDIF.

*  IF l_vepo-posnr IS INITIAL AND sy-uname = &apos;APICAZO&apos;.
*    l_vepo-posnr = posnr.
*  ENDIF.

    IF l_vepo IS INITIAL.
      mensaje = &apos;No se encuentra posición de embalaje&apos;.
      RETURN.
    ENDIF.

    SELECT SINGLE vbeln FROM (l_tabla)
      INTO l_vbup-vbeln
     WHERE vbeln = vbeln
       AND posnr = l_vepo-posnr
       AND kosta = &apos;C&apos;.
    IF sy-subrc = 0.
* Posicion ya embalada!
    ELSE.
      o_bi-&gt;inicio( ).
* Pantalla selccion de entrega
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
      o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

* Pulsamos para seleccionar posicion
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

* Entrega                Ventana   Posicionar    Posicion
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = posnr ). &quot; Número de posicion del documento comercial

      IF posnr &lt;&gt; l_vepo-posnr.
* Marcamos la primera fila y puslsamos sobre seleccion de lotes
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHPL_T01&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;LIPS-POSNR(01)&apos; ).
        o_bi-&gt;campos( campo = &apos;RV50A-LIPS_SELKZ(01)&apos; valor = &apos;X&apos; ). &quot; Indicador de seleccion en dynpros de lista

* Pulsamos para añadir una nueva línbea
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
        o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_vepo-posnr ). &quot; Número de posicion del documento comercial

      ENDIF.
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
      o_bi-&gt;campos( campo = &apos;LIPSD-PIKMG(01)&apos; valor = l_cantidad ). &quot; Cantidad entregada efectivamente en UMV

      IF posnr &lt;&gt; l_vepo-posnr.
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK_T&apos; ).
      ENDIF.

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

      mensaje = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = modoct ).

      IF o_bi-&gt;msgty = &apos;S&apos;.
        CLEAR mensaje.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SALIDA_MERCANCIAS" VERSION="1" LANGU="S" DESCRIPT="Realiza salida de mercancías" EXPOSURE="2" STATE="1" EDITORDER="4 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SALIDA_MERCANCIAS" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-VBELN"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SALIDA_MERCANCIAS" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SALIDA_MERCANCIAS" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SALIDA_MERCANCIAS" SCONAME="MENSAJE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPIRET2-MESSAGE"/>
  <source>METHOD salida_mercancias.
    DATA: l_tabla TYPE tabname VALUE &apos;VBUK&apos;,
          l_wbstk TYPE wbstk,
          o_bi    TYPE REF TO zcl_ap_batch_input,
          l_vbtyp TYPE likp-vbtyp.

    IF zcl_c=&gt;hana = &apos;X&apos;.
      l_tabla = &apos;LIKP&apos;.
    ENDIF.

    CLEAR mensaje.

    SELECT SINGLE wbstk FROM (l_tabla)
      INTO l_wbstk
     WHERE vbeln = vbeln.
    IF l_wbstk = &apos;C&apos;.
      IF NOT o_log IS INITIAL.
        o_log-&gt;log( p1 = &apos;La entrega&apos; p2 = vbeln p3 = &apos;ya tenía efectuada la salida de mercancías&apos; msgty = &apos;W&apos; ).
      ENDIF.
      RETURN.
    ELSE.
      o_bi = NEW #( ).

      o_bi-&gt;inicio( ).

      SELECT SINGLE vbtyp FROM likp
        INTO l_vbtyp
       WHERE vbeln = vbeln.

      IF l_vbtyp = &apos;7&apos;.
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4104&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WABU_T&apos; ).
        o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

        mensaje = o_bi-&gt;llamar_transaccion( tcode = &apos;VL32N&apos; modo = modoct ).
      ELSE.
* Pantalla selcción de entrega
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4004&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WABU_T&apos; ).
        o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

        mensaje = o_bi-&gt;llamar_transaccion( tcode = &apos;VL02N&apos; modo = modoct ).
      ENDIF.

      IF o_bi-&gt;msgty = &apos;E&apos; AND mensaje &lt;&gt; &apos;&apos;.
      ELSE.
        SELECT SINGLE wbstk FROM (l_tabla)
          INTO l_wbstk
         WHERE vbeln = vbeln.
        IF l_wbstk = &apos;C&apos;.
          CLEAR mensaje.
        ENDIF.
      ENDIF.

      IF NOT o_log IS INITIAL.
        IF mensaje IS INITIAL.
          o_log-&gt;log( p1 = &apos;Se ha efectuado la salida de mercancías de la entrega&apos; p2 = vbeln msgty = &apos;S&apos; ).
        ELSE.
          o_log-&gt;log( p1 = &apos;Error de SM de la entrega&apos; p2 = vbeln p3 = mensaje msgty = &apos;E&apos; ).
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_FECHA_HORA_INICIO" VERSION="1" LANGU="S" DESCRIPT="Graba fecha/hora de eventos de cabecera" EXPOSURE="2" STATE="1" EDITORDER="39 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_FECHA_HORA_INICIO" SCONAME="VBELN" VERSION="1" LANGU="S" DESCRIPT="Entrega" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_FECHA_HORA_INICIO" SCONAME="HANDLE" VERSION="1" LANGU="S" DESCRIPT="Clave unívoca mundial para LIKP-VBELN" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-HANDLE" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_FECHA_HORA_INICIO" SCONAME="TIPO_FECHA" VERSION="1" LANGU="S" DESCRIPT="&apos;WSHDR0003&apos; &quot;Fecha descarga" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TSEGE-EVEN" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_FECHA_HORA_INICIO" SCONAME="TIPO" VERSION="1" LANGU="S" DESCRIPT="0-Plan, 1-Real" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TSEGE-EVEN_VERTY" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_FECHA_HORA_INICIO" SCONAME="TZONE" VERSION="1" LANGU="S" DESCRIPT="Huso horario inicio de operación" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TSEGE-EVEN_ZONFR" PARVALUE="&apos;CET&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_FECHA_HORA_INICIO" SCONAME="FECHA" VERSION="1" LANGU="S" DESCRIPT="Campo de tipo DATS" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="DATS"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_FECHA_HORA_INICIO" SCONAME="HORA" VERSION="1" LANGU="S" DESCRIPT="Hora del día" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="UZEIT"/>
  <source>METHOD set_fecha_hora_inicio.
    DATA: l_handle     TYPE likp-handle,
          tsege        TYPE tsege,
          l_even_tstfr TYPE tsege-even_tstfr,
          l_even_zonfr TYPE tsege-even_zonfr,
          l_fecha      TYPE dats,
          l_hora       TYPE uzeit,
          tsegh        TYPE tsegh,
          l_aux        TYPE c LENGTH 22.

    IF handle IS INITIAL.
      SELECT SINGLE handle FROM likp
        INTO l_handle
       WHERE vbeln = vbeln.
    ELSE.
      l_handle = handle.
    ENDIF.

    IF l_handle IS INITIAL.
      RETURN.
    ENDIF.

    SELECT SINGLE even_tstfr even_zonfr FROM tsege
      INTO (l_even_tstfr, l_even_zonfr)
     WHERE head_hdl   = l_handle
       AND even       = tipo_fecha
       AND even_verty = tipo.
    IF sy-subrc = 0.
      zcl_ap_fechas=&gt;timestamp_2_fechahora( EXPORTING timestamp = l_even_tstfr
                                                      tzone     = l_even_zonfr
                                            IMPORTING fecha     = l_fecha
                                                      hora      = l_hora ).
      IF NOT ( l_fecha = fecha AND l_hora = hora ).
        l_even_tstfr = zcl_ap_fechas=&gt;fechahora_2_timestamp( fecha = fecha hora = hora tzone = tzone ).
        UPDATE tsege &quot;#EC AOC_STD_TABLE
          SET even_tstfr = l_even_tstfr
              even_tstto = l_even_tstfr
         WHERE head_hdl   = l_handle
           AND even       = tipo_fecha
           AND even_verty = tipo.
      ENDIF.
    ELSE.
      SELECT SINGLE * FROM tsegh
        INTO tsegh
      WHERE head_hdl = l_handle.
      IF sy-subrc &lt;&gt; 0.
        tsegh-head_hdl   = l_handle.
        tsegh-head_obj   = &apos;WSHDRLIKP&apos;.
        tsegh-head_tpl   = &apos;WSHDRSTDDL&apos;.
        tsegh-head_unacr = sy-uname.
        CONCATENATE sy-datum sy-uzeit INTO l_aux.
        tsegh-head_tstcr = l_aux.
        INSERT tsegh FROM tsegh. &quot;#EC AOC_STD_TABLE
      ENDIF.
      tsege-head_hdl   = l_handle.
      tsege-even       = tipo_fecha.
      tsege-even_sor   = 300.
      tsege-even_zonfr = tzone.
      tsege-even_zonto = tzone.
      IF tipo = &apos;1&apos;.
        tsege-even_verty = &apos;0&apos;.
        INSERT tsege FROM tsege. &quot;#EC AOC_STD_TABLE
      ELSEIF tipo = &apos;0&apos;.
        tsege-even_verty = &apos;1&apos;.
        INSERT tsege FROM tsege. &quot;#EC AOC_STD_TABLE
      ENDIF.

      tsege-even_verty = tipo.
      tsege-even_tstfr = zcl_ap_fechas=&gt;fechahora_2_timestamp( fecha = fecha hora = hora tzone = tzone ).
      tsege-even_tstto = tsege-even_tstfr.
      INSERT tsege FROM tsege.  &quot;#EC AOC_STD_TABLE
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_TEXTO_STRING" VERSION="1" LANGU="S" DESCRIPT="Actualiza texto de la entrega" EXPOSURE="2" STATE="1" EDITORDER="12 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_TEXTO_STRING" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_TEXTO_STRING" SCONAME="POSNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="POSNR_VL" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_TEXTO_STRING" SCONAME="ID" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STXH-TDID"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_TEXTO_STRING" SCONAME="SPRAS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SPRAS" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="SET_TEXTO_STRING" SCONAME="STRING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STRING"/>
  <source>METHOD set_texto_string.
    DATA l_name TYPE stxh-tdname.

    IF posnr IS INITIAL.
      zcl_ap_textos=&gt;save_texto_string( id = id object = &apos;VBBK&apos; name = vbeln spras = spras string = string ).
    ELSE.
      CONCATENATE vbeln posnr INTO l_name.
      zcl_ap_textos=&gt;save_texto_string( id = id object = &apos;VBBP&apos; name = l_name spras = spras string = string ).
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="TIENE_SM" VERSION="1" LANGU="S" DESCRIPT="¿Entrega tiene SM?" EXPOSURE="2" STATE="1" EDITORDER="25 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="TIENE_SM" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="TIENE_SM" SCONAME="SM" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="ABAP_BOOL"/>
  <source>METHOD tiene_sm.
    DATA: l_tabla TYPE tabname VALUE &apos;VBUK&apos;,
          l_vbeln TYPE vbuk-vbeln,
          l_wbstk TYPE vbuk-wbstk.

    IF zcl_c=&gt;hana = &apos;X&apos;.
      l_tabla = &apos;LIKP&apos;.
    ENDIF.

    l_vbeln = vbeln.
    __poner_ceros l_vbeln.
    SELECT SINGLE wbstk FROM (l_tabla)
      INTO l_wbstk
     WHERE vbeln = l_vbeln.
    IF l_wbstk = &apos;C&apos;.
      sm = &apos;X&apos;.
    ELSE.
      CLEAR sm.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VALIDAR_ENTREGA_MODIFICABLE" VERSION="1" LANGU="S" DESCRIPT="¿Entrega es modificable?" EXPOSURE="2" STATE="1" EDITORDER="40 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VALIDAR_ENTREGA_MODIFICABLE" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VALIDAR_ENTREGA_MODIFICABLE" SCONAME="MESSAGE" VERSION="1" LANGU="S" DESCRIPT="Texto de mensaje" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD validar_entrega_modificable.
    DATA: l_tknum TYPE tknum,
          l_sttrg TYPE vttk-sttrg.

    IF tiene_sm( vbeln ) = &apos;X&apos;.
      message = &apos;Entrega ya tiene salida de mercancías. No es posible modificarla&apos;.
    ELSE.
      l_tknum = get_transporte( vbeln ).
      IF NOT l_tknum IS INITIAL.
        SELECT SINGLE sttrg FROM vttk
          INTO l_sttrg
         WHERE tknum = l_tknum.
        IF l_sttrg = &apos;7&apos;.
          __concat3 message &apos;Entrega está incluída en transporte finalizado&apos; l_tknum &apos;. No es posible modificarla&apos;.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VISUALIZAR" VERSION="1" LANGU="S" DESCRIPT="Visualizar entrega" EXPOSURE="2" STATE="1" EDITORDER="1 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VISUALIZAR" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY"/>
  <source>METHOD visualizar.
    TYPES: BEGIN OF t_ent,
             vbeln TYPE likp-vbeln,
             lfdat TYPE likp-lfdat,
           END OF t_ent,
           BEGIN OF t_vbeln,
             vbeln TYPE vbak-vbeln,
           END OF t_vbeln.

    DATA: l_entrada  TYPE string,
          l_lista    TYPE string,
          l_vbeln    TYPE vbeln_va,
          i_entregas TYPE TABLE OF t_vbeln,
          i_ent      TYPE TABLE OF t_ent,
          l_ent      TYPE t_ent.

    CHECK NOT vbeln IS INITIAL.

    l_entrada = vbeln.
    IF l_entrada(1) = &apos;@&apos;.
      REPLACE ALL OCCURRENCES OF &apos;@&apos; IN l_entrada WITH &apos;&apos;.
      l_entrada = l_entrada+5.
    ENDIF.

    IF l_entrada CS &apos;,&apos;.
      l_lista = l_entrada.
      CLEAR l_vbeln.
    ELSE.
      l_vbeln = l_entrada.
      __poner_ceros l_vbeln.
    ENDIF.

    IF NOT l_vbeln IS INITIAL.
      CALL FUNCTION &apos;RV_CALL_DISPLAY_TRANSACTION&apos;
        EXPORTING
          vbeln = l_vbeln.
    ELSE.
      i_entregas = zcl_ap_lista=&gt;lista2tabla_n10( lista = l_lista ).
      DESCRIBE TABLE i_entregas LINES sy-tfill.
      IF sy-tfill = 1.
        READ TABLE i_entregas INTO l_vbeln INDEX 1.
        CALL FUNCTION &apos;RV_CALL_DISPLAY_TRANSACTION&apos;
          EXPORTING
            vbeln = l_vbeln.
      ELSEIF sy-tfill &gt; 1.
        SELECT * FROM likp
          INTO CORRESPONDING FIELDS OF TABLE i_ent
          FOR ALL ENTRIES IN i_entregas
         WHERE vbeln = i_entregas-vbeln
         ORDER BY PRIMARY KEY.
        DESCRIBE TABLE i_ent LINES sy-tfill.
        IF sy-tfill = 1.
          READ TABLE i_ent INTO l_ent INDEX 1.
          IF sy-subrc = 0.
            CALL FUNCTION &apos;RV_CALL_DISPLAY_TRANSACTION&apos;
              EXPORTING
                vbeln = l_ent-vbeln.
          ENDIF.
        ELSEIF sy-tfill &gt; 1.
          CALL FUNCTION &apos;Z_POPUP_ALV_AP&apos;
            EXPORTING
              titulo         = &apos;Seleccione entrega a visualizar&apos;(spv)
              campos_hotspot = &apos;VBELN&apos;
              ancho          = 40
              botones        = &apos;CANCEL&apos;
            TABLES
              t_datos        = i_ent.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.                    &quot; handle_double_click</source>
 </method>
 <method CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VLPOD" VERSION="1" LANGU="S" DESCRIPT="VLPOD" EXPOSURE="2" STATE="1" EDITORDER="33 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VLPOD" SCONAME="I_POS" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_VLPOD"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VLPOD" SCONAME="VBELN" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="VBELN_VL"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VLPOD" SCONAME="PODAT" VERSION="1" LANGU="S" DESCRIPT="Fecha ARE" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-PODAT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VLPOD" SCONAME="POTIM" VERSION="1" LANGU="S" DESCRIPT="Hora ARE" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="LIKP-POTIM" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VLPOD" SCONAME="O_LOG" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="3" TYPE="ZCL_AP_LOG" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VLPOD" SCONAME="MODOCT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="CHAR1" PARVALUE="&apos;N&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VLPOD" SCONAME="CONFIRMAR_ARE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ENTREGAS" CMPNAME="VLPOD" SCONAME="MESSAGE" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <source>METHOD vlpod.
    DATA: l_tabla TYPE tabname VALUE &apos;VBUK&apos;,
          o_bi    TYPE REF TO zcl_ap_batch_input,
          l_tvpod TYPE tvpod,
          l_posnr TYPE posnr,
          l_pos   TYPE numc2,
          l_aux   TYPE posnr,
          l_npos  TYPE i,
          l_pdstk TYPE vbuk-pdstk.

    FIELD-SYMBOLS &lt;pos&gt; TYPE t_vlpod.

    IF zcl_c=&gt;hana = &apos;X&apos;.
      l_tabla = &apos;LIKP&apos;.
    ENDIF.

    o_bi = NEW #( ).

    o_bi-&gt;inicio( ).

    o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4006&apos; ).
    o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
    o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

    LOOP AT i_pos ASSIGNING &lt;pos&gt;.
      SELECT SINGLE lfimg_diff calcu FROM tvpod &quot;#EC CI_SEL_NESTED &quot;#EC CI_NOFIELD
        INTO CORRESPONDING FIELDS OF l_tvpod
       WHERE vbeln = vbeln
         AND posnr = &lt;pos&gt;-posnr.
      IF sy-subrc = 0.
        IF &lt;pos&gt;-diff = l_tvpod-lfimg_diff.
          IF    ( &lt;pos&gt;-grund = &apos;DFG1&apos; AND l_tvpod-calcu = &apos;+&apos; )
             OR ( &lt;pos&gt;-grund = &apos;DFG2&apos; AND l_tvpod-calcu = &apos;-&apos; ).
            CONTINUE.
          ENDIF.
        ENDIF.
      ENDIF.
      IF &lt;pos&gt;-posnr &lt; &apos;900000&apos;.
        l_posnr = &lt;pos&gt;-posnr.
      ELSE.
        SELECT SINGLE uecha FROM lips                &quot;#EC CI_SEL_NESTED
          INTO l_posnr                                 ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
         WHERE vbeln = vbeln
           AND posnr = &lt;pos&gt;-posnr.
      ENDIF.

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=POPO_T&apos; ).

      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;0111&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos; ).
      o_bi-&gt;campos( campo = &apos;RV50A-POSNR&apos; valor = l_posnr ).

      IF &lt;pos&gt;-posnr &lt; &apos;900000&apos;.
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;TVPODVB-GRUND(01)&apos; valor = &lt;pos&gt;-grund ).
        o_bi-&gt;campos( campo = &apos;TVPODVB-LFIMG_DIFF(01)&apos; valor = &lt;pos&gt;-diff ).
        o_bi-&gt;campos( campo = &apos;TVPODVB-LGMNG_DIFF(01)&apos; valor = &apos;&apos; ind = l_pos ).
      ELSE.
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;RV50A-CHMULT(01)&apos; ).
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=CHPL_T01&apos; ).

        l_pos = 1.
        SELECT posnr FROM lips                       &quot;#EC CI_SEL_NESTED  &quot;#EC CI_EXIT_SELECT
          INTO l_aux                                   ##DB_FEATURE_MODE[TABLE_LEN_MAX1]
         WHERE vbeln = vbeln
           AND uecha = l_posnr
         ORDER BY posnr.
          l_pos = l_pos + 1.
          IF l_aux = &lt;pos&gt;-posnr.
            EXIT.
          ENDIF.
        ENDSELECT.

        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
        o_bi-&gt;campos( campo = &apos;TVPODVB-GRUND&apos; valor = &lt;pos&gt;-grund ind = l_pos ).
        o_bi-&gt;campos( campo = &apos;TVPODVB-LFIMG_DIFF&apos; valor = &lt;pos&gt;-diff ind = l_pos ).

      ENDIF.
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=BACK_T&apos; ).
      l_npos = l_npos + 1.
    ENDLOOP.

    IF l_npos = 0.
      o_log-&gt;log( p1 = &apos;No habia ninguna posición con modificaciones ARE&apos; p2 = vbeln msgty = &apos;S&apos; ).
      IF confirmar_are = &apos;X&apos;.
        SELECT SINGLE pdstk FROM (l_tabla)
          INTO l_pdstk
         WHERE vbeln = vbeln.
        IF l_pdstk &lt;&gt; &apos;C&apos;.
          o_bi-&gt;inicio( ).
          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4006&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
          o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
*        o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;TVPODVB-GRUND&apos;).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=PODQ&apos; ).
          IF NOT podat IS INITIAL.
            o_bi-&gt;campos( campo = &apos;LIKP-PODAT&apos; valor = podat ).
          ENDIF.
          IF NOT potim IS INITIAL.
            o_bi-&gt;campos( campo = &apos;LIKP-POTIM&apos; valor = potim ).
          ENDIF.

          o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

          message = o_bi-&gt;llamar_transaccion( tcode = &apos;VLPOD&apos; modo = modoct ).
          SELECT SINGLE pdstk FROM (l_tabla)
            INTO l_pdstk
           WHERE vbeln = vbeln.
          IF l_pdstk = &apos;C&apos;.
            CLEAR message.
          ENDIF.
        ENDIF.
      ENDIF.
    ELSE.
      o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      IF NOT podat IS INITIAL.
        o_bi-&gt;campos( campo = &apos;LIKP-PODAT&apos; valor = podat ).
      ENDIF.
      IF NOT potim IS INITIAL.
        o_bi-&gt;campos( campo = &apos;LIKP-POTIM&apos; valor = potim ).
      ENDIF.
      IF confirmar_are = &apos;X&apos;.
        o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=PODQ&apos; ).
        o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
      ENDIF.
      o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

      message = o_bi-&gt;llamar_transaccion( tcode = &apos;VLPOD&apos; modo = modoct ).

      IF o_bi-&gt;msgty = &apos;S&apos;.
        CLEAR message.
      ENDIF.

      IF message IS INITIAL.
        LOOP AT i_pos ASSIGNING &lt;pos&gt;.
          SELECT lfimg_diff, calcu
            FROM tvpod               &quot;#EC CI_SEL_NESTED &quot;#EC CI_NOFIELD
            WHERE vbeln = @vbeln
              AND posnr = @&lt;pos&gt;-posnr
            ORDER BY PRIMARY KEY
            INTO CORRESPONDING FIELDS OF @l_tvpod
            UP TO 1 ROWS.
          ENDSELECT.
          IF sy-subrc = 0.
            IF &lt;pos&gt;-diff = l_tvpod-lfimg_diff.
              IF    ( &lt;pos&gt;-grund = &apos;DFG1&apos; AND l_tvpod-calcu = &apos;+&apos; )
                 OR ( &lt;pos&gt;-grund = &apos;DFG2&apos; AND l_tvpod-calcu = &apos;-&apos; ).
                CONTINUE.
              ENDIF.
            ENDIF.
            message = &apos;No se han podido realizar todas las modificaciones ARE&apos;.
          ELSE.
            message = &apos;No se han podido realizar todas las modificaciones ARE&apos;.
          ENDIF.
        ENDLOOP.

        IF l_npos = 0 AND message IS INITIAL AND confirmar_are = &apos;X&apos;.
          SELECT SINGLE pdstk FROM (l_tabla)
            INTO l_pdstk
           WHERE vbeln = vbeln.
          IF l_pdstk &lt;&gt; &apos;C&apos;.
            o_bi-&gt;inicio( ).
            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;4006&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos; ).
            o_bi-&gt;campos( campo = &apos;LIKP-VBELN&apos; valor = vbeln ). &quot; Entrega

            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_CURSOR&apos; valor = &apos;TVPODVB-GRUND&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=PODQ&apos; ).
            IF NOT podat IS INITIAL.
              o_bi-&gt;campos( campo = &apos;LIKP-PODAT&apos; valor = podat ).
            ENDIF.
            IF NOT potim IS INITIAL.
              o_bi-&gt;campos( campo = &apos;LIKP-POTIM&apos; valor = potim ).
            ENDIF.

            o_bi-&gt;dynpro( program = &apos;SAPMV50A&apos; dynpro = &apos;1000&apos; ).
            o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=SICH_T&apos; ).

            message = o_bi-&gt;llamar_transaccion( tcode = &apos;VLPOD&apos; modo = modoct ).
            SELECT SINGLE pdstk FROM (l_tabla)
              INTO l_pdstk
             WHERE vbeln = vbeln.
            IF l_pdstk = &apos;C&apos;.
              CLEAR message.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.

      IF NOT o_log IS INITIAL.
        IF message IS INITIAL.
          o_log-&gt;log( p1 = &apos;Se ha realizado correctamente el acuse de recibo de la entrega&apos; p2 = vbeln msgty = &apos;S&apos; ).
        ELSE.
          o_log-&gt;log( p1 = message ).
        ENDIF.
      ENDIF.
    ENDIF.
  ENDMETHOD.</source>
 </method>
</CLAS>
