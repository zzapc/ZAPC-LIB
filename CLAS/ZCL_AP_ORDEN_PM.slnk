<?xml version="1.0" encoding="utf-8"?>
<CLAS CLSNAME="ZCL_AP_ORDEN_PM" VERSION="1" LANGU="S" DESCRIPT="Orden PM" CATEGORY="00" EXPOSURE="2" STATE="1" RELEASE="0" CLSCCINCL="X" FIXPT="X" UNICODE="X" CLSBCCAT="00" DURATION_TYPE="0 " RISK_LEVEL="0 " ZSAPLINK_PLUGIN_MAJOR_VERSION="0 " ZSAPLINK_PLUGIN_MINOR_VERSION="1 " ZSAPLINK_PLUGIN_BUILD_VERSION="0 " ZSAPLINK_PLUGIN_INFO1="ZSAPLINK_CLASS is part of the main ZSAPLINK project --&gt; This plugin found there instead of ZSAPLINK_PLUGINS projects" ZSAPLINK_PLUGIN_INFO2="SAPLINK homepage: https://www.assembla.com/spaces/saplink/wiki" ZSAPLINK_PLUGIN_INFO3="Download from https://www.assembla.com/code/saplink/subversion/nodes" ZSAPLINK_PLUGIN_INFO4="and navigate to:  trunk -&gt; core -&gt; ZSAPLINK -&gt; CLAS -&gt; ZSAPLINK_CLASS.slnk">
 <localImplementation>*&quot;* use this source file for the definition and implementation of
*&quot;* local helper classes, interface definitions and type
*&quot;* declarations</localImplementation>
 <localTypes>*&quot;* use this source file for any type of declarations (class
*&quot;* definitions, interfaces or type declarations) you need for
*&quot;* components in the private section</localTypes>
 <localMacros>*&quot;* use this source file for any macro definitions you need
*&quot;* in the implementation part of the class</localMacros>
 <typeUsage CLSNAME="ZCL_AP_ORDEN_PM" TYPEGROUP="ABAP" VERSION="1" TPUTYPE="0" IMPLICIT="X"/>
 <forwardDeclaration>ABAP</forwardDeclaration>
 <method CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="CERRAR_ORDEN" VERSION="1" LANGU="S" DESCRIPT="Cerrar orden" EXPOSURE="2" STATE="1" EDITORDER="2 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="CERRAR_ORDEN" SCONAME="AUFNR" VERSION="1" LANGU="S" DESCRIPT="Número de orden" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="AUFNR"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="CERRAR_ORDEN" SCONAME="FECHA_CIERRE" VERSION="1" LANGU="S" DESCRIPT="Campo de tipo DATS" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="DATS" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="CERRAR_ORDEN" SCONAME="HORA_CIERRE" VERSION="1" LANGU="S" DESCRIPT="Hora del día" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="UZEIT" PAROPTIONL="X"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="CERRAR_ORDEN" SCONAME="COMMIT" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ABAP_BOOL" PARVALUE="&apos;X&apos;"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="CERRAR_ORDEN" SCONAME="MESSAGE" VERSION="1" LANGU="S" DESCRIPT="Texto de mensaje" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPI_MSG"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="CERRAR_ORDEN" SCONAME="I_RETURN" VERSION="1" LANGU="S" DESCRIPT="Parámetro de retorno" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="BAPIRET2_T"/>
  <source>METHOD cerrar_orden.

    CLEAR i_return.

    SELECT SINGLE objnr FROM aufk
      INTO @DATA(l_objnr)
     WHERE aufnr = @aufnr.

    SELECT SINGLE objnr FROM jest
      INTO l_objnr
     WHERE objnr = l_objnr
       AND stat  = &apos;I0045&apos; &quot;Cierre técnico
       AND inact = &apos;&apos;.
    IF sy-subrc = 0.
      message = &apos;Orden ya estaba cerrada&apos;.
    ELSE.
      DATA(i_methods) = VALUE bapi_alm_order_method_t( ( refnumber = &apos;000001&apos; objecttype = &apos;HEADER&apos;  method = &apos;TECHNICALCOMPLETE&apos; objectkey = aufnr )
                                                       ( refnumber = &apos;000000&apos; objecttype = &apos;&apos;        method = &apos;SAVE&apos;              objectkey = aufnr ) ).
      IF NOT fecha_cierre IS INITIAL.
        DATA(i_header)  = VALUE bapi_alm_order_header_t( ( orderid   = aufnr teco_ref_date = fecha_cierre teco_ref_time = hora_cierre ) ).
      ENDIF.
      DATA(i_header_up)  = VALUE  bapi_alm_order_header_ut( ( orderid   = aufnr ) ).

      CALL FUNCTION &apos;BAPI_ALM_ORDER_MAINTAIN&apos;
        TABLES
          it_methods   = i_methods
          it_header    = i_header
          it_header_up = i_header_up
          return       = i_return.

      IF zcl_orden=&gt;contiene_status( objnr = l_objnr status_int = &apos;I0045&apos; ). &quot;Cerrado técnicamente
        CLEAR i_return.
      ENDIF.

* A veces falla por un error raro y no sé porqué en esos casos intentamos batchinput.
      IF commit = &apos;X&apos;.
        IF line_exists( i_return[ type = &apos;E&apos; number = &apos;162&apos; ] ).
          DATA: o_bi      TYPE REF TO zcl_ap_batch_input,
                l_mensaje TYPE bapireturn1-message.
          CREATE OBJECT o_bi.

          o_bi-&gt;inicio( ).

* Orden MT: acceso modificar/visualizar
          o_bi-&gt;dynpro( program = &apos;SAPLCOIH&apos; dynpro = &apos;0101&apos;).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;/00&apos;).
          o_bi-&gt;campos( campo = &apos;CAUFVD-AUFNR&apos; valor = aufnr ). &quot; Número de orden

          o_bi-&gt;dynpro( program = &apos;SAPLCOIH&apos; dynpro = &apos;3000&apos;).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=ARCH&apos;).

          o_bi-&gt;dynpro( program = &apos;SAPLCOI0&apos; dynpro = &apos;1000&apos;).
          o_bi-&gt;campos( campo = &apos;BDC_OKCODE&apos; valor = &apos;=WEIT&apos;).
          o_bi-&gt;campos( campo = &apos;RIARCH-ADDAT&apos; valor = fecha_cierre ). &quot; Orden PM: fecha de referencia
          o_bi-&gt;campos( campo = &apos;RIARCH-ADUHR&apos; valor = hora_cierre ). &quot; Hora para la fecha de referencia

          l_mensaje = o_bi-&gt;llamar_transaccion( tcode = &apos;IW32&apos; modo = &apos;N&apos;).
          IF zcl_orden=&gt;contiene_status( objnr = l_objnr status_int = &apos;I0045&apos; ). &quot;Cerrado técnicamente
            CLEAR i_return.
          ENDIF.

        ENDIF.
      ENDIF.

      IF line_exists( i_return[ type = &apos;E&apos; ] ).
        LOOP AT i_return ASSIGNING FIELD-SYMBOL(&lt;return&gt;) WHERE type = &apos;E&apos; AND id NE &apos;IWO_BAPI2&apos;.
          CONCATENATE message &lt;return&gt;-message INTO &lt;return&gt;-message SEPARATED BY space.
        ENDLOOP.
      ELSE.
        IF commit = &apos;X&apos;.
          CALL FUNCTION &apos;BAPI_TRANSACTION_COMMIT&apos;
            EXPORTING
              wait = &apos;X&apos;.
        ENDIF.
      ENDIF.
    ENDIF.

  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="GET_TEXTO_STRING" VERSION="1" LANGU="S" DESCRIPT="Recupera texto" EXPOSURE="2" STATE="1" EDITORDER="3 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="GET_TEXTO_STRING" SCONAME="AUFNR" VERSION="1" LANGU="S" DESCRIPT="Número de orden" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="AUFNR"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="GET_TEXTO_STRING" SCONAME="ID" VERSION="1" LANGU="S" DESCRIPT="ID de texto" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="TDID" PARVALUE="&apos;KOPF&apos;"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="GET_TEXTO_STRING" SCONAME="SPRAS" VERSION="1" LANGU="S" DESCRIPT="Clave de idioma" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="STXH-TDSPRAS" PARVALUE="SY-LANGU"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="GET_TEXTO_STRING" SCONAME="STRING" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="3" PARPASSTYP="0" TYPTYPE="1" TYPE="STRING"/>
  <source>METHOD get_texto_string.

    DATA l_name TYPE stxh-tdname.

    l_name = sy-mandt &amp;&amp; aufnr.
    string = zcl_ap_textos=&gt;get_texto_string( id     = id
                                              name   = l_name
                                              spras  = spras
                                              object = &apos;AUFK&apos;
                                              memory = &apos;X&apos;
                                              elim_regexp = &apos;:.()&apos; ).

  ENDMETHOD.</source>
 </method>
 <method CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" VERSION="1" LANGU="S" DESCRIPT="Imprime formulario" EXPOSURE="2" STATE="1" EDITORDER="1 " DISPID="0 " MTDTYPE="0" MTDDECLTYP="1" BCMTDCAT="00" BCMTDSYN="0">
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" SCONAME="AUFNR" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="1 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="AUFNR"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" SCONAME="WORKPAPER" VERSION="1" LANGU="S" DESCRIPT="PM: Documento de trabajo" CMPTYPE="1" MTDTYPE="0" EDITORDER="2 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="WWORKPAPER-WORKPAPER"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" SCONAME="DEVICE" VERSION="1" LANGU="S" DESCRIPT="Dipsositivo de salida" CMPTYPE="1" MTDTYPE="0" EDITORDER="3 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ITCPP-TDDEVICE" PARVALUE="&apos;PREVIEW&apos;"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" SCONAME="TDDEST" VERSION="1" LANGU="S" DESCRIPT="SPOOL: Dispositivo de salida" CMPTYPE="1" MTDTYPE="0" EDITORDER="4 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="RSPOPNAME" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" SCONAME="GET_AREA_OTF" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="5 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" SCONAME="GET_AREA_PDF" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="6 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="ANY" PARVALUE="&apos;&apos;"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" SCONAME="LANGU" VERSION="1" LANGU="S" DESCRIPT="Campo de sistema ABAP: Clave de idioma de entorno de texto" CMPTYPE="1" MTDTYPE="0" EDITORDER="7 " DISPID="0 " PARDECLTYP="0" PARPASSTYP="1" TYPTYPE="1" TYPE="SY-LANGU" PARVALUE="SY-LANGU"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" SCONAME="I_OTFDATA" VERSION="1" LANGU="S" CMPTYPE="1" MTDTYPE="0" EDITORDER="8 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="TT_ITCOO"/>
  <parameter CLSNAME="ZCL_AP_ORDEN_PM" CMPNAME="IMPRIMIR_FORMULARIO" SCONAME="PDF" VERSION="1" LANGU="S" DESCRIPT="Procesamiento formulario: Contenido de XFT, XFD, PDF, etc." CMPTYPE="1" MTDTYPE="0" EDITORDER="9 " DISPID="0 " PARDECLTYP="1" PARPASSTYP="1" TYPTYPE="1" TYPE="FPCONTENT"/>
  <source>METHOD imprimir_formulario.
    DATA: caufvd       TYPE caufvd,
          iloa         TYPE iloa,
          riwo1        TYPE riwo1,
          iaffhd       TYPE TABLE OF affhd,
          iafvgd       TYPE TABLE OF afvgd,
          iresbd       TYPE TABLE OF resbd,
          iripw0       TYPE TABLE OF ripw0,
          op_print_tab TYPE TABLE OF riprt1,
          ihpad_tab    TYPE TABLE OF ihpad,
          ihsg_tab     TYPE TABLE OF ihsg,
          ihgns_tab    TYPE TABLE OF ihgns,
          kbedp_tab    TYPE TABLE OF kbedp,
          wworkpaper   TYPE wworkpaper,
          iworkpaper   TYPE TABLE OF wworkpaper.

    IF tddest IS INITIAL.
      wworkpaper-tddest = zcl_ap_usuario=&gt;get_impresora( ).
    ELSE.
      wworkpaper-tddest = tddest.
    ENDIF.
    wworkpaper-pm_appl = &apos;O&apos;.
    wworkpaper-workpaper = workpaper.
    wworkpaper-selected = &apos;X&apos;.
    wworkpaper-print_lang = sy-langu.
    APPEND wworkpaper TO iworkpaper.

    CALL FUNCTION &apos;PM_ORDER_DATA_READ&apos;
      EXPORTING
        order_number    = aufnr
*       CALL_FROM_NOTIF =
      IMPORTING
        wcaufvd         = caufvd
        wiloa           = iloa
        wriwo1          = riwo1
      TABLES
        iaffhd          = iaffhd
        iafvgd          = iafvgd
        iresbd          = iresbd
        iripw0          = iripw0
        op_print_tab    = op_print_tab
        ihpad_tab       = ihpad_tab
        ihsg_tab        = ihsg_tab
        ihgns_tab       = ihgns_tab
        kbedp_tab       = kbedp_tab
      EXCEPTIONS
        order_not_found = 1
        OTHERS          = 2.
    IF sy-subrc &lt;&gt; 0.
* Implement suitable error handling here
    ENDIF.

    CALL FUNCTION &apos;PM_ORDER_PRINT_CONTROL&apos;   &quot; IN DIALOG !!!!!!!
      EXPORTING
        device       = device
        caufvd       = caufvd       &quot; order data !!!
        riwo1        = riwo1
        iloa         = iloa                    &quot;
*       iviqmel      = iviqmel
*       n_riwo1      = riwo1
*       riwo00       = riwo00
*       iv_vrgng     = lv_vrgng
      TABLES
        iafvgd       = iafvgd
        iresbd       = iresbd
        iripw0       = iripw0
        iaffhd       = iaffhd
        kbedp_tab    = kbedp_tab    &quot;capacities and split
        ihpad_tab    = ihpad_tab
        ihsg_tab     = ihsg_tab     &quot; special permnission
        ihgns_tab    = ihgns_tab    &quot; special permnission
        op_print_tab = op_print_tab
        iworkpaper   = iworkpaper   &quot; papers to display
*       idocuments   = lt_documents
*       iviqmfe      = iviqmfe
*       iviqmma      = iviqmma
*       iviqmsm      = iviqmsm
*       iviqmur      = iviqmur
*       iqkat        = iqkat
        n_ihpad_tab  = ihpad_tab.

  ENDMETHOD.</source>
 </method>
</CLAS>
